@using Microsoft.AspNetCore.Components.Authorization
@inject INotificationService NotificationService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@implements IDisposable

<div class="relative" @onclick:stopPropagation>
    <!-- Notification Bell Button with Modern Styling -->
    <button id="notification-bell-button" @onclick="ToggleDropdown"
        class="relative p-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-700/50 hover:bg-gray-200/70 dark:hover:bg-gray-600/70 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 shadow-sm hover:shadow-md @(hasNewNotifications ? "animate-bell-ring" : "") group">
            <!-- Bell Icon with Gradient Stroke -->
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="url(#bellGradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <defs>
                    <linearGradient id="bellGradient" x1="0" y1="0" x2="1" y2="0">
                        <stop offset="0%" stop-color="var(--color-primary)" />
                        <stop offset="100%" stop-color="var(--color-accent)" />
                    </linearGradient>
                </defs>
                <path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
            </svg>

        <!-- Modern Gradient Badge for Unread Count -->
        @if (unreadCount > 0)
        {
            <span class="absolute -top-1 -right-1 inline-flex items-center justify-center min-w-[22px] h-[22px] px-1.5 text-xs font-extrabold leading-none text-white bg-gradient-to-br from-red-500 via-pink-500 to-purple-600 rounded-full shadow-lg animate-pulse ring-2 ring-white dark:ring-gray-800">
                @(unreadCount > 99 ? "99+" : unreadCount.ToString())
            </span>
        }

        <!-- Subtle Glow Effect on Hover -->
        <div class="absolute inset-0 rounded-xl bg-gradient-to-br from-primary to-accent opacity-0 group-hover:opacity-20 dark:group-hover:opacity-30 blur-md transition-opacity duration-300 -z-10"></div>
    </button>

    <!-- Glassmorphism Dropdown Panel -->
    @if (isDropdownOpen)
    {
        <div id="notification-dropdown" class="absolute right-0 mt-3 w-[420px] bg-white/95 dark:bg-gray-800/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-gray-200/50 dark:border-gray-700/50 z-[60] max-h-[600px] flex flex-col overflow-hidden animate-slide-in"
             @onclick:stopPropagation
             style="box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(255, 255, 255, 0.2) inset;">

            <!-- Modern Header with Gradient -->
            <div class="px-6 py-4 border-b border-gray-200/50 dark:border-gray-700/50 bg-gradient-to-r from-primary via-accent to-primary">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold text-white flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>
                        Notifications
                    </h3>
                    @if (unreadCount > 0)
                    {
                        <button @onclick="MarkAllAsRead"
                                class="text-sm text-white/90 hover:text-white font-medium transition-all duration-200 hover:bg-white/20 px-3 py-1.5 rounded-lg">
                            Mark all read
                        </button>
                    }
                </div>
            </div>

            <!-- Notifications List with Custom Scrollbar -->
            <div class="overflow-y-auto flex-1 custom-scrollbar">
                @if (isLoading)
                {
                    <div class="p-12 text-center">
                        <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-primary border-t-transparent"></div>
                        <p class="mt-4 text-sm text-gray-500 dark:text-gray-400 font-medium">Loading notifications...</p>
                    </div>
                }
                else if (recentNotifications.Count == 0)
                {
                    <div class="p-12 text-center">
                        <div class="mx-auto w-20 h-20 bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-600 rounded-full flex items-center justify-center mb-4">
                            <svg class="h-10 w-10 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                            </svg>
                        </div>
                        <p class="text-base text-gray-700 dark:text-gray-200 font-semibold">All caught up!</p>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">No new notifications</p>
                    </div>
                }
                else
                {
                    @foreach (var notification in recentNotifications)
                    {
                        <div @onclick="() => HandleNotificationClick(notification)"
                             class="px-5 py-4 border-b border-gray-100/80 dark:border-gray-700/50 hover:bg-gradient-to-r hover:from-primary-50/50 hover:to-accent-50/50 dark:hover:from-primary-900/20 dark:hover:to-accent-900/20 cursor-pointer transition-all duration-200 @(notification.IsRead ? "bg-white dark:bg-gray-800" : "bg-gradient-to-r from-primary-50/80 to-accent-50/80 dark:from-primary-900/20 dark:to-accent-900/20") group">
                            <div class="flex items-start space-x-3">
                                <!-- Modern Icon with Gradient Background -->
                                <div class="flex-shrink-0 mt-1">
                                    @GetNotificationIcon(notification)
                                </div>

                                <!-- Content -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-start justify-between mb-1">
                                        <div class="flex items-center space-x-2">
                                            <p class="text-sm font-bold text-gray-900 dark:text-gray-100 @(notification.IsRead ? "" : "font-extrabold") group-hover:text-primary dark:group-hover:text-primary transition-colors">
                                                @notification.Title
                                            </p>
                                            @if (notification.Priority == NotificationPriority.Urgent || notification.Priority == NotificationPriority.High)
                                            {
                                                <span class="px-2 py-0.5 text-[10px] font-bold @(notification.Priority == NotificationPriority.Urgent ? "text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900/50" : "text-orange-600 dark:text-orange-400 bg-orange-100 dark:bg-orange-900/50") rounded-full">
                                                    @notification.Priority.ToString().ToUpper()
                                                </span>
                                            }
                                        </div>
                                        @if (!notification.IsRead)
                                        {
                                            <span class="ml-2 w-2.5 h-2.5 bg-gradient-to-br from-primary to-accent rounded-full flex-shrink-0 animate-pulse shadow-sm"></span>
                                        }
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2 mb-2">
                                        @notification.Message
                                    </p>
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs text-gray-500 dark:text-gray-500 font-medium flex items-center">
                                            <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            @FormatTimeAgo(notification.CreatedAt)
                                        </span>
                                        @if (!string.IsNullOrEmpty(notification.ActionText))
                                        {
                                            <span class="text-xs text-primary font-semibold flex items-center group-hover:text-primary dark:group-hover:text-primary">
                                                @notification.ActionText
                                                <svg class="w-3.5 h-3.5 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                </svg>
                                            </span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>

            <!-- Modern Footer -->
            <div class="px-5 py-4 border-t border-gray-200/50 dark:border-gray-700/50 bg-gradient-to-r from-gray-50 to-gray-100/50 dark:from-gray-800/50 dark:to-gray-700/50">
                <button @onclick="ViewAllNotifications"
                        class="w-full text-center text-sm text-primary hover:text-primary dark:hover:text-primary font-semibold transition-all duration-200 hover:bg-primary-50 dark:hover:bg-primary-900/30 py-2 rounded-lg flex items-center justify-center space-x-2 group">
                    <span>View all notifications</span>
                    <svg class="w-4 h-4 transition-transform duration-200 group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                    </svg>
                </button>
            </div>
        </div>
    }
</div>

<style>
    @@keyframes bell-ring {
        0%, 100% { transform: rotate(0deg); }
        10%, 30% { transform: rotate(-12deg); }
        20%, 40% { transform: rotate(12deg); }
    }

    .animate-bell-ring {
        animation: bell-ring 0.6s ease-in-out;
    }

    @@keyframes slide-in {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-slide-in {
        animation: slide-in 0.3s ease-out;
    }

    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(243, 244, 246, 0.5);
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: linear-gradient(to bottom, #a855f7, #6366f1);
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(to bottom, #9333ea, #4f46e5);
    }

    /* Dark mode scrollbar */
    .dark .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(55, 65, 81, 0.5);
    }
</style>

@code {
    private bool isDropdownOpen = false;
    private int unreadCount = 0;
    private bool hasNewNotifications = false;
    private bool isLoading = false;
    private List<NotificationDto> recentNotifications = new();
    private DotNetObjectReference<NotificationBell>? _dotNetRef;

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("NotificationBell: OnInitializedAsync called");

        // Subscribe to notification events
        Console.WriteLine("NotificationBell: Subscribing to notification events");
        NotificationService.OnNotificationReceived += HandleNewNotification;
        NotificationService.OnUnreadCountChanged += HandleUnreadCountChanged;
        NotificationService.OnNotificationsUpdated += HandleNotificationsUpdated;

        Console.WriteLine($"NotificationBell: SignalR IsConnected = {NotificationService.IsConnected}");

        // Load initial data
        Console.WriteLine("NotificationBell: Loading initial notifications");
        await LoadNotifications();
    }

    private async Task LoadNotifications()
    {
        Console.WriteLine("NotificationBell: LoadNotifications called");
        isLoading = true;
        StateHasChanged();

        try
        {
            var input = new GetNotificationsInput(Skip: 0, Take: 5);
            Console.WriteLine("NotificationBell: Calling GetNotificationsAsync");
            var response = await NotificationService.GetNotificationsAsync(input);

            Console.WriteLine($"NotificationBell: Response = {(response != null ? "not null" : "null")}");
            if (response != null)
            {
                Console.WriteLine($"NotificationBell: Received {response.Notifications.Count} notifications, TotalCount = {response.TotalCount}");
                recentNotifications = response.Notifications;

                Console.WriteLine("NotificationBell: Getting unread count");
                unreadCount = await NotificationService.GetUnreadCountAsync();
                Console.WriteLine($"NotificationBell: Unread count = {unreadCount}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"NotificationBell: Error loading notifications: {ex.Message}");
            Console.WriteLine($"NotificationBell: Stack trace: {ex.StackTrace}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
            Console.WriteLine("NotificationBell: LoadNotifications completed");
        }
    }

    private void HandleNewNotification(NotificationDto notification)
    {
        Console.WriteLine($"NotificationBell: HandleNewNotification called - {notification.Title}");
        hasNewNotifications = true;
        StateHasChanged();

        // Reset animation after 600ms
        Task.Delay(600).ContinueWith(_ =>
        {
            InvokeAsync(() =>
            {
                hasNewNotifications = false;
                StateHasChanged();
            });
        });
    }

    private void HandleUnreadCountChanged(int count)
    {
        Console.WriteLine($"NotificationBell: HandleUnreadCountChanged called - count = {count}");
        unreadCount = count;
        StateHasChanged();
    }

    private void HandleNotificationsUpdated()
    {
        Console.WriteLine("NotificationBell: HandleNotificationsUpdated called - triggering LoadNotifications");
        _ = LoadNotifications();
    }

    private async Task ToggleDropdown()
    {
        isDropdownOpen = !isDropdownOpen;
        if (isDropdownOpen)
        {
            _ = LoadNotifications();
            await RegisterOutsideClickAsync();
        }
        else
        {
            await UnregisterOutsideClickAsync();
        }
    }

    [JSInvokable("CloseModal")]
    public async Task CloseDropdownFromJS()
    {
        if (isDropdownOpen)
        {
            isDropdownOpen = false;
            await UnregisterOutsideClickAsync();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task RegisterOutsideClickAsync()
    {
        try
        {
            _dotNetRef ??= DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("registerOutsideClickHandler", "notification-bell-button", "notification-dropdown", _dotNetRef);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"NotificationBell: Error registering outside click handler: {ex.Message}");
        }
    }

    private async Task UnregisterOutsideClickAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("unregisterOutsideClickHandler", "notification-dropdown");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"NotificationBell: Error unregistering outside click handler: {ex.Message}");
        }
    }

    private async Task HandleNotificationClick(NotificationDto notification)
    {
        if (!notification.IsRead)
        {
            await NotificationService.MarkAsReadAsync(notification.Id);
        }

        // Close dropdown after clicking notification
        isDropdownOpen = false;
        await UnregisterOutsideClickAsync();

        if (!string.IsNullOrEmpty(notification.ActionUrl))
        {
            Navigation.NavigateTo(notification.ActionUrl);
        }
    }

    private async Task MarkAllAsRead()
    {
        await NotificationService.MarkAllAsReadAsync();
        await LoadNotifications();

        // Close dropdown after marking all as read
        isDropdownOpen = false;
        await UnregisterOutsideClickAsync();
    }

    private async Task ViewAllNotifications()
    {
        // Close dropdown before navigating
        isDropdownOpen = false;
        await UnregisterOutsideClickAsync();

        // Navigate to role-specific notification page
        var notificationUrl = await GetRoleBasedNotificationUrl();
        Navigation.NavigateTo(notificationUrl);
    }

    private async Task<string> GetRoleBasedNotificationUrl()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user?.Identity?.IsAuthenticated == true)
            {
                var role = user.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value;
                return role switch
                {
                    "Patient" => "/patient/notifications",
                    "Doctor" => "/doctor/notifications",
                    "Admin" => "/admin/notifications",
                    _ => "/notifications"
                };
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"NotificationBell: Error getting role-based URL: {ex.Message}");
        }

        return "/notifications";
    }

    private RenderFragment GetNotificationIcon(NotificationDto notification)
    {
        var (iconPath, gradientFrom, gradientTo) = notification.Type switch
        {
            NotificationType.Success => ("M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z", "from-green-400", "to-emerald-600"),
            NotificationType.Error => ("M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z", "from-red-400", "to-rose-600"),
            NotificationType.Warning => ("M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z", "from-yellow-400", "to-orange-500"),
            NotificationType.System => ("M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z", "from-gray-400", "to-slate-600"),
            _ => ("M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z", "from-blue-400", "to-indigo-600")
        };

        return @<div class="@($"w-10 h-10 rounded-xl bg-gradient-to-br {gradientFrom} {gradientTo} flex items-center justify-center shadow-md")">
                   <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                       <path stroke-linecap="round" stroke-linejoin="round" d="@iconPath"></path>
                   </svg>
               </div>;
    }

    private string FormatTimeAgo(DateTime createdAt)
    {
        var timeSpan = DateTime.UtcNow - createdAt.ToUniversalTime();

        if (timeSpan.TotalMinutes < 1)
            return "Just now";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes}m ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours}h ago";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays}d ago";

        return createdAt.ToString("MMM dd");
    }

    public void Dispose()
    {
        NotificationService.OnNotificationReceived -= HandleNewNotification;
        NotificationService.OnUnreadCountChanged -= HandleUnreadCountChanged;
        NotificationService.OnNotificationsUpdated -= HandleNotificationsUpdated;

        // Cleanup JavaScript interop
        _dotNetRef?.Dispose();
    }
}

@page "/emergency"
@using Microsoft.AspNetCore.Components.Authorization
@using MediChatAI_BlazorWebAssembly.Features.Emergency.Components
@using MediChatAI_BlazorWebAssembly.Core.Components.UI
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject AppSettingsState AppSettings
@inject ThemeState ThemeState
@inject IJSRuntime JSRuntime
@inject IHospitalService HospitalService
@implements IDisposable

<PageTitle>Emergency - @AppSettings.Settings.SiteName</PageTitle>

<style>
    @@keyframes gradient-x {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
    }

    @@keyframes heartbeat {
        0%, 100% { transform: scale(1); }
        10%, 30% { transform: scale(0.9); }
        20%, 40% { transform: scale(1.1); }
    }

    @@keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-20px); }
    }

    @@keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
    }

    @@keyframes glow-pulse {
        0%, 100% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.5), 0 0 40px rgba(239, 68, 68, 0.3); }
        50% { box-shadow: 0 0 30px rgba(239, 68, 68, 0.8), 0 0 60px rgba(239, 68, 68, 0.5); }
    }

    @@keyframes slide-in {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @@keyframes rotate-gradient {
        0% { filter: hue-rotate(0deg); }
        100% { filter: hue-rotate(360deg); }
    }

    @@keyframes pulse-ring {
        0% { transform: scale(0.33); opacity: 1; }
        80%, 100% { transform: scale(2.33); opacity: 0; }
    }

    @@keyframes emergency-glow {
        0%, 100% { 
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.4), 
                        0 0 60px rgba(99, 102, 241, 0.2),
                        inset 0 0 30px rgba(255, 255, 255, 0.1);
        }
        50% { 
            box-shadow: 0 0 50px rgba(99, 102, 241, 0.6), 
                        0 0 100px rgba(99, 102, 241, 0.3),
                        inset 0 0 50px rgba(255, 255, 255, 0.2);
        }
    }

    @@keyframes text-glow {
        0%, 100% { text-shadow: 0 0 20px rgba(99, 102, 241, 0.3); }
        50% { text-shadow: 0 0 30px rgba(99, 102, 241, 0.5); }
    }

    @@keyframes morphing-bg {
        0%, 100% { border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; transform: rotate(0deg); }
        25% { border-radius: 30% 60% 70% 40% / 50% 60% 30% 60%; transform: rotate(90deg); }
        50% { border-radius: 50% 40% 20% 60% / 25% 75% 60% 40%; transform: rotate(180deg); }
        75% { border-radius: 40% 60% 60% 40% / 70% 30% 40% 70%; transform: rotate(270deg); }
    }

    @@keyframes particle-float {
        0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
        33% { transform: translateY(-30px) rotate(120deg); opacity: 1; }
        66% { transform: translateY(-15px) rotate(240deg); opacity: 0.8; }
    }

    @@keyframes emergency-scan {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100vw); }
    }

    .animate-gradient-x {
        background-size: 200% 200%;
        animation: gradient-x 15s ease infinite;
    }

    .animate-heartbeat {
        animation: heartbeat 2s ease-in-out infinite;
    }

    .animate-float {
        animation: float 3s ease-in-out infinite;
    }

    .animate-shimmer {
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        background-size: 1000px 100%;
        animation: shimmer 2s infinite;
    }

    .glow-pulse {
        animation: glow-pulse 2s ease-in-out infinite;
    }

    .slide-in {
        animation: slide-in 0.5s ease-out forwards;
    }

    .pulse-ring {
        animation: pulse-ring 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
    }

    .emergency-glow {
        animation: emergency-glow 3s ease-in-out infinite;
    }

    .text-glow {
        animation: text-glow 2s ease-in-out infinite;
    }

    .morphing-bg {
        animation: morphing-bg 8s ease-in-out infinite;
    }

    .particle-float {
        animation: particle-float 4s ease-in-out infinite;
    }

    .emergency-scan {
        animation: emergency-scan 3s linear infinite;
    }

    .glass-effect {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .dark .glass-effect {
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .hero-glass {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(30px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    .dark .hero-glass {
        background: rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(30px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .emergency-particle {
        position: absolute;
        width: 6px;
        height: 6px;
        background: rgba(99, 102, 241, 0.4);
        border-radius: 50%;
        pointer-events: none;
        box-shadow: 0 0 8px rgba(99, 102, 241, 0.3);
    }

    .emergency-scan-line {
        position: absolute;
        top: 0;
        left: -100%;
        width: 1px;
        height: 100%;
        background: linear-gradient(to bottom, transparent, rgba(99, 102, 241, 0.8), transparent);
        box-shadow: 0 0 8px rgba(99, 102, 241, 0.4);
    }

    .hospital-card {
        perspective: 1000px;
        transform-style: preserve-3d;
        transition: all 0.6s cubic-bezier(0.23, 1, 0.320, 1);
    }

    .hospital-card:hover {
        transform: translateY(-10px) rotateX(5deg);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    .gradient-text {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 25%, #6366f1 50%, #4f46e5 75%, #6366f1 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        background-size: 300% 300%;
        animation: gradient-x 4s ease infinite;
    }

    .dark .gradient-text {
        background: linear-gradient(135deg, #818cf8 0%, #c084fc 25%, #818cf8 50%, #a5b4fc 75%, #818cf8 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        background-size: 300% 300%;
    }

    .hero-subtitle {
        background: linear-gradient(90deg, #6b7280, #374151, #6b7280);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        background-size: 200% 200%;
        animation: gradient-x 6s ease infinite;
    }

    .dark .hero-subtitle {
        background: linear-gradient(90deg, #d1d5db, #9ca3af, #d1d5db);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        background-size: 200% 200%;
    }

    .emergency-btn {
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .emergency-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.5);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }

    .emergency-btn:active::before {
        width: 300px;
        height: 300px;
    }

    .badge-float {
        animation: float 2s ease-in-out infinite;
    }

    @@keyframes skeleton-loading {
        0% { background-position: -200px 0; }
        100% { background-position: calc(200px + 100%) 0; }
    }

    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200px 100%;
        animation: skeleton-loading 1.5s ease-in-out infinite;
    }

    .dark .skeleton {
        background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
        background-size: 200px 100%;
    }
</style>

<div class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-indigo-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 transition-colors duration-300 relative overflow-hidden">

    <!-- Subtle Background Elements -->
    <div class="absolute inset-0 overflow-hidden pointer-events-none">
        <div class="emergency-particle top-1/4 left-1/5 particle-float" style="animation-delay: 0s;"></div>
        <div class="emergency-particle top-1/3 right-1/4 particle-float" style="animation-delay: 2s;"></div>
        <div class="emergency-particle bottom-1/3 left-1/3 particle-float" style="animation-delay: 4s;"></div>
    </div>

    <!-- Amazing Full-Width Hero Section -->
    <div class="w-full min-h-screen flex items-center justify-center relative z-10 py-20">
        <div class="w-full">
            <!-- Animated Background Grid -->
            <div class="absolute inset-0 opacity-20">
                <div class="grid grid-cols-12 gap-4 h-full">
                    @for (int i = 0; i < 48; i++)
                    {
                        <div class="bg-primary/10 rounded animate-pulse" style="animation-delay: @(i * 0.1)s;"></div>
                    }
                </div>
            </div>
            
            <!-- Main Hero Content -->
            <div class="relative z-10 text-center px-6">
                <!-- Animated Status Badge -->
                <div class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-primary/20 to-accent/20 border-2 border-primary/40 rounded-full text-primary dark:text-primary-300 font-black text-base mb-12 shadow-2xl animate-bounce">
                    <div class="w-4 h-4 bg-primary rounded-full mr-4 animate-ping"></div>
                    üö® LIVE EMERGENCY SERVICES ACTIVE
                </div>
                
                <!-- Massive Animated Title -->
                <h1 class="text-6xl md:text-8xl lg:text-9xl xl:text-[12rem] font-black mb-8 gradient-text leading-none animate-pulse">
                    EMERGENCY
                </h1>
                
                <!-- Enhanced Subtitle -->
                <div class="max-w-6xl mx-auto mb-16">
                    <p class="text-2xl md:text-3xl lg:text-4xl text-gray-700 dark:text-gray-300 font-bold mb-6">
                        Critical Healthcare Access Platform
                    </p>
                    <p class="text-lg md:text-xl text-gray-600 dark:text-gray-400 font-medium leading-relaxed">
                        Instant emergency response ‚Ä¢ Real-time hospital locations ‚Ä¢ 24/7 medical assistance ‚Ä¢ AI-powered triage
                    </p>
                </div>
                
                <!-- Enhanced Stats Grid -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 max-w-4xl mx-auto mb-16">
                    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-2xl p-6 border border-primary/20 hover:border-primary/40 transition-all duration-300 hover:scale-105 shadow-lg">
                        <div class="text-3xl md:text-4xl font-black text-primary mb-2 animate-pulse">24/7</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 font-semibold">Always Available</div>
                    </div>
                    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-2xl p-6 border border-accent/20 hover:border-accent/40 transition-all duration-300 hover:scale-105 shadow-lg">
                        <div class="text-3xl md:text-4xl font-black text-accent mb-2 animate-pulse">&lt;60s</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 font-semibold">Response Time</div>
                    </div>
                    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-2xl p-6 border border-primary/20 hover:border-primary/40 transition-all duration-300 hover:scale-105 shadow-lg">
                        <div class="text-3xl md:text-4xl font-black text-primary mb-2 animate-pulse">‚àû</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 font-semibold">Hospital Network</div>
                    </div>
                    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-2xl p-6 border border-accent/20 hover:border-accent/40 transition-all duration-300 hover:scale-105 shadow-lg">
                        <div class="text-3xl md:text-4xl font-black text-accent mb-2 animate-pulse">AI</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 font-semibold">Powered Triage</div>
                    </div>
                </div>
                
                <!-- Enhanced Action Cards -->
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-6xl mx-auto mb-16">
                    <!-- Emergency Call Card -->
                    <div class="group bg-gradient-to-br from-primary/10 to-accent/10 backdrop-blur-xl rounded-3xl p-8 border-2 border-primary/30 hover:border-primary/60 hover:shadow-2xl transition-all duration-500 hover:-translate-y-4 hover:rotate-1">
                        <div class="w-16 h-16 bg-gradient-to-br from-primary to-accent rounded-2xl flex items-center justify-center mb-6 mx-auto shadow-xl group-hover:scale-110 transition-transform duration-300">
                            <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-black text-gray-900 dark:text-white mb-2">Emergency Call</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">Instant 911 connection</p>
                        <button @onclick="Call911" class="w-full bg-gradient-to-r from-primary to-accent hover:from-primary-700 hover:to-accent-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 hover:scale-105 shadow-lg">
                            Call Now
                        </button>
                    </div>
                    
                    <!-- Find Hospitals Card -->
                    <div class="group bg-gradient-to-br from-accent/10 to-primary/10 backdrop-blur-xl rounded-3xl p-8 border-2 border-accent/30 hover:border-accent/60 hover:shadow-2xl transition-all duration-500 hover:-translate-y-4 hover:-rotate-1">
                        <div class="w-16 h-16 bg-gradient-to-br from-accent to-primary rounded-2xl flex items-center justify-center mb-6 mx-auto shadow-xl group-hover:scale-110 transition-transform duration-300">
                            <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-black text-gray-900 dark:text-white mb-2">Find Hospitals</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">Nearby medical facilities</p>
                        <button @onclick="FindNearestHospital" class="w-full bg-white dark:bg-gray-700 border-2 border-accent text-accent dark:text-accent-400 font-bold py-3 px-4 rounded-xl transition-all duration-300 hover:bg-accent hover:text-white hover:scale-105 shadow-lg">
                            Search
                        </button>
                    </div>
                    
                    <!-- AI Assistant Card -->
                    <div class="group bg-gradient-to-br from-primary/10 to-accent/10 backdrop-blur-xl rounded-3xl p-8 border-2 border-primary/30 hover:border-primary/60 hover:shadow-2xl transition-all duration-500 hover:-translate-y-4 hover:rotate-1">
                        <div class="w-16 h-16 bg-gradient-to-br from-primary to-accent rounded-2xl flex items-center justify-center mb-6 mx-auto shadow-xl group-hover:scale-110 transition-transform duration-300">
                            <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-black text-gray-900 dark:text-white mb-2">AI Assistant</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">Smart medical guidance</p>
                        <button class="w-full bg-gradient-to-r from-accent to-primary hover:from-accent-700 hover:to-primary-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 hover:scale-105 shadow-lg">
                            Chat Now
                        </button>
                    </div>
                    
                    <!-- Emergency Info Card -->
                    <div class="group bg-gradient-to-br from-accent/10 to-primary/10 backdrop-blur-xl rounded-3xl p-8 border-2 border-accent/30 hover:border-accent/60 hover:shadow-2xl transition-all duration-500 hover:-translate-y-4 hover:-rotate-1">
                        <div class="w-16 h-16 bg-gradient-to-br from-accent to-primary rounded-2xl flex items-center justify-center mb-6 mx-auto shadow-xl group-hover:scale-110 transition-transform duration-300">
                            <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-black text-gray-900 dark:text-white mb-2">Emergency Info</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">First aid & protocols</p>
                        <button class="w-full bg-white dark:bg-gray-700 border-2 border-primary text-primary dark:text-primary-400 font-bold py-3 px-4 rounded-xl transition-all duration-300 hover:bg-primary hover:text-white hover:scale-105 shadow-lg">
                            Learn More
                        </button>
                    </div>
                </div>
                
                <!-- Emergency Features Banner -->
                <div class="bg-gradient-to-r from-primary/20 via-accent/20 to-primary/20 backdrop-blur-xl rounded-3xl p-8 border border-primary/30 max-w-4xl mx-auto">
                    <div class="grid md:grid-cols-3 gap-6 text-center">
                        <div>
                            <div class="text-2xl mb-2">üöë</div>
                            <h4 class="font-bold text-gray-900 dark:text-white mb-1">Ambulance Dispatch</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Real-time tracking</p>
                        </div>
                        <div>
                            <div class="text-2xl mb-2">üè•</div>
                            <h4 class="font-bold text-gray-900 dark:text-white mb-1">Hospital Network</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Verified facilities</p>
                        </div>
                        <div>
                            <div class="text-2xl mb-2">ü§ñ</div>
                            <h4 class="font-bold text-gray-900 dark:text-white mb-1">AI Triage</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Instant assessment</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="w-full space-y-8 px-6">

        <!-- CRITICAL EMERGENCY ACTIONS -->
        <div class="bg-gradient-to-br from-primary via-primary-600 to-accent dark:from-primary-800 dark:via-primary-700 dark:to-accent-800 rounded-3xl shadow-2xl p-8 lg:p-12 text-white relative overflow-hidden">
            <!-- Background Pattern -->
            <div class="absolute inset-0 opacity-10">
                <div class="absolute top-0 right-0 w-64 h-64 bg-white rounded-full -translate-y-32 translate-x-32"></div>
                <div class="absolute bottom-0 left-0 w-48 h-48 bg-white rounded-full translate-y-24 -translate-x-24"></div>
            </div>
            
            <div class="relative z-10">
                <div class="flex items-center mb-10">
                    <div class="p-4 bg-white/20 backdrop-blur-sm rounded-2xl mr-6">
                        <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 00-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-4xl lg:text-5xl font-black mb-2">Immediate Assistance</h2>
                        <p class="text-white/80 text-lg">Critical emergency services available 24/7</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 lg:gap-8">
                    <!-- Call 911 -->
                    <button @onclick="Call911" class="emergency-btn group bg-white/15 hover:bg-white/25 backdrop-blur-xl border border-white/30 rounded-3xl p-8 transition-all duration-300 hover:scale-105 hover:shadow-2xl">
                        <div class="flex flex-col items-center text-center">
                            <div class="w-20 h-20 bg-white rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform shadow-lg">
                                <svg class="w-10 h-10 text-primary" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-black mb-2">CALL 911</h3>
                            <p class="text-white/90 font-medium">Medical Emergency</p>
                        </div>
                    </button>

                    <!-- Ambulance -->
                    <button @onclick="CallAmbulance" class="emergency-btn group bg-white/15 hover:bg-white/25 backdrop-blur-xl border border-white/30 rounded-3xl p-8 transition-all duration-300 hover:scale-105 hover:shadow-2xl">
                        <div class="flex flex-col items-center text-center">
                            <div class="w-20 h-20 bg-white rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform shadow-lg">
                                <svg class="w-10 h-10 text-primary" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-black mb-2">AMBULANCE</h3>
                            <p class="text-white/90 font-medium">Immediate Transport</p>
                        </div>
                    </button>

                    <!-- Poison Control -->
                    <button @onclick="CallPoisonControl" class="emergency-btn group bg-white/15 hover:bg-white/25 backdrop-blur-xl border border-white/30 rounded-3xl p-8 transition-all duration-300 hover:scale-105 hover:shadow-2xl">
                        <div class="flex flex-col items-center text-center">
                            <div class="w-20 h-20 bg-white rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform shadow-lg">
                                <svg class="w-10 h-10 text-primary" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M19.5 3.5L18 2l-1.5 1.5L15 2l-1.5 1.5L12 2l-1.5 1.5L9 2 7.5 3.5 6 2v14H3v3c0 1.66 1.34 3 3 3h12c1.66 0 3-1.34 3-3V2l-1.5 1.5zM19 19c0 .55-.45 1-1 1s-1-.45-1-1v-3H8V5h11v14z"/>
                                    <path d="M9 7h6v2H9zm7 0h2v2h-2zm-7 3h6v2H9zm7 0h2v2h-2z"/>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-black mb-2">POISON CONTROL</h3>
                            <p class="text-white/90 font-medium">1-800-222-1222</p>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Find Nearest Hospital -->
        <div class="glass-effect bg-card dark:bg-gray-800 rounded-3xl shadow-xl p-8 lg:p-10 border border-gray-200 dark:border-gray-700">
            <div class="flex items-center mb-8">
                <div class="p-4 bg-primary rounded-xl mr-5">
                    <svg class="w-10 h-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </div>
                <div class="flex-1">
                    <h2 class="text-2xl lg:text-3xl font-bold text-gray-900 dark:text-white">Find Nearest Hospital</h2>
                    <p class="text-gray-600 dark:text-gray-400 text-lg">Get directions to the closest emergency facility</p>
                </div>
            </div>

            <!-- Search Controls -->
            <div class="flex flex-col lg:flex-row gap-4 lg:gap-6 mb-8">
                <button @onclick="FindNearestHospital"
                        disabled="@isSearching"
                        class="flex-1 bg-gradient-to-r from-primary to-accent hover:from-accent hover:to-primary text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 hover:shadow-xl flex items-center justify-center space-x-3 disabled:opacity-50 disabled:cursor-not-allowed">
                    @if (isSearching)
                    {
                        <svg class="animate-spin h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-lg">Searching...</span>
                    }
                    else
                    {
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <span class="text-lg">Search Nearby Hospitals</span>
                    }
                </button>

                @if (hospitals.Any())
                {
                    <select @bind="selectedRadius" @bind:after="RefreshSearch"
                            class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="1000">1 km radius</option>
                        <option value="5000">5 km radius</option>
                        <option value="10000">10 km radius</option>
                        <option value="25000">25 km radius</option>
                    </select>

                    <select @bind="sortBy" @bind:after="ApplySorting"
                            class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="distance">Sort by Distance</option>
                        <option value="rating">Sort by Rating</option>
                        <option value="reviews">Sort by Reviews</option>
                    </select>
                }
                

            </div>

            <!-- Error Message -->
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 p-4 mb-6 rounded-lg">
                    <div class="flex items-center">
                        <svg class="w-6 h-6 text-red-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-red-700 dark:text-red-300">@errorMessage</p>
                    </div>
                </div>
            }

            <!-- Hospital Results -->
            @if (hospitals.Any())
            {
                <div id="hospital-results" class="space-y-4">
                    <!-- Filter Options -->
                    <div class="flex items-center space-x-4 pb-4 border-b border-gray-200 dark:border-gray-700">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" @bind="filterOpenOnly" @bind:after="ApplyFilters"
                                   class="w-5 h-5 text-primary rounded focus:ring-2 focus:ring-primary">
                            <span class="text-gray-700 dark:text-gray-300">Open now only</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" @bind="filterHighRated" @bind:after="ApplyFilters"
                                   class="w-5 h-5 text-primary rounded focus:ring-2 focus:ring-primary">
                            <span class="text-gray-700 dark:text-gray-300">4+ stars only</span>
                        </label>
                        <div class="flex-1 text-right">
                            <span class="text-sm text-gray-600 dark:text-gray-400">
                                Showing @filteredHospitals.Count of @hospitals.Count hospitals
                            </span>
                        </div>
                    </div>

                    <!-- Hospital Cards Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 lg:gap-8">
                        @foreach (var hospital in filteredHospitals)
                        {
                            <div class="hospital-card group bg-white dark:bg-gray-700 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden border border-gray-200 dark:border-gray-600 slide-in">
                                <!-- Hospital Image -->
                                <div class="relative h-48 bg-gradient-to-br from-blue-400 to-blue-600 overflow-hidden">
                                    @if (!string.IsNullOrEmpty(hospital.Photo))
                                    {
                                        <img src="@hospital.Photo" alt="@hospital.Name"
                                             class="w-full h-full object-cover"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                    }
                                    <div class="absolute inset-0 flex items-center justify-center @(!string.IsNullOrEmpty(hospital.Photo) ? "hidden" : "")">
                                        <svg class="w-20 h-20 text-white opacity-50" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 11h-4v4h-4v-4H6v-4h4V6h4v4h4v4z"/>
                                        </svg>
                                    </div>

                                    <!-- Status Badges -->
                                    <div class="absolute top-3 right-3 flex flex-col gap-2">
                                        @if (hospital.IsOpen)
                                        {
                                            <span class="badge-float bg-green-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg">
                                                OPEN
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge-float bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg">
                                                CLOSED
                                            </span>
                                        }
                                        @if (hospital.OpenHours?.Contains("24") == true)
                                        {
                                            <span class="badge-float bg-blue-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg">
                                                24/7
                                            </span>
                                        }
                                    </div>

                                    @if (hospital.DistanceInKm.HasValue)
                                    {
                                        <div class="absolute bottom-3 left-3 flex flex-col gap-2">
                                            <span class="bg-white/90 dark:bg-gray-800/90 text-gray-900 dark:text-white font-bold px-3 py-2 rounded-lg shadow-lg backdrop-blur-sm flex items-center space-x-1">
                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                                </svg>
                                                <span>@hospital.DistanceInKm.Value.ToString("F1") km</span>
                                            </span>
                                            <span class="bg-blue-500/90 text-white font-bold px-3 py-2 rounded-lg shadow-lg backdrop-blur-sm flex items-center space-x-1">
                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                                <span>~@CalculateETA(hospital.DistanceInKm.Value)</span>
                                            </span>
                                        </div>
                                    }
                                </div>

                                <!-- Hospital Details -->
                                <div class="p-6">
                                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2 line-clamp-2">
                                        @hospital.Name
                                    </h3>

                                    @if (hospital.Rating.HasValue)
                                    {
                                        <div class="flex items-center mb-3">
                                            <div class="flex items-center">
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    @if (i <= Math.Floor(hospital.Rating.Value))
                                                    {
                                                        <svg class="w-5 h-5 text-yellow-400 fill-current" viewBox="0 0 20 20">
                                                            <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                        </svg>
                                                    }
                                                    else if (i - 0.5 <= hospital.Rating.Value)
                                                    {
                                                        <svg class="w-5 h-5 text-yellow-400" viewBox="0 0 20 20">
                                                            <defs>
                                                                <linearGradient id="half-@i">
                                                                    <stop offset="50%" stop-color="currentColor" class="fill-current"/>
                                                                    <stop offset="50%" stop-color="transparent"/>
                                                                </linearGradient>
                                                            </defs>
                                                            <path fill="url(#half-@i)" d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                        </svg>
                                                    }
                                                    else
                                                    {
                                                        <svg class="w-5 h-5 text-gray-300 dark:text-gray-600 fill-current" viewBox="0 0 20 20">
                                                            <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                        </svg>
                                                    }
                                                }
                                            </div>
                                            <span class="ml-2 text-gray-600 dark:text-gray-400 text-sm">
                                                @hospital.Rating.Value.ToString("F1")
                                                @if (hospital.Reviews.HasValue)
                                                {
                                                    <span>(@hospital.Reviews.Value)</span>
                                                }
                                            </span>
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(hospital.FullAddress))
                                    {
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4 line-clamp-2 flex items-start">
                                            <svg class="w-4 h-4 mr-1 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                            </svg>
                                            @hospital.FullAddress
                                        </p>
                                    }

                                    <!-- Action Buttons -->
                                    <div class="grid grid-cols-2 gap-3">
                                        @if (!string.IsNullOrEmpty(hospital.PhoneNumber))
                                        {
                                            <button @onclick="() => CallHospital(hospital.PhoneNumber)"
                                                    class="emergency-btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 flex items-center justify-center space-x-2 shadow-md hover:shadow-lg">
                                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
                                                </svg>
                                                <span>Call</span>
                                            </button>
                                        }

                                        @if (hospital.Latitude.HasValue && hospital.Longitude.HasValue)
                                        {
                                            <button @onclick="() => GetDirections(hospital.Latitude.Value, hospital.Longitude.Value, hospital.Name)"
                                                    class="emergency-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 flex items-center justify-center space-x-2 shadow-md hover:shadow-lg">
                                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                                                </svg>
                                                <span>Directions</span>
                                            </button>
                                        }

                                        @if (hospital.Latitude.HasValue && hospital.Longitude.HasValue)
                                        {
                                            <button @onclick="() => StartLiveNavigation(hospital.Latitude.Value, hospital.Longitude.Value, hospital.Name, hospital.FullAddress ?? string.Empty)"
                                                    class="emergency-btn col-span-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 flex items-center justify-center space-x-2 shadow-md hover:shadow-lg">
                                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                                </svg>
                                                <span>Start Live Navigation</span>
                                            </button>
                                        }

                                        @if (!string.IsNullOrEmpty(hospital.Website))
                                        {
                                            <button @onclick="() => OpenWebsite(hospital.Website)"
                                                    class="emergency-btn col-span-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 flex items-center justify-center space-x-2 shadow-md hover:shadow-lg">
                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                                                </svg>
                                                <span>Website</span>
                                            </button>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            else if (!isSearching && !string.IsNullOrEmpty(errorMessage) == false)
            {
                <!-- Empty State -->
                <div class="text-center py-12">
                    <svg class="w-24 h-24 mx-auto text-gray-400 dark:text-gray-600 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    </svg>
                    <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">No Hospitals Found Yet</h3>
                    <p class="text-gray-500 dark:text-gray-400">Click the search button to find nearby hospitals and emergency facilities</p>
                </div>
            }
        </div>

        <!-- Emergency First Aid Tips -->
        <div class="glass-effect bg-card dark:bg-gray-800 rounded-3xl shadow-xl p-8 lg:p-10 border border-gray-200 dark:border-gray-700">
            <div class="flex items-center mb-8">
                <div class="p-4 bg-green-500 rounded-xl mr-5">
                    <svg class="w-10 h-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                </div>
                <div>
                    <h2 class="text-2xl lg:text-3xl font-bold text-gray-900 dark:text-white">Emergency First Aid</h2>
                    <p class="text-gray-600 dark:text-gray-400 text-lg">Quick reference guide for common emergencies</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 lg:gap-8">
                @foreach (var tip in firstAidTips)
                {
                    <div class="group bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors cursor-pointer border border-gray-200 dark:border-gray-600">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-primary rounded-lg flex items-center justify-center text-2xl">
                                    @tip.Icon
                                </div>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold text-gray-900 dark:text-white mb-2">@tip.Title</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-300">@tip.Description</p>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Role-Based Sections -->
        <AuthorizeView>
            <Authorized>
                @{
                    var userRole = context.User?.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value;
                }

                @if (userRole == "Admin")
                {
                    <!-- Admin Emergency Features -->
                    <div class="bg-gradient-to-br from-purple-600 to-indigo-700 dark:from-purple-700 dark:to-indigo-800 rounded-3xl shadow-2xl p-8 text-white">
                        <div class="flex items-center mb-6">
                            <div class="p-3 bg-white/20 rounded-xl mr-4">
                                <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-3xl font-bold">Admin Emergency Control</h2>
                                <p class="opacity-90">System-wide emergency management</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button @onclick="SendEmergencyBroadcast" class="bg-white/20 hover:bg-white/30 backdrop-blur-lg border-2 border-white/40 rounded-xl p-6 transition-all duration-300 hover:scale-105 text-left">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-white/30 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg">Emergency Broadcast</h3>
                                        <p class="text-sm opacity-90">Alert all users</p>
                                    </div>
                                </div>
                            </button>

                            <button @onclick="ViewEmergencyCases" class="bg-white/20 hover:bg-white/30 backdrop-blur-lg border-2 border-white/40 rounded-xl p-6 transition-all duration-300 hover:scale-105 text-left">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-white/30 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg">Active Emergency Cases</h3>
                                        <p class="text-sm opacity-90">Monitor all cases</p>
                                    </div>
                                </div>
                            </button>

                            <button @onclick="EmergencyStaffDirectory" class="bg-white/20 hover:bg-white/30 backdrop-blur-lg border-2 border-white/40 rounded-xl p-6 transition-all duration-300 hover:scale-105 text-left">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-white/30 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg">Emergency Staff</h3>
                                        <p class="text-sm opacity-90">Contact directory</p>
                                    </div>
                                </div>
                            </button>

                            <button @onclick="SystemHealthMonitor" class="bg-white/20 hover:bg-white/30 backdrop-blur-lg border-2 border-white/40 rounded-xl p-6 transition-all duration-300 hover:scale-105 text-left">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-white/30 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg">System Health</h3>
                                        <p class="text-sm opacity-90">Monitor platform</p>
                                    </div>
                                </div>
                            </button>
                        </div>
                    </div>
                }
                else if (userRole == "Doctor")
                {
                    <!-- Doctor Emergency Features -->
                    <div class="bg-gradient-to-br from-emerald-600 to-teal-700 dark:from-emerald-700 dark:to-teal-800 rounded-3xl shadow-2xl p-8 text-white">
                        <div class="flex items-center mb-6">
                            <div class="p-3 bg-white/20 rounded-xl mr-4">
                                <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-3xl font-bold">Doctor Emergency Tools</h2>
                                <p class="opacity-90">Quick access to patient emergency features</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button @onclick="ViewEmergencyPatients" class="bg-white/20 hover:bg-white/30 backdrop-blur-lg border-2 border-white/40 rounded-xl p-6 transition-all duration-300 hover:scale-105 text-left">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-white/30 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg">Emergency Patients</h3>
                                        <p class="text-sm opacity-90">Active emergency cases</p>
                                    </div>
                                </div>
                            </button>

                            <button @onclick="QuickPatientLookup" class="bg-white/20 hover:bg-white/30 backdrop-blur-lg border-2 border-white/40 rounded-xl p-6 transition-all duration-300 hover:scale-105 text-left">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-white/30 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg">Quick Patient Lookup</h3>
                                        <p class="text-sm opacity-90">Find medical history</p>
                                    </div>
                                </div>
                            </button>

                            <button @onclick="OnCallSchedule" class="bg-white/20 hover:bg-white/30 backdrop-blur-lg border-2 border-white/40 rounded-xl p-6 transition-all duration-300 hover:scale-105 text-left">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-white/30 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg">On-Call Schedule</h3>
                                        <p class="text-sm opacity-90">View doctor availability</p>
                                    </div>
                                </div>
                            </button>

                            <button @onclick="MedicalProtocols" class="bg-white/20 hover:bg-white/30 backdrop-blur-lg border-2 border-white/40 rounded-xl p-6 transition-all duration-300 hover:scale-105 text-left">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-white/30 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg">Emergency Protocols</h3>
                                        <p class="text-sm opacity-90">Medical guidelines</p>
                                    </div>
                                </div>
                            </button>
                        </div>
                    </div>
                }
                else if (userRole == "Patient")
                {
                    <!-- Patient Emergency Features -->
                    <div class="bg-gradient-to-br from-blue-600 to-cyan-700 dark:from-blue-700 dark:to-cyan-800 rounded-3xl shadow-2xl p-8 text-white">
                        <div class="flex items-center mb-6">
                            <div class="p-3 bg-white/20 rounded-xl mr-4">
                                <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-3xl font-bold">My Emergency Information</h2>
                                <p class="opacity-90">Quick access to your health information</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button @onclick="ViewMedicalHistory" class="bg-white/20 hover:bg-white/30 backdrop-blur-lg border-2 border-white/40 rounded-xl p-6 transition-all duration-300 hover:scale-105 text-left">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-white/30 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg">Medical History</h3>
                                        <p class="text-sm opacity-90">View health records</p>
                                    </div>
                                </div>
                            </button>

                            <button @onclick="ViewMedications" class="bg-white/20 hover:bg-white/30 backdrop-blur-lg border-2 border-white/40 rounded-xl p-6 transition-all duration-300 hover:scale-105 text-left">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-white/30 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg">Current Medications</h3>
                                        <p class="text-sm opacity-90">Active prescriptions</p>
                                    </div>
                                </div>
                            </button>

                            <button @onclick="ViewAllergies" class="bg-white/20 hover:bg-white/30 backdrop-blur-lg border-2 border-white/40 rounded-xl p-6 transition-all duration-300 hover:scale-105 text-left">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-white/30 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.99-.833-2.76 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg">Allergies & Conditions</h3>
                                        <p class="text-sm opacity-90">Important alerts</p>
                                    </div>
                                </div>
                            </button>

                            <button @onclick="ContactMyDoctor" class="bg-white/20 hover:bg-white/30 backdrop-blur-lg border-2 border-white/40 rounded-xl p-6 transition-all duration-300 hover:scale-105 text-left">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-white/30 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg">Contact My Doctor</h3>
                                        <p class="text-sm opacity-90">Direct communication</p>
                                    </div>
                                </div>
                            </button>

                            <button @onclick="EmergencyContacts" class="bg-white/20 hover:bg-white/30 backdrop-blur-lg border-2 border-white/40 rounded-xl p-6 transition-all duration-300 hover:scale-105 text-left">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-white/30 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg">Emergency Contacts</h3>
                                        <p class="text-sm opacity-90">Manage contacts</p>
                                    </div>
                                </div>
                            </button>

                            <button @onclick="BookEmergencyAppointment" class="bg-white/20 hover:bg-white/30 backdrop-blur-lg border-2 border-white/40 rounded-xl p-6 transition-all duration-300 hover:scale-105 text-left">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-white/30 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg">Emergency Appointment</h3>
                                        <p class="text-sm opacity-90">Book urgent visit</p>
                                    </div>
                                </div>
                            </button>
                        </div>
                    </div>
                }
            </Authorized>
            <NotAuthorized>
                <!-- Login Prompt for Enhanced Features -->
                <div class="bg-gradient-to-r from-primary to-accent dark:from-indigo-800 dark:to-purple-900 rounded-3xl shadow-2xl p-8 text-white text-center">
                    <div class="max-w-2xl mx-auto">
                        <svg class="w-20 h-20 mx-auto mb-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                        </svg>
                        <h2 class="text-3xl font-bold mb-4">Get Personalized Emergency Access</h2>
                        <p class="text-xl mb-6 opacity-90">
                            Sign in to access personalized emergency features including your medical history,
                            current medications, emergency contacts, and direct communication with your healthcare providers.
                        </p>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center">
                            <a href="/login" class="bg-white text-primary font-bold py-3 px-8 rounded-xl hover:bg-gray-100 transition-colors shadow-lg inline-flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/>
                                </svg>
                                Sign In
                            </a>
                            <a href="/register" class="bg-white/20 hover:bg-white/30 border-2 border-white text-white font-bold py-3 px-8 rounded-xl transition-colors shadow-lg inline-flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                                </svg>
                                Create Account
                            </a>
                        </div>
                    </div>
                </div>
            </NotAuthorized>
        </AuthorizeView>

        <!-- Important Notice -->
        <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 p-6 rounded-xl">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="w-6 h-6 text-yellow-600 dark:text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.99-.833-2.76 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-lg font-bold text-yellow-800 dark:text-yellow-300 mb-2">Important Emergency Notice</h3>
                    <p class="text-yellow-700 dark:text-yellow-400">
                        <strong>If you are experiencing a life-threatening emergency, call 911 immediately.</strong>
                        This page provides helpful resources and information, but should not replace immediate emergency medical care.
                        For serious injuries, chest pain, difficulty breathing, severe bleeding, or other critical conditions,
                        always contact emergency services first.
                    </p>
                </div>
            </div>
        </div>

        <!-- Location Permission Banner -->
        @if (showLocationPrompt)
        {
            var bannerClass = locationPermissionStatus switch
            {
                LocationPermissionStatus.Asking => "bg-blue-50 dark:bg-blue-900/20 border-blue-500",
                LocationPermissionStatus.Denied => "bg-red-50 dark:bg-red-900/20 border-red-500",
                LocationPermissionStatus.Granted => "bg-green-50 dark:bg-green-900/20 border-green-500",
                _ => "bg-gray-50 dark:bg-gray-900/20 border-gray-500"
            };

            var textClass = locationPermissionStatus switch
            {
                LocationPermissionStatus.Asking => "text-blue-700 dark:text-blue-300",
                LocationPermissionStatus.Denied => "text-red-700 dark:text-red-300",
                LocationPermissionStatus.Granted => "text-green-700 dark:text-green-300",
                _ => "text-gray-700 dark:text-gray-300"
            };

            var icon = locationPermissionStatus switch
            {
                LocationPermissionStatus.Asking => "üìç",
                LocationPermissionStatus.Denied => "‚ö†Ô∏è",
                LocationPermissionStatus.Granted => "‚úÖ",
                _ => "‚ÑπÔ∏è"
            };

            <div class="@bannerClass border-l-4 rounded-xl p-6 mb-8 slide-in">
                <div class="flex items-start gap-4">
                    <span class="text-3xl">@icon</span>
                    <div class="flex-1">
                        @if (locationPermissionStatus == LocationPermissionStatus.Asking)
                        {
                            <h3 class="text-lg font-bold @textClass mb-2">Requesting Location Permission...</h3>
                            <p class="@textClass mb-4">We need your location to show nearby hospitals and provide accurate emergency assistance. Please allow location access when prompted by your browser.</p>
                        }
                        else if (locationPermissionStatus == LocationPermissionStatus.Denied)
                        {
                            <h3 class="text-lg font-bold @textClass mb-2">Location Access Denied</h3>
                            <p class="@textClass mb-4">@locationErrorMessage</p>
                            <div class="flex flex-wrap gap-3">
                                <button @onclick="RetryLocationPermission"
                                        class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-all duration-300 shadow-md hover:shadow-lg flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                    </svg>
                                    Allow Location
                                </button>
                                <button @onclick="DismissLocationPrompt"
                                        class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-bold py-2 px-6 rounded-lg transition-all duration-300">
                                    Skip for now
                                </button>
                            </div>
                        }
                        else if (locationPermissionStatus == LocationPermissionStatus.Granted)
                        {
                            <h3 class="text-lg font-bold @textClass mb-2">Location Access Granted</h3>
                            <p class="@textClass">Your location has been detected. You can now use all emergency features.</p>
                        }
                    </div>
                    <button @onclick="DismissLocationPrompt"
                            class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
        }
    </div>

    <!-- AI Chatbot Component -->
    <EmergencyAiChatbot AvailableHospitals="@filteredHospitals"
                        UserLatitude="@userLocation?.Latitude"
                        UserLongitude="@userLocation?.Longitude"
                        UserRole="@userRole"
                        OnRequestHospitalSearch="@HandleHospitalSearchRequest"
                        IsSearchingHospitals="@isSearching" />
</div>

<!-- Live Navigation Modal -->
<LiveNavigationModal IsOpen="@isNavigationModalOpen"
                     IsOpenChanged="@OnNavigationModalClosed"
                     DestinationName="@navigationDestinationName"
                     DestinationAddress="@navigationDestinationAddress"
                     DestinationLatitude="@navigationDestinationLat"
                     DestinationLongitude="@navigationDestinationLng" />

@code {
    private bool isAuthenticated = false;
    private string? userRole;

    // Hospital Search State
    private List<HospitalDto> hospitals = new();
    private List<HospitalDto> filteredHospitals = new();
    private bool isSearching = false;
    private string? errorMessage;
    private UserLocationDto? userLocation;

    // Filter and Sort Options
    private int selectedRadius = 5000;
    private string sortBy = "distance";
    private bool filterOpenOnly = false;
    private bool filterHighRated = false;

    // Live Navigation Modal State
    private bool isNavigationModalOpen = false;
    private string navigationDestinationName = string.Empty;
    private string navigationDestinationAddress = string.Empty;
    private double navigationDestinationLat = 0;
    private double navigationDestinationLng = 0;

    // Location Permission State
    private enum LocationPermissionStatus { NotAsked, Asking, Granted, Denied }
    private LocationPermissionStatus locationPermissionStatus = LocationPermissionStatus.NotAsked;
    private bool showLocationPrompt = false;
    private string? locationErrorMessage = null;

    private List<FirstAidTip> firstAidTips = new()
    {
        new FirstAidTip { Icon = "üíî", Title = "Heart Attack", Description = "Call 911, chew aspirin (if not allergic), keep person calm and seated" },
        new FirstAidTip { Icon = "ü´Å", Title = "Choking", Description = "Perform Heimlich maneuver, call 911 if unsuccessful" },
        new FirstAidTip { Icon = "ü©∏", Title = "Severe Bleeding", Description = "Apply direct pressure, elevate wound above heart, call 911" },
        new FirstAidTip { Icon = "üî•", Title = "Burns", Description = "Cool with water for 10+ minutes, cover with clean cloth, seek medical help" },
        new FirstAidTip { Icon = "üß†", Title = "Stroke", Description = "FAST: Face drooping, Arm weakness, Speech difficulty, Time to call 911" },
        new FirstAidTip { Icon = "üíä", Title = "Poisoning", Description = "Call Poison Control 1-800-222-1222, do NOT induce vomiting" }
    };

    protected override async Task OnInitializedAsync()
    {
        ThemeState.OnChange += OnThemeChanged;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        isAuthenticated = authState.User?.Identity?.IsAuthenticated == true;

        if (isAuthenticated)
        {
            userRole = authState.User?.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Request location permission immediately on page load
            await RequestLocationPermission();
        }
    }

    private void OnThemeChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        ThemeState.OnChange -= OnThemeChanged;
    }

    // Emergency Action Methods
    private async Task Call911()
    {
        await JSRuntime.InvokeVoidAsync("alert", "Calling 911 Emergency Services\n\nIn a real emergency, this would dial 911 automatically.\n\nFor demonstration purposes, please manually dial 911 if you need emergency assistance.");
    }

    private async Task CallAmbulance()
    {
        await JSRuntime.InvokeVoidAsync("alert", "Requesting Ambulance\n\nIn a real emergency, this would connect you to ambulance services.\n\nPlease call 911 for immediate ambulance dispatch.");
    }

    private async Task CallPoisonControl()
    {
        await JSRuntime.InvokeVoidAsync("alert", "Poison Control Center\n\nNational Poison Control: 1-800-222-1222\n\n24/7 Emergency assistance for poisoning cases.");
    }

    // Location Permission Methods
    private async Task RequestLocationPermission()
    {
        if (locationPermissionStatus != LocationPermissionStatus.NotAsked)
        {
            return; // Already asked
        }

        locationPermissionStatus = LocationPermissionStatus.Asking;
        showLocationPrompt = true;
        StateHasChanged();

        try
        {
            // Request location from browser
            var location = await JSRuntime.InvokeAsync<UserLocationDto>("geolocationHelper.getCurrentPosition");
            userLocation = location;
            locationPermissionStatus = LocationPermissionStatus.Granted;
            showLocationPrompt = false;
            locationErrorMessage = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            locationPermissionStatus = LocationPermissionStatus.Denied;
            showLocationPrompt = true; // Keep showing prompt to allow retry
            locationErrorMessage = ex.Message.Contains("denied", StringComparison.OrdinalIgnoreCase)
                ? "Location permission denied. Some features may be limited."
                : $"Unable to get location: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task RetryLocationPermission()
    {
        locationPermissionStatus = LocationPermissionStatus.NotAsked;
        await RequestLocationPermission();
    }

    private void DismissLocationPrompt()
    {
        showLocationPrompt = false;
        StateHasChanged();
    }

    // Hospital Search Methods
    private async Task FindNearestHospital()
    {
        isSearching = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            // Get user's current location
            var location = await JSRuntime.InvokeAsync<UserLocationDto>("geolocationHelper.getCurrentPosition");
            userLocation = location;

            // Search for nearby hospitals
            var searchInput = new HospitalSearchInputDto
            {
                Latitude = location.Latitude,
                Longitude = location.Longitude,
                Radius = selectedRadius,
                Limit = 20,
                Language = "en",
                Country = "in"
            };

            var result = await HospitalService.SearchNearbyHospitalsAsync(searchInput);

            if (result != null && result.Success)
            {
                hospitals = result.Hospitals;
                ApplyFiltersAndSort();

                if (!hospitals.Any())
                {
                    errorMessage = "No hospitals found in your area. Try increasing the search radius.";
                }
            }
            else
            {
                errorMessage = result?.ErrorMessage ?? "Failed to search for hospitals. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message.Contains("denied")
                ? "Location permission denied. Please enable location access in your browser settings."
                : $"Error: {ex.Message}";
        }
        finally
        {
            isSearching = false;
            StateHasChanged();
        }
    }

    private async Task RefreshSearch()
    {
        if (userLocation != null)
        {
            await FindNearestHospital();
        }
    }

    private void ApplyFiltersAndSort()
    {
        filteredHospitals = hospitals;

        // Apply filters
        if (filterOpenOnly)
        {
            filteredHospitals = filteredHospitals.Where(h => h.IsOpen).ToList();
        }

        if (filterHighRated)
        {
            filteredHospitals = filteredHospitals.Where(h => h.Rating >= 4.0).ToList();
        }

        // Apply sorting
        filteredHospitals = sortBy switch
        {
            "rating" => filteredHospitals.OrderByDescending(h => h.Rating ?? 0).ToList(),
            "reviews" => filteredHospitals.OrderByDescending(h => h.Reviews ?? 0).ToList(),
            _ => filteredHospitals.OrderBy(h => h.DistanceInKm ?? double.MaxValue).ToList()
        };
    }

    private void ApplyFilters()
    {
        ApplyFiltersAndSort();
        StateHasChanged();
    }

    private void ApplySorting()
    {
        ApplyFiltersAndSort();
        StateHasChanged();
    }

    private async Task CallHospital(string phoneNumber)
    {
        await JSRuntime.InvokeVoidAsync("geolocationHelper.makeCall", phoneNumber);
    }

    private async Task GetDirections(double latitude, double longitude, string name)
    {
        await JSRuntime.InvokeVoidAsync("geolocationHelper.openDirections", latitude, longitude, name);
    }

    private async Task OpenWebsite(string url)
    {
        await JSRuntime.InvokeVoidAsync("geolocationHelper.openWebsite", url);
    }

    // Admin Emergency Methods
    private void SendEmergencyBroadcast()
    {
        // Navigate to admin broadcast page or show modal
        Navigation.NavigateTo("/admin/emergency-broadcast");
    }

    private void ViewEmergencyCases()
    {
        Navigation.NavigateTo("/admin/emergency-cases");
    }

    private void EmergencyStaffDirectory()
    {
        Navigation.NavigateTo("/admin/emergency-staff");
    }

    private void SystemHealthMonitor()
    {
        Navigation.NavigateTo("/admin/system-health");
    }

    // Doctor Emergency Methods
    private void ViewEmergencyPatients()
    {
        Navigation.NavigateTo("/doctor/emergency-patients");
    }

    private void QuickPatientLookup()
    {
        Navigation.NavigateTo("/doctor/patient-lookup");
    }

    private void OnCallSchedule()
    {
        Navigation.NavigateTo("/doctor/on-call-schedule");
    }

    private void MedicalProtocols()
    {
        Navigation.NavigateTo("/doctor/emergency-protocols");
    }

    // Patient Emergency Methods
    private void ViewMedicalHistory()
    {
        Navigation.NavigateTo("/patient/medical-history");
    }

    private void ViewMedications()
    {
        Navigation.NavigateTo("/patient/medications");
    }

    private void ViewAllergies()
    {
        Navigation.NavigateTo("/patient/allergies");
    }

    private void ContactMyDoctor()
    {
        Navigation.NavigateTo("/patient/contact-doctor");
    }

    private void EmergencyContacts()
    {
        Navigation.NavigateTo("/patient/emergency-contacts");
    }

    private void BookEmergencyAppointment()
    {
        Navigation.NavigateTo("/patient/emergency-appointment");
    }

    // Handler for chatbot requesting hospital search
    private async Task HandleHospitalSearchRequest()
    {
        if (!isSearching)
        {
            await FindNearestHospital();
        }
    }



    // Calculate ETA based on distance (assuming average urban driving speed of 40 km/h in emergency)
    private string CalculateETA(double distanceInKm)
    {
        // Average emergency driving speed in urban areas (accounting for traffic, lights, etc.)
        const double averageSpeedKmh = 40.0;
        var timeInMinutes = Math.Round((distanceInKm / averageSpeedKmh) * 60);

        if (timeInMinutes < 1) return "< 1 min";
        if (timeInMinutes < 60) return $"{timeInMinutes} min";

        var hours = Math.Floor(timeInMinutes / 60);
        var minutes = timeInMinutes % 60;

        return minutes > 0 ? $"{hours}h {minutes}m" : $"{hours}h";
    }

    // Live Navigation Methods
    private void StartLiveNavigation(double latitude, double longitude, string name, string address)
    {
        navigationDestinationName = name;
        navigationDestinationAddress = address;
        navigationDestinationLat = latitude;
        navigationDestinationLng = longitude;
        isNavigationModalOpen = true;
    }

    private void OnNavigationModalClosed(bool isOpen)
    {
        isNavigationModalOpen = isOpen;
        StateHasChanged();
    }

    // Helper class
    public class FirstAidTip
    {
        public string Icon { get; set; } = "";
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
    }
}

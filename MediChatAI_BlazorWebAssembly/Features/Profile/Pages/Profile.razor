@page "/profile"
@page "/patient/profile"
@page "/doctor/profile"
@page "/admin/profile"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Authorization
@inject IAuthService AuthService
@inject IUserProfileService UserProfileService
@inject IProfileService ProfileService
@inject NavigationManager Navigation
@inject AppSettingsState AppSettings
@inject IToastService ToastService
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Profile - @AppSettings.Settings.SiteName</PageTitle>

<AuthorizeRouteGuard>

<div class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50/30 to-purple-50/30 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900">
    <!-- Top Navigation Bar -->
    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl shadow-xl border border-white/50 dark:border-gray-700/50">
        <div class="w-full px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <button @onclick="() => Navigation.NavigateTo(GetDashboardUrl())"
                            class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </button>
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">My Profile</h1>
                </div>
                <div class="flex items-center space-x-3">
                    @if (!isEditingProfile)
                    {
                        <button @onclick="() => isEditingProfile = true"
                                class="bg-gradient-to-r from-primary to-accent hover:opacity-90 text-white px-4 py-2 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
                            <svg class="w-4 h-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                            Edit Profile
                        </button>
                    }
                    else
                    {
                        <button @onclick="SaveProfile" disabled="@isLoading"
                                class="bg-gradient-to-r from-primary to-accent hover:opacity-90 text-white px-4 py-2 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed">
                            @if (isLoading)
                            {
                                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white inline mr-2"></div>
                            }
                            else
                            {
                                <svg class="w-4 h-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                            }
                            Save Changes
                        </button>
                        <button @onclick="CancelEdit"
                                class="bg-gray-500 dark:bg-gray-600 hover:bg-gray-600 dark:hover:bg-gray-700 text-white px-4 py-2 rounded-xl font-semibold transition-all duration-300 shadow-lg hover:shadow-xl">
                            Cancel
                        </button>
                    }
                    <button @onclick="() => showPasswordModal = true"
                            class="bg-gray-500 dark:bg-gray-600 hover:bg-gray-600 dark:hover:bg-gray-700 text-white px-4 py-2 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
                        <svg class="w-4 h-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                        </svg>
                        Change Password
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Main Content -->
    <div class="w-full px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">

            <!-- Left Sidebar - Profile Overview (Sticky) -->
            <div class="lg:col-span-1">
                <!-- Sticky wrapper: position sticky with top offset -->
                <div class="sticky top-20" style="max-height: calc(100vh - 5rem);">
                    <!-- Scrollable sidebar content with hidden scrollbar -->
                    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-2xl shadow-xl border border-white/50 dark:border-gray-700/50 overflow-hidden overflow-y-auto scrollbar-hide"
                         style="box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(255, 255, 255, 0.3) inset; max-height: calc(100vh - 5.5rem);">
                    <!-- Profile Image Section -->
                    <div class="bg-gradient-to-br @GetProfileGradient() p-8 text-center relative overflow-hidden">
                        <!-- Background Pattern -->
                        <div class="absolute inset-0 bg-black/10"></div>
                        <div class="absolute inset-0 bg-gradient-to-br from-white/5 via-transparent to-black/5"></div>

                        <div class="relative">
                            <div class="relative inline-block group">
                                <div class="w-36 h-36 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center text-white text-3xl font-bold shadow-2xl border-4 border-white/30 transition-all duration-300 group-hover:scale-105">
                                    @if (isUploadingImage)
                                    {
                                        <div class="flex flex-col items-center space-y-2">
                                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
                                            <span class="text-xs">Uploading...</span>
                                        </div>
                                    }
                                    else if (!string.IsNullOrEmpty(profile?.ProfileImage))
                                    {
                                        <img src="@GetImageUrl(profile.ProfileImage)"
                                             alt="Profile"
                                             class="profile-image w-36 h-36 rounded-full object-cover border-4 border-white/30 shadow-inner"
                                             data-initials="@GetInitials()"
                                             onerror="window.handleImageError(this, '@GetInitials()')" />
                                    }
                                    else
                                    {
                                        <div class="flex flex-col items-center">
                                            <span class="text-4xl">@GetInitials()</span>
                                            <svg class="w-8 h-8 mt-2 opacity-60" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                            </svg>
                                        </div>
                                    }
                                </div>

                                <!-- Camera overlay on hover -->
                                <div class="absolute inset-0 rounded-full bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all duration-300">
                                    <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    </svg>
                                </div>

                                <label for="profile-image-upload"
                                       class="absolute -bottom-3 -right-3 bg-white text-gray-700 p-3 rounded-full shadow-xl hover:shadow-2xl transition-all duration-300 cursor-pointer transform hover:scale-110 hover:bg-gray-50 border-4 border-white">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                </label>
                                <InputFile id="profile-image-upload"
                                          OnChange="HandleImageUpload"
                                          accept="image/*"
                                          style="display: none;" />
                            </div>

                            <div class="mt-6 space-y-3">
                                <h2 class="text-2xl font-bold text-white drop-shadow-lg">@profile?.FirstName @profile?.LastName</h2>
                                <p class="text-white/80 text-sm">@profile?.Email</p>

                                <div class="flex flex-wrap justify-center gap-2">
                                    <div class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-white/25 text-white backdrop-blur-sm border border-white/20">
                                        @GetRoleIconSvg()
                                        <span class="ml-2">@GetRoleDisplayName(profile?.Role)</span>
                                    </div>

                                    @if (profile?.EmailConfirmed == true)
                                    {
                                        <div class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-emerald-500/30 text-white backdrop-blur-sm border border-emerald-400/30">
                                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                            </svg>
                                            Verified Account
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Stats -->
                    <div class="p-6 space-y-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-900 dark:text-white">@GetProfileCompletion()%</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Profile Complete</div>
                            <div class="mt-2 w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div class="bg-gradient-to-r from-primary to-accent h-2 rounded-full transition-all duration-500" style="width: @GetProfileCompletion()%"></div>
                            </div>
                        </div>

                        <div class="border-t border-gray-200 dark:border-gray-700 pt-4 space-y-3">
                            <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                                <svg class="w-4 h-4 mr-3 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                Member since @GetMemberSince()
                            </div>
                            <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                                <svg class="w-4 h-4 mr-3 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Last active @GetLastActive()
                            </div>
                            <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                                <svg class="w-4 h-4 mr-3 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                </svg>
                                @(profile?.Email ?? "Not available")
                            </div>
                            <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                                <svg class="w-4 h-4 mr-3 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                </svg>
                                @(profile?.PhoneNumber ?? "Not provided")
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- Main Content Area (Independently Scrollable) -->
            <div class="lg:col-span-3">
                <div class="space-y-8">

                    <!-- Basic Information -->
                    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-2xl shadow-xl border border-white/50 dark:border-gray-700/50 overflow-hidden"
                         style="box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(255, 255, 255, 0.3) inset;">
                        <div class="bg-gradient-to-r from-primary to-accent px-6 py-4">
                            <h3 class="text-lg font-semibold text-white flex items-center">
                                <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                Basic Information
                            </h3>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">First Name</label>
                                    @if (isEditingProfile)
                                    {
                                        <input @bind="editModel.FirstName" type="text"
                                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200" />
                                    }
                                    else
                                    {
                                        <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-gray-900 dark:text-gray-100">@profile?.FirstName</div>
                                    }
                                </div>

                                <div class="space-y-2">
                                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Last Name</label>
                                    @if (isEditingProfile)
                                    {
                                        <input @bind="editModel.LastName" type="text"
                                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200" />
                                    }
                                    else
                                    {
                                        <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-gray-900 dark:text-gray-100">@profile?.LastName</div>
                                    }
                                </div>

                                <div class="space-y-2">
                                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Email Address</label>
                                    <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-gray-900 dark:text-gray-100 flex items-center justify-between">
                                        <span>@profile?.Email</span>
                                        @if (profile?.EmailConfirmed == true)
                                        {
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                                </svg>
                                                Verified
                                            </span>
                                        }
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Role</label>
                                    <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-gray-900 dark:text-gray-100 flex items-center">
                                        <span class="@GetRoleIcon() w-4 h-4 mr-2 @GetRoleColor()"></span>
                                        @profile?.Role
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Phone Number</label>
                                    @if (isEditingProfile)
                                    {
                                        <input @bind="editModel.PhoneNumber" type="tel"
                                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200" />
                                    }
                                    else
                                    {
                                        <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-gray-900 dark:text-gray-100">@(profile?.PhoneNumber ?? "Not provided")</div>
                                    }
                                </div>

                                <div class="space-y-2">
                                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Date of Birth</label>
                                    @if (isEditingProfile)
                                    {
                                        <input @bind="editModel.DateOfBirth" type="date"
                                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200" />
                                    }
                                    else
                                    {
                                        <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-gray-900 dark:text-gray-100">@(profile?.DateOfBirth?.ToString("MMM dd, yyyy") ?? "Not provided")</div>
                                    }
                                </div>

                                <div class="space-y-2">
                                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Gender</label>
                                    @if (isEditingProfile)
                                    {
                                        <select @bind="editModel.Gender"
                                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200">
                                            <option value="">Select Gender</option>
                                            <option value="Male">Male</option>
                                            <option value="Female">Female</option>
                                            <option value="Other">Other</option>
                                            <option value="Prefer not to say">Prefer not to say</option>
                                        </select>
                                    }
                                    else
                                    {
                                        <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-gray-900 dark:text-gray-100">@(profile?.Gender ?? "Not provided")</div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Address Information -->
                    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-2xl shadow-xl border border-white/50 dark:border-gray-700/50 overflow-hidden"
                         style="box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(255, 255, 255, 0.3) inset;">
                        <div class="bg-gradient-to-r from-primary to-accent px-6 py-4">
                            <h3 class="text-lg font-semibold text-white flex items-center">
                                <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                Address Information
                            </h3>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="md:col-span-2 space-y-2">
                                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Street Address</label>
                                    @if (isEditingProfile)
                                    {
                                        <input @bind="editModel.Address" type="text"
                                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200" />
                                    }
                                    else
                                    {
                                        <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-gray-900 dark:text-gray-100">@(profile?.Address ?? "Not provided")</div>
                                    }
                                </div>

                                <div class="space-y-2">
                                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">City</label>
                                    @if (isEditingProfile)
                                    {
                                        <input @bind="editModel.City" type="text"
                                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200" />
                                    }
                                    else
                                    {
                                        <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-gray-900 dark:text-gray-100">@(profile?.City ?? "Not provided")</div>
                                    }
                                </div>

                                <div class="space-y-2">
                                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">State</label>
                                    @if (isEditingProfile)
                                    {
                                        <input @bind="editModel.State" type="text"
                                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200" />
                                    }
                                    else
                                    {
                                        <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-gray-900 dark:text-gray-100">@(profile?.State ?? "Not provided")</div>
                                    }
                                </div>

                                <div class="space-y-2">
                                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">ZIP Code</label>
                                    @if (isEditingProfile)
                                    {
                                        <input @bind="editModel.ZipCode" type="text"
                                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200" />
                                    }
                                    else
                                    {
                                        <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-gray-900 dark:text-gray-100">@(profile?.ZipCode ?? "Not provided")</div>
                                    }
                                </div>

                                <div class="space-y-2">
                                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Country</label>
                                    @if (isEditingProfile)
                                    {
                                        <input @bind="editModel.Country" type="text"
                                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200" />
                                    }
                                    else
                                    {
                                        <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-gray-900 dark:text-gray-100">@(profile?.Country ?? "Not provided")</div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Role-Specific Information -->
                    @if (profile?.Role == "Doctor")
                    {
                        <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-2xl shadow-xl border border-white/50 dark:border-gray-700/50 overflow-hidden"
                             style="box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(255, 255, 255, 0.3) inset;">
                            <div class="bg-gradient-to-r from-primary to-accent px-6 py-4">
                                <h3 class="text-lg font-semibold text-white flex items-center">
                                    <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                    </svg>
                                    Professional Information
                                </h3>
                            </div>
                            <div class="p-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Specialization</label>
                                        @if (isEditingProfile)
                                        {
                                            <input @bind="editModel.Specialization" type="text"
                                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200" />
                                        }
                                        else
                                        {
                                            <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-gray-900 dark:text-gray-100">@(profile?.Specialization ?? "Not provided")</div>
                                        }
                                    </div>

                                    <div class="space-y-2">
                                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">License Number</label>
                                        @if (isEditingProfile)
                                        {
                                            <input @bind="editModel.LicenseNumber" type="text"
                                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200" />
                                        }
                                        else
                                        {
                                            <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-gray-900 dark:text-gray-100">@(profile?.LicenseNumber ?? "Not provided")</div>
                                        }
                                    </div>

                                    <div class="md:col-span-2 space-y-2">
                                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Department</label>
                                        @if (isEditingProfile)
                                        {
                                            <input @bind="editModel.Department" type="text"
                                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200" />
                                        }
                                        else
                                        {
                                            <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-gray-900 dark:text-gray-100">@(profile?.Department ?? "Not provided")</div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else if (profile?.Role == "Patient")
                    {
                        <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-2xl shadow-xl border border-white/50 dark:border-gray-700/50 overflow-hidden"
                             style="box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(255, 255, 255, 0.3) inset;">
                            <div class="bg-gradient-to-r from-primary to-accent px-6 py-4">
                                <h3 class="text-lg font-semibold text-white flex items-center">
                                    <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                    </svg>
                                    Medical Information
                                </h3>
                            </div>
                            <div class="p-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Blood Type</label>
                                        @if (isEditingProfile)
                                        {
                                            <select @bind="editModel.BloodType"
                                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200">
                                                <option value="">Select Blood Type</option>
                                                <option value="A+">A+</option>
                                                <option value="A-">A-</option>
                                                <option value="B+">B+</option>
                                                <option value="B-">B-</option>
                                                <option value="AB+">AB+</option>
                                                <option value="AB-">AB-</option>
                                                <option value="O+">O+</option>
                                                <option value="O-">O-</option>
                                            </select>
                                        }
                                        else
                                        {
                                            <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-gray-900 dark:text-gray-100">@(profile?.BloodType ?? "Not provided")</div>
                                        }
                                    </div>

                                    <div class="space-y-2">
                                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Allergies</label>
                                        @if (isEditingProfile)
                                        {
                                            <input @bind="editModel.Allergies" type="text"
                                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200" />
                                        }
                                        else
                                        {
                                            <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-gray-900 dark:text-gray-100">@(profile?.Allergies ?? "Not provided")</div>
                                        }
                                    </div>

                                    <div class="md:col-span-2 space-y-2">
                                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Medical History</label>
                                        @if (isEditingProfile)
                                        {
                                            <textarea @bind="editModel.MedicalHistory" rows="4"
                                                      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200"></textarea>
                                        }
                                        else
                                        {
                                            <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-gray-900 dark:text-gray-100 min-h-[100px]">@(profile?.MedicalHistory ?? "Not provided")</div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Emergency Contact -->
                    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-2xl shadow-xl border border-white/50 dark:border-gray-700/50 overflow-hidden"
                         style="box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(255, 255, 255, 0.3) inset;">
                        <div class="bg-gradient-to-r from-primary to-accent px-6 py-4">
                            <h3 class="text-lg font-semibold text-white flex items-center">
                                <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                </svg>
                                Emergency Contact
                            </h3>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Contact Name</label>
                                    @if (isEditingProfile)
                                    {
                                        <input @bind="editModel.EmergencyContactName" type="text"
                                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200" />
                                    }
                                    else
                                    {
                                        <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-gray-900 dark:text-gray-100">@(profile?.EmergencyContactName ?? "Not provided")</div>
                                    }
                                </div>

                                <div class="space-y-2">
                                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Contact Phone</label>
                                    @if (isEditingProfile)
                                    {
                                        <input @bind="editModel.EmergencyContactPhone" type="tel"
                                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200" />
                                    }
                                    else
                                    {
                                        <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-gray-900 dark:text-gray-100">@(profile?.EmergencyContactPhone ?? "Not provided")</div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Password Change Modal -->
@if (showPasswordModal)
{
    <div class="fixed inset-0 bg-black/60 dark:bg-black/80 backdrop-blur-sm overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4" @onclick="ClosePasswordModal">
        <div class="relative bg-white/95 dark:bg-gray-800/95 backdrop-blur-xl rounded-2xl shadow-2xl w-full max-w-md border border-white/50 dark:border-gray-700/50"
             @onclick:stopPropagation="true"
             style="box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(255, 255, 255, 0.2) inset;">
            <div class="bg-gray-600 dark:bg-gray-700 px-6 py-4 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-white">Change Password</h3>
                    <button @onclick="ClosePasswordModal" class="text-white hover:text-gray-200 transition-colors hover:bg-white/10 p-2 rounded-lg">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Current Password</label>
                        <input @bind="passwordModel.CurrentPassword" type="password"
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">New Password</label>
                        <input @bind="passwordModel.NewPassword" type="password"
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Confirm New Password</label>
                        <input @bind="passwordModel.ConfirmNewPassword" type="password"
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200" />
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button @onclick="ClosePasswordModal"
                            class="px-5 py-2.5 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-xl transition-all duration-300 font-semibold shadow-lg hover:shadow-xl">
                        Cancel
                    </button>
                    <button @onclick="ChangePassword" disabled="@isLoading"
                            class="px-5 py-2.5 bg-gray-600 dark:bg-gray-700 hover:bg-gray-700 dark:hover:bg-gray-600 text-white rounded-xl transition-all duration-300 font-semibold shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed">
                        @if (isLoading)
                        {
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white inline mr-2"></div>
                        }
                        Change Password
                    </button>
                </div>
            </div>
        </div>
    </div>
}

</AuthorizeRouteGuard>

@code {
    private UserProfile? profile;
    private ProfileEditModel editModel = new();
    private PasswordChangeModel passwordModel = new();
    private bool isLoading = false;
    private bool isEditingProfile = false;
    private bool showPasswordModal = false;
    private bool isUploadingImage = false;

    protected override async Task OnInitializedAsync()
    {
        // Validate role-based access and redirect if needed
        await ValidateRoleBasedAccess();

        await LoadProfile();
    }

    private async Task ValidateRoleBasedAccess()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user?.Identity?.IsAuthenticated == true)
            {
                var role = user.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value;
                var currentPath = Navigation.ToAbsoluteUri(Navigation.Uri).AbsolutePath.ToLower();

                // Determine the correct profile route for the user's role
                var correctRoute = role switch
                {
                    "Patient" => "/patient/profile",
                    "Doctor" => "/doctor/profile",
                    "Admin" => "/admin/profile",
                    _ => "/profile"
                };

                // If user is on generic /profile route, redirect to role-specific route
                if (currentPath == "/profile" && correctRoute != "/profile")
                {
                    Navigation.NavigateTo(correctRoute, forceLoad: true);
                    return;
                }

                // If user is on a different role's profile route, redirect to their correct route
                if (currentPath != correctRoute.ToLower() && currentPath != "/profile")
                {
                    Console.WriteLine($"Profile: User role '{role}' accessing incorrect route '{currentPath}'. Redirecting to '{correctRoute}'");
                    Navigation.NavigateTo(correctRoute, forceLoad: true);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Profile: Error validating role-based access: {ex.Message}");
        }
    }

    private async Task LoadProfile()
    {
        try
        {
            isLoading = true;
            Console.WriteLine("Loading profile...");
            profile = await UserProfileService.GetUserProfileAsync();
            Console.WriteLine($"Profile loaded: {profile != null}");
            if (profile != null)
            {
                Console.WriteLine($"Profile: {profile.FirstName} {profile.LastName} - {profile.Role}");
                PopulateEditModel();
            }
            else
            {
                Console.WriteLine("Profile is null");
                ToastService.ShowError("No profile data found.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Profile load error: {ex.Message}");
            ToastService.ShowError("Failed to load profile information.");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        // Validate file size (5MB max)
        const long maxFileSize = 5 * 1024 * 1024;
        if (file.Size > maxFileSize)
        {
            ToastService.ShowError("File size must be less than 5MB.");
            return;
        }

        // Validate file type
        var allowedTypes = new[] { "image/jpeg", "image/jpg", "image/png", "image/gif", "image/webp" };
        if (!allowedTypes.Contains(file.ContentType))
        {
            ToastService.ShowError("Only JPEG, PNG, GIF, and WebP images are allowed.");
            return;
        }

        try
        {
            isUploadingImage = true;
            StateHasChanged();

            // Upload file - stream will be converted to byte array in service to avoid _blazorFilesById error
            var stream = file.OpenReadStream(maxFileSize);
            var imageUrl = await ProfileService.UploadProfileImageAsync(stream, file.Name);

            if (!string.IsNullOrEmpty(imageUrl))
            {
                await LoadProfile(); // Reload profile to get updated image
                ToastService.ShowSuccess("Profile image updated successfully!");
            }
            else
            {
                ToastService.ShowError("Failed to upload image. Please try again.");
            }
        }
        catch (Exception)
        {
            ToastService.ShowError("An error occurred while uploading the image.");
        }
        finally
        {
            isUploadingImage = false;
            StateHasChanged();
        }
    }

    private void PopulateEditModel()
    {
        if (profile == null) return;

        editModel = new ProfileEditModel
        {
            FirstName = profile.FirstName,
            LastName = profile.LastName,
            PhoneNumber = profile.PhoneNumber,
            DateOfBirth = profile.DateOfBirth,
            Gender = profile.Gender,
            Address = profile.Address,
            City = profile.City,
            State = profile.State,
            ZipCode = profile.ZipCode,
            Country = profile.Country,
            Specialization = profile.Specialization,
            LicenseNumber = profile.LicenseNumber,
            Department = profile.Department,
            EmergencyContactName = profile.EmergencyContactName,
            EmergencyContactPhone = profile.EmergencyContactPhone,
            BloodType = profile.BloodType,
            Allergies = profile.Allergies,
            MedicalHistory = profile.MedicalHistory
        };
    }

    private async Task SaveProfile()
    {
        try
        {
            isLoading = true;

            Console.WriteLine("Saving profile...");

            var request = new UpdateProfileRequest(
                editModel.FirstName,
                editModel.LastName,
                editModel.PhoneNumber,
                editModel.DateOfBirth,
                editModel.Gender,
                editModel.Address,
                editModel.City,
                editModel.State,
                editModel.ZipCode,
                editModel.Country,
                editModel.Specialization,
                editModel.LicenseNumber,
                editModel.Department,
                editModel.EmergencyContactName,
                editModel.EmergencyContactPhone,
                editModel.BloodType,
                editModel.Allergies,
                editModel.MedicalHistory);

            Console.WriteLine($"Update request: {request.FirstName} {request.LastName}");

            var response = await UserProfileService.UpdateProfileAsync(request);

            Console.WriteLine($"Update response: Success={response?.Success}, Profile={response?.Profile != null}");

            if (response != null && response.Success && response.Profile != null)
            {
                profile = response.Profile;
                PopulateEditModel(); // Refresh edit model with saved data
                isEditingProfile = false;
                ToastService.ShowSuccess("Profile updated successfully!");
                Console.WriteLine("Profile updated successfully");
            }
            else
            {
                var errors = response?.Errors ?? new[] { "Unknown error occurred" };
                var errorMessage = string.Join(", ", errors);
                Console.WriteLine($"Update failed: {errorMessage}");

                // Provide specific error diagnosis
                if (response == null)
                {
                    ToastService.ShowError("Network error: No response received from server. Check your internet connection.");
                }
                else if (!response.Success && (errors.Any(e => e.Contains("AUTH")) || errors.Any(e => e.Contains("authorized"))))
                {
                    ToastService.ShowError("Authentication error: Please login again to update your profile.");
                }
                else if (!response.Success && (errors.Any(e => e.Contains("validation")) || errors.Any(e => e.Contains("required"))))
                {
                    ToastService.ShowError("Validation error: Please check that required fields (First Name, Last Name) are filled out.");
                }
                else
                {
                    ToastService.ShowError(errorMessage);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Save profile error: {ex.Message}");
            ToastService.ShowError("Failed to update profile. Please try again.");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void CancelEdit()
    {
        isEditingProfile = false;
        PopulateEditModel(); // Reset to original values
    }

    private async Task ChangePassword()
    {
        try
        {
            isLoading = true;

            if (string.IsNullOrWhiteSpace(passwordModel.CurrentPassword) ||
                string.IsNullOrWhiteSpace(passwordModel.NewPassword) ||
                string.IsNullOrWhiteSpace(passwordModel.ConfirmNewPassword))
            {
                ToastService.ShowError("All password fields are required.");
                return;
            }

            if (passwordModel.NewPassword != passwordModel.ConfirmNewPassword)
            {
                ToastService.ShowError("New passwords do not match.");
                return;
            }

            var request = new ChangePasswordRequest
            {
                CurrentPassword = passwordModel.CurrentPassword,
                NewPassword = passwordModel.NewPassword,
                ConfirmNewPassword = passwordModel.ConfirmNewPassword
            };

            var success = await AuthService.ChangePasswordAsync(request);

            if (success)
            {
                ToastService.ShowSuccess("Password changed successfully!");
                showPasswordModal = false;
                passwordModel = new PasswordChangeModel();
            }
            else
            {
                ToastService.ShowError("Failed to change password. Please check your current password.");
            }
        }
        catch (Exception)
        {
            ToastService.ShowError("An error occurred while changing the password.");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ClosePasswordModal()
    {
        showPasswordModal = false;
        passwordModel = new PasswordChangeModel();
    }

    private string GetInitials()
    {
        if (profile == null) return "U";
        var firstInitial = !string.IsNullOrEmpty(profile.FirstName) ? profile.FirstName[0].ToString().ToUpper() : "";
        var lastInitial = !string.IsNullOrEmpty(profile.LastName) ? profile.LastName[0].ToString().ToUpper() : "";
        return firstInitial + lastInitial;
    }

    private string GetImageUrl(string imageUrl)
    {
        if (string.IsNullOrEmpty(imageUrl)) return "";
        return imageUrl.StartsWith("http") ? imageUrl : $"http://localhost:5095{imageUrl}";
    }

    private string GetDashboardUrl()
    {
        return profile?.Role?.ToLower() switch
        {
            "admin" => "/admin/dashboard",
            "doctor" => "/doctor/dashboard",
            "patient" => "/patient/dashboard",
            _ => "/"
        };
    }

    private string GetProfileUrl()
    {
        return profile?.Role?.ToLower() switch
        {
            "admin" => "/admin/profile",
            "doctor" => "/doctor/profile",
            "patient" => "/patient/profile",
            _ => "/profile"
        };
    }

    private string GetRoleIcon()
    {
        return profile?.Role?.ToLower() switch
        {
            "admin" => "",
            "doctor" => "",
            "patient" => "",
            _ => ""
        };
    }

    private string GetRoleColor()
    {
        return profile?.Role?.ToLower() switch
        {
            "admin" => "text-accent dark:text-accent",
            "doctor" => "text-primary dark:text-primary",
            "patient" => "text-green-600",
            _ => "text-gray-600"
        };
    }

    private int GetProfileCompletion()
    {
        if (profile == null) return 0;

        int filledFields = 0;

        if (!string.IsNullOrEmpty(profile.FirstName)) filledFields++;
        if (!string.IsNullOrEmpty(profile.LastName)) filledFields++;
        if (!string.IsNullOrEmpty(profile.Email)) filledFields++;
        if (!string.IsNullOrEmpty(profile.PhoneNumber)) filledFields++;
        if (profile.DateOfBirth.HasValue) filledFields++;
        if (!string.IsNullOrEmpty(profile.Gender)) filledFields++;
        if (!string.IsNullOrEmpty(profile.Address)) filledFields++;
        if (!string.IsNullOrEmpty(profile.City)) filledFields++;
        if (!string.IsNullOrEmpty(profile.State)) filledFields++;
        if (!string.IsNullOrEmpty(profile.ZipCode)) filledFields++;
        if (!string.IsNullOrEmpty(profile.Country)) filledFields++;
        if (!string.IsNullOrEmpty(profile.EmergencyContactName)) filledFields++;
        if (!string.IsNullOrEmpty(profile.EmergencyContactPhone)) filledFields++;
        if (!string.IsNullOrEmpty(profile.ProfileImage)) filledFields++;

        // Role-specific fields - totalFields varies by role
        int totalFields = 14; // Base fields for all users (Admin default)

        if (profile.Role == "Doctor")
        {
            totalFields = 15; // 14 common + Specialization
            if (!string.IsNullOrEmpty(profile.Specialization)) filledFields++;
        }
        else if (profile.Role == "Patient")
        {
            totalFields = 15; // 14 common + BloodType
            if (!string.IsNullOrEmpty(profile.BloodType)) filledFields++;
        }

        return (int)Math.Round((double)filledFields / totalFields * 100);
    }

    private string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;

        if (timeSpan.TotalDays > 30)
            return $"{(int)(timeSpan.TotalDays / 30)} month(s) ago";
        if (timeSpan.TotalDays > 1)
            return $"{(int)timeSpan.TotalDays} day(s) ago";
        if (timeSpan.TotalHours > 1)
            return $"{(int)timeSpan.TotalHours} hour(s) ago";
        if (timeSpan.TotalMinutes > 1)
            return $"{(int)timeSpan.TotalMinutes} minute(s) ago";

        return "Just now";
    }

    private string GetMemberSince()
    {
        return profile?.CreatedAt?.ToString("MMM yyyy") ?? "Unknown";
    }

    private string GetLastActive()
    {
        if (profile?.LastLoginAt == null)
            return "Never";

        return GetTimeAgo(profile.LastLoginAt.Value);
    }

    public class ProfileEditModel
    {
        [Required(ErrorMessage = "First name is required")]
        public string FirstName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Last name is required")]
        public string LastName { get; set; } = string.Empty;

        public string? PhoneNumber { get; set; }
        public DateTime? DateOfBirth { get; set; }
        public string? Gender { get; set; }
        public string? Address { get; set; }
        public string? City { get; set; }
        public string? State { get; set; }
        public string? ZipCode { get; set; }
        public string? Country { get; set; }
        public string? Specialization { get; set; }
        public string? LicenseNumber { get; set; }
        public string? Department { get; set; }
        public string? EmergencyContactName { get; set; }
        public string? EmergencyContactPhone { get; set; }
        public string? BloodType { get; set; }
        public string? Allergies { get; set; }
        public string? MedicalHistory { get; set; }
    }

    public class PasswordChangeModel
    {
        public string CurrentPassword { get; set; } = string.Empty;
        public string NewPassword { get; set; } = string.Empty;
        public string ConfirmNewPassword { get; set; } = string.Empty;
    }

    private string GetProfileGradient()
    {
        return profile?.Role?.ToLower() switch
        {
            "admin" => "from-primary via-accent to-primary",
            "doctor" => "from-primary via-accent to-primary",
            "patient" => "from-primary via-accent to-primary",
            _ => "from-gray-500 via-gray-600 to-gray-700"
        };
    }

    private MarkupString GetRoleIconSvg()
    {
        var svgContent = profile?.Role?.ToLower() switch
        {
            "admin" => "<svg class=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"><path fill-rule=\"evenodd\" d=\"M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z\" clip-rule=\"evenodd\"></path></svg>",
            "doctor" => "<svg class=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"><path d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\"></path></svg>",
            "patient" => "<svg class=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"><path fill-rule=\"evenodd\" d=\"M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z\" clip-rule=\"evenodd\"></path></svg>",
            _ => "<svg class=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"><path fill-rule=\"evenodd\" d=\"M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z\" clip-rule=\"evenodd\"></path></svg>"
        };
        return new MarkupString(svgContent);
    }

    private string GetRoleDisplayName(string? role)
    {
        return role?.ToLower() switch
        {
            "admin" => "Administrator",
            "doctor" => "Healthcare Provider",
            "patient" => "Patient",
            _ => "User"
        };
    }
}

<style>
    /* Modern animations */
    @@keyframes slide-in {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@keyframes fade-in {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    /* Custom scrollbar for the entire page */
    ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
    }

    ::-webkit-scrollbar-track {
        background: rgba(243, 244, 246, 0.5);
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
        background: linear-gradient(to bottom, var(--color-primary, #3b82f6), var(--color-accent, #8b5cf6));
        border-radius: 10px;
        transition: all 0.3s ease;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(to bottom, #2563eb, #7c3aed);
    }

    /* Dark mode scrollbar */
    .dark ::-webkit-scrollbar-track {
        background: rgba(55, 65, 81, 0.5);
    }

    /* Smooth transitions for theme changes */
    * {
        transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }

    /* Preserve other transitions */
    button, a, input, select, textarea {
        transition: all 0.3s ease;
    }

    /* Enhanced focus states */
    input:focus, select:focus, textarea:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .dark input:focus, .dark select:focus, .dark textarea:focus {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }

    /* Glassmorphism effect helper */
    .glass-effect {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .dark .glass-effect {
        background: rgba(31, 41, 55, 0.8);
        border: 1px solid rgba(75, 85, 99, 0.5);
    }

    /* Hover effects */
    .hover-lift {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .hover-lift:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    /* Sticky Sidebar Styles */
    .sticky {
        position: -webkit-sticky;
        position: sticky;
        will-change: transform;
    }

    /* Smooth scrolling for all scrollable containers */
    * {
        scroll-behavior: smooth;
    }

    /* Hide scrollbars globally while maintaining scroll functionality */
    /* For Webkit browsers (Chrome, Safari, Edge) */
    ::-webkit-scrollbar {
        width: 0px;
        height: 0px;
        display: none;
    }

    /* For Firefox */
    * {
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    /* Utility class to hide scrollbar */
    .scrollbar-hide {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }

    .scrollbar-hide::-webkit-scrollbar {
        display: none;  /* Chrome, Safari, Opera */
    }
</style>
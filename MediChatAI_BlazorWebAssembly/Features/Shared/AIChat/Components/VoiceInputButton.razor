@using MediChatAI_BlazorWebAssembly.Core.Services.Theme
@inject ThemeState ThemeState
@inject IJSRuntime JS
@implements IDisposable

<div class="relative">
    <button @onclick="@ToggleRecording"
            class="relative w-12 h-12 rounded-full @GetButtonClass() flex items-center justify-center transition-all duration-200 hover:scale-110 shadow-lg focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2">
        @if (isRecording)
        {
            <span class="absolute inset-0 rounded-full bg-red-500 animate-ping opacity-30"></span>
            <i class="fas fa-stop text-white text-lg relative z-10"></i>
        }
        else
        {
            <i class="fas fa-microphone @(IsDarkMode ? "text-gray-200" : "text-gray-700") text-lg"></i>
        }
    </button>

    @if (isRecording)
    {
        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-3 px-4 py-2.5 rounded-lg bg-gradient-to-r from-red-600 to-red-500 text-white text-sm font-semibold shadow-xl whitespace-nowrap z-50 animate-bounce-subtle backdrop-blur-sm border border-red-400">
            <div class="flex items-center gap-2">
                <span class="w-2.5 h-2.5 rounded-full bg-white animate-pulse shadow-sm"></span>
                Recording... @recordingDuration.ToString(@"mm\:ss")
            </div>
            <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-[6px] border-r-[6px] border-t-[6px] border-t-red-500 border-l-transparent border-r-transparent"></div>
        </div>
    }
</div>

@code {
    [Parameter] public EventCallback<string> OnVoiceRecorded { get; set; }

    private bool isRecording = false;
    private TimeSpan recordingDuration = TimeSpan.Zero;
    private System.Timers.Timer? recordingTimer;

    private bool IsDarkMode => ThemeState.CurrentTheme.Mode == "dark";

    protected override void OnInitialized()
    {
        ThemeState.OnChange += OnThemeChanged;
    }

    private void OnThemeChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private string GetButtonClass()
    {
        if (isRecording)
        {
            return "bg-gradient-to-br from-red-500 to-red-600 hover:from-red-600 hover:to-red-700";
        }
        else
        {
            return IsDarkMode
                ? "bg-gray-700 hover:bg-gray-600"
                : "bg-gray-200 hover:bg-gray-300";
        }
    }

    private async Task ToggleRecording()
    {
        if (isRecording)
        {
            await StopRecording();
        }
        else
        {
            await StartRecording();
        }
    }

    private async Task StartRecording()
    {
        try
        {
            await JS.InvokeVoidAsync("voiceRecorder.startRecording");
            isRecording = true;
            recordingDuration = TimeSpan.Zero;

            recordingTimer = new System.Timers.Timer(1000);
            recordingTimer.Elapsed += (sender, e) =>
            {
                recordingDuration = recordingDuration.Add(TimeSpan.FromSeconds(1));
                InvokeAsync(StateHasChanged);
            };
            recordingTimer.Start();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error starting recording: {ex.Message}");
        }
    }

    private async Task StopRecording()
    {
        try
        {
            recordingTimer?.Stop();
            recordingTimer?.Dispose();
            recordingTimer = null;

            var audioDataUrl = await JS.InvokeAsync<string>("voiceRecorder.stopRecording");
            isRecording = false;
            recordingDuration = TimeSpan.Zero;

            if (!string.IsNullOrEmpty(audioDataUrl))
            {
                await OnVoiceRecorded.InvokeAsync(audioDataUrl);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error stopping recording: {ex.Message}");
            isRecording = false;
        }
    }

    public void Dispose()
    {
        ThemeState.OnChange -= OnThemeChanged;
        recordingTimer?.Stop();
        recordingTimer?.Dispose();
    }
}

<style>
    @@keyframes bounce-subtle {
        0%, 100% {
            transform: translate(-50%, 0);
        }
        50% {
            transform: translate(-50%, -4px);
        }
    }

    .animate-bounce-subtle {
        animation: bounce-subtle 2s ease-in-out infinite;
    }
</style>

@using MediChatAI_BlazorWebAssembly.Core.Services.Theme
@inject ThemeState ThemeState
@inject IJSRuntime JS
@implements IDisposable

@if (IsOpen)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-90 animate-fade-in"
         @onclick="@Close">
        <!-- Close Button -->
        <button @onclick="@Close"
                @onclick:stopPropagation="true"
                class="absolute top-4 right-4 z-10 w-12 h-12 rounded-full bg-gray-800/80 hover:bg-gray-700 flex items-center justify-center transition-all hover:scale-110"
                aria-label="Close image viewer">
            <i class="fas fa-times text-white text-xl"></i>
        </button>

        <!-- Zoom Controls -->
        <div class="absolute top-4 left-4 z-10 flex items-center gap-2">
            <button @onclick="@ZoomOut"
                    @onclick:stopPropagation="true"
                    class="w-10 h-10 rounded-full bg-gray-800/80 hover:bg-gray-700 flex items-center justify-center transition-all">
                <i class="fas fa-minus text-white"></i>
            </button>
            <span class="px-4 py-2 rounded-full bg-gray-800/80 text-white text-sm font-semibold">
                @($"{(zoomLevel * 100):F0}%")
            </span>
            <button @onclick="@ZoomIn"
                    @onclick:stopPropagation="true"
                    class="w-10 h-10 rounded-full bg-gray-800/80 hover:bg-gray-700 flex items-center justify-center transition-all">
                <i class="fas fa-plus text-white"></i>
            </button>
            <button @onclick="@ResetZoom"
                    @onclick:stopPropagation="true"
                    class="w-10 h-10 rounded-full bg-gray-800/80 hover:bg-gray-700 flex items-center justify-center transition-all">
                <i class="fas fa-compress-arrows-alt text-white"></i>
            </button>
        </div>

        <!-- Download Button -->
        <button @onclick="@DownloadImage"
                @onclick:stopPropagation="true"
                class="absolute bottom-4 right-4 z-10 px-6 py-3 rounded-full bg-gray-800/80 hover:bg-gray-700 flex items-center gap-2 transition-all hover:scale-105">
            <i class="fas fa-download text-white"></i>
            <span class="text-white font-semibold">Download</span>
        </button>

        <!-- Image Container -->
        <div class="relative max-w-full max-h-full overflow-auto"
             @onclick:stopPropagation="true">
            <img src="@ImageUrl"
                 alt="@AltText"
                 class="max-w-none transition-transform duration-200 select-none"
                 style="transform: scale(@zoomLevel); cursor: @(isDragging ? "grabbing" : "grab");"
                 @onmousedown="@StartDrag"
                 @onmousemove="@Drag"
                 @onmouseup="@EndDrag"
                 @onmouseleave="@EndDrag"
                 draggable="false" />
        </div>

        <!-- Image Info -->
        @if (!string.IsNullOrEmpty(AltText))
        {
            <div class="absolute bottom-4 left-4 z-10 px-4 py-2 rounded-full bg-gray-800/80 text-white text-sm">
                @AltText
            </div>
        }
    </div>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public string ImageUrl { get; set; } = string.Empty;
    [Parameter] public string AltText { get; set; } = string.Empty;
    [Parameter] public EventCallback OnClose { get; set; }

    private double zoomLevel = 1.0;
    private const double ZoomStep = 0.25;
    private const double MinZoom = 0.5;
    private const double MaxZoom = 3.0;

    private bool isDragging = false;
    private double lastX = 0;
    private double lastY = 0;

    private bool IsDarkMode => ThemeState.CurrentTheme.Mode == "dark";

    protected override void OnInitialized()
    {
        ThemeState.OnChange += OnThemeChanged;
    }

    protected override void OnParametersSet()
    {
        if (IsOpen)
        {
            // Reset zoom when image changes
            zoomLevel = 1.0;
        }
    }

    private void OnThemeChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task Close()
    {
        zoomLevel = 1.0;
        await OnClose.InvokeAsync();
    }

    private void ZoomIn()
    {
        if (zoomLevel < MaxZoom)
        {
            zoomLevel += ZoomStep;
            if (zoomLevel > MaxZoom)
                zoomLevel = MaxZoom;
        }
    }

    private void ZoomOut()
    {
        if (zoomLevel > MinZoom)
        {
            zoomLevel -= ZoomStep;
            if (zoomLevel < MinZoom)
                zoomLevel = MinZoom;
        }
    }

    private void ResetZoom()
    {
        zoomLevel = 1.0;
    }

    private void StartDrag(MouseEventArgs e)
    {
        isDragging = true;
        lastX = e.ClientX;
        lastY = e.ClientY;
    }

    private void Drag(MouseEventArgs e)
    {
        if (isDragging)
        {
            var deltaX = e.ClientX - lastX;
            var deltaY = e.ClientY - lastY;
            lastX = e.ClientX;
            lastY = e.ClientY;

            // Pan logic would go here (currently simplified)
        }
    }

    private void EndDrag(MouseEventArgs e)
    {
        isDragging = false;
    }

    private async Task DownloadImage()
    {
        try
        {
            await JS.InvokeVoidAsync("fileDownload.downloadImage", ImageUrl, AltText ?? "image");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error downloading image: {ex.Message}");
        }
    }

    public void Dispose()
    {
        ThemeState.OnChange -= OnThemeChanged;
    }
}

<style>
    @@keyframes fade-in {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    .animate-fade-in {
        animation: fade-in 0.2s ease-out;
    }
</style>

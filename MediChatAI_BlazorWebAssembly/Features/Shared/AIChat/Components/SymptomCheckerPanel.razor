@using MediChatAI_BlazorWebAssembly.Features.Shared.AIChat.Models
@using MediChatAI_BlazorWebAssembly.Core.Services.Theme
@inject ThemeState ThemeState
@implements IDisposable

<div class="@(IsDarkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-200") rounded-2xl border-2 shadow-lg p-6">
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-lg font-bold @(IsDarkMode ? "text-white" : "text-gray-900") flex items-center gap-2">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-red-400 to-pink-500 flex items-center justify-center">
                <i class="fas fa-heartbeat text-white"></i>
            </div>
            Symptom Checker
        </h3>
        <button @onclick="@Close"
                class="w-8 h-8 rounded-lg @(IsDarkMode ? "hover:bg-gray-700" : "hover:bg-gray-100") flex items-center justify-center transition-colors">
            <i class="fas fa-times @(IsDarkMode ? "text-gray-400" : "text-gray-600")"></i>
        </button>
    </div>

    @if (!isAnalyzing)
    {
        <div class="space-y-4">
            <!-- Symptom Input -->
            <div>
                <label class="block text-sm font-semibold @(IsDarkMode ? "text-gray-300" : "text-gray-700") mb-2">
                    What symptoms are you experiencing?
                </label>
                <div class="flex gap-2">
                    <input type="text"
                           @bind="currentSymptom"
                           @onkeydown="@HandleSymptomKeyPress"
                           placeholder="E.g., headache, fever, cough..."
                           class="flex-1 px-4 py-2.5 rounded-xl @(IsDarkMode ? "bg-gray-700 text-white border-gray-600" : "bg-gray-50 text-gray-900 border-gray-300") border focus:ring-2 focus:ring-primary focus:border-transparent" />
                    <button @onclick="@AddSymptom"
                            disabled="@string.IsNullOrWhiteSpace(currentSymptom)"
                            class="px-4 py-2.5 rounded-xl bg-gradient-to-r from-primary to-accent text-white font-semibold disabled:opacity-50 disabled:cursor-not-allowed hover:shadow-lg transition-all">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>

            <!-- Symptoms List -->
            @if (symptoms.Any())
            {
                <div>
                    <label class="block text-sm font-semibold @(IsDarkMode ? "text-gray-300" : "text-gray-700") mb-2">
                        Selected Symptoms (@symptoms.Count)
                    </label>
                    <div class="flex flex-wrap gap-2">
                        @foreach (var symptom in symptoms)
                        {
                            <div class="px-3 py-1.5 rounded-lg @(IsDarkMode ? "bg-gray-700" : "bg-gray-100") flex items-center gap-2">
                                <span class="text-sm @(IsDarkMode ? "text-gray-200" : "text-gray-800")">@symptom</span>
                                <button @onclick="@(() => RemoveSymptom(symptom))"
                                        class="w-5 h-5 rounded-full @(IsDarkMode ? "hover:bg-gray-600" : "hover:bg-gray-200") flex items-center justify-center">
                                    <i class="fas fa-times text-xs @(IsDarkMode ? "text-gray-400" : "text-gray-600")"></i>
                                </button>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Duration -->
            <div>
                <label class="block text-sm font-semibold @(IsDarkMode ? "text-gray-300" : "text-gray-700") mb-2">
                    How long have you had these symptoms?
                </label>
                <select @bind="duration"
                        class="w-full px-4 py-2.5 rounded-xl @(IsDarkMode ? "bg-gray-700 text-white border-gray-600" : "bg-gray-50 text-gray-900 border-gray-300") border focus:ring-2 focus:ring-primary">
                    <option value="">Select duration...</option>
                    <option value="less_than_24h">Less than 24 hours</option>
                    <option value="1_3_days">1-3 days</option>
                    <option value="4_7_days">4-7 days</option>
                    <option value="1_2_weeks">1-2 weeks</option>
                    <option value="more_than_2_weeks">More than 2 weeks</option>
                </select>
            </div>

            <!-- Severity -->
            <div>
                <label class="block text-sm font-semibold @(IsDarkMode ? "text-gray-300" : "text-gray-700") mb-2">
                    How severe are your symptoms?
                </label>
                <div class="grid grid-cols-3 gap-2">
                    @foreach (var sev in new[] { ("mild", "Mild", "text-green-500"), ("moderate", "Moderate", "text-yellow-500"), ("severe", "Severe", "text-red-500") })
                    {
                        <button @onclick="@(() => severity = sev.Item1)"
                                class="px-4 py-3 rounded-xl border-2 @(severity == sev.Item1 ? $"border-primary {(IsDarkMode ? "bg-primary/10" : "bg-primary/5")}" : $"{(IsDarkMode ? "border-gray-700 hover:border-gray-600" : "border-gray-200 hover:border-gray-300")}") transition-all">
                            <i class="fas fa-circle @sev.Item3 text-sm mb-1"></i>
                            <div class="text-sm font-semibold @(IsDarkMode ? "text-gray-200" : "text-gray-800")">@sev.Item2</div>
                        </button>
                    }
                </div>
            </div>

            <!-- Analyze Button -->
            <button @onclick="@AnalyzeSymptoms"
                    disabled="@(!symptoms.Any())"
                    class="w-full px-6 py-3.5 rounded-xl bg-gradient-to-r from-red-500 to-pink-600 text-white font-bold disabled:opacity-50 disabled:cursor-not-allowed hover:shadow-xl transition-all hover:scale-105 disabled:hover:scale-100">
                <i class="fas fa-stethoscope mr-2"></i>
                Analyze Symptoms
            </button>
        </div>
    }
    else
    {
        <div class="flex flex-col items-center justify-center py-12">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-red-400 to-pink-500 flex items-center justify-center mb-4 animate-pulse">
                <i class="fas fa-stethoscope text-white text-2xl"></i>
            </div>
            <p class="text-lg font-semibold @(IsDarkMode ? "text-white" : "text-gray-900") mb-2">
                Analyzing your symptoms...
            </p>
            <p class="text-sm @(IsDarkMode ? "text-gray-400" : "text-gray-600")">
                This may take a few moments
            </p>
        </div>
    }
</div>

@code {
    [Parameter] public EventCallback<SymptomInput> OnAnalyze { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private List<string> symptoms = new();
    private string currentSymptom = string.Empty;
    private string duration = string.Empty;
    private string severity = "moderate";
    private bool isAnalyzing = false;

    private bool IsDarkMode => ThemeState.CurrentTheme.Mode == "dark";

    protected override void OnInitialized()
    {
        ThemeState.OnChange += OnThemeChanged;
    }

    private void OnThemeChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void HandleSymptomKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(currentSymptom))
        {
            AddSymptom();
        }
    }

    private void AddSymptom()
    {
        if (!string.IsNullOrWhiteSpace(currentSymptom) && !symptoms.Contains(currentSymptom.Trim(), StringComparer.OrdinalIgnoreCase))
        {
            symptoms.Add(currentSymptom.Trim());
            currentSymptom = string.Empty;
        }
    }

    private void RemoveSymptom(string symptom)
    {
        symptoms.Remove(symptom);
    }

    private async Task AnalyzeSymptoms()
    {
        if (!symptoms.Any()) return;

        isAnalyzing = true;

        var input = new SymptomInput
        {
            Symptoms = symptoms,
            Duration = duration,
            Severity = severity
        };

        await OnAnalyze.InvokeAsync(input);

        // Reset state
        isAnalyzing = false;
        symptoms.Clear();
        currentSymptom = string.Empty;
        duration = string.Empty;
        severity = "moderate";
    }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }

    public void Dispose()
    {
        ThemeState.OnChange -= OnThemeChanged;
    }
}

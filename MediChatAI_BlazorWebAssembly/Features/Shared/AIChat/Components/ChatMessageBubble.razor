@using MediChatAI_BlazorWebAssembly.Features.Shared.AIChat.Models
@using MediChatAI_BlazorWebAssembly.Core.Services.Theme
@using MediChatAI_BlazorWebAssembly.Core.Components.UI
@inject ThemeState ThemeState
@implements IDisposable

<div class="flex items-start gap-3 mb-6 @(IsUser ? "flex-row-reverse" : "flex-row") animate-fade-in">
    <!-- Avatar -->
    <div class="flex-shrink-0">
        @if (IsUser)
        {
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-accent flex items-center justify-center shadow-lg">
                <i class="fas fa-user text-white text-sm"></i>
            </div>
        }
        else
        {
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-emerald-400 to-cyan-500 flex items-center justify-center shadow-lg">
                <i class="fas fa-robot text-white text-sm"></i>
            </div>
        }
    </div>

    <!-- Message Content -->
    <div class="flex-1 w-full max-w-full sm:max-w-2xl md:max-w-3xl lg:max-w-4xl">
        <!-- Message Header -->
        <div class="flex items-center gap-2 mb-1.5 @(IsUser ? "justify-end" : "justify-start")">
            <span class="text-xs font-semibold @(IsDarkMode ? "text-gray-400" : "text-gray-600")">
                @(IsUser ? "You" : "AI Assistant")
            </span>
            <span class="text-xs @(IsDarkMode ? "text-gray-500" : "text-gray-400")">
                @Message.Timestamp.ToLocalTime().ToString("h:mm tt")
            </span>
        </div>

        <!-- Message Bubble -->
        <div class="@GetMessageBubbleClass() rounded-2xl shadow-md transition-all duration-200 hover:shadow-lg">
            @if (Message.IsLoading)
            {
                <div class="flex items-center gap-3">
                    <div class="flex gap-1">
                        <span class="w-2 h-2 rounded-full bg-current animate-bounce" style="animation-delay: 0ms"></span>
                        <span class="w-2 h-2 rounded-full bg-current animate-bounce" style="animation-delay: 150ms"></span>
                        <span class="w-2 h-2 rounded-full bg-current animate-bounce" style="animation-delay: 300ms"></span>
                    </div>
                    <span class="text-sm">AI is thinking...</span>
                </div>
            }
            else
            {
                <!-- Text Content -->
                @if (!string.IsNullOrEmpty(Message.Content))
                {
                    <div class="prose prose-sm max-w-none @(IsDarkMode && !IsUser ? "prose-invert" : "")">
                        <MarkdownRenderer Content="@Message.Content" />
                    </div>
                }

                <!-- Image Attachments -->
                @if (Message.Attachments?.Any() == true)
                {
                    <div class="mt-3 space-y-2">
                        @foreach (var attachment in Message.Attachments)
                        {
                            @if (attachment.FileType.StartsWith("image/"))
                            {
                                <div class="relative group rounded-xl overflow-hidden max-w-sm">
                                    <img src="@GetImageUrl(attachment.Url)"
                                         alt="@attachment.FileName"
                                         class="w-full h-auto object-cover rounded-xl" />
                                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-all duration-200 flex items-center justify-center opacity-0 group-hover:opacity-100">
                                        <button @onclick="@(() => ViewImage(attachment.Url))"
                                                class="px-4 py-2 bg-white rounded-lg shadow-lg text-gray-900 font-semibold text-sm">
                                            <i class="fas fa-expand mr-2"></i>View Full Size
                                        </button>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                }

                <!-- Symptom Analysis Results -->
                @if (Message.Metadata?.SymptomAnalysis != null)
                {
                    <div class="mt-4 @(IsUser ? "" : (IsDarkMode ? "bg-gray-800/50" : "bg-blue-50")) rounded-xl p-4 border @(IsDarkMode ? "border-gray-700" : "border-blue-200")">
                        <h4 class="font-semibold text-sm mb-3 flex items-center gap-2 @(IsDarkMode ? "text-blue-300" : "text-blue-900")">
                            <i class="fas fa-notes-medical"></i>
                            Symptom Analysis
                        </h4>
                        <div class="space-y-3">
                            @if (Message.Metadata.SymptomAnalysis.UrgencyLevel != "low")
                            {
                                <div class="@GetUrgencyClass(Message.Metadata.SymptomAnalysis.UrgencyLevel) rounded-lg p-3">
                                    <div class="flex items-center gap-2 mb-1">
                                        <i class="fas fa-exclamation-circle"></i>
                                        <span class="font-semibold text-sm">Urgency: @Message.Metadata.SymptomAnalysis.UrgencyLevel.ToUpper()</span>
                                    </div>
                                    <p class="text-sm">@Message.Metadata.SymptomAnalysis.UrgencyMessage</p>
                                </div>
                            }

                            @if (Message.Metadata.SymptomAnalysis.RecommendedActions?.Any() == true)
                            {
                                <div>
                                    <h5 class="text-xs font-semibold @(IsDarkMode ? "text-gray-300" : "text-gray-700") mb-2">Recommended Actions:</h5>
                                    <ul class="text-sm space-y-1 ml-4 list-disc @(IsDarkMode ? "text-gray-300" : "text-gray-800")">
                                        @foreach (var action in Message.Metadata.SymptomAnalysis.RecommendedActions)
                                        {
                                            <li>@action</li>
                                        }
                                    </ul>
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- Image Analysis Results -->
                @if (Message.Metadata?.ImageAnalysis != null)
                {
                    <div class="mt-4 @(IsUser ? "" : (IsDarkMode ? "bg-gray-800/50" : "bg-purple-50")) rounded-xl p-4 border @(IsDarkMode ? "border-gray-700" : "border-purple-200")">
                        <h4 class="font-semibold text-sm mb-3 flex items-center gap-2 @(IsDarkMode ? "text-purple-300" : "text-purple-900")">
                            <i class="fas fa-image"></i>
                            Image Analysis
                        </h4>
                        <div class="space-y-3">
                            <p class="text-sm @(IsDarkMode ? "text-gray-300" : "text-gray-800")">
                                @Message.Metadata.ImageAnalysis.Analysis
                            </p>

                            @if (Message.Metadata.ImageAnalysis.Recommendations?.Any() == true)
                            {
                                <div>
                                    <h5 class="text-xs font-semibold @(IsDarkMode ? "text-gray-300" : "text-gray-700") mb-2">Recommendations:</h5>
                                    <ul class="text-sm space-y-1 ml-4 list-disc @(IsDarkMode ? "text-gray-300" : "text-gray-800")">
                                        @foreach (var recommendation in Message.Metadata.ImageAnalysis.Recommendations)
                                        {
                                            <li>@recommendation</li>
                                        }
                                    </ul>
                                </div>
                            }

                            <div class="text-xs @(IsDarkMode ? "text-gray-500" : "text-gray-600") italic mt-3 pt-3 border-t @(IsDarkMode ? "border-gray-700" : "border-purple-200")">
                                <i class="fas fa-info-circle mr-1"></i>
                                @Message.Metadata.ImageAnalysis.Disclaimer
                            </div>
                        </div>
                    </div>
                }

                <!-- Suggested Actions -->
                @if (Message.Metadata?.SuggestedActions?.Any() == true)
                {
                    <div class="mt-4 flex flex-wrap gap-2">
                        @foreach (var action in Message.Metadata.SuggestedActions)
                        {
                            <button @onclick="@(() => OnSuggestedActionClick(action))"
                                    class="px-3 py-1.5 text-xs font-semibold rounded-lg @(IsDarkMode ? "bg-gray-700 hover:bg-gray-600 text-gray-200" : "bg-gray-200 hover:bg-gray-300 text-gray-800") transition-colors duration-200">
                                @action
                            </button>
                        }
                    </div>
                }
            }
        </div>

        <!-- Timestamp (for older messages) -->
        @if ((DateTime.UtcNow - Message.Timestamp).TotalHours > 24)
        {
            <div class="text-xs @(IsDarkMode ? "text-gray-600" : "text-gray-400") mt-1 @(IsUser ? "text-right" : "text-left")">
                @Message.Timestamp.ToLocalTime().ToString("MMM dd, yyyy")
            </div>
        }
    </div>
</div>

@code {
    [Parameter, EditorRequired] public ChatMessage Message { get; set; } = null!;
    [Parameter] public EventCallback<string> OnSuggestedAction { get; set; }
    [Parameter] public Action<string, string>? OnViewImage { get; set; }

    private bool IsUser => Message.Role == "user";
    private bool IsDarkMode => ThemeState.CurrentTheme.Mode == "dark";

    protected override void OnInitialized()
    {
        ThemeState.OnChange += OnThemeChanged;
    }

    private void OnThemeChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private string GetMessageBubbleClass()
    {
        if (IsUser)
        {
            return $"p-4 bg-gradient-to-br from-primary to-accent text-white";
        }
        else
        {
            return IsDarkMode
                ? "p-4 bg-gray-800 border border-gray-700 text-gray-100"
                : "p-4 bg-white border border-gray-200 text-gray-900";
        }
    }

    private string GetUrgencyClass(string urgency)
    {
        var baseClass = "text-sm";
        return urgency.ToLower() switch
        {
            "emergency" => $"{baseClass} bg-red-100 dark:bg-red-900/30 text-red-900 dark:text-red-200 border border-red-300 dark:border-red-700",
            "high" => $"{baseClass} bg-orange-100 dark:bg-orange-900/30 text-orange-900 dark:text-orange-200 border border-orange-300 dark:border-orange-700",
            "medium" => $"{baseClass} bg-yellow-100 dark:bg-yellow-900/30 text-yellow-900 dark:text-yellow-200 border border-yellow-300 dark:border-yellow-700",
            _ => $"{baseClass} bg-green-100 dark:bg-green-900/30 text-green-900 dark:text-green-200 border border-green-300 dark:border-green-700"
        };
    }

    private string GetImageUrl(string url)
    {
        if (string.IsNullOrEmpty(url))
            return "";

        return url.StartsWith("http") ? url : $"http://localhost:5095{url}";
    }

    private void ViewImage(string url)
    {
        OnViewImage?.Invoke(url, Message.Attachments?.FirstOrDefault(a => a.Url == url)?.FileName ?? "Image");
    }

    private async Task OnSuggestedActionClick(string action)
    {
        await OnSuggestedAction.InvokeAsync(action);
    }

    public void Dispose()
    {
        ThemeState.OnChange -= OnThemeChanged;
    }
}

<style>
    @@keyframes fade-in {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in {
        animation: fade-in 0.3s ease-out;
    }
</style>

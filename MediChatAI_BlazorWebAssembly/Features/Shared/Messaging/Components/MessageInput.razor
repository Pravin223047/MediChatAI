@* Message Input Component *@

<div class="p-4 @(IsDarkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-200") border-t">
    @* Reply Preview *@
    @if (ReplyToMessage != null)
    {
        <div class="mb-3 p-3 rounded-lg @(IsDarkMode ? "bg-gray-700" : "bg-gray-100") border-l-4 border-primary">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-medium @(IsDarkMode ? "text-gray-300" : "text-gray-600")">Replying to @ReplyToMessage.SenderName</span>
                <button @onclick="ClearReply" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </div>
            <p class="text-sm @(IsDarkMode ? "text-gray-400" : "text-gray-500") truncate">
                @(ReplyToMessage.Content.Length > 60 ? ReplyToMessage.Content.Substring(0, 60) + "..." : ReplyToMessage.Content)
            </p>
        </div>
    }

    @* Smart Reply Suggestions *@
    @SmartReplyPanelContent

    @* File Preview Grid *@
    @FilePreviewContent

    <div class="flex items-center gap-3">
        <button @onclick="HandleOpenFileSelector"
                disabled="@(!HasSelectedConversation)"
                class="flex items-center justify-center w-10 h-10 rounded-lg @(IsDarkMode ? "hover:bg-gray-700 text-gray-300" : "hover:bg-gray-100 text-gray-600") transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-paperclip text-lg"></i>
        </button>

        @* Voice Recorder *@
        <div class="flex items-center">
            @VoiceRecorderContent
        </div>

        <div class="flex-1 relative">
            <textarea @ref="MessageInputElement"
                      @bind="Message"
                      @bind:event="oninput"
                      @bind:after="HandleMessageChange"
                      @onkeydown="HandleKeyDown"
                      rows="1"
                      placeholder="@(HasSelectedConversation ? "Type a message..." : "Select a conversation to start messaging")"
                      disabled="@(!HasSelectedConversation)"
                      class="w-full px-4 py-3 rounded-lg @(IsDarkMode ? "bg-gray-700 text-white border-gray-600 placeholder-gray-400" : "bg-gray-50 text-gray-900 border-gray-300 placeholder-gray-500") border focus:ring-2 focus:ring-primary focus:border-transparent resize-none transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                      style="max-height: 120px; min-height: 44px;"></textarea>
        </div>

        <button @onclick="HandleSend"
                disabled="@(!CanSend)"
                class="flex items-center justify-center w-10 h-10 rounded-lg bg-primary text-white hover:bg-primary-dark disabled:opacity-50 disabled:cursor-not-allowed transition-all transform hover:scale-105 active:scale-95">
            @if (IsSending)
            {
                <i class="fas fa-spinner fa-spin text-lg"></i>
            }
            else
            {
                <i class="fas fa-paper-plane text-lg"></i>
            }
        </button>
    </div>
</div>

@code {
    [Parameter]
    public string Message { get; set; } = string.Empty;

    [Parameter]
    public EventCallback<string> MessageChanged { get; set; }

    [Parameter]
    public bool IsSending { get; set; }

    [Parameter]
    public bool IsDarkMode { get; set; }

    [Parameter]
    public bool HasSelectedConversation { get; set; }

    [Parameter]
    public bool HasFiles { get; set; }

    [Parameter]
    public EventCallback OnSend { get; set; }

    [Parameter]
    public EventCallback OnOpenFileSelector { get; set; }

    [Parameter]
    public EventCallback<KeyboardEventArgs> OnKeyDown { get; set; }

    [Parameter]
    public EventCallback OnTyping { get; set; }

    [Parameter]
    public RenderFragment? SmartReplyPanelContent { get; set; }

    [Parameter]
    public RenderFragment? FilePreviewContent { get; set; }

    [Parameter]
    public RenderFragment? VoiceRecorderContent { get; set; }

    [Parameter]
    public ReplyMessageData? ReplyToMessage { get; set; }

    [Parameter]
    public EventCallback OnClearReply { get; set; }

    public ElementReference MessageInputElement { get; set; }

    private bool CanSend => HasSelectedConversation && (!string.IsNullOrWhiteSpace(Message) || HasFiles) && !IsSending;

    private async Task HandleMessageChange()
    {
        await MessageChanged.InvokeAsync(Message);
        await OnTyping.InvokeAsync();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        await OnKeyDown.InvokeAsync(e);
    }

    private async Task HandleSend()
    {
        await OnSend.InvokeAsync();
    }

    private async Task HandleOpenFileSelector()
    {
        await OnOpenFileSelector.InvokeAsync();
    }

    private async Task ClearReply()
    {
        await OnClearReply.InvokeAsync();
    }

    public class ReplyMessageData
    {
        public string Id { get; set; } = string.Empty;
        public string Content { get; set; } = string.Empty;
        public string SenderName { get; set; } = string.Empty;
        public bool IsSentByMe { get; set; }
    }
}

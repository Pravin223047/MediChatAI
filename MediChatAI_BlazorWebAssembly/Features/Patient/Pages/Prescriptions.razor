@page "/patient/prescriptions"
@using Microsoft.AspNetCore.Components.Authorization
@using MediChatAI_BlazorWebAssembly.Core.Services.Theme
@using MediChatAI_BlazorWebAssembly.Features.Patient.DTOs
@inject ThemeState ThemeState
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IToastService ToastService
@inject ILogger<Prescriptions> Logger
@inject AppSettingsState AppSettings
@inject MediChatAI_BlazorWebAssembly.Features.Patient.Services.IPrescriptionService PrescriptionService

<PageTitle>My Prescriptions - @AppSettings.Settings.SiteName</PageTitle>

<AuthorizeRouteGuard RequiredRole="Patient">

<div class="min-h-screen transition-colors duration-300 @(IsDarkMode ? "bg-gray-900" : "bg-gradient-to-br from-gray-50 to-gray-100") py-8">
    <div class="w-full mx-auto px-4 sm:px-6 lg:px-8">

        <!-- Header -->
        <div class="mb-8">
            <button @onclick='() => Navigation.NavigateTo("/patient/dashboard")'
                    class="inline-flex items-center gap-2 @(IsDarkMode ? "text-gray-400 hover:text-white" : "text-gray-600 hover:text-gray-900") mb-4 transition-colors">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Dashboard</span>
            </button>
            <h1 class="text-4xl font-bold @(IsDarkMode ? "text-white" : "text-gray-900") mb-2">
                <i class="fas fa-pills text-orange-500 mr-3"></i>
                My Prescriptions
            </h1>
            <p class="@(IsDarkMode ? "text-gray-400" : "text-gray-600") text-lg">
                Manage your medications and prescription refills
            </p>
        </div>

        <!-- Filter Tabs & Search -->
        <div class="@GetCardClasses() p-6 mb-6">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                <div class="flex flex-wrap gap-2">
                    <button @onclick='() => SelectFilter("active")'
                            class='@GetFilterButtonClass("active")'>
                        <i class="fas fa-check-circle mr-2"></i>
                        Active (@activeCount)
                    </button>
                    <button @onclick='() => SelectFilter("expired")'
                            class='@GetFilterButtonClass("expired")'>
                        <i class="fas fa-clock mr-2"></i>
                        Expired (@expiredCount)
                    </button>
                    <button @onclick='() => SelectFilter("all")'
                            class='@GetFilterButtonClass("all")'>
                        <i class="fas fa-list mr-2"></i>
                        All (@totalCount)
                    </button>
                </div>

                <!-- Search Bar -->
                <div class="relative w-full sm:w-64">
                    <input @bind="searchQuery" @bind:event="oninput" @onkeyup="HandleSearch"
                           type="text"
                           placeholder="Search medications..."
                           class="w-full pl-10 pr-4 py-2 rounded-lg @(IsDarkMode ? "bg-gray-700 text-white border-gray-600" : "bg-white text-gray-900 border-gray-300") border focus:ring-2 focus:ring-primary" />
                    <i class="fas fa-search absolute left-3 top-3 @(IsDarkMode ? "text-gray-400" : "text-gray-500")"></i>
                </div>
            </div>
        </div>

        @if (isLoading)
        {
            <!-- Loading State -->
            <div class="@GetCardClasses() p-16 text-center">
                <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-primary border-t-transparent mb-4"></div>
                <p class="@(IsDarkMode ? "text-gray-400" : "text-gray-600") text-lg">Loading prescriptions...</p>
            </div>
        }
        else if (filteredPrescriptions.Count == 0)
        {
            <!-- Empty State -->
            <div class="@GetCardClasses() p-16 text-center">
                <div class="mx-auto w-24 h-24 bg-gradient-to-br @(IsDarkMode ? "from-gray-700 to-gray-600" : "from-gray-100 to-gray-200") rounded-full flex items-center justify-center mb-6">
                    <i class="fas fa-prescription-bottle text-5xl @(IsDarkMode ? "text-gray-500" : "text-gray-400")"></i>
                </div>
                <h3 class="text-2xl font-bold @(IsDarkMode ? "text-white" : "text-gray-900") mb-2">
                    @(currentFilter == "active" ? "No Active Prescriptions" :
                      currentFilter == "expired" ? "No Expired Prescriptions" : "No Prescriptions Found")
                </h3>
                <p class="@(IsDarkMode ? "text-gray-400" : "text-gray-600")">
                    @(string.IsNullOrEmpty(searchQuery)
                        ? "You don't have any prescriptions in this category."
                        : "No prescriptions match your search criteria.")
                </p>
            </div>
        }
        else
        {
            <!-- Prescriptions Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                @foreach (var prescription in filteredPrescriptions)
                {
                    <div class="@GetCardClasses() p-6 hover:shadow-xl transition-all group">
                        <!-- Header with Medication Name & Status -->
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center gap-3 flex-1">
                                <div class="w-14 h-14 rounded-full bg-gradient-to-br from-orange-400 to-red-500 flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-pills text-white text-2xl"></i>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-xl font-bold @(IsDarkMode ? "text-white" : "text-gray-900")">
                                        @(prescription.Items.FirstOrDefault()?.MedicationName ?? "Prescription")
                                        @if (prescription.Items.Count > 1)
                                        {
                                            <span class="text-sm @(IsDarkMode ? "text-gray-400" : "text-gray-600")"> +@(prescription.Items.Count - 1) more</span>
                                        }
                                    </h3>
                                    <p class="text-sm @(IsDarkMode ? "text-gray-400" : "text-gray-600")">
                                        @(prescription.Items.FirstOrDefault()?.GenericName)
                                    </p>
                                </div>
                            </div>
                            <span class='@GetPrescriptionStatusBadge(prescription.Status)'>
                                @prescription.Status.ToString()
                            </span>
                        </div>

                        <!-- Prescription Details -->
                        <div class="space-y-3 mb-4">
                            <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-capsules w-5 text-primary"></i>
                                <span class="@(IsDarkMode ? "text-gray-400" : "text-gray-600")">Dosage:</span>
                                <span class="font-semibold @(IsDarkMode ? "text-white" : "text-gray-900")">
                                    @(prescription.Items.FirstOrDefault()?.Dosage ?? "N/A")
                                </span>
                            </div>
                            <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-clock w-5 text-primary"></i>
                                <span class="@(IsDarkMode ? "text-gray-400" : "text-gray-600")">Frequency:</span>
                                <span class="font-semibold @(IsDarkMode ? "text-white" : "text-gray-900")">
                                    @(prescription.Items.FirstOrDefault()?.Frequency ?? "N/A")
                                </span>
                            </div>
                            <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-calendar-alt w-5 text-primary"></i>
                                <span class="@(IsDarkMode ? "text-gray-400" : "text-gray-600")">Duration:</span>
                                <span class="font-semibold @(IsDarkMode ? "text-white" : "text-gray-900")">
                                    @(prescription.Items.FirstOrDefault()?.DurationDays ?? 0) days
                                </span>
                            </div>
                            <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-user-md w-5 text-primary"></i>
                                <span class="@(IsDarkMode ? "text-gray-400" : "text-gray-600")">Prescribed by:</span>
                                <span class="font-semibold @(IsDarkMode ? "text-white" : "text-gray-900")">
                                    Dr. @prescription.DoctorName
                                </span>
                            </div>
                            <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-calendar-day w-5 text-primary"></i>
                                <span class="@(IsDarkMode ? "text-gray-400" : "text-gray-600")">Prescribed on:</span>
                                <span class="font-semibold @(IsDarkMode ? "text-white" : "text-gray-900")">
                                    @prescription.PrescribedDate.ToString("MMM dd, yyyy")
                                </span>
                            </div>
                        </div>

                        <!-- Refills Section -->
                        <div class="p-3 rounded-lg @(IsDarkMode ? "bg-gray-700/50" : "bg-gray-100") mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium @(IsDarkMode ? "text-gray-300" : "text-gray-700")">
                                    <i class="fas fa-redo mr-1"></i>
                                    Refills
                                </span>
                                <span class="text-sm font-bold @(IsDarkMode ? "text-white" : "text-gray-900")">
                                    @prescription.RefillsUsed / @prescription.RefillsAllowed
                                </span>
                            </div>
                            <div class="w-full bg-gray-300 dark:bg-gray-600 rounded-full h-2">
                                <div class="bg-gradient-to-r from-primary to-accent h-2 rounded-full transition-all"
                                     style="width: @((prescription.RefillsAllowed > 0 ? (prescription.RefillsUsed / (double)prescription.RefillsAllowed * 100) : 0))%"></div>
                            </div>
                        </div>

                        <!-- Instructions -->
                        @if (!string.IsNullOrEmpty(prescription.Items.FirstOrDefault()?.Instructions))
                        {
                            <div class="p-3 rounded-lg @(IsDarkMode ? "bg-blue-900/20 border-blue-700" : "bg-blue-50 border-blue-200") border mb-4">
                                <p class="text-xs @(IsDarkMode ? "text-blue-300" : "text-blue-800") flex items-start gap-2">
                                    <i class="fas fa-info-circle mt-0.5"></i>
                                    <span>@prescription.Items.FirstOrDefault()?.Instructions</span>
                                </p>
                            </div>
                        }

                        <!-- Action Buttons -->
                        <div class="flex gap-2">
                            @if (prescription.Status == PrescriptionStatus.Active && prescription.RefillsUsed < prescription.RefillsAllowed)
                            {
                                <button @onclick="() => RequestRefill(prescription.Id)"
                                        class="flex-1 px-4 py-2.5 bg-gradient-to-r from-primary to-accent text-white rounded-lg hover:shadow-lg transition-all font-semibold flex items-center justify-center gap-2">
                                    <i class="fas fa-redo"></i>
                                    Request Refill
                                </button>
                            }
                            <button @onclick="() => DownloadPrescription(prescription.Id)"
                                    class="px-4 py-2.5 @(IsDarkMode ? "bg-gray-700 hover:bg-gray-600" : "bg-gray-200 hover:bg-gray-300") text-gray-700 dark:text-gray-300 rounded-lg transition-all font-semibold">
                                <i class="fas fa-download"></i>
                            </button>
                            <button @onclick="() => ToggleReminder(prescription.Id)"
                                    class="px-4 py-2.5 @(IsDarkMode ? "bg-gray-700 text-gray-300" : "bg-gray-200 text-gray-700") rounded-lg hover:opacity-80 transition-all">
                                <i class="fas fa-bell-slash"></i>
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

<!-- Refill Confirmation Modal -->
@if (showRefillModal)
{
    <div class="fixed inset-0 z-50 overflow-y-auto bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="@GetCardClasses() max-w-md w-full p-6 transform transition-all">
            <h3 class="text-xl font-bold @(IsDarkMode ? "text-white" : "text-gray-900") mb-4">
                <i class="fas fa-redo text-primary mr-2"></i>
                Request Prescription Refill
            </h3>
            <p class="@(IsDarkMode ? "text-gray-400" : "text-gray-600") mb-4">
                Your refill request will be sent to your doctor for approval. You'll receive a notification once it's processed.
            </p>
            <div class="p-4 rounded-lg @(IsDarkMode ? "bg-gray-700/50" : "bg-gray-100") mb-4">
                <p class="font-semibold @(IsDarkMode ? "text-white" : "text-gray-900") mb-1">
                    @(selectedPrescription?.Items.FirstOrDefault()?.MedicationName ?? "Medication")
                </p>
                <p class="text-sm @(IsDarkMode ? "text-gray-400" : "text-gray-600")">
                    Dosage: @(selectedPrescription?.Items.FirstOrDefault()?.Dosage ?? "N/A")
                </p>
            </div>
            <div class="flex gap-3">
                <button @onclick="CloseRefillModal"
                        class="flex-1 px-4 py-2 @(IsDarkMode ? "bg-gray-700" : "bg-gray-200") text-gray-700 dark:text-gray-300 rounded-lg hover:opacity-80 transition-opacity font-semibold">
                    Cancel
                </button>
                <button @onclick="ConfirmRefillRequest" disabled="@isRequestingRefill"
                        class="flex-1 px-4 py-2 bg-gradient-to-r from-primary to-accent text-white rounded-lg hover:opacity-90 transition-opacity font-semibold disabled:opacity-50">
                    @(isRequestingRefill ? "Requesting..." : "Confirm Request")
                </button>
            </div>
        </div>
    </div>
}

</AuthorizeRouteGuard>

@code {
    private bool IsDarkMode => ThemeState.CurrentTheme.Mode == "dark";

    // State
    private bool isLoading = true;
    private string currentFilter = "active";
    private string searchQuery = "";
    private bool showRefillModal = false;
    private bool isRequestingRefill = false;
    private PrescriptionDto? selectedPrescription = null;

    // Data
    private List<PrescriptionDto> allPrescriptions = new();
    private List<PrescriptionDto> filteredPrescriptions = new();
    private int totalCount => allPrescriptions.Count;
    private int activeCount => allPrescriptions.Count(p => p.Status == PrescriptionStatus.Active);
    private int expiredCount => allPrescriptions.Count(p => p.Status == PrescriptionStatus.Expired);

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadPrescriptions();
            isLoading = false;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading prescriptions");
            ToastService.ShowError("Failed to load prescriptions");
            isLoading = false;
        }
    }

    private async Task LoadPrescriptions()
    {
        allPrescriptions = await PrescriptionService.GetMyPrescriptionsAsync();
        FilterPrescriptions();
    }

    private void SelectFilter(string filter)
    {
        currentFilter = filter;
        FilterPrescriptions();
    }

    private void FilterPrescriptions()
    {
        var filtered = allPrescriptions.AsEnumerable();

        // Apply filter
        if (currentFilter == "active")
            filtered = filtered.Where(p => p.Status == PrescriptionStatus.Active);
        else if (currentFilter == "expired")
            filtered = filtered.Where(p => p.Status == PrescriptionStatus.Expired);

        // Apply search
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            filtered = filtered.Where(p =>
                p.Items.Any(i => i.MedicationName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                (i.GenericName != null && i.GenericName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase))));
        }

        filteredPrescriptions = filtered.OrderByDescending(p => p.PrescribedDate).ToList();
    }

    private void HandleSearch()
    {
        FilterPrescriptions();
    }

    private string GetFilterButtonClass(string filter)
    {
        var baseClass = "px-4 py-2 rounded-lg font-semibold transition-all";
        if (currentFilter == filter)
            return $"{baseClass} bg-primary text-white shadow-lg";
        return $"{baseClass} {(IsDarkMode ? "bg-gray-700 text-gray-300 hover:bg-gray-600" : "bg-gray-200 text-gray-700 hover:bg-gray-300")}";
    }

    private string GetPrescriptionStatusBadge(PrescriptionStatus status)
    {
        var baseClass = "px-2.5 py-1 rounded-full text-xs font-bold";
        return status switch
        {
            PrescriptionStatus.Active => $"{baseClass} bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400",
            PrescriptionStatus.Completed => $"{baseClass} bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400",
            PrescriptionStatus.Cancelled => $"{baseClass} bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400",
            PrescriptionStatus.Expired => $"{baseClass} bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-400",
            _ => $"{baseClass} bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-400"
        };
    }

    private void RequestRefill(int prescriptionId)
    {
        selectedPrescription = allPrescriptions.FirstOrDefault(p => p.Id == prescriptionId);
        showRefillModal = true;
    }

    private void CloseRefillModal()
    {
        showRefillModal = false;
        selectedPrescription = null;
    }

    private async Task ConfirmRefillRequest()
    {
        isRequestingRefill = true;
        try
        {
            if (selectedPrescription == null)
                return;

            var success = await PrescriptionService.RequestRefillAsync(selectedPrescription.Id);

            if (success)
            {
                ToastService.ShowSuccess("Refill request sent successfully! Your doctor will review it shortly.");
                await LoadPrescriptions(); // Reload prescriptions to get updated data
            }
            else
            {
                ToastService.ShowError("Failed to request refill. Please try again.");
            }

            CloseRefillModal();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error requesting refill");
            ToastService.ShowError("Failed to request refill");
        }
        finally
        {
            isRequestingRefill = false;
        }
    }

    private void DownloadPrescription(int prescriptionId)
    {
        // TODO: Implement PDF download
        ToastService.ShowInfo("Prescription download feature coming soon!");
    }

    private void ToggleReminder(int prescriptionId)
    {
        // TODO: Implement medication reminder toggle
        ToastService.ShowInfo("Medication reminder feature coming soon!");
    }

    private string GetCardClasses()
    {
        return IsDarkMode
            ? "bg-gray-800/50 backdrop-blur-sm border border-gray-700 rounded-xl shadow-lg"
            : "bg-white/80 backdrop-blur-sm rounded-xl shadow-lg";
    }
}

@using MediChatAI_BlazorWebAssembly.Core.Services.Theme
@inject IJSRuntime JS
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject IThemeService ThemeService
@inject ThemeState ThemeState

@if (IsOpen)
{
    <!-- Modal Overlay with Glassmorphism -->
    <div @onclick="CloseModal"
         style="position: fixed !important; height:100%; width:100%; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; z-index: 9999 !important; display: flex !important; align-items: center !important; justify-content: center !important; padding: 1rem !important; background: @GetOverlayBackground() !important; backdrop-filter: blur(12px) !important; -webkit-backdrop-filter: blur(12px) !important; animation: fadeIn 0.3s ease-out !important; overflow-y: auto !important;">

        <!-- Modal Container -->
        <div @onclick:stopPropagation="true"
             class="w-full max-w-3xl my-8 rounded-2xl @GetModalBackground() shadow-2xl flex flex-col @GetModalBorder()"
             style="max-height: 90vh; animation: slideUp 0.3s ease-out;">

            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 md:px-8 py-6 @GetHeaderBorder() bg-gradient-to-r @GetHeaderGradient() flex-shrink-0">
                <div class="flex items-center gap-3">
                    <i class="fas fa-palette text-3xl @GetHeaderIconColor()"></i>
                    <h2 class="text-2xl font-bold @GetHeaderTextColor()">Theme Settings</h2>
                </div>
                <button @onclick="CloseModal"
                        type="button"
                        class="p-2 rounded-lg transition-all duration-200 @GetCloseButtonClasses() cursor-pointer text-xl"
                        title="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="px-6 md:px-8 py-6 overflow-y-auto flex-1">
                <!-- Theme Mode Section -->
                <div class="mb-6">
                    <h3 class="flex items-center gap-2 text-base font-semibold @GetSectionHeadingColor() mb-4">
                        <i class="fas fa-moon text-lg text-primary"></i>
                        Theme Mode
                    </h3>
                    <div class="grid grid-cols-3 gap-3">
                        <button @onclick="@(() => SelectMode("light"))"
                                type="button"
                                class="flex flex-col items-center justify-center gap-2 p-4 rounded-xl border-2 transition-all duration-300 cursor-pointer @GetModeButtonClasses("light")">
                            <i class="fas fa-sun text-2xl @GetModeIconClasses("light")"></i>
                            <span class="text-sm font-semibold">Light</span>
                        </button>
                        <button @onclick="@(() => SelectMode("dark"))"
                                type="button"
                                class="flex flex-col items-center justify-center gap-2 p-4 rounded-xl border-2 transition-all duration-300 cursor-pointer @GetModeButtonClasses("dark")">
                            <i class="fas fa-moon text-2xl @GetModeIconClasses("dark")"></i>
                            <span class="text-sm font-semibold">Dark</span>
                        </button>
                        <button @onclick="@(() => SelectMode("system"))"
                                type="button"
                                class="flex flex-col items-center justify-center gap-2 p-4 rounded-xl border-2 transition-all duration-300 cursor-pointer @GetModeButtonClasses("system")">
                            <i class="fas fa-desktop text-2xl @GetModeIconClasses("system")"></i>
                            <span class="text-sm font-semibold">System</span>
                        </button>
                    </div>
                </div>

                <!-- Theme Presets Section -->
                <div class="mb-6">
                    <h3 class="flex items-center gap-2 text-base font-semibold @GetSectionHeadingColor() mb-4">
                        <i class="fas fa-swatchbook text-lg text-primary"></i>
                        Color Presets
                    </h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                        @foreach (var preset in themePresets)
                        {
                            <button @onclick="() => SelectPreset(preset.Key)"
                                    type="button"
                                    class="flex flex-col items-center p-4 rounded-xl border-2 transition-all duration-300 cursor-pointer @GetPresetButtonClasses(preset.Key)">
                                <div class="flex gap-2 mb-3">
                                    <div class="w-10 h-10 rounded-xl shadow-md border-2 @GetPresetColorBorder() transition-transform hover:scale-110"
                                         style="background: @preset.Value.PrimaryColor; box-shadow: 0 4px 8px rgba(0,0,0,0.15);"></div>
                                    <div class="w-10 h-10 rounded-xl shadow-md border-2 @GetPresetColorBorder() transition-transform hover:scale-110"
                                         style="background: @preset.Value.AccentColor; box-shadow: 0 4px 8px rgba(0,0,0,0.15);"></div>
                                </div>
                                <div class="flex items-center gap-2 w-full justify-center">
                                    <span class="text-sm font-semibold @GetPresetTextColor() capitalize">@preset.Key</span>
                                    @if (currentPreset == preset.Key)
                                    {
                                        <i class="fas fa-check-circle text-green-500 text-base"></i>
                                    }
                                </div>
                            </button>
                        }
                    </div>
                </div>

                <!-- Preview Section -->
                <div class="mb-0">
                    <h3 class="flex items-center gap-2 text-base font-semibold @GetSectionHeadingColor() mb-4">
                        <i class="fas fa-eye text-lg text-primary"></i>
                        Preview
                    </h3>
                    <div class="flex justify-center px-2">
                        <div class="rounded-xl overflow-hidden shadow-lg w-full max-w-md @GetPreviewBorder() @GetPreviewBackground()">
                            <div class="p-8 flex items-center justify-center text-white text-5xl"
                                 style="background: linear-gradient(135deg, @GetCurrentPrimary() 0%, @GetCurrentAccent() 100%);">
                                <i class="fas fa-heart-pulse"></i>
                            </div>
                            <div class="p-6">
                                <p class="text-base font-semibold @GetPreviewTextColor() text-center mb-4 m-0">Preview Theme</p>
                                <div class="flex gap-4 justify-center">
                                    <div class="flex flex-col items-center gap-2">
                                        <div class="w-12 h-12 rounded-xl border-2 @GetPreviewColorBorder() shadow-lg"
                                             style="background: @GetCurrentPrimary();"></div>
                                        <span class="text-xs font-medium @GetPreviewLabelColor()">Primary</span>
                                    </div>
                                    <div class="flex flex-col items-center gap-2">
                                        <div class="w-12 h-12 rounded-xl border-2 @GetPreviewColorBorder() shadow-lg"
                                             style="background: @GetCurrentAccent();"></div>
                                        <span class="text-xs font-medium @GetPreviewLabelColor()">Accent</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3 px-6 md:px-8 py-5 @GetFooterBorder() @GetFooterBackground() flex-shrink-0">
                <button @onclick="ResetToDefault"
                        type="button"
                        class="flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-semibold text-sm transition-all duration-300 @GetResetButtonClasses() cursor-pointer">
                    <i class="fas fa-rotate-left"></i>
                    <span>Reset to Default</span>
                </button>
                <button @onclick="ApplyAndClose"
                        type="button"
                        class="flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-semibold text-sm transition-all duration-300 text-white bg-gradient-to-r from-primary to-accent hover:opacity-90 cursor-pointer shadow-lg">
                    <i class="fas fa-check"></i>
                    <span>Apply Theme</span>
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }
    [Parameter] public EventCallback<string> OnThemeChanged { get; set; }

    private string currentMode = "light";
    private string currentPreset = "default";
    private Dictionary<string, ThemeConfiguration> themePresets = new();

    // Store original theme to restore if user cancels
    private string originalMode = "light";
    private string originalPreset = "default";

    protected override async Task OnInitializedAsync()
    {
        // Load theme presets from ThemeService
        themePresets = ThemeService.GetThemePresets();

        // Load current theme configuration and save as original
        var currentTheme = await ThemeService.GetCurrentThemeAsync();
        currentMode = currentTheme.Mode;
        currentPreset = currentTheme.Preset;

        // Save original values
        originalMode = currentTheme.Mode;
        originalPreset = currentTheme.Preset;
    }

    private async Task SelectMode(string mode)
    {
        currentMode = mode;
        await ApplyTheme();
        StateHasChanged();
    }

    private async Task SelectPreset(string presetKey)
    {
        currentPreset = presetKey;
        await ApplyTheme();
        StateHasChanged();
    }

    private async Task ApplyTheme()
    {
        try
        {
            if (!themePresets.TryGetValue(currentPreset, out var preset))
            {
                preset = themePresets["default"];
            }

            // Resolve system mode to actual light/dark
            var actualMode = currentMode;
            if (actualMode == "system")
            {
                actualMode = await ThemeService.DetectSystemThemeAsync();
            }

            var themeConfig = new ThemeConfiguration
            {
                Mode = actualMode,
                PrimaryColor = preset.PrimaryColor,
                AccentColor = preset.AccentColor,
                BackgroundColor = preset.BackgroundColor,
                TextColor = preset.TextColor,
                SidebarStyle = preset.SidebarStyle,
                FontSize = preset.FontSize,
                EnableAnimations = preset.EnableAnimations,
                CompactMode = preset.CompactMode,
                Preset = currentPreset,
                HighContrast = preset.HighContrast,
                BorderRadius = preset.BorderRadius
            };

            await ThemeService.ApplyThemeAsync(themeConfig);
            await OnThemeChanged.InvokeAsync(currentPreset);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error applying theme: {ex.Message}");
        }
    }

    private async Task ResetToDefault()
    {
        currentMode = "light";
        currentPreset = "default";
        await ApplyTheme();
        StateHasChanged();
    }

    private async Task ApplyAndClose()
    {
        await ApplyTheme();
        await CloseModal();
    }

    private async Task CloseModal()
    {
        IsOpen = false;
        await IsOpenChanged.InvokeAsync(IsOpen);
        StateHasChanged();
    }

    private string GetCurrentPrimary()
    {
        return themePresets.TryGetValue(currentPreset, out var preset)
            ? preset.PrimaryColor
            : "#3b82f6";
    }

    private string GetCurrentAccent()
    {
        return themePresets.TryGetValue(currentPreset, out var preset)
            ? preset.AccentColor
            : "#8b5cf6";
    }

    // Theme-aware helper methods
    private bool IsDarkMode => ThemeState.CurrentTheme.Mode == "dark";

    private string GetOverlayBackground()
    {
        return IsDarkMode ? "rgba(0, 0, 0, 0.6)" : "rgba(0, 0, 0, 0.3)";
    }

    private string GetModalBackground()
    {
        return IsDarkMode ? "bg-gray-800" : "bg-white";
    }

    private string GetModalBorder()
    {
        return IsDarkMode ? "border border-gray-700" : "border border-gray-200";
    }

    private string GetHeaderGradient()
    {
        return IsDarkMode ? "from-gray-700 to-gray-800" : "from-primary-50 to-accent-50";
    }

    private string GetHeaderBorder()
    {
        return IsDarkMode ? "border-b border-gray-700" : "border-b border-gray-200";
    }

    private string GetHeaderIconColor()
    {
        return IsDarkMode ? "text-primary-400" : "text-primary";
    }

    private string GetHeaderTextColor()
    {
        return IsDarkMode ? "text-white" : "text-gray-800";
    }

    private string GetCloseButtonClasses()
    {
        return IsDarkMode
            ? "bg-gray-700 hover:bg-red-900 text-gray-300 hover:text-red-400"
            : "bg-white hover:bg-red-50 text-gray-500 hover:text-red-500";
    }

    private string GetSectionHeadingColor()
    {
        return IsDarkMode ? "text-gray-200" : "text-gray-700";
    }

    private string GetModeButtonClasses(string mode)
    {
        var isSelected = currentMode == mode;
        if (isSelected)
        {
            return IsDarkMode
                ? "bg-gradient-to-br from-primary-900 to-accent-900 border-primary-500 shadow-lg text-white"
                : "bg-gradient-to-br from-primary-50 to-accent-50 border-primary-500 shadow-lg text-gray-800";
        }
        return IsDarkMode
            ? "bg-gray-700 border-gray-600 hover:border-primary-400 hover:shadow-md hover:-translate-y-0.5 text-gray-300"
            : "bg-gray-50 border-gray-200 hover:border-primary-300 hover:shadow-md hover:-translate-y-0.5 text-gray-700";
    }

    private string GetModeIconClasses(string mode)
    {
        return currentMode == mode ? "text-primary" : "";
    }

    private string GetPresetButtonClasses(string presetKey)
    {
        var isSelected = currentPreset == presetKey;
        if (isSelected)
        {
            return IsDarkMode
                ? "bg-gradient-to-br from-primary-900 to-accent-900 border-primary-500 shadow-lg scale-105 text-white"
                : "bg-gradient-to-br from-primary-50 to-accent-50 border-primary-500 shadow-lg scale-105 text-gray-800";
        }
        return IsDarkMode
            ? "bg-gray-700 border-gray-600 hover:border-primary-400 hover:shadow-md hover:-translate-y-1 text-gray-300"
            : "bg-gray-50 border-gray-200 hover:border-primary-300 hover:shadow-md hover:-translate-y-1 text-gray-700";
    }

    private string GetPresetTextColor()
    {
        return IsDarkMode ? "text-gray-200" : "text-gray-700";
    }

    private string GetPresetColorBorder()
    {
        return IsDarkMode ? "border-gray-600" : "border-white";
    }

    private string GetPreviewBackground()
    {
        return IsDarkMode ? "bg-gray-700" : "bg-white";
    }

    private string GetPreviewBorder()
    {
        return IsDarkMode ? "border border-gray-600" : "border border-gray-200";
    }

    private string GetPreviewTextColor()
    {
        return IsDarkMode ? "text-gray-200" : "text-gray-700";
    }

    private string GetPreviewLabelColor()
    {
        return IsDarkMode ? "text-gray-400" : "text-gray-500";
    }

    private string GetPreviewColorBorder()
    {
        return IsDarkMode ? "border-gray-500" : "border-gray-200";
    }

    private string GetFooterBorder()
    {
        return IsDarkMode ? "border-t border-gray-700" : "border-t border-gray-200";
    }

    private string GetFooterBackground()
    {
        return IsDarkMode ? "bg-gray-750" : "bg-gray-50";
    }

    private string GetResetButtonClasses()
    {
        return IsDarkMode
            ? "bg-gray-700 hover:bg-gray-600 text-gray-200 border border-gray-600 hover:border-gray-500"
            : "bg-white hover:bg-gray-100 text-gray-700 border border-gray-300 hover:border-gray-400";
    }
}

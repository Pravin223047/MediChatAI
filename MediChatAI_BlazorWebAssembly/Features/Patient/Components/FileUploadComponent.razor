@using Microsoft.AspNetCore.Components.Forms
@using MediChatAI_BlazorWebAssembly.Core.Services.Theme
@using System.Net.Http.Headers
@inject ILogger<FileUploadComponent> Logger
@inject IThemeService ThemeService
@inject ThemeState ThemeState
@inject HttpClient HttpClient

<div class="@ContainerClass">
    <div class="@(IsDarkMode ? "bg-gray-700 border-gray-600" : "bg-white border-gray-300")
                rounded-lg border-2 border-dashed transition-colors
                @(isDragging ? "border-primary bg-primary/10" : "")">

        <InputFile OnChange="HandleFileSelection"
                   multiple="@AllowMultiple"
                   accept="@AcceptedFileTypes"
                   class="hidden"
                   id="@inputId" />

        <label for="@inputId" class="block p-8 cursor-pointer">
            <div class="text-center">
                @if (uploadedFiles.Count == 0)
                {
                    <div class="mb-4">
                        <i class="fas fa-cloud-upload-alt text-5xl @(IsDarkMode ? "text-gray-500" : "text-gray-400")"></i>
                    </div>
                    <p class="text-sm @(IsDarkMode ? "text-gray-300" : "text-gray-700") font-medium mb-2">
                        @(AllowMultiple ? "Click to upload files or drag and drop" : "Click to upload a file or drag and drop")
                    </p>
                    <p class="text-xs @(IsDarkMode ? "text-gray-500" : "text-gray-500")">
                        @FileTypeMessage
                    </p>
                    @if (MaxFileSizeMB > 0)
                    {
                        <p class="text-xs @(IsDarkMode ? "text-gray-500" : "text-gray-500") mt-1">
                            Maximum file size: @MaxFileSizeMB MB
                        </p>
                    }
                }
                else
                {
                    <div class="space-y-3">
                        @foreach (var file in uploadedFiles)
                        {
                            <div class="flex items-center justify-between p-3 rounded-lg @(IsDarkMode ? "bg-gray-800" : "bg-gray-50")">
                                <div class="flex items-center gap-3 flex-1">
                                    @if (file.IsImage)
                                    {
                                        <div class="w-12 h-12 rounded overflow-hidden flex-shrink-0">
                                            <img src="@file.PreviewUrl" alt="@file.FileName" class="w-full h-full object-cover" />
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="w-12 h-12 rounded @(IsDarkMode ? "bg-gray-700" : "bg-gray-200") flex items-center justify-center flex-shrink-0">
                                            <i class="fas @GetFileIcon(file.FileName) text-xl @(IsDarkMode ? "text-gray-400" : "text-gray-600")"></i>
                                        </div>
                                    }
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium @(IsDarkMode ? "text-white" : "text-gray-900") truncate">
                                            @file.FileName
                                        </p>
                                        <div class="flex items-center gap-2 mt-1">
                                            <p class="text-xs @(IsDarkMode ? "text-gray-400" : "text-gray-600")">
                                                @FormatFileSize(file.Size)
                                            </p>
                                            @if (file.IsUploading)
                                            {
                                                <span class="text-xs @(IsDarkMode ? "text-blue-400" : "text-blue-600")">
                                                    Uploading... @file.Progress%
                                                </span>
                                            }
                                            else if (file.IsUploaded)
                                            {
                                                <span class="text-xs text-green-600">
                                                    <i class="fas fa-check-circle mr-1"></i>Uploaded
                                                </span>
                                            }
                                        </div>
                                        @if (file.IsUploading)
                                        {
                                            <div class="w-full bg-gray-300 rounded-full h-1.5 mt-2">
                                                <div class="bg-primary h-1.5 rounded-full transition-all" style="width: @(file.Progress)%"></div>
                                            </div>
                                        }
                                    </div>
                                </div>
                                <button type="button"
                                        @onclick="() => RemoveFile(file)"
                                        class="ml-2 p-2 rounded-lg @(IsDarkMode ? "hover:bg-gray-700" : "hover:bg-gray-200") transition-colors">
                                    <i class="fas fa-times @(IsDarkMode ? "text-gray-400" : "text-gray-600")"></i>
                                </button>
                            </div>
                        }
                    </div>
                    @if (AllowMultiple)
                    {
                        <div class="mt-4">
                            <p class="text-sm @(IsDarkMode ? "text-gray-400" : "text-gray-600")">
                                Click or drag to add more files
                            </p>
                        </div>
                    }
                }
            </div>
        </label>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="mt-3 p-3 rounded-lg bg-red-100 border border-red-300 text-red-800 text-sm">
            <i class="fas fa-exclamation-circle mr-2"></i>
            @errorMessage
        </div>
    }
</div>

@code {
    private bool IsDarkMode => ThemeState.CurrentTheme.Mode == "dark";

    [Parameter] public bool AllowMultiple { get; set; } = true;
    [Parameter] public string AcceptedFileTypes { get; set; } = "image/*,.pdf";
    [Parameter] public long MaxFileSizeMB { get; set; } = 10;
    [Parameter] public string FileTypeMessage { get; set; } = "PNG, JPG, PDF up to 10MB";
    [Parameter] public string ContainerClass { get; set; } = "";
    [Parameter] public string? UploadFolder { get; set; } = "patient-documents";
    [Parameter] public EventCallback<List<UploadedFileInfo>> OnFilesUploaded { get; set; }

    private string inputId = Guid.NewGuid().ToString();
    private bool isDragging = false;
    private string errorMessage = "";
    private List<UploadedFileInfo> uploadedFiles = new();

    private async Task HandleFileSelection(InputFileChangeEventArgs e)
    {
        errorMessage = "";
        var files = e.GetMultipleFiles(AllowMultiple ? 10 : 1);

        foreach (var file in files)
        {
            // Validate file size
            var fileSizeInMB = file.Size / (1024.0 * 1024.0);
            if (MaxFileSizeMB > 0 && fileSizeInMB > MaxFileSizeMB)
            {
                errorMessage = $"{file.Name} exceeds the maximum file size of {MaxFileSizeMB} MB";
                continue;
            }

            var fileInfo = new UploadedFileInfo
            {
                FileName = file.Name,
                Size = file.Size,
                ContentType = file.ContentType,
                IsImage = file.ContentType.StartsWith("image/"),
                IsUploading = true,
                Progress = 0
            };

            // Generate preview for images
            if (fileInfo.IsImage)
            {
                try
                {
                    var buffer = new byte[file.Size];
                    await file.OpenReadStream(maxAllowedSize: MaxFileSizeMB * 1024 * 1024).ReadAsync(buffer);
                    fileInfo.PreviewUrl = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
                    fileInfo.FileData = buffer;
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error generating preview for {FileName}", file.Name);
                    errorMessage = $"Error loading {file.Name}";
                    continue;
                }
            }
            else
            {
                try
                {
                    var buffer = new byte[file.Size];
                    await file.OpenReadStream(maxAllowedSize: MaxFileSizeMB * 1024 * 1024).ReadAsync(buffer);
                    fileInfo.FileData = buffer;
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error reading file {FileName}", file.Name);
                    errorMessage = $"Error loading {file.Name}";
                    continue;
                }
            }

            uploadedFiles.Add(fileInfo);
            StateHasChanged();

            // Simulate upload to Cloudinary
            await UploadToCloudinary(fileInfo);
        }

        // Notify parent component
        await OnFilesUploaded.InvokeAsync(uploadedFiles.Where(f => f.IsUploaded).ToList());
    }

    private async Task UploadToCloudinary(UploadedFileInfo file)
    {
        try
        {
            // Create multipart form content
            using var content = new MultipartFormDataContent();

            // Read file stream and add to content
            var fileContent = new StreamContent(new System.IO.MemoryStream(file.FileData));
            fileContent.Headers.ContentType = new MediaTypeHeaderValue(file.ContentType);
            content.Add(fileContent, "file", file.FileName);

            // Add optional folder parameter
            content.Add(new StringContent(UploadFolder ?? "patient-documents"), "folder");

            // Simulate progress updates (actual progress tracking would require streaming)
            var progressTask = Task.Run(async () =>
            {
                for (int i = 10; i <= 90; i += 10)
                {
                    if (file.IsUploading)
                    {
                        file.Progress = i;
                        await InvokeAsync(StateHasChanged);
                        await Task.Delay(200);
                    }
                }
            });

            // Upload to backend API
            var response = await HttpClient.PostAsync("api/FileUpload/patient-document", content);

            await progressTask; // Wait for progress simulation

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<CloudinaryUploadResponse>();

                file.Progress = 100;
                file.IsUploading = false;
                file.IsUploaded = true;
                file.CloudinaryUrl = result?.CloudinaryUrl ?? "";

                Logger.LogInformation("File uploaded successfully to Cloudinary: {FileName} -> {Url}", file.FileName, file.CloudinaryUrl);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                throw new Exception($"Upload failed: {error}");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error uploading file {FileName} to Cloudinary", file.FileName);
            file.IsUploading = false;
            file.Progress = 0;
            errorMessage = $"Failed to upload {file.FileName}: {ex.Message}";
        }

        await InvokeAsync(StateHasChanged);
    }

    private class CloudinaryUploadResponse
    {
        public bool Success { get; set; }
        public string? FileName { get; set; }
        public string? CloudinaryUrl { get; set; }
        public long FileSize { get; set; }
        public string? Message { get; set; }
    }

    private void RemoveFile(UploadedFileInfo file)
    {
        uploadedFiles.Remove(file);
        StateHasChanged();
    }

    private string GetFileIcon(string fileName)
    {
        var extension = Path.GetExtension(fileName).ToLower();
        return extension switch
        {
            ".pdf" => "fa-file-pdf",
            ".doc" or ".docx" => "fa-file-word",
            ".xls" or ".xlsx" => "fa-file-excel",
            ".zip" or ".rar" => "fa-file-archive",
            _ => "fa-file"
        };
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    public class UploadedFileInfo
    {
        public string FileName { get; set; } = "";
        public long Size { get; set; }
        public string ContentType { get; set; } = "";
        public bool IsImage { get; set; }
        public string PreviewUrl { get; set; } = "";
        public byte[] FileData { get; set; } = Array.Empty<byte>();
        public bool IsUploading { get; set; }
        public bool IsUploaded { get; set; }
        public int Progress { get; set; }
        public string CloudinaryUrl { get; set; } = "";
        public string PublicId { get; set; } = "";
    }
}

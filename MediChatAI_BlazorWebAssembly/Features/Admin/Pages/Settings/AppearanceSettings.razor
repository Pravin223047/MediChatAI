@inject ISettingsService SettingsService
@inject IToastService ToastService
@inject IThemeService ThemeService
@inject AppSettingsState AppSettings

<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 transition-colors duration-200">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Appearance Settings</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Customize the look and feel of the application</p>
        </div>
        @if (showPreview)
        {
            <button type="button" @onclick="TogglePreview"
                    class="px-4 py-2 text-sm font-medium text-primary dark:text-primary hover:text-primary dark:hover:text-primary transition-colors">
                <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
                Hide Preview
            </button>
        }
    </div>

    <EditForm Model="@appearanceSettings" OnValidSubmit="@HandleSubmit">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Theme Mode -->
            <div class="lg:col-span-2">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Theme Mode</label>
                <div class="grid grid-cols-3 gap-3">
                    @foreach (var mode in new[] { ("light", "Light", "‚òÄÔ∏è"), ("dark", "Dark", "üåô"), ("system", "System", "‚öôÔ∏è") })
                    {
                        <button type="button" @onclick="() => SelectThemeMode(mode.Item1)"
                                class="@GetModeButtonClass(mode.Item1) relative flex flex-col items-center p-4 border-2 rounded-lg transition-all">
                            <span class="text-3xl mb-2">@mode.Item3</span>
                            <span class="text-sm font-medium">@mode.Item2</span>
                            @if (appearanceSettings.ThemeMode == mode.Item1)
                            {
                                <span class="absolute top-2 right-2 text-primary dark:text-primary">‚úì</span>
                            }
                        </button>
                    }
                </div>
            </div>

            <!-- Theme Presets -->
            <div class="lg:col-span-2">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Color Presets</label>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                    @foreach (var preset in ThemeService.GetThemePresets())
                    {
                        <button type="button" @onclick="() => SelectPreset(preset.Key)"
                                class="@GetPresetButtonClass(preset.Key) flex flex-col items-center p-3 border-2 rounded-lg transition-all hover:shadow-md">
                            <div class="flex space-x-1 mb-2">
                                <div class="w-6 h-6 rounded" style="background-color: @preset.Value.PrimaryColor"></div>
                                <div class="w-6 h-6 rounded" style="background-color: @preset.Value.AccentColor"></div>
                            </div>
                            <span class="text-xs font-medium capitalize">@preset.Key</span>
                        </button>
                    }
                </div>
            </div>

            <!-- Custom Colors -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Primary Color</label>
                <div class="flex items-center space-x-2">
                    <input type="color" @bind="appearanceSettings.ThemePrimaryColor" @oninput="OnColorChange"
                           class="h-10 w-20 rounded border border-gray-300 cursor-pointer" />
                    <input type="text" @bind="appearanceSettings.ThemePrimaryColor"
                           class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                           placeholder="#3b82f6" />
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Accent Color</label>
                <div class="flex items-center space-x-2">
                    <input type="color" @bind="appearanceSettings.ThemeAccentColor" @oninput="OnColorChange"
                           class="h-10 w-20 rounded border border-gray-300 cursor-pointer" />
                    <input type="text" @bind="appearanceSettings.ThemeAccentColor"
                           class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                           placeholder="#8b5cf6" />
                </div>
            </div>

            <!-- Font Size -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Font Size</label>
                <select @bind="appearanceSettings.ThemeFontSize" @oninput="OnSettingChange"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    <option value="small">Small (14px)</option>
                    <option value="medium">Medium (16px)</option>
                    <option value="large">Large (18px)</option>
                </select>
            </div>

            <!-- Border Radius -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Border Radius</label>
                <select @bind="appearanceSettings.ThemeBorderRadius" @oninput="OnSettingChange"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    <option value="none">None (Sharp corners)</option>
                    <option value="small">Small</option>
                    <option value="medium">Medium</option>
                    <option value="large">Large (Rounded)</option>
                </select>
            </div>

            <!-- Sidebar Style -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sidebar Style</label>
                <select @bind="appearanceSettings.ThemeSidebarStyle"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    <option value="expanded">Expanded</option>
                    <option value="collapsed">Collapsed</option>
                    <option value="floating">Floating</option>
                </select>
            </div>

            <!-- Toggle Options -->
            <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="checkbox" @bind="appearanceSettings.ThemeEnableAnimations" @oninput="OnSettingChange"
                           class="w-5 h-5 text-primary dark:text-primary rounded" />
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Enable Animations</span>
                </label>

                <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="checkbox" @bind="appearanceSettings.ThemeCompactMode" @oninput="OnSettingChange"
                           class="w-5 h-5 text-primary dark:text-primary rounded" />
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Compact Mode</span>
                </label>

                <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="checkbox" @bind="appearanceSettings.ThemeHighContrast" @oninput="OnSettingChange"
                           class="w-5 h-5 text-primary dark:text-primary rounded" />
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">High Contrast</span>
                </label>
            </div>

        </div>

        <!-- Action Buttons -->
        <div class="mt-6 flex items-center justify-between pt-6 border-t border-gray-200 dark:border-gray-700">
            <button type="button" @onclick="TogglePreview"
                    class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                @(showPreview ? "Hide" : "Show") Live Preview
            </button>

            <div class="flex space-x-3">
                <button type="button" @onclick="ResetToDefaults"
                        class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    Reset to Defaults
                </button>
                <button type="submit" disabled="@isLoading"
                        class="px-6 py-2 bg-primary text-white rounded-lg hover:opacity-90 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                    @if (isLoading)
                    {
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>Save Changes</span>
                    }
                </button>
            </div>
        </div>
    </EditForm>

    <!-- Live Preview Card -->
    @if (showPreview)
    {
        <div class="mt-6 p-6 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg">
            <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4">Live Preview</h4>
            <div class="space-y-4">
                <div class="p-4 rounded-lg" style="background-color: @appearanceSettings.ThemeBackgroundColor; color: @appearanceSettings.ThemeTextColor">
                    <h5 class="font-semibold mb-2">Sample Content</h5>
                    <p class="text-sm">This is how your content will look with the current theme settings.</p>
                    <div class="mt-3 flex space-x-2">
                        <button class="px-4 py-2 rounded text-white text-sm" style="background-color: @appearanceSettings.ThemePrimaryColor">Primary Button</button>
                        <button class="px-4 py-2 rounded text-white text-sm" style="background-color: @appearanceSettings.ThemeAccentColor">Accent Button</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private UpdateAppearanceSettingsInput appearanceSettings = new();
    private bool isLoading = false;
    private bool showPreview = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
    }

    private async Task LoadSettings()
    {
        try
        {
            var systemSettings = await SettingsService.GetSystemSettingsAsync();
            if (systemSettings != null)
            {
                appearanceSettings = new UpdateAppearanceSettingsInput(
                    systemSettings.ThemeMode,
                    systemSettings.ThemePrimaryColor,
                    systemSettings.ThemeAccentColor,
                    systemSettings.ThemeBackgroundColor,
                    systemSettings.ThemeTextColor,
                    systemSettings.ThemeSidebarStyle,
                    systemSettings.ThemeFontSize,
                    systemSettings.ThemeEnableAnimations,
                    systemSettings.ThemeCompactMode,
                    systemSettings.ThemePreset,
                    systemSettings.ThemeHighContrast,
                    systemSettings.ThemeBorderRadius
                );
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load settings: {ex.Message}");
        }
    }

    private void SelectThemeMode(string mode)
    {
        appearanceSettings.ThemeMode = mode;
        StateHasChanged();
    }

    private void SelectPreset(string presetKey)
    {
        var presets = ThemeService.GetThemePresets();
        if (presets.TryGetValue(presetKey, out var preset))
        {
            appearanceSettings.ThemePreset = presetKey;
            appearanceSettings.ThemePrimaryColor = preset.PrimaryColor;
            appearanceSettings.ThemeAccentColor = preset.AccentColor;
            appearanceSettings.ThemeBackgroundColor = preset.BackgroundColor;
            appearanceSettings.ThemeTextColor = preset.TextColor;

            if (preset.Mode != "light")
            {
                appearanceSettings.ThemeMode = preset.Mode;
            }

            StateHasChanged();
        }
    }

    private void OnColorChange()
    {
        appearanceSettings.ThemePreset = "custom";
        StateHasChanged();
    }

    private void OnSettingChange()
    {
        StateHasChanged();
    }

    private void TogglePreview()
    {
        showPreview = !showPreview;
    }

    private void ResetToDefaults()
    {
        appearanceSettings = new UpdateAppearanceSettingsInput(
            "light",
            "#3b82f6",
            "#8b5cf6",
            "#f8fafc",
            "#1f2937",
            "expanded",
            "medium",
            true,
            false,
            "default",
            false,
            "medium"
        );
        StateHasChanged();
    }

    private async Task HandleSubmit()
    {
        isLoading = true;

        try
        {
            var result = await SettingsService.UpdateAppearanceSettingsAsync(appearanceSettings);

            if (result != null && result.Success)
            {
                // Apply theme immediately
                await ThemeService.LoadThemeFromSettingsAsync(new SystemSettingsData
                {
                    ThemeMode = appearanceSettings.ThemeMode,
                    ThemePrimaryColor = appearanceSettings.ThemePrimaryColor,
                    ThemeAccentColor = appearanceSettings.ThemeAccentColor,
                    ThemeBackgroundColor = appearanceSettings.ThemeBackgroundColor,
                    ThemeTextColor = appearanceSettings.ThemeTextColor,
                    ThemeSidebarStyle = appearanceSettings.ThemeSidebarStyle,
                    ThemeFontSize = appearanceSettings.ThemeFontSize,
                    ThemeEnableAnimations = appearanceSettings.ThemeEnableAnimations,
                    ThemeCompactMode = appearanceSettings.ThemeCompactMode,
                    ThemePreset = appearanceSettings.ThemePreset,
                    ThemeHighContrast = appearanceSettings.ThemeHighContrast,
                    ThemeBorderRadius = appearanceSettings.ThemeBorderRadius
                });

                // Update AppSettingsState to notify all components
                AppSettings.UpdateAppearanceSettings(new AppearanceSettingsDto(
                    appearanceSettings.ThemeMode,
                    appearanceSettings.ThemePrimaryColor,
                    appearanceSettings.ThemeAccentColor,
                    appearanceSettings.ThemeBackgroundColor,
                    appearanceSettings.ThemeTextColor,
                    appearanceSettings.ThemeSidebarStyle,
                    appearanceSettings.ThemeFontSize,
                    appearanceSettings.ThemeEnableAnimations,
                    appearanceSettings.ThemeCompactMode,
                    appearanceSettings.ThemePreset,
                    appearanceSettings.ThemeHighContrast,
                    appearanceSettings.ThemeBorderRadius
                ));

                ToastService.ShowSuccess(result.Message ?? "Appearance settings updated successfully!");
            }
            else
            {
                ToastService.ShowError(result?.Message ?? "Failed to update appearance settings.");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetModeButtonClass(string mode)
    {
        var baseClass = "border-gray-300 dark:border-gray-600 hover:border-primary dark:hover:border-primary-400";
        var selectedClass = "border-primary dark:border-primary-400 bg-primary";
        return mode == appearanceSettings.ThemeMode ? selectedClass : baseClass;
    }

    private string GetPresetButtonClass(string preset)
    {
        var baseClass = "border-gray-300 dark:border-gray-600";
        var selectedClass = "border-primary dark:border-primary-400 ring-2 ring-primary dark:ring-primary-400";
        return preset == appearanceSettings.ThemePreset ? selectedClass : baseClass;
    }
}

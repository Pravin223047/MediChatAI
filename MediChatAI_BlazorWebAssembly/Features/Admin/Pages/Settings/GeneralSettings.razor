@inject ISettingsService SettingsService
@inject IToastService ToastService
@inject AppSettingsState AppSettings

<div class="bg-card dark:bg-gray-800 rounded-lg shadow-sm p-6 transition-colors duration-200">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">General Settings</h3>

    <EditForm Model="@generalSettings" OnValidSubmit="@HandleSubmit">
        <DataAnnotationsValidator />

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Site Name -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Site Name <span class="text-red-500">*</span>
                </label>
                <InputText @bind-Value="generalSettings.SiteName"
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                           placeholder="Enter site name" />
                <ValidationMessage For="@(() => generalSettings.SiteName)" class="text-red-500 text-sm mt-1" />
            </div>

            <!-- Contact Email -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Contact Email <span class="text-red-500">*</span>
                </label>
                <InputText @bind-Value="generalSettings.ContactEmail"
                           type="email"
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                           placeholder="contact@example.com" />
                <ValidationMessage For="@(() => generalSettings.ContactEmail)" class="text-red-500 text-sm mt-1" />
            </div>

            <!-- Site Description -->
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Site Description
                </label>
                <InputTextArea @bind-Value="generalSettings.SiteDescription"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                               rows="3"
                               placeholder="Brief description of your site" />
            </div>

            <!-- Contact Phone -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Contact Phone
                </label>
                <InputText @bind-Value="generalSettings.ContactPhone"
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                           placeholder="+1 (555) 123-4567" />
            </div>

            <!-- Timezone -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Timezone <span class="text-red-500">*</span>
                </label>
                <InputSelect @bind-Value="generalSettings.Timezone"
                             class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="UTC">UTC</option>
                    <option value="EST">Eastern Time (EST)</option>
                    <option value="CST">Central Time (CST)</option>
                    <option value="MST">Mountain Time (MST)</option>
                    <option value="PST">Pacific Time (PST)</option>
                    <option value="IST">India Standard Time (IST)</option>
                </InputSelect>
            </div>

            <!-- Date Format -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Date Format <span class="text-red-500">*</span>
                </label>
                <InputSelect @bind-Value="generalSettings.DateFormat"
                             class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="MM/dd/yyyy">MM/dd/yyyy (US)</option>
                    <option value="dd/MM/yyyy">dd/MM/yyyy (EU)</option>
                    <option value="yyyy-MM-dd">yyyy-MM-dd (ISO)</option>
                </InputSelect>
            </div>

            <!-- Time Format -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Time Format <span class="text-red-500">*</span>
                </label>
                <InputSelect @bind-Value="generalSettings.TimeFormat"
                             class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="12-hour">12-hour (AM/PM)</option>
                    <option value="24-hour">24-hour</option>
                </InputSelect>
            </div>
        </div>

        <div class="mt-6 flex justify-end">
            <button type="submit"
                    disabled="@isLoading"
                    class="px-6 py-2 bg-primary text-white rounded-lg hover:opacity-90 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                @if (isLoading)
                {
                    <span>Saving...</span>
                }
                else
                {
                    <span>Save Changes</span>
                }
            </button>
        </div>
    </EditForm>
</div>

@code {
    private UpdateGeneralSettingsInput generalSettings = new("", "", "", "", "UTC", "MM/dd/yyyy", "12-hour");
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
    }

    private async Task LoadSettings()
    {
        try
        {
            var systemSettings = await SettingsService.GetSystemSettingsAsync();
            if (systemSettings != null)
            {
                generalSettings = new UpdateGeneralSettingsInput(
                    systemSettings.SiteName,
                    systemSettings.SiteDescription,
                    systemSettings.ContactEmail,
                    systemSettings.ContactPhone,
                    systemSettings.Timezone,
                    systemSettings.DateFormat,
                    systemSettings.TimeFormat
                );
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load settings: {ex.Message}");
        }
    }

    private async Task HandleSubmit()
    {
        isLoading = true;

        try
        {
            var result = await SettingsService.UpdateGeneralSettingsAsync(generalSettings);

            if (result != null && result.Success)
            {
                var dto = new GeneralSettingsDto(
                    generalSettings.SiteName,
                    generalSettings.SiteDescription,
                    generalSettings.ContactEmail,
                    generalSettings.ContactPhone,
                    generalSettings.Timezone,
                    generalSettings.DateFormat,
                    generalSettings.TimeFormat
                );
                AppSettings.UpdateSettings(dto);

                ToastService.ShowSuccess(result.Message ?? "Settings saved successfully!");
            }
            else
            {
                ToastService.ShowError(result?.Message ?? "Failed to save settings.");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
}

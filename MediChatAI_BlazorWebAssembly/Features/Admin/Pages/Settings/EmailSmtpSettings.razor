@inject ISettingsService SettingsService
@inject IToastService ToastService

<div class="bg-card dark:bg-gray-800 rounded-lg shadow-sm p-6 transition-colors duration-200">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Email & SMTP Settings</h3>

    <EditForm Model="@smtpSettings" OnValidSubmit="@HandleSmtpSubmit">
        <DataAnnotationsValidator />

        <!-- SMTP Configuration -->
        <div class="mb-6">
            <h4 class="text-md font-medium text-gray-900 dark:text-white mb-3">SMTP Configuration</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- SMTP Server (Disabled with default value) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        SMTP Server <span class="text-red-500">*</span>
                    </label>
                    <InputText @bind-Value="smtpSettings.SmtpServer"
                               disabled="true"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-600 text-gray-900 dark:text-gray-400 cursor-not-allowed"
                               placeholder="smtp.gmail.com" />
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Default: smtp.gmail.com</p>
                </div>

                <!-- SMTP Port (Disabled with default value) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        SMTP Port <span class="text-red-500">*</span>
                    </label>
                    <InputNumber @bind-Value="smtpSettings.SmtpPort"
                                 disabled="true"
                                 class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-600 text-gray-900 dark:text-gray-400 cursor-not-allowed" />
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Default: 587 (TLS)</p>
                </div>

                <!-- SMTP Username -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        SMTP Username <span class="text-red-500">*</span>
                    </label>
                    <InputText @bind-Value="smtpSettings.SmtpUsername"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                               placeholder="your-email@gmail.com" />
                    <ValidationMessage For="@(() => smtpSettings.SmtpUsername)" class="text-red-500 text-sm mt-1" />
                </div>

                <!-- SMTP Password -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        SMTP Password <span class="text-red-500">*</span>
                    </label>
                    <InputText @bind-Value="smtpSettings.SmtpPassword"
                               type="password"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                               placeholder="App password" />
                    <ValidationMessage For="@(() => smtpSettings.SmtpPassword)" class="text-red-500 text-sm mt-1" />
                </div>

                <!-- From Email -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        From Email <span class="text-red-500">*</span>
                    </label>
                    <InputText @bind-Value="smtpSettings.SmtpFromEmail"
                               type="email"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                               placeholder="noreply@example.com" />
                    <ValidationMessage For="@(() => smtpSettings.SmtpFromEmail)" class="text-red-500 text-sm mt-1" />
                </div>

                <!-- From Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        From Name <span class="text-red-500">*</span>
                    </label>
                    <InputText @bind-Value="smtpSettings.SmtpFromName"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                               placeholder="MediChat.AI" />
                    <ValidationMessage For="@(() => smtpSettings.SmtpFromName)" class="text-red-500 text-sm mt-1" />
                </div>

                <!-- Enable SSL -->
                <div class="md:col-span-2">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <InputCheckbox @bind-Value="smtpSettings.SmtpEnableSsl"
                                       class="w-5 h-5 text-primary dark:text-primary border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-primary" />
                        <span class="text-sm text-gray-700 dark:text-gray-300">Enable SSL/TLS (Recommended)</span>
                    </label>
                </div>
            </div>

            <div class="mt-4 flex gap-3">
                <button type="submit"
                        disabled="@isSmtpLoading"
                        class="px-6 py-2 bg-primary text-white rounded-lg hover:opacity-90 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                    @if (isSmtpLoading)
                    {
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>Save SMTP Settings</span>
                    }
                </button>

                <button type="button"
                        @onclick="TestSmtpConnection"
                        disabled="@isTestingSmtp"
                        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                    @if (isTestingSmtp)
                    {
                        <span>Testing...</span>
                    }
                    else
                    {
                        <span>Test Connection</span>
                    }
                </button>
            </div>
        </div>
    </EditForm>

    <!-- Email Template Theme -->
    <EditForm Model="@emailThemeSettings" OnValidSubmit="@HandleEmailThemeSubmit">
        <DataAnnotationsValidator />

        <div class="border-t pt-6">
            <h4 class="text-md font-medium text-gray-900 dark:text-white mb-3">Email Template Theme</h4>

            <!-- Theme Selection -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-white mb-2">
                    Select Theme <span class="text-red-500">*</span>
                </label>
                <InputSelect @bind-Value="emailThemeSettings.EmailTemplateTheme"
                             @bind-Value:after="OnThemeChanged"
                             class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="Default">Default Theme</option>
                    <option value="Modern">Modern Theme</option>
                    <option value="Professional">Professional Theme</option>
                    <option value="Custom">Custom Theme</option>
                </InputSelect>
                <p class="text-xs text-gray-500 dark:text-gray-200 mt-2">Select "Custom" to customize colors</p>

                <!-- Color Preview for Selected Theme -->
                <div class="mt-3 p-3 bg-gray-50 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white ">
                    <p class="text-xs font-medium text-gray-600 dark:text-gray-200 mb-2">Current Theme Colors:</p>
                    <div class="flex gap-3 items-center">
                        <div class="flex items-center gap-2">
                            <div style="background-color: @emailThemeSettings.EmailPrimaryColor; width: 40px; height: 40px; border-radius: 6px; border: 2px solid #e5e7eb;"></div>
                            <span class="text-xs text-gray-600 dark:text-gray-200">Primary</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div style="background-color: @emailThemeSettings.EmailSecondaryColor; width: 40px; height: 40px; border-radius: 6px; border: 2px solid #e5e7eb;"></div>
                            <span class="text-xs text-gray-600 dark:text-gray-200">Secondary</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div style="background-color: @emailThemeSettings.EmailBackgroundColor; width: 40px; height: 40px; border-radius: 6px; border: 2px solid #e5e7eb;"></div>
                            <span class="text-xs text-gray-600 dark:text-gray-200">Background</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div style="background-color: @emailThemeSettings.EmailTextColor; width: 40px; height: 40px; border-radius: 6px; border: 2px solid #e5e7eb;"></div>
                            <span class="text-xs text-gray-600 dark:text-gray-200">Text</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Custom Color Options (Only visible when Custom theme is selected) -->
            @if (emailThemeSettings.EmailTemplateTheme == "Custom")
            {
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Primary Color
                        </label>
                        <div class="flex gap-2">
                            <InputText @bind-Value="emailThemeSettings.EmailPrimaryColor"
                                       type="color"
                                       class="w-16 h-10 border border-gray-300 rounded-lg cursor-pointer" />
                            <InputText @bind-Value="emailThemeSettings.EmailPrimaryColor"
                                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="#007bff" />
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Secondary Color
                        </label>
                        <div class="flex gap-2">
                            <InputText @bind-Value="emailThemeSettings.EmailSecondaryColor"
                                       type="color"
                                       class="w-16 h-10 border border-gray-300 rounded-lg cursor-pointer" />
                            <InputText @bind-Value="emailThemeSettings.EmailSecondaryColor"
                                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="#6c757d" />
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Background Color
                        </label>
                        <div class="flex gap-2">
                            <InputText @bind-Value="emailThemeSettings.EmailBackgroundColor"
                                       type="color"
                                       class="w-16 h-10 border border-gray-300 rounded-lg cursor-pointer" />
                            <InputText @bind-Value="emailThemeSettings.EmailBackgroundColor"
                                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="#f8f9fa" />
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Text Color
                        </label>
                        <div class="flex gap-2">
                            <InputText @bind-Value="emailThemeSettings.EmailTextColor"
                                       type="color"
                                       class="w-16 h-10 border border-gray-300 rounded-lg cursor-pointer" />
                            <InputText @bind-Value="emailThemeSettings.EmailTextColor"
                                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="#212529" />
                        </div>
                    </div>
                </div>
            }

            <!-- Header & Footer -->
            <div class="grid grid-cols-1 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Header Image URL
                    </label>
                    <InputText @bind-Value="emailThemeSettings.EmailHeaderImageUrl"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                               placeholder="https://example.com/logo.png" />
                </div>

                <div>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <InputCheckbox @bind-Value="emailThemeSettings.EmailIncludeFooter"
                                       class="w-5 h-5 text-primary dark:text-primary border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-primary" />
                        <span class="text-sm text-gray-700 dark:text-gray-300">Include Footer</span>
                    </label>
                </div>

                @if (emailThemeSettings.EmailIncludeFooter)
                {
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Footer Text
                        </label>
                        <InputTextArea @bind-Value="emailThemeSettings.EmailFooterText"
                                       class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                       rows="2"
                                       placeholder="Â© 2025 MediChat.AI. All rights reserved." />
                    </div>
                }

                <div>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <InputCheckbox @bind-Value="emailThemeSettings.EmailIncludeSocialLinks"
                                       class="w-5 h-5 text-primary dark:text-primary border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-primary" />
                        <span class="text-sm text-gray-700 dark:text-gray-300">Include Social Media Links</span>
                    </label>
                </div>

                @if (emailThemeSettings.EmailIncludeSocialLinks)
                {
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Facebook URL</label>
                            <InputText @bind-Value="emailThemeSettings.EmailFacebookUrl"
                                       class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                       placeholder="https://facebook.com/yourpage" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Twitter URL</label>
                            <InputText @bind-Value="emailThemeSettings.EmailTwitterUrl"
                                       class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                       placeholder="https://twitter.com/yourhandle" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">LinkedIn URL</label>
                            <InputText @bind-Value="emailThemeSettings.EmailLinkedInUrl"
                                       class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                       placeholder="https://linkedin.com/company/yourcompany" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Instagram URL</label>
                            <InputText @bind-Value="emailThemeSettings.EmailInstagramUrl"
                                       class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                       placeholder="https://instagram.com/yourprofile" />
                        </div>
                    </div>
                }
            </div>

            <div class="flex justify-end">
                <button type="submit"
                        disabled="@isEmailThemeLoading"
                        class="px-6 py-2 bg-primary text-white rounded-lg hover:opacity-90 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                    @if (isEmailThemeLoading)
                    {
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>Save Email Theme</span>
                    }
                </button>
            </div>
        </div>
    </EditForm>
</div>

@code {
    private UpdateSmtpSettingsInput smtpSettings = new("smtp.gmail.com", 587, "", "", true, "", "");
    private UpdateEmailThemeInput emailThemeSettings = new("Default", "#007bff", "#6c757d", "#f8f9fa", "#212529", "", false, "", false, null, null, null, null);

    private bool isSmtpLoading = false;
    private bool isEmailThemeLoading = false;
    private bool isTestingSmtp = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
    }

    private async Task LoadSettings()
    {
        try
        {
            var systemSettings = await SettingsService.GetSystemSettingsAsync();
            if (systemSettings != null)
            {
                smtpSettings = new UpdateSmtpSettingsInput(
                    string.IsNullOrEmpty(systemSettings.SmtpServer) ? "smtp.gmail.com" : systemSettings.SmtpServer,
                    systemSettings.SmtpPort == 0 ? 587 : systemSettings.SmtpPort,
                    systemSettings.SmtpUsername,
                    "", // Don't load password for security
                    systemSettings.SmtpEnableSsl,
                    systemSettings.SmtpFromEmail,
                    systemSettings.SmtpFromName
                );

                emailThemeSettings = new UpdateEmailThemeInput(
                    systemSettings.EmailTemplateTheme,
                    systemSettings.EmailPrimaryColor,
                    systemSettings.EmailSecondaryColor,
                    systemSettings.EmailBackgroundColor,
                    systemSettings.EmailTextColor,
                    systemSettings.EmailHeaderImageUrl,
                    systemSettings.EmailIncludeFooter,
                    systemSettings.EmailFooterText,
                    systemSettings.EmailIncludeSocialLinks,
                    systemSettings.EmailFacebookUrl,
                    systemSettings.EmailTwitterUrl,
                    systemSettings.EmailLinkedInUrl,
                    systemSettings.EmailInstagramUrl
                );
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load settings: {ex.Message}");
        }
    }

    private void OnThemeChanged()
    {
        // Set default colors based on theme selection
        switch (emailThemeSettings.EmailTemplateTheme)
        {
            case "Default":
                emailThemeSettings.EmailPrimaryColor = "#007bff";
                emailThemeSettings.EmailSecondaryColor = "#6c757d";
                emailThemeSettings.EmailBackgroundColor = "#f8f9fa";
                emailThemeSettings.EmailTextColor = "#212529";
                break;
            case "Modern":
                emailThemeSettings.EmailPrimaryColor = "#6366f1";
                emailThemeSettings.EmailSecondaryColor = "#8b5cf6";
                emailThemeSettings.EmailBackgroundColor = "#f9fafb";
                emailThemeSettings.EmailTextColor = "#111827";
                break;
            case "Professional":
                emailThemeSettings.EmailPrimaryColor = "#1e40af";
                emailThemeSettings.EmailSecondaryColor = "#475569";
                emailThemeSettings.EmailBackgroundColor = "#ffffff";
                emailThemeSettings.EmailTextColor = "#1f2937";
                break;
            // Custom - user will define their own colors
        }

        // Force UI update to show new colors in preview boxes
        StateHasChanged();
    }

    private async Task HandleSmtpSubmit()
    {
        isSmtpLoading = true;

        try
        {
            var result = await SettingsService.UpdateSmtpSettingsAsync(smtpSettings);

            if (result != null && result.Success)
            {
                ToastService.ShowSuccess(result.Message ?? "SMTP settings saved successfully!");
            }
            else
            {
                ToastService.ShowError(result?.Message ?? "Failed to save SMTP settings.");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error: {ex.Message}");
        }
        finally
        {
            isSmtpLoading = false;
        }
    }

    private async Task HandleEmailThemeSubmit()
    {
        isEmailThemeLoading = true;

        try
        {
            var result = await SettingsService.UpdateEmailThemeSettingsAsync(emailThemeSettings);

            if (result != null && result.Success)
            {
                ToastService.ShowSuccess(result.Message ?? "Email theme settings saved successfully!");
            }
            else
            {
                ToastService.ShowError(result?.Message ?? "Failed to save email theme settings.");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error: {ex.Message}");
        }
        finally
        {
            isEmailThemeLoading = false;
        }
    }

    private async Task TestSmtpConnection()
    {
        isTestingSmtp = true;

        try
        {
            var result = await SettingsService.TestSmtpConnectionAsync();

            if (result != null && result.Success)
            {
                ToastService.ShowSuccess(result.Message ?? "SMTP connection test successful!");
            }
            else
            {
                ToastService.ShowError(result?.Message ?? "SMTP connection test failed.");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error: {ex.Message}");
        }
        finally
        {
            isTestingSmtp = false;
        }
    }
}

@page "/admin/reports"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.SignalR.Client
@using MediChatAI_BlazorWebAssembly.Features.Admin.Components
@inject IAdminService AdminService
@inject NavigationManager Navigation
@inject AppSettingsState AppSettings
@inject IJSRuntime JS
@inject IToastService ToastService
@inject IReportService ReportService
@inject IThemeService ThemeService
@inject ThemeState ThemeState
@inject ILocalStorageService LocalStorage
@implements IAsyncDisposable

<PageTitle>Reports - @AppSettings.Settings.SiteName Admin</PageTitle>

<AuthorizeRouteGuard RequiredRole="Admin">

<div class="min-h-screen bg-theme dark:bg-gray-900">
    <!-- Hero Header with Glassmorphism -->
    <header class="backdrop-blur-md bg-gradient-to-r from-primary via-accent to-primary border-b border-gray-200/50 dark:border-gray-700/50 shadow-2xl">
        <div class="py-10 px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="p-4 bg-white/20 dark:bg-white/10 rounded-2xl shadow-lg backdrop-blur-sm">
                        <svg class="w-10 h-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-4xl font-bold text-white">
                            Advanced Reports
                        </h1>
                        <p class="mt-2 text-lg text-white/90">Generate, customize, and schedule comprehensive reports</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button @onclick="OpenReportBuilder"
                            class="group flex items-center px-5 py-2.5 rounded-xl bg-white/20 dark:bg-white/10 backdrop-blur-sm border border-white/20 text-white hover:bg-white/30 transition-all duration-300 shadow-lg hover:shadow-xl">
                        <svg class="w-5 h-5 mr-2 group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        New Report
                    </button>
                    <button @onclick='() => Navigation.NavigateTo("/admin/scheduled-reports")'
                            class="group flex items-center px-5 py-2.5 rounded-xl bg-white/20 dark:bg-white/10 backdrop-blur-sm border border-white/20 text-white hover:bg-white/30 transition-all duration-300 shadow-lg hover:shadow-xl">
                        <svg class="w-5 h-5 mr-2 group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Scheduled
                    </button>
                    <button @onclick='() => Navigation.NavigateTo("/admin/dashboard")'
                            class="group flex items-center px-4 py-2.5 rounded-xl bg-white/20 dark:bg-white/10 backdrop-blur-sm border border-white/20 text-white hover:bg-white/30 transition-all duration-300 shadow-lg">
                        <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
                        Back
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="py-8 px-4 sm:px-6 lg:px-8">

        <!-- Quick Stats Bar -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-xl hover:shadow-2xl transition-all duration-300 hover:scale-105">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Total Reports</p>
                        <p class="text-3xl font-bold mt-1">@totalReports</p>
                    </div>
                    <div class="p-3 bg-white/20 rounded-xl">
                        <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-6 text-white shadow-xl hover:shadow-2xl transition-all duration-300 hover:scale-105">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Scheduled</p>
                        <p class="text-3xl font-bold mt-1">@scheduledReports</p>
                    </div>
                    <div class="p-3 bg-white/20 rounded-xl">
                        <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-6 text-white shadow-xl hover:shadow-2xl transition-all duration-300 hover:scale-105">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Templates</p>
                        <p class="text-3xl font-bold mt-1">@savedTemplates</p>
                    </div>
                    <div class="p-3 bg-white/20 rounded-xl">
                        <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl p-6 text-white shadow-xl hover:shadow-2xl transition-all duration-300 hover:scale-105">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">This Month</p>
                        <p class="text-3xl font-bold mt-1">@monthlyReports</p>
                    </div>
                    <div class="p-3 bg-white/20 rounded-xl">
                        <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-card/80 dark:bg-gray-800/80 backdrop-blur-lg border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl mb-8">
            <div class="border-b border-gray-200 dark:border-gray-700">
                <nav class="flex -mb-px overflow-x-auto custom-scrollbar">
                    <button @onclick='() => activeTab = "templates"'
                            class="@GetTabClass("templates") whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition-all duration-200 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        Report Templates
                    </button>

                    <button @onclick='() => activeTab = "custom"'
                            class="@GetTabClass("custom") whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition-all duration-200 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"/>
                        </svg>
                        Custom Builder
                    </button>

                    <button @onclick='() => activeTab = "scheduled"'
                            class="@GetTabClass("scheduled") whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition-all duration-200 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        Scheduled Reports
                    </button>

                    <button @onclick='() => activeTab = "history"'
                            class="@GetTabClass("history") whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition-all duration-200 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Report History
                    </button>

                    <button @onclick='() => activeTab = "comparison"'
                            class="@GetTabClass("comparison") whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition-all duration-200 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        Comparison
                    </button>
                </nav>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="mt-6">
            @if (activeTab == "templates")
            {
                <!-- Report Templates Section -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                    <!-- User Reports Category -->
                    <div class="bg-gradient-to-br from-card/90 to-card/70 dark:from-gray-800/90 dark:to-gray-900/70 backdrop-blur-xl border border-gray-200/50 dark:border-gray-700/50 rounded-3xl shadow-2xl overflow-hidden group hover:scale-105 transition-all duration-300">
                        <div class="p-6 border-b border-gray-200/50 dark:border-gray-700/50 bg-gradient-to-r from-blue-500/10 to-cyan-500/10">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="p-3 bg-blue-500/20 rounded-xl">
                                        <svg class="w-8 h-8 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">User Reports</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">5 templates</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-6 space-y-3">
                            <button @onclick='() => GenerateReport("new-registrations")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">New Registrations Trend</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("user-activity")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">User Activity Heatmap</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("engagement")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">Engagement Metrics</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("role-distribution")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">Role Distribution</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("retention")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">Retention Analysis</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- System Performance Category -->
                    <div class="bg-gradient-to-br from-card/90 to-card/70 dark:from-gray-800/90 dark:to-gray-900/70 backdrop-blur-xl border border-gray-200/50 dark:border-gray-700/50 rounded-3xl shadow-2xl overflow-hidden group hover:scale-105 transition-all duration-300">
                        <div class="p-6 border-b border-gray-200/50 dark:border-gray-700/50 bg-gradient-to-r from-purple-500/10 to-pink-500/10">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="p-3 bg-purple-500/20 rounded-xl">
                                        <svg class="w-8 h-8 text-purple-600 dark:text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">System Performance</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">4 templates</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-6 space-y-3">
                            <button @onclick='() => GenerateReport("performance-metrics")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">Performance Metrics</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-purple-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("response-times")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">API Response Times</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-purple-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("error-rate")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">Error Rate Analysis</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-purple-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("uptime")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">Uptime/Downtime Report</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-purple-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- Activity Reports Category -->
                    <div class="bg-gradient-to-br from-card/90 to-card/70 dark:from-gray-800/90 dark:to-gray-900/70 backdrop-blur-xl border border-gray-200/50 dark:border-gray-700/50 rounded-3xl shadow-2xl overflow-hidden group hover:scale-105 transition-all duration-300">
                        <div class="p-6 border-b border-gray-200/50 dark:border-gray-700/50 bg-gradient-to-r from-emerald-500/10 to-teal-500/10">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="p-3 bg-emerald-500/20 rounded-xl">
                                        <svg class="w-8 h-8 text-emerald-600 dark:text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Activity Reports</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">5 templates</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-6 space-y-3">
                            <button @onclick='() => GenerateReport("activity-types")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">Top Activities by Type</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-emerald-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("peak-hours")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">Peak Usage Hours</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-emerald-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("timeline")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">Activity Timeline</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-emerald-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("user-journey")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">User Journey Analysis</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-emerald-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("comparative")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">Comparative Activity</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-emerald-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                        </div>
                    </div>

                </div>
            }
            else if (activeTab == "custom")
            {
                <!-- Custom Report Builder -->
                <MediChatAI_BlazorWebAssembly.Features.Admin.Components.CustomReportBuilder OnReportGenerated="OnCustomReportGenerated" OnCancel="CloseReportBuilder" />
            }
            else if (activeTab == "scheduled")
            {
                <!-- Scheduled Reports -->
                <div class="bg-card/80 dark:bg-gray-800/80 backdrop-blur-lg border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Scheduled Reports</h3>
                        <button @onclick="OpenScheduleModal" class="px-4 py-2 bg-primary text-white rounded-lg hover:opacity-90 transition-all flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            New Schedule
                        </button>
                    </div>

                    @if (!scheduledReportsList.Any())
                    {
                        <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <p>No scheduled reports yet. Create one to get automated reports delivered to your email.</p>
                        </div>
                    }
                    else
                    {
                        <div class="space-y-4">
                            @foreach (var schedule in scheduledReportsList)
                            {
                                <div class="p-6 bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-700/50 dark:to-gray-800/50 rounded-xl border border-gray-200 dark:border-gray-700">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-3 mb-2">
                                                <h4 class="text-lg font-bold text-gray-900 dark:text-white">@schedule.ReportName</h4>
                                                <span class="px-2 py-1 text-xs font-medium @(schedule.IsActive ? "bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400" : "bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-400") rounded-full">
                                                    @(schedule.IsActive ? "Active" : "Inactive")
                                                </span>
                                            </div>
                                            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-4 text-sm">
                                                <div>
                                                    <p class="text-gray-600 dark:text-gray-400">Frequency</p>
                                                    <p class="font-medium text-gray-900 dark:text-white">@schedule.Frequency</p>
                                                </div>
                                                <div>
                                                    <p class="text-gray-600 dark:text-gray-400">Format</p>
                                                    <p class="font-medium text-gray-900 dark:text-white">@schedule.Format</p>
                                                </div>
                                                <div>
                                                    <p class="text-gray-600 dark:text-gray-400">Next Run</p>
                                                    <p class="font-medium text-gray-900 dark:text-white">@FormatIst(schedule.NextRun)</p>
                                                </div>
                                                <div>
                                                    <p class="text-gray-600 dark:text-gray-400">Last Run</p>
                                                    <p class="font-medium text-gray-900 dark:text-white">@(schedule.LastRun.HasValue ? FormatIst(schedule.LastRun) : "Never")</p>
                                                </div>
                                                <div>
                                                    <p class="text-gray-600 dark:text-gray-400">Recipients</p>
                                                    <p class="font-medium text-gray-900 dark:text-white">@schedule.Recipients.Count email(s)</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2 ml-4">
                                            <button @onclick="() => RunScheduleNow(schedule)" class="p-2 hover:bg-green-100 dark:hover:bg-green-900/30 rounded-lg transition-colors" title="Run Now">
                                                <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                            </button>
                                            <button @onclick="() => ToggleScheduleStatus(schedule)" class="p-2 hover:bg-yellow-100 dark:hover:bg-yellow-900/30 rounded-lg transition-colors" title="@(schedule.IsActive ? "Pause" : "Activate")">
                                                @if (schedule.IsActive)
                                                {
                                                    <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                    </svg>
                                                }
                                                else
                                                {
                                                    <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                    </svg>
                                                }
                                            </button>
                                            <button @onclick="() => EditSchedule(schedule)" class="p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors" title="Edit">
                                                <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                </svg>
                                            </button>
                                            <button @onclick="() => DeleteSchedule(schedule.Id)" class="p-2 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg transition-colors" title="Delete">
                                                <svg class="w-5 h-5 text-red-600 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
            else if (activeTab == "history")
            {
                <!-- Report History -->
                <div class="bg-card/80 dark:bg-gray-800/80 backdrop-blur-lg border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Report History</h3>
                        <div class="flex space-x-2">
                            <input type="text" @bind="searchQuery" placeholder="Search reports..."
                                   class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" />
                            <button class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    @if (!reportHistory.Any())
                    {
                        <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p>No reports in history yet. Generate your first report to see it here.</p>
                        </div>
                    }
                    else
                    {
                        <div class="space-y-3">
                            @foreach (var item in reportHistory.Take(20))
                            {
                                <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                    <div class="flex items-center space-x-4">
                                        <div class="p-3 @(item.ReportType == "scheduled" ? "bg-purple-100 dark:bg-purple-900/30" : "bg-primary/10") rounded-lg">
                                            @if (item.ReportType == "scheduled")
                                            {
                                                <svg class="w-6 h-6 text-purple-600 dark:text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                            }
                                            else
                                            {
                                                <svg class="w-6 h-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                </svg>
                                            }
                                        </div>
                                        <div>
                                            <div class="flex items-center space-x-2">
                                                <h4 class="font-semibold text-gray-900 dark:text-white">@item.ReportName</h4>
                                                @if (item.ReportType == "scheduled")
                                                {
                                                    <span class="px-2 py-0.5 text-xs font-medium bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 rounded-full">
                                                        Scheduled
                                                    </span>
                                                }
                                            </div>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                                Generated by @item.GeneratedBy on @item.GeneratedAt.ToString("MMM dd, yyyy HH:mm")
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="px-3 py-1 text-xs font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded-full">
                                            @item.Format
                                        </span>
                                        <button class="p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors" title="Download">
                                            <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
            else if (activeTab == "comparison")
            {
                <!-- Comparison Tool -->
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-orange-500 via-red-500 to-pink-500 rounded-2xl p-6 text-white shadow-xl">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="p-3 bg-white/20 rounded-xl backdrop-blur-sm">
                                    <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold">Report Comparison Tool</h2>
                                    <p class="text-white/80">Compare real data between two time periods</p>
                                </div>
                            </div>
                            @if (comparisonResult != null)
                            {
                                <button @onclick="ResetComparison" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-xl transition-colors flex items-center space-x-2">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                    </svg>
                                    <span>New Comparison</span>
                                </button>
                            }
                        </div>
                    </div>

                    @if (comparisonResult == null)
                    {
                        <!-- Step 1: Select Report Template -->
                        <div class="bg-card/80 dark:bg-gray-800/80 backdrop-blur-lg border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl p-6">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold">1</div>
                                <h3 class="text-lg font-bold text-gray-900 dark:text-white">Select Report to Compare</h3>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                @foreach (var report in comparisonReportTypes)
                                {
                                    <button @onclick="() => SelectComparisonReport(report.Key)"
                                            class="@(selectedComparisonReport == report.Key 
                                                ? "border-2 border-blue-500 bg-blue-50 dark:bg-blue-900/30 ring-2 ring-blue-500/50" 
                                                : "border-2 border-gray-200 dark:border-gray-700 hover:border-blue-300") 
                                                p-4 rounded-xl transition-all text-left">
                                        <div class="flex items-center space-x-3">
                                            <span class="text-2xl">@report.Value.Icon</span>
                                            <div>
                                                <p class="font-medium text-gray-900 dark:text-white text-sm">@report.Value.Name</p>
                                                <p class="text-xs text-gray-500 dark:text-gray-400">@report.Value.Description</p>
                                            </div>
                                        </div>
                                    </button>
                                }
                            </div>
                        </div>

                        <!-- Step 2: Select Time Periods -->
                        <div class="bg-card/80 dark:bg-gray-800/80 backdrop-blur-lg border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl p-6">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full flex items-center justify-center text-white font-bold">2</div>
                                <h3 class="text-lg font-bold text-gray-900 dark:text-white">Select Time Periods</h3>
                            </div>
                            
                            <!-- Quick Presets -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Quick Compare</label>
                                <div class="flex flex-wrap gap-2">
                                    <button @onclick='() => SetQuickCompare("week")' 
                                            class="@(comparisonPreset == "week" ? "bg-gradient-to-r from-blue-500 to-indigo-600 text-white" : "bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200") px-4 py-2 rounded-xl text-sm font-medium transition-all">
                                         Previous Week vs This Week
                                    </button>
                                    <button @onclick='() => SetQuickCompare("month")'
                                            class="@(comparisonPreset == "month" ? "bg-gradient-to-r from-blue-500 to-indigo-600 text-white" : "bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200") px-4 py-2 rounded-xl text-sm font-medium transition-all">
                                         Previous Month vs This Month
                                    </button>
                                    <button @onclick='() => SetQuickCompare("quarter")'
                                            class="@(comparisonPreset == "quarter" ? "bg-gradient-to-r from-blue-500 to-indigo-600 text-white" : "bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200") px-4 py-2 rounded-xl text-sm font-medium transition-all">
                                         Previous Quarter vs This Quarter
                                    </button>
                                    <button @onclick='() => SetQuickCompare("custom")'
                                            class="@(comparisonPreset == "custom" ? "bg-gradient-to-r from-blue-500 to-indigo-600 text-white" : "bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200") px-4 py-2 rounded-xl text-sm font-medium transition-all">
                                         Custom Dates
                                    </button>
                                </div>
                            </div>

                            <!-- Period Cards -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Period A (Baseline) -->
                                <div class="border-2 border-blue-200 dark:border-blue-800 rounded-xl overflow-hidden">
                                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-4 py-3">
                                        <div class="flex items-center space-x-2">
                                            <div class="w-7 h-7 bg-white/20 rounded-full flex items-center justify-center font-bold text-sm">A</div>
                                            <span class="font-semibold text-white">Baseline Period</span>
                                        </div>
                                    </div>
                                    <div class="p-4 space-y-3">
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">From</label>
                                                <input type="date" @bind="periodAStart" 
                                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm"/>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">To</label>
                                                <input type="date" @bind="periodAEnd" 
                                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm"/>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-sm">
                                            <span class="text-blue-700 dark:text-blue-300">@periodAStart.ToString("MMM dd") - @periodAEnd.ToString("MMM dd, yyyy")</span>
                                            <span class="text-blue-600 dark:text-blue-400 font-medium">@GetPeriodDuration(periodAStart, periodAEnd)</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Period B (Current) -->
                                <div class="border-2 border-green-200 dark:border-green-800 rounded-xl overflow-hidden">
                                    <div class="bg-gradient-to-r from-green-500 to-emerald-600 px-4 py-3">
                                        <div class="flex items-center space-x-2">
                                            <div class="w-7 h-7 bg-white/20 rounded-full flex items-center justify-center font-bold text-sm">B</div>
                                            <span class="font-semibold text-white">Current Period</span>
                                        </div>
                                    </div>
                                    <div class="p-4 space-y-3">
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">From</label>
                                                <input type="date" @bind="periodBStart"
                                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm"/>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">To</label>
                                                <input type="date" @bind="periodBEnd"
                                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm"/>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between p-2 bg-green-50 dark:bg-green-900/20 rounded-lg text-sm">
                                            <span class="text-green-700 dark:text-green-300">@periodBStart.ToString("MMM dd") - @periodBEnd.ToString("MMM dd, yyyy")</span>
                                            <span class="text-green-600 dark:text-green-400 font-medium">@GetPeriodDuration(periodBStart, periodBEnd)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Compare Button -->
                        <div class="flex justify-center">
                            <button @onclick="RunComparison" disabled="@(isRunningComparison || string.IsNullOrEmpty(selectedComparisonReport))"
                                    class="px-8 py-4 bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-2xl hover:opacity-90 transition-all shadow-xl hover:shadow-2xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-3 text-lg font-semibold">
                                @if (isRunningComparison)
                                {
                                    <svg class="animate-spin h-6 w-6" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                    </svg>
                                    <span>Fetching Real Data...</span>
                                }
                                else
                                {
                                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                    </svg>
                                    <span>Compare @(string.IsNullOrEmpty(selectedComparisonReport) ? "Report" : comparisonReportTypes[selectedComparisonReport].Name)</span>
                                }
                            </button>
                        </div>
                    }
                    else
                    {
                        <!-- Comparison Results -->
                        <div class="space-y-6">
                            <!-- Report Info Banner -->
                            <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-xl p-4 text-white">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <span class="text-3xl">@comparisonReportTypes[selectedComparisonReport].Icon</span>
                                        <div>
                                            <h3 class="text-xl font-bold">@comparisonReportTypes[selectedComparisonReport].Name Comparison</h3>
                                            <p class="text-blue-100 text-sm">
                                                @periodAStart.ToString("MMM dd") - @periodAEnd.ToString("MMM dd") 
                                                <span class="mx-2"></span>
                                                @periodBStart.ToString("MMM dd") - @periodBEnd.ToString("MMM dd, yyyy")
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Summary Cards -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <!-- Period A Total -->
                                <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-xl p-4">
                                    <p class="text-sm text-blue-600 dark:text-blue-400 font-medium mb-1">Baseline (Period A)</p>
                                    <p class="text-3xl font-bold text-blue-700 dark:text-blue-300">@comparisonResult.PeriodATotal.ToString("N0")</p>
                                    <p class="text-xs text-blue-500">@periodAStart.ToString("MMM dd") - @periodAEnd.ToString("MMM dd")</p>
                                </div>
                                
                                <!-- Period B Total -->
                                <div class="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-700 rounded-xl p-4">
                                    <p class="text-sm text-green-600 dark:text-green-400 font-medium mb-1">Current (Period B)</p>
                                    <p class="text-3xl font-bold text-green-700 dark:text-green-300">@comparisonResult.PeriodBTotal.ToString("N0")</p>
                                    <p class="text-xs text-green-500">@periodBStart.ToString("MMM dd") - @periodBEnd.ToString("MMM dd")</p>
                                </div>
                                
                                <!-- Absolute Change -->
                                <div class="@(comparisonResult.AbsoluteChange >= 0 ? "bg-emerald-50 dark:bg-emerald-900/30 border-emerald-200 dark:border-emerald-700" : "bg-red-50 dark:bg-red-900/30 border-red-200 dark:border-red-700") border rounded-xl p-4">
                                    <p class="text-sm @(comparisonResult.AbsoluteChange >= 0 ? "text-emerald-600 dark:text-emerald-400" : "text-red-600 dark:text-red-400") font-medium mb-1">Change</p>
                                    <p class="text-3xl font-bold @(comparisonResult.AbsoluteChange >= 0 ? "text-emerald-700 dark:text-emerald-300" : "text-red-700 dark:text-red-300")">
                                        @(comparisonResult.AbsoluteChange >= 0 ? "+" : "")@comparisonResult.AbsoluteChange.ToString("N0")
                                    </p>
                                    <p class="text-xs @(comparisonResult.AbsoluteChange >= 0 ? "text-emerald-500" : "text-red-500")">
                                        @(comparisonResult.AbsoluteChange >= 0 ? "Increase" : "Decrease")
                                    </p>
                                </div>
                                
                                <!-- Percentage Change -->
                                <div class="@(comparisonResult.PercentageChange >= 0 ? "bg-purple-50 dark:bg-purple-900/30 border-purple-200 dark:border-purple-700" : "bg-orange-50 dark:bg-orange-900/30 border-orange-200 dark:border-orange-700") border rounded-xl p-4">
                                    <p class="text-sm @(comparisonResult.PercentageChange >= 0 ? "text-purple-600 dark:text-purple-400" : "text-orange-600 dark:text-orange-400") font-medium mb-1">% Change</p>
                                    <p class="text-3xl font-bold @(comparisonResult.PercentageChange >= 0 ? "text-purple-700 dark:text-purple-300" : "text-orange-700 dark:text-orange-300")">
                                        @(comparisonResult.PercentageChange >= 0 ? "+" : "")@comparisonResult.PercentageChange.ToString("F1")%
                                    </p>
                                    <p class="text-xs @(comparisonResult.PercentageChange >= 0 ? "text-purple-500" : "text-orange-500")">
                                        @(comparisonResult.PercentageChange >= 0 ? " Growth" : " Decline")
                                    </p>
                                </div>
                            </div>

                            <!-- Detailed Breakdown Table -->
                            <div class="bg-card/80 dark:bg-gray-800/80 backdrop-blur-lg border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl overflow-hidden">
                                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50">
                                    <h3 class="text-lg font-bold text-gray-900 dark:text-white flex items-center">
                                        <span class="mr-2"></span> Day-by-Day Breakdown
                                    </h3>
                                </div>
                                <div class="overflow-x-auto max-h-96">
                                    <table class="w-full">
                                        <thead class="bg-gray-100 dark:bg-gray-700 sticky top-0">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 dark:text-gray-300">Date/Label</th>
                                                <th class="px-4 py-3 text-right text-sm font-semibold text-blue-600 dark:text-blue-400">Period A</th>
                                                <th class="px-4 py-3 text-right text-sm font-semibold text-green-600 dark:text-green-400">Period B</th>
                                                <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600 dark:text-gray-300">Difference</th>
                                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600 dark:text-gray-300">Trend</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                            @foreach (var item in comparisonResult.DetailedData)
                                            {
                                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                                    <td class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-white">@item.Label</td>
                                                    <td class="px-4 py-3 text-right text-sm text-blue-600 dark:text-blue-400 font-semibold">@item.PeriodAValue.ToString("N0")</td>
                                                    <td class="px-4 py-3 text-right text-sm text-green-600 dark:text-green-400 font-semibold">@item.PeriodBValue.ToString("N0")</td>
                                                    <td class="px-4 py-3 text-right text-sm font-semibold @(item.Difference >= 0 ? "text-emerald-600" : "text-red-600")">
                                                        @(item.Difference >= 0 ? "+" : "")@item.Difference.ToString("N0")
                                                    </td>
                                                    <td class="px-4 py-3 text-center">
                                                        @if (item.Difference > 0)
                                                        {
                                                            <span class="inline-flex items-center px-2 py-1 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 rounded-full text-xs">
                                                                 @item.PercentChange.ToString("F1")%
                                                            </span>
                                                        }
                                                        else if (item.Difference < 0)
                                                        {
                                                            <span class="inline-flex items-center px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-full text-xs">
                                                                 @Math.Abs(item.PercentChange).ToString("F1")%
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="inline-flex items-center px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded-full text-xs">
                                                                 0%
                                                            </span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                        <tfoot class="bg-gray-100 dark:bg-gray-700 font-bold">
                                            <tr>
                                                <td class="px-4 py-3 text-sm text-gray-900 dark:text-white">TOTAL</td>
                                                <td class="px-4 py-3 text-right text-sm text-blue-700 dark:text-blue-300">@comparisonResult.PeriodATotal.ToString("N0")</td>
                                                <td class="px-4 py-3 text-right text-sm text-green-700 dark:text-green-300">@comparisonResult.PeriodBTotal.ToString("N0")</td>
                                                <td class="px-4 py-3 text-right text-sm @(comparisonResult.AbsoluteChange >= 0 ? "text-emerald-700" : "text-red-700")">
                                                    @(comparisonResult.AbsoluteChange >= 0 ? "+" : "")@comparisonResult.AbsoluteChange.ToString("N0")
                                                </td>
                                                <td class="px-4 py-3 text-center">
                                                    <span class="@(comparisonResult.PercentageChange >= 0 ? "text-emerald-700" : "text-red-700")">
                                                        @(comparisonResult.PercentageChange >= 0 ? "+" : "")@comparisonResult.PercentageChange.ToString("F1")%
                                                    </span>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>

                            <!-- Detailed Changes Section - Shows actual names/records -->
                            @if (comparisonResult.NewInPeriodB.Any() || comparisonResult.RemovedInPeriodB.Any() || comparisonResult.AllPeriodBRecords.Any())
                            {
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <!-- New Additions in Period B -->
                                    <div class="bg-card/80 dark:bg-gray-800/80 backdrop-blur-lg border border-emerald-200 dark:border-emerald-800 rounded-2xl shadow-xl overflow-hidden">
                                        <div class="px-6 py-4 border-b border-emerald-200 dark:border-emerald-800 bg-gradient-to-r from-emerald-50 to-green-50 dark:from-emerald-900/30 dark:to-green-900/30">
                                            <h3 class="text-lg font-bold text-emerald-800 dark:text-emerald-300 flex items-center">
                                                <span class="mr-2"></span> New in @periodBStart.ToString("MMM dd") - @periodBEnd.ToString("MMM dd")
                                                @if (comparisonResult.NewInPeriodB.Any())
                                                {
                                                    <span class="ml-2 px-2 py-1 bg-emerald-500 text-white text-xs rounded-full">
                                                        +@comparisonResult.NewInPeriodB.Count
                                                    </span>
                                                }
                                            </h3>
                                            <p class="text-sm text-emerald-600 dark:text-emerald-400 mt-1">
                                                New @GetComparisonItemTypeName() not present in the baseline period
                                            </p>
                                        </div>
                                        <div class="p-4 max-h-64 overflow-y-auto">
                                            @if (comparisonResult.NewInPeriodB.Any())
                                            {
                                                <div class="space-y-2">
                                                    @foreach (var record in comparisonResult.NewInPeriodB)
                                                    {
                                                        <div class="flex items-center justify-between p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl border border-emerald-100 dark:border-emerald-800">
                                                            <div class="flex items-center space-x-3">
                                                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center text-white font-bold text-sm">
                                                                    @(record.Name.Length > 0 ? record.Name[0].ToString().ToUpper() : "?")
                                                                </div>
                                                                <div>
                                                                    <p class="font-semibold text-gray-900 dark:text-white">@record.Name</p>
                                                                    <p class="text-xs text-gray-500 dark:text-gray-400">@record.Email</p>
                                                                </div>
                                                            </div>
                                                            <div class="text-right">
                                                                <span class="px-2 py-1 text-xs font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-full">@record.Role</span>
                                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                                    @record.Timestamp.ToString("MMM dd, HH:mm")
                                                                </p>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                            else if (comparisonResult.AllPeriodBRecords.Any())
                                            {
                                                <div class="text-center text-gray-500 dark:text-gray-400 py-4">
                                                    <span class="text-2xl"></span>
                                                    <p class="mt-2">All @comparisonResult.AllPeriodBRecords.Count records already existed in the baseline period</p>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="text-center text-gray-500 dark:text-gray-400 py-4">
                                                    <span class="text-2xl"></span>
                                                    <p class="mt-2">No new records in this period</p>
                                                </div>
                                            }
                                        </div>
                                    </div>

                                    <!-- Removed/Deleted in Period B -->
                                    <div class="bg-card/80 dark:bg-gray-800/80 backdrop-blur-lg border border-red-200 dark:border-red-800 rounded-2xl shadow-xl overflow-hidden">
                                        <div class="px-6 py-4 border-b border-red-200 dark:border-red-800 bg-gradient-to-r from-red-50 to-pink-50 dark:from-red-900/30 dark:to-pink-900/30">
                                            <h3 class="text-lg font-bold text-red-800 dark:text-red-300 flex items-center">
                                                <span class="mr-2"></span> Removed/Not in Current Period
                                                @if (comparisonResult.RemovedInPeriodB.Any())
                                                {
                                                    <span class="ml-2 px-2 py-1 bg-red-500 text-white text-xs rounded-full">
                                                        -@comparisonResult.RemovedInPeriodB.Count
                                                    </span>
                                                }
                                            </h3>
                                            <p class="text-sm text-red-600 dark:text-red-400 mt-1">
                                                @(char.ToUpper(GetComparisonItemTypeName()[0]) + GetComparisonItemTypeName().Substring(1)) that were in baseline but not in current period
                                            </p>
                                        </div>
                                        <div class="p-4 max-h-64 overflow-y-auto">
                                            @if (comparisonResult.RemovedInPeriodB.Any())
                                            {
                                                <div class="space-y-2">
                                                    @foreach (var record in comparisonResult.RemovedInPeriodB)
                                                    {
                                                        <div class="flex items-center justify-between p-3 bg-red-50 dark:bg-red-900/20 rounded-xl border border-red-100 dark:border-red-800">
                                                            <div class="flex items-center space-x-3">
                                                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-red-400 to-pink-500 flex items-center justify-center text-white font-bold text-sm">
                                                                    @(record.Name.Length > 0 ? record.Name[0].ToString().ToUpper() : "?")
                                                                </div>
                                                                <div>
                                                                    <p class="font-semibold text-gray-900 dark:text-white line-through opacity-70">@record.Name</p>
                                                                    <p class="text-xs text-gray-500 dark:text-gray-400">@record.Email</p>
                                                                </div>
                                                            </div>
                                                            <div class="text-right">
                                                                <span class="px-2 py-1 text-xs font-medium bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-full">Removed</span>
                                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                                    Was: @record.Role
                                                                </p>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="text-center text-emerald-500 dark:text-emerald-400 py-4">
                                                    <span class="text-2xl"></span>
                                                    <p class="mt-2 font-medium">No records were removed!</p>
                                                    <p class="text-sm text-gray-500 dark:text-gray-400">All baseline records are still present</p>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>

                                <!-- All Records in Current Period (Period B) -->
                                @if (comparisonResult.AllPeriodBRecords.Any())
                                {
                                    <div class="bg-card/80 dark:bg-gray-800/80 backdrop-blur-lg border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl overflow-hidden">
                                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50">
                                            <h3 class="text-lg font-bold text-gray-900 dark:text-white flex items-center">
                                                <span class="mr-2"></span> All Records in Current Period (@periodBStart.ToString("MMM dd") - @periodBEnd.ToString("MMM dd"))
                                                <span class="ml-2 px-2 py-1 bg-blue-500 text-white text-xs rounded-full">
                                                    @comparisonResult.AllPeriodBRecords.Count total
                                                </span>
                                            </h3>
                                        </div>
                                        <div class="overflow-x-auto max-h-64">
                                            <table class="w-full">
                                                <thead class="bg-gray-100 dark:bg-gray-700 sticky top-0">
                                                    <tr>
                                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 dark:text-gray-300">Name</th>
                                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 dark:text-gray-300">Email</th>
                                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600 dark:text-gray-300">Role</th>
                                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600 dark:text-gray-300">Action</th>
                                                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600 dark:text-gray-300">Date</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                                    @foreach (var record in comparisonResult.AllPeriodBRecords)
                                                    {
                                                        var isNew = comparisonResult.NewInPeriodB.Any(n => n.Id == record.Id);
                                                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 @(isNew ? "bg-emerald-50/50 dark:bg-emerald-900/10" : "")">
                                                            <td class="px-4 py-3">
                                                                <div class="flex items-center space-x-2">
                                                                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-indigo-500 flex items-center justify-center text-white font-bold text-xs">
                                                                        @(record.Name.Length > 0 ? record.Name[0].ToString().ToUpper() : "?")
                                                                    </div>
                                                                    <span class="font-medium text-gray-900 dark:text-white">@record.Name</span>
                                                                    @if (isNew)
                                                                    {
                                                                        <span class="px-1.5 py-0.5 text-xs bg-emerald-500 text-white rounded">NEW</span>
                                                                    }
                                                                </div>
                                                            </td>
                                                            <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">@record.Email</td>
                                                            <td class="px-4 py-3 text-center">
                                                                <span class="px-2 py-1 text-xs font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-full">@record.Role</span>
                                                            </td>
                                                            <td class="px-4 py-3 text-center">
                                                                <span class="px-2 py-1 text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full">@record.Action</span>
                                                            </td>
                                                            <td class="px-4 py-3 text-right text-sm text-gray-600 dark:text-gray-400">
                                                                @record.Timestamp.ToString("MMM dd, yyyy HH:mm")
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                }
                            }

                            <!-- Insights -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Key Findings -->
                                <div class="bg-card/80 dark:bg-gray-800/80 backdrop-blur-lg border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl p-6">
                                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                                        <span class="text-xl mr-2"></span> Key Findings
                                    </h3>
                                    <div class="space-y-3">
                                        @foreach (var insight in comparisonResult.Insights)
                                        {
                                            <div class="flex items-start space-x-3 p-3 @(insight.Type == "success" ? "bg-emerald-50 dark:bg-emerald-900/20" : insight.Type == "warning" ? "bg-amber-50 dark:bg-amber-900/20" : "bg-blue-50 dark:bg-blue-900/20") rounded-xl">
                                                <span class="text-lg">@insight.Icon</span>
                                                <div>
                                                    <p class="font-medium text-gray-900 dark:text-white">@insight.Title</p>
                                                    <p class="text-sm text-gray-600 dark:text-gray-400">@insight.Description</p>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div class="bg-card/80 dark:bg-gray-800/80 backdrop-blur-lg border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl p-6">
                                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                                        <span class="text-xl mr-2"></span> Recommendations
                                    </h3>
                                    <div class="space-y-3">
                                        @foreach (var rec in comparisonResult.Recommendations)
                                        {
                                            <div class="@GetRecommendationClass(rec.Priority) p-3 rounded-xl">
                                                <div class="flex items-start justify-between">
                                                    <div>
                                                        <p class="font-medium text-gray-900 dark:text-white">@rec.Title</p>
                                                        <p class="text-sm text-gray-600 dark:text-gray-400">@rec.Description</p>
                                                    </div>
                                                    <span class="@GetRecommendationBadgeClass(rec.Priority)">@rec.Priority</span>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Export Options -->
                            <div class="flex justify-center space-x-4">
                                <button @onclick="ExportComparisonPDF" class="px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl transition-colors flex items-center space-x-2">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                    </svg>
                                    <span>Export PDF</span>
                                </button>
                                <button @onclick="ExportComparisonExcel" class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl transition-colors flex items-center space-x-2">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    <span>Export CSV</span>
                                </button>
                                <button @onclick="ShareComparison" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-xl transition-colors flex items-center space-x-2">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                                    </svg>
                                    <span>Share</span>
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>

    </main>
</div>

<!-- Hidden Report Preview Section for PDF Generation -->
<div id="reportPreviewContainer" style="position: fixed; left: -9999px; top: -9999px; width: 1200px; background: white;">
    <div id="reportPreview" class="bg-white p-12" style="font-family: Arial, sans-serif;">
        <!-- Report Header -->
        <div class="mb-8 border-b-4 border-blue-600 pb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 id="reportTitle" class="text-4xl font-bold text-gray-900 mb-2">Report Title</h1>
                    <p id="reportSubtitle" class="text-lg text-gray-600">Report Subtitle</p>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold text-blue-600 mb-1">MediChat.AI</div>
                    <div id="reportDate" class="text-sm text-gray-600">Generated on: @DateTime.Now.ToString("MMMM dd, yyyy")</div>
                </div>
            </div>
        </div>

        <!-- Executive Summary -->
        <div id="reportSummary" class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Executive Summary</h2>
            <div id="reportMetrics" class="grid grid-cols-4 gap-4 mb-6">
                <!-- Metrics will be injected here -->
            </div>
        </div>

        <!-- Chart Visualization -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Data Visualization</h2>
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <canvas id="reportChartCanvas" width="1000" height="400"></canvas>
            </div>
        </div>

        <!-- Data Table (if applicable) -->
        <div id="reportTableSection" class="mb-8" style="display: none;">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Detailed Data</h2>
            <div id="reportTableContent"></div>
        </div>

        <!-- Report Footer -->
        <div class="mt-12 pt-6 border-t-2 border-gray-300 text-center text-sm text-gray-600">
            <p>This report was automatically generated by MediChat.AI Healthcare Communication Platform</p>
            <p class="mt-1"> @DateTime.Now.Year MediChat.AI. All rights reserved.</p>
            <p class="mt-1 text-xs">For internal use only. Contains confidential information.</p>
        </div>
    </div>
</div>

<!-- Schedule Create/Edit Modal -->
@if (showScheduleModal)
{
    <div class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-gray-900/75 backdrop-blur-sm" @onclick="CloseScheduleModal"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen"></span>&#8203;

            <div class="relative inline-block w-full max-w-2xl px-4 pt-5 pb-4 overflow-hidden text-left align-bottom transition-all transform bg-white dark:bg-gray-800 rounded-2xl shadow-2xl sm:my-8 sm:align-middle sm:p-6">
                <!-- Modal Header -->
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center">
                        <div class="p-2 bg-primary/10 rounded-xl mr-3">
                            <svg class="w-6 h-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        @(isEditingSchedule ? "Edit Schedule" : "Create New Schedule")
                    </h3>
                    <button @onclick="CloseScheduleModal" class="p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <svg class="w-6 h-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="space-y-5 max-h-[70vh] overflow-y-auto pr-2">
                    <!-- Report Template Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Report Template</label>
                        <select @bind="scheduleEditModel.ReportId" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all">
                            <option value="">Select a report template...</option>
                            <option value="new-registrations">New Registrations Trend</option>
                            <option value="user-activity">User Activity Heatmap</option>
                            <option value="engagement">Engagement Metrics</option>
                            <option value="role-distribution">Role Distribution</option>
                            <option value="retention">Retention Analysis</option>
                            <option value="performance-metrics">Performance Metrics</option>
                            <option value="response-times">API Response Times</option>
                            <option value="error-rate">Error Rate Analysis</option>
                            <option value="uptime">Uptime/Downtime Report</option>
                            <option value="activity-types">Top Activities by Type</option>
                            <option value="peak-hours">Peak Usage Hours</option>
                            <option value="timeline">Activity Timeline</option>
                        </select>
                    </div>

                    <!-- Schedule Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Schedule Name</label>
                        <input type="text" @bind="scheduleEditModel.ReportName" placeholder="e.g., Weekly User Activity Report"
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all"/>
                    </div>

                    <!-- Start Date (Today or Future only) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Start Date</label>
                        <input type="date" value="@scheduleStartDate.ToString("yyyy-MM-dd")" 
                               @onchange="OnScheduleStartDateChanged"
                               min="@DateTime.Today.ToString("yyyy-MM-dd")"
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all"/>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Select today or a future date</p>
                    </div>

                    <!-- Frequency and Time -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Frequency</label>
                            <select @bind="scheduleEditModel.Frequency" @bind:after="UpdateScheduleExpressionInModal"
                                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all">
                                <option value="Daily">Daily</option>
                                <option value="Weekly">Weekly</option>
                                <option value="Bi-Weekly">Bi-Weekly</option>
                                <option value="Monthly">Monthly</option>
                                <option value="Quarterly">Quarterly</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Time</label>
                            <input type="time" value="@scheduleTimeString" 
                                   @onchange="OnScheduleTimeChanged"
                                   class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all"/>
                        </div>
                    </div>

                    <!-- Day Selection for Weekly/Bi-Weekly -->
                    @if (scheduleEditModel.Frequency == "Weekly" || scheduleEditModel.Frequency == "Bi-Weekly")
                    {
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Day of Week</label>
                            <div class="flex flex-wrap gap-2">
                                @foreach (var day in daysOfWeekSchedule)
                                {
                                    <button type="button" @onclick="() => ToggleScheduleDaySelection(day.Key)"
                                            class="px-4 py-2 rounded-lg text-sm font-medium transition-colors @(selectedScheduleDays.Contains(day.Key) ? "bg-primary text-white" : "bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600")">
                                        @day.Value
                                    </button>
                                }
                            </div>
                        </div>
                    }

                    <!-- Day of Month for Monthly/Quarterly -->
                    @if (scheduleEditModel.Frequency == "Monthly" || scheduleEditModel.Frequency == "Quarterly")
                    {
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Day of Month</label>
                            <select @bind="selectedScheduleDayOfMonth" @bind:after="UpdateScheduleExpressionInModal"
                                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all">
                                @for (int i = 1; i <= 28; i++)
                                {
                                    <option value="@i">@GetOrdinalSuffix(i)</option>
                                }
                                <option value="0">Last day of month</option>
                            </select>
                        </div>
                    }

                    <!-- Export Format -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Export Format</label>
                        <div class="grid grid-cols-4 gap-3">
                            @foreach (var format in scheduleExportFormats)
                            {
                                <button type="button" @onclick="() => scheduleEditModel.Format = format"
                                        class="p-3 rounded-xl text-center transition-all @(scheduleEditModel.Format == format ? "bg-primary text-white shadow-lg" : "bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600")">
                                    <span class="text-sm font-medium">@format</span>
                                </button>
                            }
                        </div>
                    </div>

                    <!-- Recipients -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Recipients</label>
                        <div class="space-y-2">
                            <div class="flex gap-2">
                                <input type="email" @bind="newScheduleRecipientEmail" placeholder="Enter email address..."
                                       class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all"/>
                                <button type="button" @onclick="AddScheduleRecipient" 
                                        class="px-4 py-3 bg-primary text-white rounded-xl hover:bg-primary/90 transition-colors">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                </button>
                            </div>
                            @if (scheduleEditModel.Recipients.Any())
                            {
                                <div class="flex flex-wrap gap-2 mt-3">
                                    @foreach (var recipient in scheduleEditModel.Recipients)
                                    {
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                                            @recipient
                                            <button type="button" @onclick="() => RemoveScheduleRecipient(recipient)" class="ml-2 text-gray-400 hover:text-red-500">
                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                </svg>
                                            </button>
                                        </span>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Active Toggle -->
                    <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                        <div>
                            <label class="text-sm font-medium text-gray-900 dark:text-white">Active</label>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Enable or disable this scheduled report</p>
                        </div>
                        <button type="button" @onclick="() => scheduleEditModel.IsActive = !scheduleEditModel.IsActive"
                                class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out @(scheduleEditModel.IsActive ? "bg-primary" : "bg-gray-200 dark:bg-gray-600")">
                            <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out @(scheduleEditModel.IsActive ? "translate-x-5" : "translate-x-0")"></span>
                        </button>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="flex justify-end space-x-3 mt-6 pt-5 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" @onclick="CloseScheduleModal"
                            class="px-6 py-2.5 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        Cancel
                    </button>
                    <button type="button" @onclick="SaveScheduleFromModal" disabled="@isSavingSchedule"
                            class="px-6 py-2.5 bg-primary text-white rounded-xl hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
                        @if (isSavingSchedule)
                        {
                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Saving...</span>
                        }
                        else
                        {
                            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>@(isEditingSchedule ? "Update Schedule" : "Create Schedule")</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@* Share Modal *@
@if (showShareModal)
{
    <div class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="share-modal" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
            @* Backdrop *@
            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75 dark:bg-gray-900 dark:bg-opacity-80" @onclick="CloseShareModal"></div>

            @* Modal Content *@
            <div class="relative z-50 w-full max-w-md p-6 mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-2xl transform transition-all">
                @* Header *@
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white flex items-center">
                        <span class="mr-2 text-2xl"></span>
                        Share Comparison Report
                    </h3>
                    <button @onclick="CloseShareModal" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                @* Share Options Grid *@
                <div class="grid grid-cols-2 gap-4 mb-6">
                    @* Copy to Clipboard *@
                    <button @onclick='() => ShareVia("copy")' class="flex flex-col items-center p-4 rounded-xl bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-600 hover:from-gray-200 hover:to-gray-300 dark:hover:from-gray-600 dark:hover:to-gray-500 transition-all group">
                        <div class="w-12 h-12 flex items-center justify-center rounded-full bg-gradient-to-br from-gray-500 to-gray-600 text-white mb-2 group-hover:scale-110 transition-transform">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/>
                            </svg>
                        </div>
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-200">Copy</span>
                    </button>

                    @* Email *@
                    <button @onclick='() => ShareVia("email")' class="flex flex-col items-center p-4 rounded-xl bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/30 hover:from-blue-100 hover:to-blue-200 dark:hover:from-blue-800/40 dark:hover:to-blue-700/40 transition-all group">
                        <div class="w-12 h-12 flex items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-blue-600 text-white mb-2 group-hover:scale-110 transition-transform">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-200">Email</span>
                    </button>

                    @* WhatsApp *@
                    <button @onclick='() => ShareVia("whatsapp")' class="flex flex-col items-center p-4 rounded-xl bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/30 dark:to-green-800/30 hover:from-green-100 hover:to-green-200 dark:hover:from-green-800/40 dark:hover:to-green-700/40 transition-all group">
                        <div class="w-12 h-12 flex items-center justify-center rounded-full bg-gradient-to-br from-green-500 to-green-600 text-white mb-2 group-hover:scale-110 transition-transform">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                            </svg>
                        </div>
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-200">WhatsApp</span>
                    </button>

                    @* SMS *@
                    <button @onclick='() => ShareVia("sms")' class="flex flex-col items-center p-4 rounded-xl bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/30 dark:to-purple-800/30 hover:from-purple-100 hover:to-purple-200 dark:hover:from-purple-800/40 dark:hover:to-purple-700/40 transition-all group">
                        <div class="w-12 h-12 flex items-center justify-center rounded-full bg-gradient-to-br from-purple-500 to-purple-600 text-white mb-2 group-hover:scale-110 transition-transform">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg>
                        </div>
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-200">SMS</span>
                    </button>

                    @* Telegram *@
                    <button @onclick='() => ShareVia("telegram")' class="flex flex-col items-center p-4 rounded-xl bg-gradient-to-br from-sky-50 to-sky-100 dark:from-sky-900/30 dark:to-sky-800/30 hover:from-sky-100 hover:to-sky-200 dark:hover:from-sky-800/40 dark:hover:to-sky-700/40 transition-all group col-span-2">
                        <div class="w-12 h-12 flex items-center justify-center rounded-full bg-gradient-to-br from-sky-500 to-sky-600 text-white mb-2 group-hover:scale-110 transition-transform">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                            </svg>
                        </div>
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-200">Telegram</span>
                    </button>
                </div>

                @* Preview Section - Actual PDF Preview in iframe *@
                <div class="mt-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-600 dark:text-gray-400"> PDF Preview</span>
                    </div>
                    @if (!string.IsNullOrEmpty(pdfPreviewUrl))
                    {
                        <div class="rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden bg-white shadow-inner">
                            <iframe src="@pdfPreviewUrl" class="w-full h-72" title="PDF Preview" style="border: none;"></iframe>
                        </div>
                    }
                    else
                    {
                        <div class="p-8 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 text-center">
                            <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-500 border-t-transparent mx-auto mb-3"></div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Generating PDF preview...</p>
                        </div>
                    }
                </div>

                @* Footer *@
                <div class="mt-6 flex justify-end">
                    <button @onclick="CloseShareModal" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
}

</AuthorizeRouteGuard>

@code {
    private string activeTab = "templates";
    private int totalReports = 14;
    private int scheduledReports = 0;
    private int savedTemplates = 14;
    private int monthlyReports = 0;
    private string searchQuery = "";
    private bool isGeneratingReport = false;
    private ReportDataDto? currentReport;
    private Dictionary<string, object>? currentChartData;
    private List<ReportHistoryDto> reportHistory = new();
    private List<ScheduledReportDto> scheduledReportsList = new();

    // SignalR
    private HubConnection? hubConnection;
    private bool isHubConnected => hubConnection?.State == HubConnectionState.Connected;

    // IST TimeZone offset (UTC+5:30)
    private static readonly TimeSpan IstOffset = TimeSpan.FromHours(5.5);
    
    // Helper to convert DateTime to IST for display
    // Handles both UTC and already-converted local times from JSON deserialization
    private static DateTime ToIst(DateTime dateTime)
    {
        // If DateTime is UTC, convert to IST by adding offset
        if (dateTime.Kind == DateTimeKind.Utc)
        {
            return dateTime.Add(IstOffset);
        }
        // If DateTime is Local (already converted by JSON deserializer), use as-is
        // since browser in IST timezone already has correct local time
        return dateTime;
    }
    
    // Helper to format date in IST
    private static string FormatIst(DateTime? dateTime, string format = "MMM dd, HH:mm")
    {
        if (!dateTime.HasValue) return "N/A";
        return ToIst(dateTime.Value).ToString(format);
    }

    // Schedule modal state
    private bool showScheduleModal = false;
    private bool isEditingSchedule = false;
    private bool isSavingSchedule = false;
    private ScheduleEditModel scheduleEditModel = new();
    private string scheduleTimeString = "09:00";
    private DateTime scheduleStartDate = DateTime.Today;
    private string newScheduleRecipientEmail = "";
    private HashSet<int> selectedScheduleDays = new() { 1 };
    private int selectedScheduleDayOfMonth = 1;
    
    private readonly Dictionary<int, string> daysOfWeekSchedule = new()
    {
        { 0, "Sun" }, { 1, "Mon" }, { 2, "Tue" }, { 3, "Wed" }, { 4, "Thu" }, { 5, "Fri" }, { 6, "Sat" }
    };
    
    private readonly string[] scheduleExportFormats = { "PDF", "Excel", "CSV", "HTML" };

    // Comparison state
    private DateTime periodAStart = DateTime.Today.AddDays(-14);
    private DateTime periodAEnd = DateTime.Today.AddDays(-8);
    private DateTime periodBStart = DateTime.Today.AddDays(-7);
    private DateTime periodBEnd = DateTime.Today;
    private string periodAPreset = "lastWeek";
    private string periodBPreset = "thisWeek";
    private string comparisonPreset = "week";
    private string selectedComparisonReport = "new-registrations";
    private bool isRunningComparison = false;
    private ComparisonResult? comparisonResult = null;
    
    // Share modal state
    private bool showShareModal = false;
    private string shareText = "";
    private string pdfPreviewUrl = "";
    private object? shareReportConfig = null;

    // Report types available for comparison
    private readonly Dictionary<string, (string Name, string Icon, string Description)> comparisonReportTypes = new()
    {
        { "new-registrations", ("User Registrations", "", "New user signups") },
        { "user-activity", ("User Activity", "", "User actions & logins") },
        { "engagement", ("Engagement", "", "User engagement metrics") },
        { "retention", ("User Retention", "", "Active vs total users") },
        { "role-distribution", ("Role Distribution", "", "Users by role") },
        { "activity-types", ("Activity Types", "", "Types of activities") },
        { "peak-hours", ("Peak Hours", "", "Usage by hour") }
    };

    // Keep for backwards compatibility but use new structure
    private HashSet<string> selectedComparisonMetrics = new() { "users" };
    private readonly Dictionary<string, (string Name, string Icon)> availableComparisonMetrics = new()
    {
        { "users", ("Users", "") }
    };

    protected override async Task OnInitializedAsync()
    {
        ThemeState.OnChange += OnThemeChanged;
        await LoadReportStats();
        await InitializeSignalRConnection();
    }

    private async Task InitializeSignalRConnection()
    {
        try
        {
            var token = await LocalStorage.GetItemAsStringAsync("token");
            if (string.IsNullOrEmpty(token))
            {
                Console.WriteLine("No auth token found for SignalR connection");
                return;
            }

            token = token.Trim('"').Trim();

            hubConnection = new HubConnectionBuilder()
                .WithUrl($"http://localhost:5095/notificationHub?access_token={Uri.EscapeDataString(token)}")
                .WithAutomaticReconnect(new[] { TimeSpan.Zero, TimeSpan.FromSeconds(2), TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(10) })
                .Build();

            // Handle scheduled report execution notification
            hubConnection.On<object>("ScheduledReportExecuted", async (notification) =>
            {
                try
                {
                    var json = System.Text.Json.JsonSerializer.Serialize(notification);
                    var data = System.Text.Json.JsonSerializer.Deserialize<ScheduledReportNotification>(json, 
                        new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });

                    if (data != null)
                    {
                        await InvokeAsync(async () =>
                        {
                            // Download the report automatically if available
                            if (data.HasDownload && !string.IsNullOrEmpty(data.ReportBase64) && !string.IsNullOrEmpty(data.FileName))
                            {
                                try
                                {
                                    await JS.InvokeVoidAsync("downloadBase64File", data.ReportBase64, data.FileName, data.MimeType ?? "application/pdf");
                                    // Single consolidated toast message
                                    ToastService.ShowSuccess($" Scheduled report '{data.ReportName}' executed and downloaded! Sent to {data.RecipientsSent} recipient(s).");
                                }
                                catch (Exception downloadEx)
                                {
                                    Console.WriteLine($"Error downloading report: {downloadEx.Message}");
                                    ToastService.ShowSuccess($" Scheduled report '{data.ReportName}' executed! Sent to {data.RecipientsSent} recipient(s).");
                                }
                            }
                            else
                            {
                                ToastService.ShowSuccess($" Scheduled report '{data.ReportName}' executed! Sent to {data.RecipientsSent} recipient(s).");
                            }
                            
                            // Refresh the schedule list to update LastRun and NextRun times
                            await RefreshScheduleList();
                            
                            StateHasChanged();
                        });
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error handling ScheduledReportExecuted: {ex.Message}");
                }
            });

            // Handle scheduled report failure notification
            hubConnection.On<object>("ScheduledReportFailed", async (notification) =>
            {
                try
                {
                    var json = System.Text.Json.JsonSerializer.Serialize(notification);
                    var data = System.Text.Json.JsonSerializer.Deserialize<ScheduledReportNotification>(json, 
                        new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });

                    if (data != null)
                    {
                        await InvokeAsync(() =>
                        {
                            ToastService.ShowError($" Scheduled report '{data.ReportName}' failed: {data.Error}");
                            StateHasChanged();
                        });
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error handling ScheduledReportFailed: {ex.Message}");
                }
            });

            hubConnection.Reconnecting += error =>
            {
                Console.WriteLine($"SignalR reconnecting: {error?.Message}");
                return Task.CompletedTask;
            };

            hubConnection.Reconnected += async connectionId =>
            {
                Console.WriteLine($"SignalR reconnected with ID: {connectionId}");
                await JoinAdminGroup();
            };

            hubConnection.Closed += error =>
            {
                Console.WriteLine($"SignalR connection closed: {error?.Message}");
                return Task.CompletedTask;
            };

            await hubConnection.StartAsync();
            Console.WriteLine("SignalR notification hub connected");

            // Join admin group to receive scheduled report notifications
            await JoinAdminGroup();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing SignalR: {ex.Message}");
        }
    }

    private async Task JoinAdminGroup()
    {
        try
        {
            if (hubConnection?.State == HubConnectionState.Connected)
            {
                await hubConnection.InvokeAsync("JoinAdminGroup");
                Console.WriteLine("Joined admin group for scheduled report notifications");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error joining admin group: {ex.Message}");
        }
    }

    private async Task RefreshScheduleList()
    {
        try
        {
            var schedules = await ReportService.GetScheduledReportsAsync();
            scheduledReportsList = schedules;
            scheduledReports = schedules.Count;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error refreshing schedules: {ex.Message}");
        }
    }

    private void OnThemeChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task LoadReportStats()
    {
        try
        {
            var history = await ReportService.GetReportHistoryAsync(0, 1000);
            var schedules = await ReportService.GetScheduledReportsAsync();
            var templates = await ReportService.GetReportTemplatesAsync();

            reportHistory = history;
            scheduledReportsList = schedules;
            totalReports = templates.Count + 14; // Default templates + saved
            scheduledReports = schedules.Count;
            savedTemplates = templates.Count + 14;
            monthlyReports = history.Count(h => h.GeneratedAt >= DateTime.UtcNow.AddMonths(-1));
        }
        catch
        {
            // Use default values
        }
    }

    private string GetTabClass(string tab)
    {
        if (tab == activeTab)
        {
            return "border-primary text-white bg-primary dark:bg-primary";
        }
        return "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 hover:bg-gray-50 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:bg-gray-700";
    }

    private async Task GenerateReport(string reportType)
    {
        if (isGeneratingReport) return;

        try
        {
            isGeneratingReport = true;
            ToastService.ShowInfo($"Generating {GetReportName(reportType)} PDF...");
            StateHasChanged();

            var filters = new ReportFilterModel
            {
                FromDate = DateTime.UtcNow.AddDays(-30),
                ToDate = DateTime.UtcNow,
                GroupBy = "day"
            };

            currentReport = await ReportService.GenerateReportAsync(reportType, filters);

            if (currentReport != null)
            {
                currentChartData = currentReport.Data;

                // Get theme colors
                var theme = await ThemeService.GetCurrentThemeAsync();

                // Prepare metrics for summary
                var metrics = ExtractMetrics(currentChartData, reportType);

                // Prepare table data if applicable
                var tableData = ExtractTableData(currentChartData, reportType);

                // Get chart details
                var chartType = currentChartData.ContainsKey("chartType") ? currentChartData["chartType"].ToString() : "bar";
                var labels = currentChartData.ContainsKey("labels") ? currentChartData["labels"] : new List<string>();
                var values = currentChartData.ContainsKey("values") ? currentChartData["values"] : new List<object>();

                // Create report configuration
                var reportConfig = new
                {
                    title = GetReportName(reportType),
                    subtitle = $"Period: {filters.FromDate:MMM dd, yyyy} - {filters.ToDate:MMM dd, yyyy}",
                    filename = $"{reportType}_{DateTime.Now:yyyyMMdd_HHmmss}.pdf",
                    chartType = chartType,
                    labels = labels,
                    values = values,
                    datasetLabel = GetReportName(reportType),
                    primaryColor = theme.PrimaryColor,
                    accentColor = theme.AccentColor,
                    metrics = metrics,
                    tableData = tableData.data,
                    tableHeaders = tableData.headers
                };

                // Generate and download professional PDF
                var success = await JS.InvokeAsync<bool>("generateProfessionalReport", reportConfig);

                if (success)
                {
                    ToastService.ShowSuccess($"{currentReport.ReportName} PDF downloaded successfully!");
                    // Reload stats to reflect new history entry
                    await LoadReportStats();
                }
                else
                {
                    ToastService.ShowError("Failed to generate PDF report");
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error generating report: {ex.Message}");
            Console.WriteLine($"Report generation error: {ex}");
        }
        finally
        {
            isGeneratingReport = false;
            StateHasChanged();
        }
    }

    private List<object> ExtractMetrics(Dictionary<string, object> data, string reportType)
    {
        var metrics = new List<object>();

        try
        {
            if (data.ContainsKey("total"))
            {
                metrics.Add(new { label = "Total", value = data["total"].ToString() });
            }

            if (data.ContainsKey("average"))
            {
                var avg = Convert.ToDouble(data["average"]);
                metrics.Add(new { label = "Average", value = avg.ToString("F2") });
            }

            if (data.ContainsKey("values"))
            {
                var valuesList = data["values"] as System.Collections.IEnumerable;
                if (valuesList != null)
                {
                    var values = valuesList.Cast<object>().Select(v => Convert.ToDouble(v)).ToList();
                    if (values.Any())
                    {
                        metrics.Add(new { label = "Count", value = values.Count.ToString() });

                        if (!data.ContainsKey("average"))
                        {
                            metrics.Add(new { label = "Average", value = values.Average().ToString("F2") });
                        }

                        if (reportType != "role-distribution" && reportType != "activity-types")
                        {
                            metrics.Add(new { label = "Max", value = values.Max().ToString("F0") });
                        }
                    }
                }
            }

            // Fill to 4 metrics minimum for better layout
            while (metrics.Count < 4 && metrics.Count > 0)
            {
                metrics.Add(new { label = "Period", value = "30 Days" });
                break;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error extracting metrics: {ex.Message}");
        }

        return metrics;
    }

    private (List<object> data, List<string> headers) ExtractTableData(Dictionary<string, object> data, string reportType)
    {
        var tableData = new List<object>();
        var headers = new List<string>();

        try
        {
            if (data.ContainsKey("labels") && data.ContainsKey("values"))
            {
                var labels = (data["labels"] as System.Collections.IEnumerable)?.Cast<object>().ToList();
                var values = (data["values"] as System.Collections.IEnumerable)?.Cast<object>().ToList();

                if (labels != null && values != null && labels.Count == values.Count)
                {
                    headers = new List<string> { GetTableColumnName(reportType), "Value" };

                    for (int i = 0; i < Math.Min(labels.Count, 20); i++)
                    {
                        tableData.Add(new
                        {
                            Label = labels[i].ToString(),
                            Value = Convert.ToDouble(values[i]).ToString("F2")
                        });
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error extracting table data: {ex.Message}");
        }

        return (tableData, headers);
    }

    private string GetTableColumnName(string reportType)
    {
        return reportType switch
        {
            "new-registrations" => "Date",
            "user-activity" => "Date",
            "engagement" => "Metric",
            "role-distribution" => "Role",
            "retention" => "Metric",
            "performance-metrics" => "Metric",
            "response-times" => "Date",
            "error-rate" => "Date",
            "uptime" => "Category",
            "activity-types" => "Activity Type",
            "peak-hours" => "Hour",
            "timeline" => "Time",
            "user-journey" => "Step",
            "comparative" => "Date",
            _ => "Category"
        };
    }

    private void OpenReportBuilder()
    {
        activeTab = "custom";
        ToastService.ShowInfo("Custom Report Builder activated - Create your own reports!");
    }

    private async Task OnCustomReportGenerated(MediChatAI_BlazorWebAssembly.Features.Admin.Components.CustomReportBuilder.CustomReportResult result)
    {
        if (result.Success)
        {
            ToastService.ShowSuccess($"Report '{result.ReportName}' generated successfully!");
            await LoadReportStats();
        }
    }

    private void CloseReportBuilder()
    {
        activeTab = "templates";
    }

    private async Task CreateScheduledReport()
    {
        try
        {
            var schedule = new ScheduledReportDto(
                Guid.NewGuid().ToString(),
                Guid.NewGuid().ToString(),
                "New Scheduled Report",
                "0 9 * * *", // Daily at 9 AM
                "Daily",
                new List<string> { "admin@medichat.ai" },
                "PDF",
                true,
                DateTime.UtcNow.AddDays(1),
                null,
                DateTime.UtcNow
            );

            var result = await ReportService.ScheduleReportAsync(schedule);
            if (result != null)
            {
                ToastService.ShowSuccess("Report scheduled successfully!");
                await LoadReportStats();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error scheduling report: {ex.Message}");
        }
    }

    private void OpenComparison()
    {
        activeTab = "comparison";
        ToastService.ShowInfo("Comparison tool activated");
    }

    private async Task DeleteSchedule(string scheduleId)
    {
        try
        {
            var result = await ReportService.DeleteScheduledReportAsync(scheduleId);
            if (result)
            {
                ToastService.ShowSuccess("Scheduled report deleted successfully!");
                await LoadReportStats();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error deleting schedule: {ex.Message}");
        }
    }

    private async Task DownloadHistoryReport(string historyId)
    {
        if (isGeneratingReport) return;

        try
        {
            isGeneratingReport = true;

            var historyItem = reportHistory.FirstOrDefault(h => h.Id == historyId);
            if (historyItem == null)
            {
                ToastService.ShowError("Report not found in history");
                return;
            }

            if (string.IsNullOrEmpty(historyItem.ReportTypeId))
            {
                ToastService.ShowError("Cannot regenerate this report - missing configuration");
                return;
            }

            ToastService.ShowInfo($"Regenerating {historyItem.ReportName} PDF...");
            StateHasChanged();

            // Use stored dates or default to last 30 days
            var filters = new ReportFilterModel
            {
                FromDate = historyItem.FromDate ?? DateTime.UtcNow.AddDays(-30),
                ToDate = historyItem.ToDate ?? DateTime.UtcNow,
                GroupBy = "day"
            };

            // Regenerate report data
            currentReport = await ReportService.GenerateReportAsync(historyItem.ReportTypeId, filters);

            if (currentReport != null)
            {
                currentChartData = currentReport.Data;

                // Get theme colors
                var theme = await ThemeService.GetCurrentThemeAsync();

                // Prepare metrics for summary
                var metrics = ExtractMetrics(currentChartData, historyItem.ReportTypeId);

                // Prepare table data if applicable
                var tableData = ExtractTableData(currentChartData, historyItem.ReportTypeId);

                // Get chart details
                var chartType = currentChartData.ContainsKey("chartType") ? currentChartData["chartType"].ToString() : "bar";
                var labels = currentChartData.ContainsKey("labels") ? currentChartData["labels"] : new List<string>();
                var values = currentChartData.ContainsKey("values") ? currentChartData["values"] : new List<object>();

                // Create report configuration
                var reportConfig = new
                {
                    title = historyItem.ReportName,
                    subtitle = $"Period: {filters.FromDate:MMM dd, yyyy} - {filters.ToDate:MMM dd, yyyy}",
                    filename = $"{historyItem.ReportTypeId}_{DateTime.Now:yyyyMMdd_HHmmss}.pdf",
                    chartType = chartType,
                    labels = labels,
                    values = values,
                    datasetLabel = historyItem.ReportName,
                    primaryColor = theme.PrimaryColor,
                    accentColor = theme.AccentColor,
                    metrics = metrics,
                    tableData = tableData.data,
                    tableHeaders = tableData.headers
                };

                // Generate and download professional PDF
                var success = await JS.InvokeAsync<bool>("generateProfessionalReport", reportConfig);

                if (success)
                {
                    ToastService.ShowSuccess($"{historyItem.ReportName} PDF downloaded successfully!");
                }
                else
                {
                    ToastService.ShowError("Failed to generate PDF report");
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error downloading report: {ex.Message}");
            Console.WriteLine($"Report download error: {ex}");
        }
        finally
        {
            isGeneratingReport = false;
            StateHasChanged();
        }
    }

    private string GetReportName(string reportType)
    {
        return reportType switch
        {
            "new-registrations" => "New Registrations Trend",
            "user-activity" => "User Activity Heatmap",
            "engagement" => "Engagement Metrics",
            "role-distribution" => "Role Distribution",
            "retention" => "Retention Analysis",
            "performance-metrics" => "Performance Metrics",
            "response-times" => "API Response Times",
            "error-rate" => "Error Rate Analysis",
            "uptime" => "Uptime/Downtime Report",
            "activity-types" => "Top Activities by Type",
            "peak-hours" => "Peak Usage Hours",
            "timeline" => "Activity Timeline",
            "user-journey" => "User Journey Analysis",
            "comparative" => "Comparative Activity",
            _ => "Custom Report"
        };
    }

    // ========================
    // Schedule Modal Methods
    // ========================

    private void OnScheduleStartDateChanged(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var date))
        {
            scheduleStartDate = date < DateTime.Today ? DateTime.Today : date;
        }
    }

    private void OnScheduleTimeChanged(ChangeEventArgs e)
    {
        scheduleTimeString = e.Value?.ToString() ?? "09:00";
        UpdateScheduleExpressionInModal();
    }

    private void OpenScheduleModal()
    {
        isEditingSchedule = false;
        scheduleEditModel = new ScheduleEditModel();
        scheduleTimeString = "09:00";
        scheduleStartDate = DateTime.Today;
        selectedScheduleDays = new HashSet<int> { 1 };
        selectedScheduleDayOfMonth = 1;
        newScheduleRecipientEmail = "";
        showScheduleModal = true;
    }

    private void EditSchedule(ScheduledReportDto schedule)
    {
        isEditingSchedule = true;
        scheduleEditModel = new ScheduleEditModel
        {
            Id = schedule.Id,
            ReportId = schedule.ReportId,
            ReportName = schedule.ReportName,
            Schedule = schedule.Schedule,
            Frequency = schedule.Frequency,
            Recipients = new List<string>(schedule.Recipients),
            Format = schedule.Format,
            IsActive = schedule.IsActive,
            NextRun = schedule.NextRun,
            LastRun = schedule.LastRun,
            CreatedAt = schedule.CreatedAt
        };
        ParseScheduleExpressionForModal(schedule.Schedule);
        scheduleStartDate = schedule.NextRun?.Date ?? DateTime.Today;
        showScheduleModal = true;
    }

    private void CloseScheduleModal()
    {
        showScheduleModal = false;
        scheduleEditModel = new ScheduleEditModel();
    }

    private async Task SaveScheduleFromModal()
    {
        if (string.IsNullOrWhiteSpace(scheduleEditModel.ReportName))
        {
            ToastService.ShowWarning("Please enter a schedule name");
            return;
        }

        if (!scheduleEditModel.Recipients.Any())
        {
            ToastService.ShowWarning("Please add at least one recipient");
            return;
        }

        if (scheduleStartDate < DateTime.Today)
        {
            ToastService.ShowWarning("Start date cannot be in the past");
            return;
        }

        isSavingSchedule = true;
        try
        {
            UpdateScheduleExpressionInModal();
            var nextRun = CalculateNextRunFromModal();
            
            var schedule = new ScheduledReportDto(
                Id: scheduleEditModel.Id,
                ReportId: scheduleEditModel.ReportId,
                ReportName: scheduleEditModel.ReportName,
                Schedule: scheduleEditModel.Schedule,
                Frequency: scheduleEditModel.Frequency,
                Recipients: scheduleEditModel.Recipients,
                Format: scheduleEditModel.Format,
                IsActive: scheduleEditModel.IsActive,
                NextRun: nextRun,
                LastRun: scheduleEditModel.LastRun,
                CreatedAt: scheduleEditModel.CreatedAt
            );

            if (isEditingSchedule)
            {
                var updatedFromServer = await ReportService.UpdateScheduledReportAsync(schedule);
                if (updatedFromServer != null)
                {
                    ToastService.ShowSuccess("Schedule updated successfully");
                    await LoadReportStats();
                }
            }
            else
            {
                var result = await ReportService.ScheduleReportAsync(schedule);
                if (result != null)
                {
                    ToastService.ShowSuccess("Schedule created successfully");
                    await LoadReportStats();
                }
            }

            CloseScheduleModal();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error saving schedule: {ex.Message}");
        }
        finally
        {
            isSavingSchedule = false;
        }
    }

    private async Task RunScheduleNow(ScheduledReportDto schedule)
    {
        if (isGeneratingReport) return;
        
        try
        {
            isGeneratingReport = true;
            ToastService.ShowInfo($"Running {schedule.ReportName} and sending to {schedule.Recipients.Count} recipient(s)...");
            StateHasChanged();

            // Try to execute via backend (which handles email sending)
            var executionResult = await ReportService.ExecuteScheduledReportNowAsync(schedule.Id, sendEmail: true);
            
            if (executionResult?.Success == true)
            {
                // Download the report locally if available
                if (!string.IsNullOrEmpty(executionResult.ReportBase64) && 
                    !string.IsNullOrEmpty(executionResult.FileName) &&
                    !string.IsNullOrEmpty(executionResult.MimeType))
                {
                    try
                    {
                        await JS.InvokeVoidAsync("downloadBase64File", 
                            executionResult.ReportBase64, 
                            executionResult.FileName, 
                            executionResult.MimeType);
                        ToastService.ShowSuccess($"{schedule.ReportName} executed! Report downloaded and {executionResult.Execution?.RecipientsSent ?? 0} email(s) sent with attachment.");
                    }
                    catch
                    {
                        ToastService.ShowSuccess($"{schedule.ReportName} executed! {executionResult.Execution?.RecipientsSent ?? 0} email(s) sent.");
                    }
                }
                else
                {
                    ToastService.ShowSuccess($"{schedule.ReportName} executed successfully! {executionResult.Execution?.RecipientsSent ?? 0} email(s) sent.");
                }

                // Update the schedule in the list immediately (real-time update)
                var index = scheduledReportsList.FindIndex(s => s.Id == schedule.Id);
                if (index >= 0)
                {
                    var updatedSchedule = schedule with 
                    { 
                        LastRun = executionResult.LastRun ?? DateTime.UtcNow,
                        NextRun = executionResult.NextRun
                    };
                    scheduledReportsList[index] = updatedSchedule;
                    StateHasChanged();
                }
            }
            else
            {
                // Fallback: Generate report locally and inform user about email limitation
                ToastService.ShowWarning("Backend unavailable. Generating report locally (emails not sent)...");
                
                var filters = new ReportFilterModel
                {
                    FromDate = DateTime.UtcNow.AddDays(-30),
                    ToDate = DateTime.UtcNow,
                    GroupBy = "day"
                };

                var reportData = await ReportService.GenerateReportAsync(schedule.ReportId, filters);

                if (reportData != null)
                {
                    // Get theme colors for PDF generation
                    var theme = await ThemeService.GetCurrentThemeAsync();
                    var metrics = ExtractMetrics(reportData.Data, schedule.ReportId);
                    var tableData = ExtractTableData(reportData.Data, schedule.ReportId);

                    var chartType = reportData.Data.ContainsKey("chartType") ? reportData.Data["chartType"].ToString() : "bar";
                    var labels = reportData.Data.ContainsKey("labels") ? reportData.Data["labels"] : new List<string>();
                    var values = reportData.Data.ContainsKey("values") ? reportData.Data["values"] : new List<object>();

                    var reportConfig = new
                    {
                        title = schedule.ReportName,
                        subtitle = $"Period: {filters.FromDate:MMM dd, yyyy} - {filters.ToDate:MMM dd, yyyy}",
                        filename = $"{schedule.ReportId}_{DateTime.Now:yyyyMMdd_HHmmss}.pdf",
                        chartType = chartType,
                        labels = labels,
                        values = values,
                        datasetLabel = schedule.ReportName,
                        primaryColor = theme.PrimaryColor,
                        accentColor = theme.AccentColor,
                        metrics = metrics,
                        tableData = tableData.data,
                        tableHeaders = tableData.headers
                    };

                    // Generate PDF locally
                    var success = await JS.InvokeAsync<bool>("generateProfessionalReport", reportConfig);

                    if (success)
                    {
                        // Update locally - the LastRun will be set by backend, but we set it here for immediate display
                        var index = scheduledReportsList.FindIndex(s => s.Id == schedule.Id);
                        if (index >= 0)
                        {
                            var updatedSchedule = schedule with { LastRun = DateTime.UtcNow };
                            scheduledReportsList[index] = updatedSchedule;
                            _ = ReportService.UpdateScheduledReportAsync(updatedSchedule);
                        }
                        ToastService.ShowSuccess($"{schedule.ReportName} downloaded. Note: Emails require backend connection.");
                        StateHasChanged();
                    }
                    else
                    {
                        ToastService.ShowError("Failed to generate report");
                    }
                }
                else
                {
                    ToastService.ShowError("Failed to retrieve report data");
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error running schedule: {ex.Message}");
            Console.WriteLine($"RunScheduleNow error: {ex}");
        }
        finally
        {
            isGeneratingReport = false;
            StateHasChanged();
        }
    }

    private async Task ToggleScheduleStatus(ScheduledReportDto schedule)
    {
        try
        {
            var updated = schedule with { IsActive = !schedule.IsActive };
            var updatedFromServer = await ReportService.UpdateScheduledReportAsync(updated);
            if (updatedFromServer != null)
            {
                ToastService.ShowSuccess(updated.IsActive ? "Schedule activated" : "Schedule paused");
                await LoadReportStats();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error updating schedule status: {ex.Message}");
        }
    }

    private void AddScheduleRecipient()
    {
        if (string.IsNullOrWhiteSpace(newScheduleRecipientEmail)) return;
        
        if (!IsValidScheduleEmail(newScheduleRecipientEmail))
        {
            ToastService.ShowWarning("Please enter a valid email address");
            return;
        }

        if (scheduleEditModel.Recipients.Contains(newScheduleRecipientEmail, StringComparer.OrdinalIgnoreCase))
        {
            ToastService.ShowWarning("This email is already added");
            return;
        }

        scheduleEditModel.Recipients.Add(newScheduleRecipientEmail);
        newScheduleRecipientEmail = "";
    }

    private void RemoveScheduleRecipient(string email)
    {
        scheduleEditModel.Recipients.Remove(email);
    }

    private bool IsValidScheduleEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }

    private void ToggleScheduleDaySelection(int day)
    {
        if (selectedScheduleDays.Contains(day))
            selectedScheduleDays.Remove(day);
        else
            selectedScheduleDays.Add(day);
        
        UpdateScheduleExpressionInModal();
    }

    private void UpdateScheduleExpressionInModal()
    {
        // Parse time string
        int hour = 9, minute = 0;
        if (TimeSpan.TryParse(scheduleTimeString, out var parsedTime))
        {
            hour = parsedTime.Hours;
            minute = parsedTime.Minutes;
        }

        string cronExpression;

        switch (scheduleEditModel.Frequency)
        {
            case "Daily":
                cronExpression = $"{minute} {hour} * * *";
                break;
            case "Weekly":
            case "Bi-Weekly":
                var days = string.Join(",", selectedScheduleDays.OrderBy(d => d));
                if (string.IsNullOrEmpty(days)) days = "1";
                cronExpression = $"{minute} {hour} * * {days}";
                break;
            case "Monthly":
                var dayOfMonth = selectedScheduleDayOfMonth == 0 ? "L" : selectedScheduleDayOfMonth.ToString();
                cronExpression = $"{minute} {hour} {dayOfMonth} * *";
                break;
            case "Quarterly":
                var qDayOfMonth = selectedScheduleDayOfMonth == 0 ? "L" : selectedScheduleDayOfMonth.ToString();
                cronExpression = $"{minute} {hour} {qDayOfMonth} 1,4,7,10 *";
                break;
            default:
                cronExpression = $"{minute} {hour} * * 1";
                break;
        }

        scheduleEditModel.Schedule = cronExpression;
    }

    private void ParseScheduleExpressionForModal(string cron)
    {
        try
        {
            var parts = cron.Split(' ');
            if (parts.Length >= 5)
            {
                if (int.TryParse(parts[0], out var minute) && int.TryParse(parts[1], out var hour))
                {
                    scheduleTimeString = $"{hour:D2}:{minute:D2}";
                }

                // Parse day of week for weekly
                if (parts[4] != "*")
                {
                    selectedScheduleDays = parts[4].Split(',')
                        .Where(d => int.TryParse(d, out _))
                        .Select(int.Parse)
                        .ToHashSet();
                }

                // Parse day of month for monthly
                if (parts[2] != "*" && parts[2] != "L")
                {
                    if (int.TryParse(parts[2], out var dayOfMonth))
                        selectedScheduleDayOfMonth = dayOfMonth;
                }
                else if (parts[2] == "L")
                {
                    selectedScheduleDayOfMonth = 0;
                }
            }
        }
        catch
        {
            // Use defaults if parsing fails
        }
    }

    private DateTime CalculateNextRunFromModal()
    {
        int hour = 9, minute = 0;
        if (TimeSpan.TryParse(scheduleTimeString, out var parsedTime))
        {
            hour = parsedTime.Hours;
            minute = parsedTime.Minutes;
        }
        var scheduleTime = new TimeSpan(hour, minute, 0);

        var startDate = scheduleStartDate < DateTime.Today ? DateTime.Today : scheduleStartDate;
        var nextRun = startDate.Date.Add(scheduleTime);
        
        if (nextRun <= DateTime.Now)
            nextRun = nextRun.AddDays(1);

        return scheduleEditModel.Frequency switch
        {
            "Weekly" => GetNextWeekdayForSchedule(nextRun, selectedScheduleDays.FirstOrDefault(1), scheduleTime),
            "Bi-Weekly" => GetNextWeekdayForSchedule(nextRun, selectedScheduleDays.FirstOrDefault(1), scheduleTime).AddDays(7),
            "Monthly" => GetNextMonthDayForSchedule(nextRun, selectedScheduleDayOfMonth, scheduleTime),
            "Quarterly" => GetNextQuarterDayForSchedule(nextRun, selectedScheduleDayOfMonth, scheduleTime),
            _ => nextRun
        };
    }

    private DateTime GetNextWeekdayForSchedule(DateTime from, int dayOfWeek, TimeSpan time)
    {
        var daysUntil = ((dayOfWeek - (int)from.DayOfWeek + 7) % 7);
        return from.AddDays(daysUntil == 0 ? 7 : daysUntil);
    }

    private DateTime GetNextMonthDayForSchedule(DateTime from, int dayOfMonth, TimeSpan time)
    {
        var next = new DateTime(from.Year, from.Month, 1).Add(time);
        if (dayOfMonth == 0)
        {
            next = next.AddMonths(1).AddDays(-1);
        }
        else
        {
            var daysInMonth = DateTime.DaysInMonth(from.Year, from.Month);
            next = next.AddDays(Math.Min(dayOfMonth, daysInMonth) - 1);
        }
        
        if (next <= from)
            next = next.AddMonths(1);
        
        return next;
    }

    private DateTime GetNextQuarterDayForSchedule(DateTime from, int dayOfMonth, TimeSpan time)
    {
        int[] quarterMonths = { 1, 4, 7, 10 };
        var currentMonth = from.Month;
        var nextQuarterMonth = quarterMonths.FirstOrDefault(m => m > currentMonth);
        
        if (nextQuarterMonth == 0)
            nextQuarterMonth = quarterMonths[0];

        var year = nextQuarterMonth < currentMonth ? from.Year + 1 : from.Year;
        var day = dayOfMonth == 0 ? DateTime.DaysInMonth(year, nextQuarterMonth) : dayOfMonth;
        
        return new DateTime(year, nextQuarterMonth, Math.Min(day, DateTime.DaysInMonth(year, nextQuarterMonth))).Add(time);
    }

    private string GetOrdinalSuffix(int number)
    {
        return number switch
        {
            1 or 21 => $"{number}st",
            2 or 22 => $"{number}nd",
            3 or 23 => $"{number}rd",
            _ => $"{number}th"
        };
    }

    // Mutable edit model for two-way binding in schedule modal
    private class ScheduleEditModel
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string ReportId { get; set; } = "";
        public string ReportName { get; set; } = "";
        public string Schedule { get; set; } = "0 9 * * 1";
        public string Frequency { get; set; } = "Weekly";
        public List<string> Recipients { get; set; } = new();
        public string Format { get; set; } = "PDF";
        public bool IsActive { get; set; } = true;
        public DateTime? NextRun { get; set; } = DateTime.Now.AddDays(1);
        public DateTime? LastRun { get; set; }
        public DateTime CreatedAt { get; set; } = DateTime.Now;
    }

    // Notification model for SignalR messages
    private class ScheduledReportNotification
    {
        public string Type { get; set; } = "";
        public string ReportName { get; set; } = "";
        public string? ReportId { get; set; }
        public int RecipientsSent { get; set; }
        public DateTime ExecutedAt { get; set; }
        public string? Message { get; set; }
        public string? Error { get; set; }
        public DateTime? FailedAt { get; set; }
        // Download properties for scheduled reports
        public string? ReportBase64 { get; set; }
        public string? FileName { get; set; }
        public string? MimeType { get; set; }
        public bool HasDownload { get; set; }
    }

    // Comparison Models
    private class ComparisonResult
    {
        public DateTime PeriodAStart { get; set; }
        public DateTime PeriodAEnd { get; set; }
        public DateTime PeriodBStart { get; set; }
        public DateTime PeriodBEnd { get; set; }
        public string ReportType { get; set; } = "";
        public decimal PeriodATotal { get; set; }
        public decimal PeriodBTotal { get; set; }
        public decimal AbsoluteChange { get; set; }
        public decimal PercentageChange { get; set; }
        public List<ComparisonDataItem> DetailedData { get; set; } = new();
        public List<DetailedChangeRecord> NewInPeriodB { get; set; } = new(); // New items in Period B (not in A)
        public List<DetailedChangeRecord> RemovedInPeriodB { get; set; } = new(); // Items in A but not in B
        public List<DetailedChangeRecord> AllPeriodARecords { get; set; } = new(); // All items in Period A
        public List<DetailedChangeRecord> AllPeriodBRecords { get; set; } = new(); // All items in Period B
        public List<ComparisonInsight> Insights { get; set; } = new();
        public List<ComparisonRecommendation> Recommendations { get; set; } = new();
        // Keep for backwards compatibility
        public List<ComparisonMetric> Metrics { get; set; } = new();
    }

    private class ComparisonDataItem
    {
        public string Label { get; set; } = "";
        public decimal PeriodAValue { get; set; }
        public decimal PeriodBValue { get; set; }
        public decimal Difference { get; set; }
        public decimal PercentChange { get; set; }
    }

    // Model for detailed change records (who registered, who signed in, etc.)
    private class DetailedChangeRecord
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string Email { get; set; } = "";
        public string Role { get; set; } = "";
        public string Action { get; set; } = ""; // "Registered", "Signed In", "Deleted", etc.
        public DateTime Timestamp { get; set; }
        public string Period { get; set; } = ""; // "A" or "B"
        public string ChangeType { get; set; } = ""; // "new", "existing", "removed"
    }

    private class ComparisonMetric
    {
        public string Key { get; set; } = "";
        public string Name { get; set; } = "";
        public string Icon { get; set; } = "";
        public decimal PeriodAValue { get; set; }
        public decimal PeriodBValue { get; set; }
        public decimal ChangePercent { get; set; }
        public string Trend { get; set; } = "neutral"; // up, down, neutral
        public bool IsPositive { get; set; } = true;
    }

    private class ComparisonInsight
    {
        public string Icon { get; set; } = "";
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public string Type { get; set; } = "info"; // success, warning, info
    }

    private class ComparisonRecommendation
    {
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public string Priority { get; set; } = "medium"; // high, medium, low
    }

    // Comparison Methods
    private void SetPeriodPreset(string period, string preset)
    {
        var today = DateTime.Today;
        DateTime start, end;

        switch (preset)
        {
            case "thisWeek":
                int daysFromMonday = (int)today.DayOfWeek - 1;
                if (daysFromMonday < 0) daysFromMonday = 6;
                start = today.AddDays(-daysFromMonday);
                end = today;
                break;
            case "lastWeek":
                int daysFromMondayLast = (int)today.DayOfWeek - 1;
                if (daysFromMondayLast < 0) daysFromMondayLast = 6;
                end = today.AddDays(-daysFromMondayLast - 1);
                start = end.AddDays(-6);
                break;
            case "thisMonth":
                start = new DateTime(today.Year, today.Month, 1);
                end = today;
                break;
            case "lastMonth":
                var firstOfThisMonth = new DateTime(today.Year, today.Month, 1);
                end = firstOfThisMonth.AddDays(-1);
                start = new DateTime(end.Year, end.Month, 1);
                break;
            case "thisQuarter":
                int quarterStart = ((today.Month - 1) / 3) * 3 + 1;
                start = new DateTime(today.Year, quarterStart, 1);
                end = today;
                break;
            case "lastQuarter":
                int currentQuarterStart = ((today.Month - 1) / 3) * 3 + 1;
                var thisQuarterStartDate = new DateTime(today.Year, currentQuarterStart, 1);
                end = thisQuarterStartDate.AddDays(-1);
                start = end.AddMonths(-2);
                start = new DateTime(start.Year, start.Month, 1);
                break;
            case "thisYear":
                start = new DateTime(today.Year, 1, 1);
                end = today;
                break;
            case "lastYear":
                start = new DateTime(today.Year - 1, 1, 1);
                end = new DateTime(today.Year - 1, 12, 31);
                break;
            case "last7Days":
                start = today.AddDays(-6);
                end = today;
                break;
            case "last30Days":
                start = today.AddDays(-29);
                end = today;
                break;
            case "last90Days":
                start = today.AddDays(-89);
                end = today;
                break;
            default:
                return;
        }

        if (period == "A")
        {
            periodAStart = start;
            periodAEnd = end;
            periodAPreset = preset;
        }
        else
        {
            periodBStart = start;
            periodBEnd = end;
            periodBPreset = preset;
        }
        StateHasChanged();
    }

    private string GetPeriodDuration(DateTime start, DateTime end)
    {
        var days = (end - start).Days + 1;
        if (days == 1) return "1 day";
        if (days < 7) return $"{days} days";
        if (days == 7) return "1 week";
        if (days < 30) return $"{days} days";
        if (days <= 31) return "~1 month";
        if (days < 90) return $"{days / 30} months";
        if (days <= 92) return "~1 quarter";
        if (days < 365) return $"{days / 30} months";
        return $"{days / 365} year(s)";
    }

    private void ToggleComparisonMetric(string metric)
    {
        if (selectedComparisonMetrics.Contains(metric))
        {
            if (selectedComparisonMetrics.Count > 1)
                selectedComparisonMetrics.Remove(metric);
        }
        else
        {
            selectedComparisonMetrics.Add(metric);
        }
        StateHasChanged();
    }

    private void SelectComparisonReport(string reportKey)
    {
        selectedComparisonReport = reportKey;
        StateHasChanged();
    }

    private void SetQuickCompare(string preset)
    {
        comparisonPreset = preset;
        var today = DateTime.Today;

        switch (preset)
        {
            case "week":
                // Get start of this week (Monday)
                int daysSinceMonday = ((int)today.DayOfWeek - 1 + 7) % 7;
                periodBStart = today.AddDays(-daysSinceMonday);
                periodBEnd = today;
                // Previous week
                periodAStart = periodBStart.AddDays(-7);
                periodAEnd = periodBStart.AddDays(-1);
                break;
            case "month":
                // This month
                periodBStart = new DateTime(today.Year, today.Month, 1);
                periodBEnd = today;
                // Previous month
                periodAEnd = periodBStart.AddDays(-1);
                periodAStart = new DateTime(periodAEnd.Year, periodAEnd.Month, 1);
                break;
            case "quarter":
                // This quarter
                int currentQuarterStart = ((today.Month - 1) / 3) * 3 + 1;
                periodBStart = new DateTime(today.Year, currentQuarterStart, 1);
                periodBEnd = today;
                // Previous quarter
                periodAEnd = periodBStart.AddDays(-1);
                int prevQuarterStart = ((periodAEnd.Month - 1) / 3) * 3 + 1;
                periodAStart = new DateTime(periodAEnd.Year, prevQuarterStart, 1);
                break;
            case "custom":
                // Keep current dates
                break;
        }
        StateHasChanged();
    }

    private async Task RunComparison()
    {
        if (periodAStart >= periodAEnd || periodBStart >= periodBEnd)
        {
            ToastService.ShowWarning("Please select valid date ranges for both periods");
            return;
        }

        if (string.IsNullOrEmpty(selectedComparisonReport))
        {
            ToastService.ShowWarning("Please select a report type to compare");
            return;
        }

        isRunningComparison = true;
        StateHasChanged();

        try
        {
            // Fetch real data for both periods
            // Add end-of-day time to ToDate to include records created during the day
            var filterA = new ReportFilterModel { FromDate = periodAStart.Date, ToDate = periodAEnd.Date.AddDays(1).AddSeconds(-1), GroupBy = "day" };
            var filterB = new ReportFilterModel { FromDate = periodBStart.Date, ToDate = periodBEnd.Date.AddDays(1).AddSeconds(-1), GroupBy = "day" };

            var dataA = await ReportService.GetReportDataAsync(selectedComparisonReport, filterA);
            var dataB = await ReportService.GetReportDataAsync(selectedComparisonReport, filterB);

            // Extract labels and values
            var labelsA = dataA.ContainsKey("labels") ? (dataA["labels"] as IEnumerable<object>)?.Select(x => x.ToString() ?? "").ToList() ?? new List<string>() : new List<string>();
            var labelsB = dataB.ContainsKey("labels") ? (dataB["labels"] as IEnumerable<object>)?.Select(x => x.ToString() ?? "").ToList() ?? new List<string>() : new List<string>();
            
            var valuesA = ExtractNumericValues(dataA);
            var valuesB = ExtractNumericValues(dataB);

            // Calculate totals - prefer "total" key if available
            decimal periodATotal = GetTotalFromData(dataA);
            decimal periodBTotal = GetTotalFromData(dataB);
            
            // Debug log
            Console.WriteLine($"Period A: labels={labelsA.Count}, values={valuesA.Count}, total={periodATotal}");
            Console.WriteLine($"Period B: labels={labelsB.Count}, values={valuesB.Count}, total={periodBTotal}");
            
            decimal absoluteChange = periodBTotal - periodATotal;
            decimal percentageChange = periodATotal > 0 ? Math.Round((absoluteChange / periodATotal) * 100, 1) : (periodBTotal > 0 ? 100 : 0);

            // Build detailed data comparison
            var detailedData = new List<ComparisonDataItem>();
            
            // Combine data by matching labels or by index
            var allLabels = labelsA.Union(labelsB).Distinct().OrderBy(l => l).ToList();
            
            for (int i = 0; i < Math.Max(valuesA.Count, valuesB.Count); i++)
            {
                var label = i < allLabels.Count ? allLabels[i] : $"Item {i + 1}";
                var valA = i < valuesA.Count ? valuesA[i] : 0;
                var valB = i < valuesB.Count ? valuesB[i] : 0;
                var diff = valB - valA;
                var pctChange = valA > 0 ? Math.Round((diff / valA) * 100, 1) : (valB > 0 ? 100 : 0);

                detailedData.Add(new ComparisonDataItem
                {
                    Label = label,
                    PeriodAValue = valA,
                    PeriodBValue = valB,
                    Difference = diff,
                    PercentChange = pctChange
                });
            }

            // Generate insights
            var insights = new List<ComparisonInsight>();
            
            if (periodATotal == 0 && periodBTotal == 0)
            {
                insights.Add(new ComparisonInsight
                {
                    Icon = "",
                    Title = "No Data Found",
                    Description = "No data available for either period. Ensure there is activity data in the selected date ranges.",
                    Type = "warning"
                });
            }
            else
            {
                // Overall trend insight
                insights.Add(new ComparisonInsight
                {
                    Icon = absoluteChange >= 0 ? "" : "",
                    Title = absoluteChange >= 0 ? "Positive Growth" : "Decline Detected",
                    Description = $"Total changed from {periodATotal:N0} to {periodBTotal:N0} ({(absoluteChange >= 0 ? "+" : "")}{absoluteChange:N0})",
                    Type = absoluteChange >= 0 ? "success" : "warning"
                });

                // Find best performing day/label
                var bestItem = detailedData.Where(d => d.PeriodBValue > 0).OrderByDescending(d => d.Difference).FirstOrDefault();
                if (bestItem != null && bestItem.Difference > 0)
                {
                    insights.Add(new ComparisonInsight
                    {
                        Icon = "",
                        Title = $"Best: {bestItem.Label}",
                        Description = $"Highest increase with +{bestItem.Difference:N0} ({(bestItem.PercentChange >= 0 ? "+" : "")}{bestItem.PercentChange}%)",
                        Type = "success"
                    });
                }

                // Find worst performing
                var worstItem = detailedData.Where(d => d.Difference < 0).OrderBy(d => d.Difference).FirstOrDefault();
                if (worstItem != null)
                {
                    insights.Add(new ComparisonInsight
                    {
                        Icon = "",
                        Title = $"Needs Attention: {worstItem.Label}",
                        Description = $"Decreased by {Math.Abs(worstItem.Difference):N0} ({worstItem.PercentChange}%)",
                        Type = "warning"
                    });
                }

                // Data completeness
                var itemsWithBothData = detailedData.Count(d => d.PeriodAValue > 0 && d.PeriodBValue > 0);
                insights.Add(new ComparisonInsight
                {
                    Icon = "",
                    Title = "Data Coverage",
                    Description = $"{itemsWithBothData} of {detailedData.Count} items have data in both periods",
                    Type = "info"
                });
            }

            // Generate recommendations
            var recommendations = new List<ComparisonRecommendation>();

            if (percentageChange < -10)
            {
                recommendations.Add(new ComparisonRecommendation
                {
                    Title = "Investigate Decline",
                    Description = $"There's a significant {Math.Abs(percentageChange)}% decline. Review recent changes that may have affected {comparisonReportTypes[selectedComparisonReport].Name.ToLower()}.",
                    Priority = percentageChange < -25 ? "high" : "medium"
                });
            }
            else if (percentageChange > 20)
            {
                recommendations.Add(new ComparisonRecommendation
                {
                    Title = "Capitalize on Growth",
                    Description = $"Excellent {percentageChange}% growth! Identify what's driving this success and amplify it.",
                    Priority = "low"
                });
            }

            var declinedItems = detailedData.Where(d => d.PercentChange < -20).ToList();
            if (declinedItems.Any())
            {
                recommendations.Add(new ComparisonRecommendation
                {
                    Title = "Address Specific Declines",
                    Description = $"{declinedItems.Count} items show >20% decline. Focus improvement efforts on: {string.Join(", ", declinedItems.Take(3).Select(d => d.Label))}",
                    Priority = "medium"
                });
            }

            if (!recommendations.Any())
            {
                recommendations.Add(new ComparisonRecommendation
                {
                    Title = "Maintain Momentum",
                    Description = "Performance is stable. Continue monitoring and look for optimization opportunities.",
                    Priority = "low"
                });
            }

            comparisonResult = new ComparisonResult
            {
                PeriodAStart = periodAStart,
                PeriodAEnd = periodAEnd,
                PeriodBStart = periodBStart,
                PeriodBEnd = periodBEnd,
                ReportType = selectedComparisonReport,
                PeriodATotal = periodATotal,
                PeriodBTotal = periodBTotal,
                AbsoluteChange = absoluteChange,
                PercentageChange = percentageChange,
                DetailedData = detailedData,
                AllPeriodARecords = ExtractDetailedRecords(dataA, "A"),
                AllPeriodBRecords = ExtractDetailedRecords(dataB, "B"),
                NewInPeriodB = FindNewRecords(dataA, dataB),
                RemovedInPeriodB = FindRemovedRecords(dataA, dataB),
                Insights = insights,
                Recommendations = recommendations,
                Metrics = new List<ComparisonMetric>() // Empty for new model
            };

            ToastService.ShowSuccess("Comparison analysis completed with real data!");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error running comparison: {ex.Message}");
            Console.WriteLine($"Comparison error: {ex}");
        }
        finally
        {
            isRunningComparison = false;
            StateHasChanged();
        }
    }

    private List<decimal> ExtractNumericValues(Dictionary<string, object> data)
    {
        if (!data.ContainsKey("values")) return new List<decimal>();

        var values = data["values"];
        
        // Debug logging
        Console.WriteLine($"Values type: {values?.GetType().FullName}");
        
        if (values is List<int> intList)
            return intList.Select(v => (decimal)v).ToList();
        if (values is IEnumerable<int> intEnumerable)
            return intEnumerable.Select(v => (decimal)v).ToList();
        if (values is List<double> doubleList)
            return doubleList.Select(v => (decimal)v).ToList();
        if (values is IEnumerable<double> doubleEnumerable)
            return doubleEnumerable.Select(v => (decimal)v).ToList();
        if (values is List<decimal> decimalList)
            return decimalList;
        if (values is IEnumerable<decimal> decimalEnumerable)
            return decimalEnumerable.ToList();
        
        // Handle System.Text.Json arrays (JsonElement)
        if (values is System.Text.Json.JsonElement jsonElement && jsonElement.ValueKind == System.Text.Json.JsonValueKind.Array)
        {
            var result = new List<decimal>();
            foreach (var item in jsonElement.EnumerateArray())
            {
                if (item.TryGetDecimal(out var d))
                    result.Add(d);
                else if (item.TryGetInt32(out var i))
                    result.Add(i);
                else if (item.TryGetDouble(out var dbl))
                    result.Add((decimal)dbl);
            }
            return result;
        }
        
        // Handle generic object enumerable (last resort)
        if (values is IEnumerable<object> objList)
        {
            var result = new List<decimal>();
            foreach (var v in objList)
            {
                try
                {
                    result.Add(Convert.ToDecimal(v));
                }
                catch
                {
                    Console.WriteLine($"Could not convert value: {v} ({v?.GetType().FullName})");
                }
            }
            return result;
        }

        Console.WriteLine($"Unhandled values type: {values?.GetType().FullName}");
        return new List<decimal>();
    }

    private decimal GetTotalFromData(Dictionary<string, object> data)
    {
        // First try to get "total" key directly (more reliable)
        if (data.ContainsKey("total"))
        {
            var total = data["total"];
            if (total is int intVal) return intVal;
            if (total is double dblVal) return (decimal)dblVal;
            if (total is decimal decVal) return decVal;
            if (total is long longVal) return longVal;
            try { return Convert.ToDecimal(total); } catch { }
        }
        
        // Fall back to summing values
        return ExtractNumericValues(data).Sum();
    }

    // Extract detailed records (users, activities, etc.) from data
    private List<DetailedChangeRecord> ExtractDetailedRecords(Dictionary<string, object> data, string period)
    {
        var records = new List<DetailedChangeRecord>();
        
        if (!data.ContainsKey("details")) return records;
        
        var details = data["details"];
        
        if (details is IEnumerable<Dictionary<string, object>> dictList)
        {
            foreach (var item in dictList)
            {
                records.Add(new DetailedChangeRecord
                {
                    Id = item.ContainsKey("id") ? item["id"]?.ToString() ?? "" : "",
                    Name = item.ContainsKey("name") ? item["name"]?.ToString() ?? "Unknown" : "Unknown",
                    Email = item.ContainsKey("email") ? item["email"]?.ToString() ?? "" : "",
                    Role = item.ContainsKey("role") ? item["role"]?.ToString() ?? "" : "",
                    Action = item.ContainsKey("action") ? item["action"]?.ToString() ?? "" : "",
                    Timestamp = item.ContainsKey("createdAt") && item["createdAt"] is DateTime dt ? dt : DateTime.MinValue,
                    Period = period,
                    ChangeType = "existing"
                });
            }
        }
        else if (details is List<Dictionary<string, object>> typedList)
        {
            foreach (var item in typedList)
            {
                records.Add(new DetailedChangeRecord
                {
                    Id = item.ContainsKey("id") ? item["id"]?.ToString() ?? "" : "",
                    Name = item.ContainsKey("name") ? item["name"]?.ToString() ?? "Unknown" : "Unknown",
                    Email = item.ContainsKey("email") ? item["email"]?.ToString() ?? "" : "",
                    Role = item.ContainsKey("role") ? item["role"]?.ToString() ?? "" : "",
                    Action = item.ContainsKey("action") ? item["action"]?.ToString() ?? "" : "",
                    Timestamp = item.ContainsKey("createdAt") && item["createdAt"] is DateTime dt ? dt : DateTime.MinValue,
                    Period = period,
                    ChangeType = "existing"
                });
            }
        }
        
        return records;
    }

    // Find records that are NEW in Period B (not in Period A)
    private List<DetailedChangeRecord> FindNewRecords(Dictionary<string, object> dataA, Dictionary<string, object> dataB)
    {
        var recordsA = ExtractDetailedRecords(dataA, "A");
        var recordsB = ExtractDetailedRecords(dataB, "B");
        
        var idsInA = new HashSet<string>(recordsA.Select(r => r.Id).Where(id => !string.IsNullOrEmpty(id)));
        
        return recordsB
            .Where(r => !string.IsNullOrEmpty(r.Id) && !idsInA.Contains(r.Id))
            .Select(r => new DetailedChangeRecord
            {
                Id = r.Id,
                Name = r.Name,
                Email = r.Email,
                Role = r.Role,
                Action = r.Action,
                Timestamp = r.Timestamp,
                Period = "B",
                ChangeType = "new"
            })
            .ToList();
    }

    // Find records that were REMOVED in Period B (in Period A but not in B)
    private List<DetailedChangeRecord> FindRemovedRecords(Dictionary<string, object> dataA, Dictionary<string, object> dataB)
    {
        var recordsA = ExtractDetailedRecords(dataA, "A");
        var recordsB = ExtractDetailedRecords(dataB, "B");
        
        var idsInB = new HashSet<string>(recordsB.Select(r => r.Id).Where(id => !string.IsNullOrEmpty(id)));
        
        return recordsA
            .Where(r => !string.IsNullOrEmpty(r.Id) && !idsInB.Contains(r.Id))
            .Select(r => new DetailedChangeRecord
            {
                Id = r.Id,
                Name = r.Name,
                Email = r.Email,
                Role = r.Role,
                Action = "Removed/Deleted",
                Timestamp = r.Timestamp,
                Period = "A",
                ChangeType = "removed"
            })
            .ToList();
    }

    private string GetRecommendationForMetric(string key, decimal change)
    {
        return key switch
        {
            "users" => "Consider user acquisition campaigns and referral programs to boost user growth.",
            "consultations" => "Review consultation pricing, availability, and promote telehealth services.",
            "revenue" => "Analyze pricing strategies, upselling opportunities, and payment collection efficiency.",
            "appointments" => "Simplify booking process, send reminders, and offer flexible scheduling options.",
            "prescriptions" => "Ensure e-prescription system is optimized and integrated with pharmacies.",
            "messages" => "Promote the messaging feature and ensure quick response times from staff.",
            "activeUsers" => "Implement engagement features like health tips, reminders, and loyalty programs.",
            "newPatients" => "Increase marketing efforts and improve the onboarding experience.",
            "doctorRatings" => "Focus on patient experience, follow-up care, and collect feedback regularly.",
            "responseTime" => "Optimize workflows, add more staff during peak hours, or implement AI assistance.",
            "satisfaction" => "Survey patients, address common complaints, and improve service quality.",
            "emergencies" => change > 0 
                ? "Implement preventive care programs and early warning systems."
                : "Great improvement! Continue current preventive care initiatives.",
            _ => "Review this metric's performance and identify areas for improvement."
        };
    }

    private void ResetComparison()
    {
        comparisonResult = null;
        periodAPreset = "lastMonth";
        periodBPreset = "thisMonth";
        SetPeriodPreset("A", periodAPreset);
        SetPeriodPreset("B", periodBPreset);
        selectedComparisonMetrics = new() { "users", "consultations", "revenue" };
        StateHasChanged();
    }

    private string GetPresetClass(string currentPreset, string buttonPreset)
    {
        return currentPreset == buttonPreset
            ? "px-3 py-1 text-xs rounded-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-md"
            : "px-3 py-1 text-xs rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600";
    }

    private string GetMetricClass(string key)
    {
        return selectedComparisonMetrics.Contains(key)
            ? "p-3 rounded-xl border-2 border-blue-500 bg-blue-50 dark:bg-blue-900/30 cursor-pointer transition-all"
            : "p-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 cursor-pointer transition-all";
    }

    private string GetChangeClass(ComparisonMetric metric)
    {
        if (metric.Trend == "neutral") 
            return "text-gray-500";
        
        return metric.IsPositive
            ? "text-emerald-500"
            : "text-red-500";
    }

    private string GetRecommendationClass(string priority)
    {
        return priority switch
        {
            "high" => "border-l-4 border-red-500 bg-red-50 dark:bg-red-900/20",
            "medium" => "border-l-4 border-amber-500 bg-amber-50 dark:bg-amber-900/20",
            _ => "border-l-4 border-emerald-500 bg-emerald-50 dark:bg-emerald-900/20"
        };
    }

    private string GetRecommendationBadgeClass(string priority)
    {
        return priority switch
        {
            "high" => "px-2 py-0.5 text-xs font-medium bg-red-100 text-red-700 dark:bg-red-800 dark:text-red-200 rounded-full",
            "medium" => "px-2 py-0.5 text-xs font-medium bg-amber-100 text-amber-700 dark:bg-amber-800 dark:text-amber-200 rounded-full",
            _ => "px-2 py-0.5 text-xs font-medium bg-emerald-100 text-emerald-700 dark:bg-emerald-800 dark:text-emerald-200 rounded-full"
        };
    }

    private string GetComparisonItemTypeName()
    {
        return selectedComparisonReport switch
        {
            "new-registrations" => "users",
            "user-activity" => "activities",
            "engagement" => "engaged users",
            "retention" => "users",
            "role-distribution" => "users",
            "activity-types" => "activities",
            "peak-hours" => "activities",
            _ => "records"
        };
    }

    private string GetComparisonItemSingular()
    {
        return selectedComparisonReport switch
        {
            "new-registrations" => "user",
            "user-activity" => "activity",
            "engagement" => "user",
            "retention" => "user",
            "role-distribution" => "user",
            "activity-types" => "activity",
            "peak-hours" => "activity",
            _ => "record"
        };
    }

    private string GetItemTypeName()
    {
        return selectedComparisonReport switch
        {
            "new-registrations" => "Users",
            "user-activity" => "Activities",
            "engagement" => "Users",
            "retention" => "Users",
            "role-distribution" => "Users",
            "activity-types" => "Activities",
            "peak-hours" => "Activities",
            _ => "Records"
        };
    }

    private async Task ExportComparisonPDF()
    {
        if (comparisonResult == null) return;
        
        try
        {
            // Get theme colors
            var theme = await ThemeService.GetCurrentThemeAsync();
            var reportTypeName = comparisonReportTypes.ContainsKey(selectedComparisonReport) 
                ? comparisonReportTypes[selectedComparisonReport].Name 
                : "Report";
            var itemTypeName = GetItemTypeName();
            
            var reportConfig = new
            {
                title = $"{reportTypeName} Comparison Report",
                subtitle = $"Comparing {periodAStart:MMM dd, yyyy} - {periodAEnd:MMM dd, yyyy} vs {periodBStart:MMM dd, yyyy} - {periodBEnd:MMM dd, yyyy}",
                dateRange = $"Generated on {DateTime.Now:MMMM dd, yyyy 'at' hh:mm tt}",
                type = "detailed-comparison",
                reportType = selectedComparisonReport,
                itemTypeName = itemTypeName,
                
                // Summary data
                summary = new
                {
                    periodATotal = comparisonResult.PeriodATotal,
                    periodBTotal = comparisonResult.PeriodBTotal,
                    absoluteChange = comparisonResult.AbsoluteChange,
                    percentageChange = comparisonResult.PercentageChange,
                    periodALabel = $"{periodAStart:MMM dd} - {periodAEnd:MMM dd, yyyy}",
                    periodBLabel = $"{periodBStart:MMM dd} - {periodBEnd:MMM dd, yyyy}"
                },
                
                // Day-by-day breakdown
                breakdown = comparisonResult.DetailedData?.Select(d => new 
                { 
                    label = d.Label, 
                    periodA = d.PeriodAValue, 
                    periodB = d.PeriodBValue, 
                    difference = d.Difference,
                    percentChange = d.PercentChange
                }) ?? Enumerable.Empty<object>(),
                
                // New items in current period
                newItems = comparisonResult.NewInPeriodB?.Select(r => new
                {
                    name = r.Name,
                    email = r.Email,
                    role = r.Role,
                    action = r.Action,
                    date = r.Timestamp.ToString("MMM dd, yyyy HH:mm")
                }) ?? Enumerable.Empty<object>(),
                
                // Removed items
                removedItems = comparisonResult.RemovedInPeriodB?.Select(r => new
                {
                    name = r.Name,
                    email = r.Email,
                    role = r.Role,
                    action = r.Action,
                    date = r.Timestamp.ToString("MMM dd, yyyy HH:mm")
                }) ?? Enumerable.Empty<object>(),
                
                // All items in current period
                allCurrentItems = comparisonResult.AllPeriodBRecords?.Select(r => new
                {
                    name = r.Name,
                    email = r.Email,
                    role = r.Role,
                    action = r.Action,
                    date = r.Timestamp.ToString("MMM dd, yyyy HH:mm"),
                    isNew = comparisonResult.NewInPeriodB?.Any(n => n.Email == r.Email && n.Timestamp == r.Timestamp) ?? false
                }) ?? Enumerable.Empty<object>(),
                
                // Format insights for JavaScript - just the text content
                insights = comparisonResult.Insights?.Select(i => new 
                { 
                    title = i.Title, 
                    description = i.Description,
                    type = i.Type
                }) ?? Enumerable.Empty<object>(),
                
                // Format recommendations for JavaScript
                recommendations = comparisonResult.Recommendations?.Select(r => new 
                { 
                    title = r.Title, 
                    description = r.Description, 
                    priority = r.Priority 
                }) ?? Enumerable.Empty<object>(),
                
                primaryColor = theme.PrimaryColor,
                accentColor = theme.AccentColor
            };

            await JS.InvokeVoidAsync("generateComparisonReport", reportConfig);
            ToastService.ShowSuccess("Comparison report exported as PDF!");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to export PDF: {ex.Message}");
            Console.WriteLine($"PDF Export error: {ex}");
        }
    }

    private async Task ExportComparisonExcel()
    {
        if (comparisonResult == null) return;

        try
        {
            var reportTypeName = comparisonReportTypes.ContainsKey(selectedComparisonReport) 
                ? comparisonReportTypes[selectedComparisonReport].Name 
                : "Report";
            var itemTypeName = GetItemTypeName();
            
            var csvContent = new System.Text.StringBuilder();
            
            // Header section
            csvContent.AppendLine($"{reportTypeName} Comparison Report");
            csvContent.AppendLine($"Generated on: {DateTime.Now:MMMM dd, yyyy 'at' hh:mm tt}");
            csvContent.AppendLine();
            
            // Summary section
            csvContent.AppendLine("=== SUMMARY ===");
            csvContent.AppendLine($"Period A ({periodAStart:MMM dd} - {periodAEnd:MMM dd, yyyy}): {comparisonResult.PeriodATotal} {itemTypeName.ToLower()}");
            csvContent.AppendLine($"Period B ({periodBStart:MMM dd} - {periodBEnd:MMM dd, yyyy}): {comparisonResult.PeriodBTotal} {itemTypeName.ToLower()}");
            csvContent.AppendLine($"Change: {(comparisonResult.AbsoluteChange >= 0 ? "+" : "")}{comparisonResult.AbsoluteChange} ({(comparisonResult.PercentageChange >= 0 ? "+" : "")}{comparisonResult.PercentageChange}%)");
            csvContent.AppendLine();
            
            // Day-by-day breakdown
            csvContent.AppendLine("=== DAY-BY-DAY BREAKDOWN ===");
            csvContent.AppendLine("Date/Label,Period A,Period B,Difference,% Change");
            if (comparisonResult.DetailedData != null)
            {
                foreach (var item in comparisonResult.DetailedData)
                {
                    var percentStr = item.PercentChange >= 0 ? $"+{item.PercentChange}%" : $"{item.PercentChange}%";
                    csvContent.AppendLine($"\"{item.Label}\",{item.PeriodAValue},{item.PeriodBValue},{(item.Difference >= 0 ? "+" : "")}{item.Difference},{percentStr}");
                }
            }
            csvContent.AppendLine($"TOTAL,{comparisonResult.PeriodATotal},{comparisonResult.PeriodBTotal},{(comparisonResult.AbsoluteChange >= 0 ? "+" : "")}{comparisonResult.AbsoluteChange},{(comparisonResult.PercentageChange >= 0 ? "+" : "")}{comparisonResult.PercentageChange}%");
            csvContent.AppendLine();
            
            // New items section
            if (comparisonResult.NewInPeriodB?.Any() == true)
            {
                csvContent.AppendLine($"=== NEW {itemTypeName.ToUpper()} IN CURRENT PERIOD ===");
                csvContent.AppendLine("Name,Email,Role,Action,Date");
                foreach (var item in comparisonResult.NewInPeriodB)
                {
                    csvContent.AppendLine($"\"{item.Name}\",\"{item.Email}\",\"{item.Role}\",\"{item.Action}\",\"{item.Timestamp:MMM dd, yyyy HH:mm}\"");
                }
                csvContent.AppendLine();
            }
            
            // Removed items section
            if (comparisonResult.RemovedInPeriodB?.Any() == true)
            {
                csvContent.AppendLine($"=== REMOVED {itemTypeName.ToUpper()} ===");
                csvContent.AppendLine("Name,Email,Role,Action,Date");
                foreach (var item in comparisonResult.RemovedInPeriodB)
                {
                    csvContent.AppendLine($"\"{item.Name}\",\"{item.Email}\",\"{item.Role}\",\"{item.Action}\",\"{item.Timestamp:MMM dd, yyyy HH:mm}\"");
                }
                csvContent.AppendLine();
            }
            
            // All current period items
            if (comparisonResult.AllPeriodBRecords?.Any() == true)
            {
                csvContent.AppendLine($"=== ALL {itemTypeName.ToUpper()} IN CURRENT PERIOD ===");
                csvContent.AppendLine("Name,Email,Role,Action,Date,Status");
                foreach (var item in comparisonResult.AllPeriodBRecords)
                {
                    var isNew = comparisonResult.NewInPeriodB?.Any(n => n.Email == item.Email && n.Timestamp == item.Timestamp) ?? false;
                    csvContent.AppendLine($"\"{item.Name}\",\"{item.Email}\",\"{item.Role}\",\"{item.Action}\",\"{item.Timestamp:MMM dd, yyyy HH:mm}\",\"{(isNew ? "New" : "Existing")}\"");
                }
                csvContent.AppendLine();
            }
            
            // Recommendations - formatted for users
            if (comparisonResult.Recommendations?.Any() == true)
            {
                csvContent.AppendLine("=== RECOMMENDATIONS ===");
                csvContent.AppendLine("Priority,Recommendation,Details");
                foreach (var rec in comparisonResult.Recommendations)
                {
                    csvContent.AppendLine($"\"{rec.Priority}\",\"{rec.Title}\",\"{rec.Description}\"");
                }
            }

            var fileName = $"{selectedComparisonReport}_comparison_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
            await JS.InvokeVoidAsync("downloadFileContent", fileName, csvContent.ToString(), "text/csv");
            ToastService.ShowSuccess("Comparison data exported as CSV!");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to export CSV: {ex.Message}");
            Console.WriteLine($"CSV Export error: {ex}");
        }
    }

    private async Task ShareComparison()
    {
        if (comparisonResult == null) return;

        try
        {
            var reportTypeName = comparisonReportTypes.ContainsKey(selectedComparisonReport) 
                ? comparisonReportTypes[selectedComparisonReport].Name 
                : "Report";
            var itemTypeName = GetItemTypeName();
            
            // Build report config for PDF preview - same data as PDF export
            shareReportConfig = new
            {
                title = $"{reportTypeName} Comparison Report",
                subtitle = $"Comparing {periodAStart:MMM dd, yyyy} - {periodAEnd:MMM dd, yyyy} vs {periodBStart:MMM dd, yyyy} - {periodBEnd:MMM dd, yyyy}",
                dateRange = $"Generated on {DateTime.Now:MMMM dd, yyyy 'at' hh:mm tt}",
                reportType = selectedComparisonReport,
                itemTypeName = itemTypeName,
                
                summary = new
                {
                    periodATotal = comparisonResult.PeriodATotal,
                    periodBTotal = comparisonResult.PeriodBTotal,
                    absoluteChange = comparisonResult.AbsoluteChange,
                    percentageChange = comparisonResult.PercentageChange,
                    periodALabel = $"{periodAStart:MMM dd} - {periodAEnd:MMM dd, yyyy}",
                    periodBLabel = $"{periodBStart:MMM dd} - {periodBEnd:MMM dd, yyyy}"
                },
                
                // Day-by-day breakdown
                breakdown = comparisonResult.DetailedData?.Select(d => new 
                { 
                    label = d.Label, 
                    periodA = d.PeriodAValue, 
                    periodB = d.PeriodBValue, 
                    difference = d.Difference,
                    percentChange = d.PercentChange
                }) ?? Enumerable.Empty<object>(),
                
                // New items
                newItems = comparisonResult.NewInPeriodB?.Select(r => new
                {
                    name = r.Name,
                    email = r.Email,
                    role = r.Role,
                    action = r.Action,
                    date = r.Timestamp.ToString("MMM dd, yyyy HH:mm")
                }) ?? Enumerable.Empty<object>(),
                
                // Recommendations
                recommendations = comparisonResult.Recommendations?.Select(r => new 
                { 
                    title = r.Title, 
                    description = r.Description, 
                    priority = r.Priority 
                }) ?? Enumerable.Empty<object>()
            };
            
            // Build share text for messaging apps
            var sb = new System.Text.StringBuilder();
            sb.AppendLine($" {reportTypeName} Comparison Report");
            sb.AppendLine();
            sb.AppendLine($" Period A: {periodAStart:MMM dd} - {periodAEnd:MMM dd, yyyy}");
            sb.AppendLine($" Period B: {periodBStart:MMM dd} - {periodBEnd:MMM dd, yyyy}");
            sb.AppendLine();
            sb.AppendLine($" SUMMARY:");
            sb.AppendLine($" Baseline: {comparisonResult.PeriodATotal} {itemTypeName.ToLower()}");
            sb.AppendLine($" Current: {comparisonResult.PeriodBTotal} {itemTypeName.ToLower()}");
            var changeSign = comparisonResult.AbsoluteChange >= 0 ? "+" : "";
            sb.AppendLine($" Change: {changeSign}{comparisonResult.AbsoluteChange} ({changeSign}{comparisonResult.PercentageChange}%)");
            
            if (comparisonResult.NewInPeriodB?.Any() == true)
            {
                sb.AppendLine();
                sb.AppendLine($" New {itemTypeName}: {comparisonResult.NewInPeriodB.Count}");
            }
            
            sb.AppendLine();
            sb.AppendLine("Generated by MediChat AI");
            
            shareText = sb.ToString();
            
            // Show modal first, then generate PDF preview
            pdfPreviewUrl = ""; // Reset to show loading
            showShareModal = true;
            StateHasChanged();
            
            // Generate PDF preview asynchronously
            try
            {
                pdfPreviewUrl = await JS.InvokeAsync<string>("generateComparisonReportPreview", shareReportConfig);
                StateHasChanged();
            }
            catch (Exception pdfEx)
            {
                Console.WriteLine($"PDF preview generation failed: {pdfEx.Message}");
                // Preview will stay in loading state, but modal is usable
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to prepare share: {ex.Message}");
            Console.WriteLine($"Share error: {ex}");
        }
    }

    private async Task ShareVia(string method)
    {
        try
        {
            var encodedText = Uri.EscapeDataString(shareText);
            var subject = Uri.EscapeDataString("MediChat AI - Comparison Report");
            
            switch (method)
            {
                case "copy":
                    await JS.InvokeVoidAsync("navigator.clipboard.writeText", shareText);
                    ToastService.ShowSuccess("Report copied to clipboard!");
                    break;
                    
                case "email":
                    var emailUrl = $"mailto:?subject={subject}&body={encodedText}";
                    await JS.InvokeVoidAsync("window.open", emailUrl);
                    ToastService.ShowSuccess("Opening email client...");
                    break;
                    
                case "whatsapp":
                    var whatsappUrl = $"https://wa.me/?text={encodedText}";
                    await JS.InvokeVoidAsync("window.open", whatsappUrl, "_blank");
                    ToastService.ShowSuccess("Opening WhatsApp...");
                    break;
                    
                case "sms":
                    var smsUrl = $"sms:?body={encodedText}";
                    await JS.InvokeVoidAsync("window.open", smsUrl);
                    ToastService.ShowSuccess("Opening SMS...");
                    break;
                    
                case "telegram":
                    var telegramUrl = $"https://t.me/share/url?text={encodedText}";
                    await JS.InvokeVoidAsync("window.open", telegramUrl, "_blank");
                    ToastService.ShowSuccess("Opening Telegram...");
                    break;
            }
            
            showShareModal = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to share: {ex.Message}");
        }
    }

    private void CloseShareModal()
    {
        showShareModal = false;
        shareText = "";
        pdfPreviewUrl = "";
        shareReportConfig = null;
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        ThemeState.OnChange -= OnThemeChanged;
        
        if (hubConnection != null)
        {
            try
            {
                await hubConnection.InvokeAsync("LeaveAdminGroup");
            }
            catch { /* Ignore errors during disposal */ }
            
            await hubConnection.DisposeAsync();
        }
    }
}

@page "/admin/reports"
@using Microsoft.AspNetCore.Components.Authorization
@using MediChatAI_BlazorWebAssembly.Features.Admin.Components
@inject IAdminService AdminService
@inject NavigationManager Navigation
@inject AppSettingsState AppSettings
@inject IJSRuntime JS
@inject IToastService ToastService
@inject IReportService ReportService
@inject IThemeService ThemeService
@inject ThemeState ThemeState
@implements IDisposable

<PageTitle>Reports - @AppSettings.Settings.SiteName Admin</PageTitle>

<AuthorizeRouteGuard RequiredRole="Admin">

<div class="min-h-screen bg-theme dark:bg-gray-900">
    <!-- Hero Header with Glassmorphism -->
    <header class="backdrop-blur-md bg-gradient-to-r from-primary via-accent to-primary border-b border-gray-200/50 dark:border-gray-700/50 shadow-2xl">
        <div class="py-10 px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="p-4 bg-white/20 dark:bg-white/10 rounded-2xl shadow-lg backdrop-blur-sm">
                        <svg class="w-10 h-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-4xl font-bold text-white">
                            Advanced Reports
                        </h1>
                        <p class="mt-2 text-lg text-white/90">Generate, customize, and schedule comprehensive reports</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button @onclick="OpenReportBuilder"
                            class="group flex items-center px-5 py-2.5 rounded-xl bg-white/20 dark:bg-white/10 backdrop-blur-sm border border-white/20 text-white hover:bg-white/30 transition-all duration-300 shadow-lg hover:shadow-xl">
                        <svg class="w-5 h-5 mr-2 group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        New Report
                    </button>
                    <button @onclick='() => Navigation.NavigateTo("/admin/dashboard")'
                            class="group flex items-center px-4 py-2.5 rounded-xl bg-white/20 dark:bg-white/10 backdrop-blur-sm border border-white/20 text-white hover:bg-white/30 transition-all duration-300 shadow-lg">
                        <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
                        Back
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="py-8 px-4 sm:px-6 lg:px-8">

        <!-- Quick Stats Bar -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-xl hover:shadow-2xl transition-all duration-300 hover:scale-105">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Total Reports</p>
                        <p class="text-3xl font-bold mt-1">@totalReports</p>
                    </div>
                    <div class="p-3 bg-white/20 rounded-xl">
                        <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-6 text-white shadow-xl hover:shadow-2xl transition-all duration-300 hover:scale-105">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Scheduled</p>
                        <p class="text-3xl font-bold mt-1">@scheduledReports</p>
                    </div>
                    <div class="p-3 bg-white/20 rounded-xl">
                        <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-6 text-white shadow-xl hover:shadow-2xl transition-all duration-300 hover:scale-105">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Templates</p>
                        <p class="text-3xl font-bold mt-1">@savedTemplates</p>
                    </div>
                    <div class="p-3 bg-white/20 rounded-xl">
                        <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl p-6 text-white shadow-xl hover:shadow-2xl transition-all duration-300 hover:scale-105">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">This Month</p>
                        <p class="text-3xl font-bold mt-1">@monthlyReports</p>
                    </div>
                    <div class="p-3 bg-white/20 rounded-xl">
                        <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-card/80 dark:bg-gray-800/80 backdrop-blur-lg border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl mb-8">
            <div class="border-b border-gray-200 dark:border-gray-700">
                <nav class="flex -mb-px overflow-x-auto custom-scrollbar">
                    <button @onclick='() => activeTab = "templates"'
                            class="@GetTabClass("templates") whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition-all duration-200 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        Report Templates
                    </button>

                    <button @onclick='() => activeTab = "custom"'
                            class="@GetTabClass("custom") whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition-all duration-200 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"/>
                        </svg>
                        Custom Builder
                    </button>

                    <button @onclick='() => activeTab = "scheduled"'
                            class="@GetTabClass("scheduled") whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition-all duration-200 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        Scheduled Reports
                    </button>

                    <button @onclick='() => activeTab = "history"'
                            class="@GetTabClass("history") whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition-all duration-200 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Report History
                    </button>

                    <button @onclick='() => activeTab = "comparison"'
                            class="@GetTabClass("comparison") whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition-all duration-200 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        Comparison
                    </button>
                </nav>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="mt-6">
            @if (activeTab == "templates")
            {
                <!-- Report Templates Section -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                    <!-- User Reports Category -->
                    <div class="bg-gradient-to-br from-card/90 to-card/70 dark:from-gray-800/90 dark:to-gray-900/70 backdrop-blur-xl border border-gray-200/50 dark:border-gray-700/50 rounded-3xl shadow-2xl overflow-hidden group hover:scale-105 transition-all duration-300">
                        <div class="p-6 border-b border-gray-200/50 dark:border-gray-700/50 bg-gradient-to-r from-blue-500/10 to-cyan-500/10">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="p-3 bg-blue-500/20 rounded-xl">
                                        <svg class="w-8 h-8 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">User Reports</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">5 templates</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-6 space-y-3">
                            <button @onclick='() => GenerateReport("new-registrations")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">New Registrations Trend</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("user-activity")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">User Activity Heatmap</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("engagement")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">Engagement Metrics</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("role-distribution")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">Role Distribution</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("retention")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">Retention Analysis</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- System Performance Category -->
                    <div class="bg-gradient-to-br from-card/90 to-card/70 dark:from-gray-800/90 dark:to-gray-900/70 backdrop-blur-xl border border-gray-200/50 dark:border-gray-700/50 rounded-3xl shadow-2xl overflow-hidden group hover:scale-105 transition-all duration-300">
                        <div class="p-6 border-b border-gray-200/50 dark:border-gray-700/50 bg-gradient-to-r from-purple-500/10 to-pink-500/10">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="p-3 bg-purple-500/20 rounded-xl">
                                        <svg class="w-8 h-8 text-purple-600 dark:text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">System Performance</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">4 templates</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-6 space-y-3">
                            <button @onclick='() => GenerateReport("performance-metrics")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">Performance Metrics</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-purple-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("response-times")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">API Response Times</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-purple-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("error-rate")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">Error Rate Analysis</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-purple-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("uptime")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">Uptime/Downtime Report</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-purple-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- Activity Reports Category -->
                    <div class="bg-gradient-to-br from-card/90 to-card/70 dark:from-gray-800/90 dark:to-gray-900/70 backdrop-blur-xl border border-gray-200/50 dark:border-gray-700/50 rounded-3xl shadow-2xl overflow-hidden group hover:scale-105 transition-all duration-300">
                        <div class="p-6 border-b border-gray-200/50 dark:border-gray-700/50 bg-gradient-to-r from-emerald-500/10 to-teal-500/10">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="p-3 bg-emerald-500/20 rounded-xl">
                                        <svg class="w-8 h-8 text-emerald-600 dark:text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Activity Reports</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">5 templates</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-6 space-y-3">
                            <button @onclick='() => GenerateReport("activity-types")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">Top Activities by Type</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-emerald-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("peak-hours")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">Peak Usage Hours</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-emerald-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("timeline")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">Activity Timeline</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-emerald-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("user-journey")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">User Journey Analysis</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-emerald-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                            <button @onclick='() => GenerateReport("comparative")' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors group">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
                                        <span class="font-medium text-gray-900 dark:text-white">Comparative Activity</span>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-emerald-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                        </div>
                    </div>

                </div>
            }
            else if (activeTab == "custom")
            {
                <!-- Custom Report Builder -->
                <div class="bg-card/80 dark:bg-gray-800/80 backdrop-blur-lg border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl p-8">
                    <div class="text-center py-12">
                        <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-primary to-accent rounded-full mb-4">
                            <svg class="w-10 h-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"/>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Custom Report Builder</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-6">Create your own custom reports with advanced filtering and visualization options</p>
                        <button @onclick="OpenReportBuilder" class="px-6 py-3 bg-primary text-white rounded-xl hover:opacity-90 transition-all shadow-lg hover:shadow-xl">
                            Start Building
                        </button>
                    </div>
                </div>
            }
            else if (activeTab == "scheduled")
            {
                <!-- Scheduled Reports -->
                <div class="bg-card/80 dark:bg-gray-800/80 backdrop-blur-lg border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Scheduled Reports</h3>
                        <button @onclick="CreateScheduledReport" class="px-4 py-2 bg-primary text-white rounded-lg hover:opacity-90 transition-all">
                            <svg class="w-5 h-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            New Schedule
                        </button>
                    </div>

                    @if (!scheduledReportsList.Any())
                    {
                        <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <p>No scheduled reports yet. Create one to get automated reports delivered to your email.</p>
                        </div>
                    }
                    else
                    {
                        <div class="space-y-4">
                            @foreach (var schedule in scheduledReportsList)
                            {
                                <div class="p-6 bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-700/50 dark:to-gray-800/50 rounded-xl border border-gray-200 dark:border-gray-700">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-3 mb-2">
                                                <h4 class="text-lg font-bold text-gray-900 dark:text-white">@schedule.ReportName</h4>
                                                <span class="px-2 py-1 text-xs font-medium @(schedule.IsActive ? "bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400" : "bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-400") rounded-full">
                                                    @(schedule.IsActive ? "Active" : "Inactive")
                                                </span>
                                            </div>
                                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 text-sm">
                                                <div>
                                                    <p class="text-gray-600 dark:text-gray-400">Frequency</p>
                                                    <p class="font-medium text-gray-900 dark:text-white">@schedule.Frequency</p>
                                                </div>
                                                <div>
                                                    <p class="text-gray-600 dark:text-gray-400">Format</p>
                                                    <p class="font-medium text-gray-900 dark:text-white">@schedule.Format</p>
                                                </div>
                                                <div>
                                                    <p class="text-gray-600 dark:text-gray-400">Next Run</p>
                                                    <p class="font-medium text-gray-900 dark:text-white">@(schedule.NextRun?.ToString("MMM dd, HH:mm") ?? "N/A")</p>
                                                </div>
                                                <div>
                                                    <p class="text-gray-600 dark:text-gray-400">Recipients</p>
                                                    <p class="font-medium text-gray-900 dark:text-white">@schedule.Recipients.Count</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2 ml-4">
                                            <button class="p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors" title="Edit">
                                                <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                </svg>
                                            </button>
                                            <button @onclick="() => DeleteSchedule(schedule.Id)" class="p-2 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg transition-colors" title="Delete">
                                                <svg class="w-5 h-5 text-red-600 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
            else if (activeTab == "history")
            {
                <!-- Report History -->
                <div class="bg-card/80 dark:bg-gray-800/80 backdrop-blur-lg border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Report History</h3>
                        <div class="flex space-x-2">
                            <input type="text" @bind="searchQuery" placeholder="Search reports..."
                                   class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" />
                            <button class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    @if (!reportHistory.Any())
                    {
                        <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p>No reports in history yet. Generate your first report to see it here.</p>
                        </div>
                    }
                    else
                    {
                        <div class="space-y-3">
                            @foreach (var item in reportHistory.Take(20))
                            {
                                <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                    <div class="flex items-center space-x-4">
                                        <div class="p-3 bg-primary/10 rounded-lg">
                                            <svg class="w-6 h-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-gray-900 dark:text-white">@item.ReportName</h4>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                                Generated by @item.GeneratedBy on @item.GeneratedAt.ToString("MMM dd, yyyy HH:mm")
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="px-3 py-1 text-xs font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded-full">
                                            @item.Format
                                        </span>
                                        <button class="p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors" title="Download">
                                            <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
            else if (activeTab == "comparison")
            {
                <!-- Comparison Tool -->
                <div class="bg-card/80 dark:bg-gray-800/80 backdrop-blur-lg border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl p-8">
                    <div class="text-center py-12">
                        <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-orange-500 to-red-600 rounded-full mb-4">
                            <svg class="w-10 h-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Report Comparison</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-6">Compare data across different time periods to identify trends and changes</p>
                        <button @onclick="OpenComparison" class="px-6 py-3 bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-xl hover:opacity-90 transition-all shadow-lg hover:shadow-xl">
                            Start Comparison
                        </button>
                    </div>
                </div>
            }
        </div>

    </main>
</div>

<!-- Hidden Report Preview Section for PDF Generation -->
<div id="reportPreviewContainer" style="position: fixed; left: -9999px; top: -9999px; width: 1200px; background: white;">
    <div id="reportPreview" class="bg-white p-12" style="font-family: Arial, sans-serif;">
        <!-- Report Header -->
        <div class="mb-8 border-b-4 border-blue-600 pb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 id="reportTitle" class="text-4xl font-bold text-gray-900 mb-2">Report Title</h1>
                    <p id="reportSubtitle" class="text-lg text-gray-600">Report Subtitle</p>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold text-blue-600 mb-1">MediChat.AI</div>
                    <div id="reportDate" class="text-sm text-gray-600">Generated on: @DateTime.Now.ToString("MMMM dd, yyyy")</div>
                </div>
            </div>
        </div>

        <!-- Executive Summary -->
        <div id="reportSummary" class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Executive Summary</h2>
            <div id="reportMetrics" class="grid grid-cols-4 gap-4 mb-6">
                <!-- Metrics will be injected here -->
            </div>
        </div>

        <!-- Chart Visualization -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Data Visualization</h2>
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <canvas id="reportChartCanvas" width="1000" height="400"></canvas>
            </div>
        </div>

        <!-- Data Table (if applicable) -->
        <div id="reportTableSection" class="mb-8" style="display: none;">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Detailed Data</h2>
            <div id="reportTableContent"></div>
        </div>

        <!-- Report Footer -->
        <div class="mt-12 pt-6 border-t-2 border-gray-300 text-center text-sm text-gray-600">
            <p>This report was automatically generated by MediChat.AI Healthcare Communication Platform</p>
            <p class="mt-1">Â© @DateTime.Now.Year MediChat.AI. All rights reserved.</p>
            <p class="mt-1 text-xs">For internal use only. Contains confidential information.</p>
        </div>
    </div>
</div>

</AuthorizeRouteGuard>

@code {
    private string activeTab = "templates";
    private int totalReports = 14;
    private int scheduledReports = 0;
    private int savedTemplates = 14;
    private int monthlyReports = 0;
    private string searchQuery = "";
    private bool isGeneratingReport = false;
    private ReportDataDto? currentReport;
    private Dictionary<string, object>? currentChartData;
    private List<ReportHistoryDto> reportHistory = new();
    private List<ScheduledReportDto> scheduledReportsList = new();

    protected override async Task OnInitializedAsync()
    {
        ThemeState.OnChange += OnThemeChanged;
        await LoadReportStats();
    }

    private void OnThemeChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task LoadReportStats()
    {
        try
        {
            var history = await ReportService.GetReportHistoryAsync(0, 1000);
            var schedules = await ReportService.GetScheduledReportsAsync();
            var templates = await ReportService.GetReportTemplatesAsync();

            reportHistory = history;
            scheduledReportsList = schedules;
            totalReports = templates.Count + 14; // Default templates + saved
            scheduledReports = schedules.Count;
            savedTemplates = templates.Count + 14;
            monthlyReports = history.Count(h => h.GeneratedAt >= DateTime.UtcNow.AddMonths(-1));
        }
        catch
        {
            // Use default values
        }
    }

    private string GetTabClass(string tab)
    {
        if (tab == activeTab)
        {
            return "border-primary text-white bg-primary dark:bg-primary";
        }
        return "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 hover:bg-gray-50 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:bg-gray-700";
    }

    private async Task GenerateReport(string reportType)
    {
        if (isGeneratingReport) return;

        try
        {
            isGeneratingReport = true;
            ToastService.ShowInfo($"Generating {GetReportName(reportType)} PDF...");
            StateHasChanged();

            var filters = new ReportFilterModel
            {
                FromDate = DateTime.UtcNow.AddDays(-30),
                ToDate = DateTime.UtcNow,
                GroupBy = "day"
            };

            currentReport = await ReportService.GenerateReportAsync(reportType, filters);

            if (currentReport != null)
            {
                currentChartData = currentReport.Data;

                // Get theme colors
                var theme = await ThemeService.GetCurrentThemeAsync();

                // Prepare metrics for summary
                var metrics = ExtractMetrics(currentChartData, reportType);

                // Prepare table data if applicable
                var tableData = ExtractTableData(currentChartData, reportType);

                // Get chart details
                var chartType = currentChartData.ContainsKey("chartType") ? currentChartData["chartType"].ToString() : "bar";
                var labels = currentChartData.ContainsKey("labels") ? currentChartData["labels"] : new List<string>();
                var values = currentChartData.ContainsKey("values") ? currentChartData["values"] : new List<object>();

                // Create report configuration
                var reportConfig = new
                {
                    title = GetReportName(reportType),
                    subtitle = $"Period: {filters.FromDate:MMM dd, yyyy} - {filters.ToDate:MMM dd, yyyy}",
                    filename = $"{reportType}_{DateTime.Now:yyyyMMdd_HHmmss}.pdf",
                    chartType = chartType,
                    labels = labels,
                    values = values,
                    datasetLabel = GetReportName(reportType),
                    primaryColor = theme.PrimaryColor,
                    accentColor = theme.AccentColor,
                    metrics = metrics,
                    tableData = tableData.data,
                    tableHeaders = tableData.headers
                };

                // Generate and download professional PDF
                var success = await JS.InvokeAsync<bool>("generateProfessionalReport", reportConfig);

                if (success)
                {
                    ToastService.ShowSuccess($"{currentReport.ReportName} PDF downloaded successfully!");
                    // Reload stats to reflect new history entry
                    await LoadReportStats();
                }
                else
                {
                    ToastService.ShowError("Failed to generate PDF report");
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error generating report: {ex.Message}");
            Console.WriteLine($"Report generation error: {ex}");
        }
        finally
        {
            isGeneratingReport = false;
            StateHasChanged();
        }
    }

    private List<object> ExtractMetrics(Dictionary<string, object> data, string reportType)
    {
        var metrics = new List<object>();

        try
        {
            if (data.ContainsKey("total"))
            {
                metrics.Add(new { label = "Total", value = data["total"].ToString() });
            }

            if (data.ContainsKey("average"))
            {
                var avg = Convert.ToDouble(data["average"]);
                metrics.Add(new { label = "Average", value = avg.ToString("F2") });
            }

            if (data.ContainsKey("values"))
            {
                var valuesList = data["values"] as System.Collections.IEnumerable;
                if (valuesList != null)
                {
                    var values = valuesList.Cast<object>().Select(v => Convert.ToDouble(v)).ToList();
                    if (values.Any())
                    {
                        metrics.Add(new { label = "Count", value = values.Count.ToString() });

                        if (!data.ContainsKey("average"))
                        {
                            metrics.Add(new { label = "Average", value = values.Average().ToString("F2") });
                        }

                        if (reportType != "role-distribution" && reportType != "activity-types")
                        {
                            metrics.Add(new { label = "Max", value = values.Max().ToString("F0") });
                        }
                    }
                }
            }

            // Fill to 4 metrics minimum for better layout
            while (metrics.Count < 4 && metrics.Count > 0)
            {
                metrics.Add(new { label = "Period", value = "30 Days" });
                break;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error extracting metrics: {ex.Message}");
        }

        return metrics;
    }

    private (List<object> data, List<string> headers) ExtractTableData(Dictionary<string, object> data, string reportType)
    {
        var tableData = new List<object>();
        var headers = new List<string>();

        try
        {
            if (data.ContainsKey("labels") && data.ContainsKey("values"))
            {
                var labels = (data["labels"] as System.Collections.IEnumerable)?.Cast<object>().ToList();
                var values = (data["values"] as System.Collections.IEnumerable)?.Cast<object>().ToList();

                if (labels != null && values != null && labels.Count == values.Count)
                {
                    headers = new List<string> { GetTableColumnName(reportType), "Value" };

                    for (int i = 0; i < Math.Min(labels.Count, 20); i++)
                    {
                        tableData.Add(new
                        {
                            Label = labels[i].ToString(),
                            Value = Convert.ToDouble(values[i]).ToString("F2")
                        });
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error extracting table data: {ex.Message}");
        }

        return (tableData, headers);
    }

    private string GetTableColumnName(string reportType)
    {
        return reportType switch
        {
            "new-registrations" => "Date",
            "user-activity" => "Date",
            "engagement" => "Metric",
            "role-distribution" => "Role",
            "retention" => "Metric",
            "performance-metrics" => "Metric",
            "response-times" => "Date",
            "error-rate" => "Date",
            "uptime" => "Category",
            "activity-types" => "Activity Type",
            "peak-hours" => "Hour",
            "timeline" => "Time",
            "user-journey" => "Step",
            "comparative" => "Date",
            _ => "Category"
        };
    }

    private void OpenReportBuilder()
    {
        activeTab = "custom";
        ToastService.ShowInfo("Custom Report Builder activated");
    }

    private async Task CreateScheduledReport()
    {
        try
        {
            var schedule = new ScheduledReportDto(
                Guid.NewGuid().ToString(),
                Guid.NewGuid().ToString(),
                "New Scheduled Report",
                "0 9 * * *", // Daily at 9 AM
                "Daily",
                new List<string> { "admin@medichat.ai" },
                "PDF",
                true,
                DateTime.UtcNow.AddDays(1),
                null,
                DateTime.UtcNow
            );

            var result = await ReportService.ScheduleReportAsync(schedule);
            if (result != null)
            {
                ToastService.ShowSuccess("Report scheduled successfully!");
                await LoadReportStats();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error scheduling report: {ex.Message}");
        }
    }

    private void OpenComparison()
    {
        activeTab = "comparison";
        ToastService.ShowInfo("Comparison tool activated");
    }

    private async Task DeleteSchedule(string scheduleId)
    {
        try
        {
            var result = await ReportService.DeleteScheduledReportAsync(scheduleId);
            if (result)
            {
                ToastService.ShowSuccess("Scheduled report deleted successfully!");
                await LoadReportStats();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error deleting schedule: {ex.Message}");
        }
    }

    private async Task DownloadHistoryReport(string historyId)
    {
        if (isGeneratingReport) return;

        try
        {
            isGeneratingReport = true;

            var historyItem = reportHistory.FirstOrDefault(h => h.Id == historyId);
            if (historyItem == null)
            {
                ToastService.ShowError("Report not found in history");
                return;
            }

            if (string.IsNullOrEmpty(historyItem.ReportTypeId))
            {
                ToastService.ShowError("Cannot regenerate this report - missing configuration");
                return;
            }

            ToastService.ShowInfo($"Regenerating {historyItem.ReportName} PDF...");
            StateHasChanged();

            // Use stored dates or default to last 30 days
            var filters = new ReportFilterModel
            {
                FromDate = historyItem.FromDate ?? DateTime.UtcNow.AddDays(-30),
                ToDate = historyItem.ToDate ?? DateTime.UtcNow,
                GroupBy = "day"
            };

            // Regenerate report data
            currentReport = await ReportService.GenerateReportAsync(historyItem.ReportTypeId, filters);

            if (currentReport != null)
            {
                currentChartData = currentReport.Data;

                // Get theme colors
                var theme = await ThemeService.GetCurrentThemeAsync();

                // Prepare metrics for summary
                var metrics = ExtractMetrics(currentChartData, historyItem.ReportTypeId);

                // Prepare table data if applicable
                var tableData = ExtractTableData(currentChartData, historyItem.ReportTypeId);

                // Get chart details
                var chartType = currentChartData.ContainsKey("chartType") ? currentChartData["chartType"].ToString() : "bar";
                var labels = currentChartData.ContainsKey("labels") ? currentChartData["labels"] : new List<string>();
                var values = currentChartData.ContainsKey("values") ? currentChartData["values"] : new List<object>();

                // Create report configuration
                var reportConfig = new
                {
                    title = historyItem.ReportName,
                    subtitle = $"Period: {filters.FromDate:MMM dd, yyyy} - {filters.ToDate:MMM dd, yyyy}",
                    filename = $"{historyItem.ReportTypeId}_{DateTime.Now:yyyyMMdd_HHmmss}.pdf",
                    chartType = chartType,
                    labels = labels,
                    values = values,
                    datasetLabel = historyItem.ReportName,
                    primaryColor = theme.PrimaryColor,
                    accentColor = theme.AccentColor,
                    metrics = metrics,
                    tableData = tableData.data,
                    tableHeaders = tableData.headers
                };

                // Generate and download professional PDF
                var success = await JS.InvokeAsync<bool>("generateProfessionalReport", reportConfig);

                if (success)
                {
                    ToastService.ShowSuccess($"{historyItem.ReportName} PDF downloaded successfully!");
                }
                else
                {
                    ToastService.ShowError("Failed to generate PDF report");
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error downloading report: {ex.Message}");
            Console.WriteLine($"Report download error: {ex}");
        }
        finally
        {
            isGeneratingReport = false;
            StateHasChanged();
        }
    }

    private string GetReportName(string reportType)
    {
        return reportType switch
        {
            "new-registrations" => "New Registrations Trend",
            "user-activity" => "User Activity Heatmap",
            "engagement" => "Engagement Metrics",
            "role-distribution" => "Role Distribution",
            "retention" => "Retention Analysis",
            "performance-metrics" => "Performance Metrics",
            "response-times" => "API Response Times",
            "error-rate" => "Error Rate Analysis",
            "uptime" => "Uptime/Downtime Report",
            "activity-types" => "Top Activities by Type",
            "peak-hours" => "Peak Usage Hours",
            "timeline" => "Activity Timeline",
            "user-journey" => "User Journey Analysis",
            "comparative" => "Comparative Activity",
            _ => "Custom Report"
        };
    }

    public void Dispose()
    {
        ThemeState.OnChange -= OnThemeChanged;
    }
}

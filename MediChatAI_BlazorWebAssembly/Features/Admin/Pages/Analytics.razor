@page "/admin/analytics"
@using Microsoft.AspNetCore.Components.Authorization
@using MediChatAI_BlazorWebAssembly.Features.Admin.Components
@inject IAdminService AdminService
@inject NavigationManager Navigation
@inject AppSettingsState AppSettings
@inject IJSRuntime JS
@inject IToastService ToastService
@inject ThemeState ThemeState
@implements IDisposable

<PageTitle>Analytics Dashboard - @AppSettings.Settings.SiteName</PageTitle>

<AuthorizeRouteGuard RequiredRole="Admin">

<div class="min-h-screen bg-theme dark:bg-gray-900">
    <!-- Modern Header with Glassmorphism -->
    <header class="backdrop-blur-md bg-gradient-to-r from-primary to-accent border-b border-gray-200/50 dark:border-gray-700/50 shadow-xl">
        <div class="py-8 px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="p-3 bg-white/20 dark:bg-white/10 rounded-2xl shadow-lg backdrop-blur-sm">
                        <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-4xl font-bold text-white">
                            Analytics Dashboard
                        </h1>
                        <p class="mt-2 text-lg text-white/90">Real-time insights and data visualization</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Export Modal Trigger Button -->
                    <button @onclick="OpenExportModal"
                            class="group flex items-center px-4 py-2 rounded-xl bg-white/20 dark:bg-white/10 backdrop-blur-sm border border-white/20 text-white hover:bg-white/30 transition-all duration-300 shadow-lg hover:shadow-xl">
                        <svg class="w-5 h-5 mr-2 group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Export Data
                    </button>
                    <button @onclick='() => Navigation.NavigateTo("/admin/dashboard")' class="group flex items-center px-4 py-2 rounded-xl bg-white/20 dark:bg-white/10 backdrop-blur-sm border border-white/20 text-white hover:bg-white/30 transition-all duration-300 shadow-lg">
                        <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
                        Back
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Content Area -->
    <main class="py-8 px-4 sm:px-6 lg:px-8">

        <!-- Date Range Filter -->
        <div class="mb-8 bg-card/80 dark:bg-gray-800/80 backdrop-blur-lg border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl p-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center space-x-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">From Date</label>
                        <input type="date" @bind="fromDate" @bind:event="oninput" @onchange="LoadAnalytics"
                               class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all"/>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">To Date</label>
                        <input type="date" @bind="toDate" @bind:event="oninput" @onchange="LoadAnalytics"
                               class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all"/>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button @onclick="() => SetDateRange(7)" class="px-4 py-2 text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Last 7 Days</button>
                    <button @onclick="() => SetDateRange(30)" class="px-4 py-2 text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Last 30 Days</button>
                    <button @onclick="() => SetDateRange(90)" class="px-4 py-2 text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Last 90 Days</button>
                </div>
            </div>
        </div>

        @if (isLoading)
        {
            <div class="flex justify-center items-center py-20">
                <div class="relative">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-primary"></div>
                    <div class="absolute inset-0 animate-ping rounded-full h-16 w-16 border border-primary opacity-20"></div>
                </div>
            </div>
        }
        else
        {
            <!-- Enhanced KPI Metrics Grid -->
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4 mb-12">
                <!-- Total Users Metric -->
                <div class="group relative overflow-hidden bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-500 hover:scale-105 p-6">
                    <div class="absolute inset-0 bg-white/10 dark:bg-black/20"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-white/20 rounded-xl">
                                <svg class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                                </svg>
                            </div>
                            <div class="text-right">
                                <p class="text-3xl font-bold text-white">@(adminStats?.TotalUsers ?? 0)</p>
                                <p class="text-sm text-white/80">Total Users</p>
                            </div>
                        </div>
                        <div class="mt-3 flex items-center text-white/90">
                            <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                            </svg>
                            <span class="text-sm">+@(adminStats?.NewUsersThisWeek ?? 0) this week</span>
                        </div>
                    </div>
                </div>

                <!-- Active Today Metric -->
                <div class="group relative overflow-hidden bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-500 hover:scale-105 p-6">
                    <div class="absolute inset-0 bg-white/10 dark:bg-black/20"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-white/20 rounded-xl">
                                <svg class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                            </div>
                            <div class="text-right">
                                <p class="text-3xl font-bold text-white">@(adminStats?.ActiveUsersToday ?? 0)</p>
                                <p class="text-sm text-white/80">Active Today</p>
                            </div>
                        </div>
                        <div class="mt-3 flex items-center text-white/90">
                            <div class="flex-1 h-2 bg-white/30 rounded-full overflow-hidden">
                                <div class="h-full bg-white rounded-full animate-pulse" style="width: @GetActivePercentage()%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Total Activities Metric -->
                <div class="group relative overflow-hidden bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-500 hover:scale-105 p-6">
                    <div class="absolute inset-0 bg-white/10 dark:bg-black/20"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-white/20 rounded-xl">
                                <svg class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                                </svg>
                            </div>
                            <div class="text-right">
                                <p class="text-3xl font-bold text-white">@(adminStats?.TotalActivities ?? 0)</p>
                                <p class="text-sm text-white/80">Total Activities</p>
                            </div>
                        </div>
                        <div class="mt-3 text-white/90 text-sm">
                            <span>@GetActivityRate() activities/day avg</span>
                        </div>
                    </div>
                </div>

                <!-- User Distribution Metric -->
                <div class="group relative overflow-hidden bg-gradient-to-br from-orange-500 to-red-600 rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-500 hover:scale-105 p-6">
                    <div class="absolute inset-0 bg-white/10 dark:bg-black/20"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-white/20 rounded-xl">
                                <svg class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/>
                                </svg>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-semibold text-white">Role Distribution</p>
                                <p class="text-xs text-white/80 mt-1">Patients: @(adminStats?.TotalPatients ?? 0)</p>
                                <p class="text-xs text-white/80">Doctors: @(adminStats?.TotalDoctors ?? 0)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">

                <!-- User Growth Chart -->
                <div class="bg-card/80 dark:bg-gray-800/80 backdrop-blur-lg border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl overflow-hidden">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">User Growth Trend</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Daily registration trends</p>
                            </div>
                            <div class="p-2 bg-primary/10 rounded-lg">
                                <svg class="w-6 h-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <canvas id="userGrowthChart" class="w-full" style="height: 300px;"></canvas>
                    </div>
                </div>

                <!-- Activity Breakdown Chart -->
                <div class="bg-card/80 dark:bg-gray-800/80 backdrop-blur-lg border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl overflow-hidden">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Activity Breakdown</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Activity types distribution</p>
                            </div>
                            <div class="p-2 bg-accent/10 rounded-lg">
                                <svg class="w-6 h-6 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <canvas id="activityBreakdownChart" class="w-full" style="height: 300px;"></canvas>
                    </div>
                </div>

            </div>

            <!-- Role Distribution & Peak Hours -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">

                <!-- Role Distribution Chart -->
                <div class="bg-card/80 dark:bg-gray-800/80 backdrop-blur-lg border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl overflow-hidden">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">User Role Distribution</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Users by role</p>
                            </div>
                            <div class="p-2 bg-emerald-500/10 rounded-lg">
                                <svg class="w-6 h-6 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <canvas id="roleDistributionChart" class="w-full" style="height: 300px;"></canvas>
                    </div>
                </div>

                <!-- Recent Activity Feed -->
                <div class="bg-card/80 dark:bg-gray-800/80 backdrop-blur-lg border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl overflow-hidden">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Recent Activities</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Latest user actions</p>
                            </div>
                            <button @onclick="RefreshActivities" class="p-2 bg-primary/10 rounded-lg hover:bg-primary/20 transition-colors">
                                <svg class="w-5 h-5 text-primary @(isRefreshing ? "animate-spin" : "")" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="p-6 max-h-80 overflow-y-auto custom-scrollbar">
                        @if (recentActivities?.Any() == true)
                        {
                            <div class="space-y-3">
                                @foreach (var activity in recentActivities.Take(5))
                                {
                                    <div class="flex items-start space-x-3 p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                                        <div class="flex-shrink-0 w-10 h-10 rounded-full @GetActivityIconBg(activity.ActivityType) flex items-center justify-center">
                                            @((MarkupString)GetActivityIconSvg(activity.ActivityType))
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-gray-900 dark:text-white">
                                                <span class="text-primary font-semibold">@activity.UserName</span>
                                            </p>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">@activity.Description</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">@GetRelativeTime(activity.Timestamp)</p>
                                        </div>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium @GetActivityBadgeColor(activity.ActivityType)">
                                            @activity.ActivityType
                                        </span>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-8">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                                </svg>
                                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">No recent activities</p>
                            </div>
                        }
                    </div>
                </div>

            </div>


            <!-- Additional Data Visualizations Grid -->
           
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">

                <!-- Activity Heatmap - Modern Full Width Design -->
                <div class="bg-gradient-to-br from-card/90 to-card/70 dark:from-gray-800/90 dark:to-gray-900/70 backdrop-blur-xl border border-gray-200/50 dark:border-gray-700/50 rounded-3xl shadow-2xl overflow-hidden">
                    <!-- Enhanced Header with Gradient -->
                    <div class="p-6 border-b border-gray-200/50 dark:border-gray-700/50 bg-gradient-to-r from-yellow-500/5 to-orange-500/5">
                        <div class="flex flex-col">
                            <div class="flex space-x-4 mb-2">
                                <div class="p-2 bg-primary text-white rounded-xl">
                                    <svg class="w-8 h-8 text-whhite" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900 dark:text-white">
                                        Activity Contribution Graph
                                        <span class="ml-3 px-3 py-1 text-xs font-medium bg-primary/10 text-primary rounded-full">Live</span>
                                    </h3>
                                    <p class="text-xs text-gray-600 dark:text-gray-400">User activity intensity visualization over the past weeks</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3 text-sm text-gray-600 dark:text-gray-400">
                                <span class="font-medium">Less</span>
                                <div class="flex space-x-1.5 p-2 bg-white/50 dark:bg-gray-800/50 rounded-xl backdrop-blur-sm">
                                    <div class="w-5 h-5 bg-gray-200 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 transition-all hover:scale-110"></div>
                                    <div class="w-5 h-5 rounded border border-primary/30 transition-all hover:scale-110" style="background-color: rgba(var(--color-primary-rgb, 59 130 246), 0.2);"></div>
                                    <div class="w-5 h-5 rounded border border-primary/40 transition-all hover:scale-110" style="background-color: rgba(var(--color-primary-rgb, 59 130 246), 0.4);"></div>
                                    <div class="w-5 h-5 rounded border border-primary/50 transition-all hover:scale-110" style="background-color: rgba(var(--color-primary-rgb, 59 130 246), 0.7);"></div>
                                    <div class="w-5 h-5 bg-primary rounded border border-primary transition-all hover:scale-110"></div>
                                </div>
                                <span class="font-medium">More</span>
                            </div>
                        </div>
                        <!-- Decorative gradient line -->
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-primary via-accent to-primary opacity-30"></div>
                    </div>

                    <!-- Heatmap Container - Full Width -->
                    <div class="w-full p-8 bg-gradient-to-b from-transparent to-gray-50/50 dark:to-gray-900/30">
                        <div id="activityHeatmap" class="w-full overflow-x-auto custom-scrollbar pb-4" style="width:100%;"></div>
                    </div>
                </div>

                <!-- Activity Timeline Chart -->
                <div class="bg-gradient-to-br from-card/90 to-card/70 dark:from-gray-800/90 dark:to-gray-900/70 backdrop-blur-xl border border-gray-200/50 dark:border-gray-700/50 rounded-3xl shadow-2xl overflow-hidden">
                    <div class="p-6 border-b border-gray-200/50 dark:border-gray-700/50 bg-gradient-to-r from-blue-500/5 to-cyan-500/5">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="p-2 bg-blue-500/20 rounded-xl">
                                    <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-gray-900 dark:text-white">Activity Timeline</h4>
                                    <p class="text-xs text-gray-600 dark:text-gray-400">Daily trends over time</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <canvas id="activityTimelineChart" class="w-full" style="height: 260px;"></canvas>
                    </div>
                </div>

                <!-- Peak Hours Heatmap -->
                <div class="bg-gradient-to-br from-card/90 to-card/70 dark:from-gray-800/90 dark:to-gray-900/70 backdrop-blur-xl border border-gray-200/50 dark:border-gray-700/50 rounded-3xl shadow-2xl overflow-hidden">
                    <div class="p-6 border-b border-gray-200/50 dark:border-gray-700/50 bg-gradient-to-r from-purple-500/5 to-pink-500/5">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="p-2 bg-purple-500/20 rounded-xl">
                                    <svg class="w-6 h-6 text-purple-600 dark:text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-gray-900 dark:text-white">Peak Activity Hours</h4>
                                    <p class="text-xs text-gray-600 dark:text-gray-400">Hour-by-hour heatmap</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-2">
                        <div id="peakHoursHeatmap" class="w-full h-full"></div>
                    </div>
                    <div class="p-4 border-t border-gray-200/50 dark:border-gray-700/50 bg-gradient-to-r from-purple-500/5 to-pink-500/5 text-center text-sm text-gray-600 dark:text-gray-400">
                          <p class="text-2xl">Real Time Data</p>  
                    </div>
                </div>

            </div>

            <!-- Bottom Row Visualizations -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">

                <!-- Activity Distribution Radial -->
                <div class="bg-gradient-to-br from-card/90 to-card/70 dark:from-gray-800/90 dark:to-gray-900/70 backdrop-blur-xl border border-gray-200/50 dark:border-gray-700/50 rounded-3xl shadow-2xl overflow-hidden">
                    <div class="p-6 border-b border-gray-200/50 dark:border-gray-700/50 bg-gradient-to-r from-emerald-500/5 to-teal-500/5">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="p-2 bg-emerald-500/20 rounded-xl">
                                    <svg class="w-6 h-6 text-emerald-600 dark:text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-gray-900 dark:text-white">Activity Types</h4>
                                    <p class="text-xs text-gray-600 dark:text-gray-400">Distribution breakdown</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <canvas id="activityDistributionChart" class="w-full" style="height: 250px;"></canvas>
                    </div>
                </div>

                <!-- Weekly Comparison -->
                <div class="bg-gradient-to-br from-card/90 to-card/70 dark:from-gray-800/90 dark:to-gray-900/70 backdrop-blur-xl border border-gray-200/50 dark:border-gray-700/50 rounded-3xl shadow-2xl overflow-hidden">
                    <div class="p-6 border-b border-gray-200/50 dark:border-gray-700/50 bg-gradient-to-r from-orange-500/5 to-red-500/5">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="p-2 bg-orange-500/20 rounded-xl">
                                    <svg class="w-6 h-6 text-orange-600 dark:text-orange-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-gray-900 dark:text-white">Weekly Comparison</h4>
                                    <p class="text-xs text-gray-600 dark:text-gray-400">This week vs last week</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <canvas id="weeklyComparisonChart" class="w-full" style="height: 250px;"></canvas>
                    </div>
                </div>

            </div>

        }
    </main>
</div>

<!-- Export Modal -->
<ExportModal IsOpen="@showExportModal"
             OnClose="@CloseExportModal"
             OnExportCsv="@ExportUserDataCsv"
             OnExportXlsx="@ExportUserDataXlsx"
             OnExportJson="@ExportAnalyticsJson"
             OnExportPdf="@ExportAnalyticsPdf"
             OnExportPng="@ExportAllChartsAsPng" />

</AuthorizeRouteGuard>

@code {
    private AdminStatsDto? adminStats;
    private List<UserActivityDto>? recentActivities;
    private List<UserActivityDto>? allActivities;
    private bool isLoading = true;
    private bool isRefreshing = false;
    private bool showExportModal = false;
    private DateTime fromDate = DateTime.UtcNow.AddDays(-30);
    private DateTime toDate = DateTime.UtcNow;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to theme changes
        ThemeState.OnChange += OnThemeChanged;

        await LoadAnalytics();
    }

    private void OnThemeChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && allActivities != null)
        {
            await RenderCharts();
            await RenderHeatmap();
        }
    }

    private async Task LoadAnalytics()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // Load admin stats
            adminStats = await AdminService.GetAdminStatsAsync();

            // Load activities
            var input = new GetUserActivitiesInput(
                Skip: 0,
                Take: 1000,
                FromDate: fromDate,
                ToDate: toDate,
                SortBy: "Timestamp",
                SortDescending: true
            );

            var result = await AdminService.GetUserActivitiesAsync(input);
            if (result?.Success == true)
            {
                allActivities = result.Activities;
                recentActivities = result.Activities.Take(10).ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading analytics: {ex.Message}");
            ToastService.ShowError("Failed to load analytics data");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }

        if (allActivities != null)
        {
            await RenderCharts();
            await RenderHeatmap();
        }
    }

    private async Task RenderCharts()
    {
        try
        {
            // Original charts
            var userGrowthData = PrepareUserGrowthData();
            await JS.InvokeVoidAsync("renderUserGrowthChart", userGrowthData);

            var activityBreakdown = PrepareActivityBreakdownData();
            await JS.InvokeVoidAsync("renderActivityBreakdownChart", activityBreakdown);

            var roleDistribution = PrepareRoleDistributionData();
            await JS.InvokeVoidAsync("renderRoleDistributionChart", roleDistribution);

            // New enhanced visualizations
            var timelineData = PrepareTimelineData();
            await JS.InvokeVoidAsync("renderActivityTimeline", timelineData);

            var peakHoursData = PreparePeakHoursData();
            await JS.InvokeVoidAsync("renderPeakHoursHeatmap", peakHoursData);

            var activityTypesData = PrepareActivityTypesData();
            await JS.InvokeVoidAsync("renderActivityDistribution", activityTypesData);

            var weeklyComparisonData = PrepareWeeklyComparisonData();
            await JS.InvokeVoidAsync("renderWeeklyComparison", weeklyComparisonData);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rendering charts: {ex.Message}");
        }
    }

    private object PrepareUserGrowthData()
    {
        if (allActivities == null) return new { labels = Array.Empty<string>(), data = Array.Empty<int>() };

        var registrations = allActivities
            .Where(a => a.ActivityType == "Register")
            .GroupBy(a => a.Timestamp.Date)
            .OrderBy(g => g.Key)
            .Select(g => new { Date = g.Key, Count = g.Count() })
            .ToList();

        return new
        {
            labels = registrations.Select(r => r.Date.ToString("MMM dd")).ToArray(),
            data = registrations.Select(r => r.Count).ToArray()
        };
    }

    private object PrepareActivityBreakdownData()
    {
        if (allActivities == null) return new { labels = Array.Empty<string>(), data = Array.Empty<int>() };

        var breakdown = allActivities
            .GroupBy(a => a.ActivityType)
            .Select(g => new { Type = g.Key, Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .ToList();

        return new
        {
            labels = breakdown.Select(b => b.Type).ToArray(),
            data = breakdown.Select(b => b.Count).ToArray()
        };
    }

    private object PrepareRoleDistributionData()
    {
        return new
        {
            labels = new[] { "Patients", "Doctors", "Admins" },
            data = new[] { adminStats?.TotalPatients ?? 0, adminStats?.TotalDoctors ?? 0, adminStats?.TotalAdmins ?? 0 }
        };
    }

    private object PrepareTimelineData()
    {
        if (allActivities == null) return new { labels = Array.Empty<string>(), data = Array.Empty<int>() };

        // Get daily activity counts for the date range
        var dailyActivities = allActivities
            .GroupBy(a => a.Timestamp.Date)
            .OrderBy(g => g.Key)
            .Select(g => new { Date = g.Key, Count = g.Count() })
            .ToList();

        return new
        {
            labels = dailyActivities.Select(d => d.Date.ToString("MMM dd")).ToArray(),
            data = dailyActivities.Select(d => d.Count).ToArray()
        };
    }

    private object PreparePeakHoursData()
    {
        if (allActivities == null) return new { hours = Array.Empty<object>() };

        // Create 24x7 grid (hour x day of week)
        var hourlyData = new List<object>();
        var dayNames = new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };

        for (int hour = 0; hour < 24; hour++)
        {
            for (int day = 0; day < 7; day++)
            {
                var count = allActivities
                    .Where(a => a.Timestamp.Hour == hour && (int)a.Timestamp.DayOfWeek == day)
                    .Count();

                // Calculate intensity level (0-4)
                var level = count == 0 ? 0 :
                            count <= 5 ? 1 :
                            count <= 15 ? 2 :
                            count <= 30 ? 3 : 4;

                hourlyData.Add(new
                {
                    hour = hour,
                    day = day,
                    dayName = dayNames[day],
                    count = count,
                    level = level
                });
            }
        }

        return new { hours = hourlyData };
    }

    private object PrepareActivityTypesData()
    {
        if (allActivities == null) return new { labels = Array.Empty<string>(), data = Array.Empty<int>(), percentages = Array.Empty<double>() };

        var total = allActivities.Count;
        var breakdown = allActivities
            .GroupBy(a => a.ActivityType)
            .Select(g => new
            {
                Type = g.Key,
                Count = g.Count(),
                Percentage = Math.Round((double)g.Count() / total * 100, 1)
            })
            .OrderByDescending(x => x.Count)
            .ToList();

        return new
        {
            labels = breakdown.Select(b => b.Type).ToArray(),
            data = breakdown.Select(b => b.Count).ToArray(),
            percentages = breakdown.Select(b => b.Percentage).ToArray()
        };
    }

    private object PrepareWeeklyComparisonData()
    {
        if (allActivities == null) return new { labels = Array.Empty<string>(), thisWeek = Array.Empty<int>(), lastWeek = Array.Empty<int>() };

        var today = DateTime.UtcNow.Date;
        var dayNames = new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };

        // Get start of this week (Sunday)
        var thisWeekStart = today.AddDays(-(int)today.DayOfWeek);
        var lastWeekStart = thisWeekStart.AddDays(-7);

        var thisWeekData = new int[7];
        var lastWeekData = new int[7];

        for (int i = 0; i < 7; i++)
        {
            var thisWeekDay = thisWeekStart.AddDays(i);
            var lastWeekDay = lastWeekStart.AddDays(i);

            thisWeekData[i] = allActivities.Count(a => a.Timestamp.Date == thisWeekDay);
            lastWeekData[i] = allActivities.Count(a => a.Timestamp.Date == lastWeekDay);
        }

        return new
        {
            labels = dayNames,
            thisWeek = thisWeekData,
            lastWeek = lastWeekData
        };
    }

    private void SetDateRange(int days)
    {
        fromDate = DateTime.UtcNow.AddDays(-days);
        toDate = DateTime.UtcNow;
        _ = LoadAnalytics();
    }

    private async Task RefreshActivities()
    {
        isRefreshing = true;
        StateHasChanged();
        await Task.Delay(500);
        await LoadAnalytics();
        isRefreshing = false;
        StateHasChanged();
    }

    private void OpenExportModal()
    {
        showExportModal = true;
    }

    private void CloseExportModal()
    {
        showExportModal = false;
    }

    private async Task ExportUserDataCsv()
    {
        try
        {
            ToastService.ShowSuccess("Exporting user data...");
            var result = await AdminService.ExportUserDataAsync();

            if (result?.Success == true && !string.IsNullOrEmpty(result.Message))
            {
                // The Message field contains base64 CSV data
                var base64Csv = result.Message;
                var csvData = System.Convert.FromBase64String(base64Csv);
                var csvString = System.Text.Encoding.UTF8.GetString(csvData);

                var filename = $"user-data-export-{DateTime.Now:yyyy-MM-dd-HHmmss}.csv";
                await JS.InvokeVoidAsync("downloadFileContent", filename, csvString, "text/csv");

                ToastService.ShowSuccess("User data exported successfully!");
            }
            else
            {
                ToastService.ShowError("No data to export");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Export failed: {ex.Message}");
        }
    }

    private async Task ExportUserDataXlsx()
    {
        try
        {
            ToastService.ShowSuccess("Exporting to Excel...");
            var result = await AdminService.ExportUserDataAsync();

            if (result?.Success == true && !string.IsNullOrEmpty(result.Message))
            {
                // Convert CSV to XLSX format using JavaScript
                var base64Csv = result.Message;
                var csvData = System.Convert.FromBase64String(base64Csv);
                var csvString = System.Text.Encoding.UTF8.GetString(csvData);

                var filename = $"user-data-export-{DateTime.Now:yyyy-MM-dd-HHmmss}.xlsx";
                await JS.InvokeVoidAsync("exportCsvToXlsx", csvString, filename);

                ToastService.ShowSuccess("Excel file exported successfully!");
            }
            else
            {
                ToastService.ShowError("No data to export");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Export failed: {ex.Message}");
        }
    }

    private async Task ExportAnalyticsPdf()
    {
        try
        {
            ToastService.ShowSuccess("Generating PDF report...");
            
            var reportConfig = new
            {
                title = "Analytics Report",
                subtitle = $"Period: {fromDate:MMM dd, yyyy} - {toDate:MMM dd, yyyy}",
                dateRange = $"Generated on {DateTime.Now:MMMM dd, yyyy 'at' hh:mm tt}",
                type = "analytics",
                stats = new
                {
                    totalUsers = adminStats?.TotalUsers ?? 0,
                    totalPatients = adminStats?.TotalPatients ?? 0,
                    totalDoctors = adminStats?.TotalDoctors ?? 0,
                    totalAdmins = adminStats?.TotalAdmins ?? 0,
                    activeUsersToday = adminStats?.ActiveUsersToday ?? 0,
                    newUsersThisWeek = adminStats?.NewUsersThisWeek ?? 0,
                    totalActivities = adminStats?.TotalActivities ?? 0
                },
                userGrowth = PrepareUserGrowthData(),
                activityBreakdown = PrepareActivityBreakdownData(),
                roleDistribution = PrepareRoleDistributionData()
            };

            await JS.InvokeVoidAsync("generateAnalyticsPdfReport", reportConfig);
            ToastService.ShowSuccess("PDF report generated successfully!");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"PDF export failed: {ex.Message}");
        }
    }

    private async Task ExportAnalyticsJson()
    {
        try
        {
            ToastService.ShowSuccess("Exporting analytics data...");
            var analyticsData = new
            {
                exportDate = DateTime.UtcNow,
                dateRange = new { from = fromDate, to = toDate },
                stats = new
                {
                    totalUsers = adminStats?.TotalUsers ?? 0,
                    totalPatients = adminStats?.TotalPatients ?? 0,
                    totalDoctors = adminStats?.TotalDoctors ?? 0,
                    totalAdmins = adminStats?.TotalAdmins ?? 0,
                    activeUsersToday = adminStats?.ActiveUsersToday ?? 0,
                    newUsersThisWeek = adminStats?.NewUsersThisWeek ?? 0,
                    totalActivities = adminStats?.TotalActivities ?? 0
                },
                userGrowth = PrepareUserGrowthData(),
                activityBreakdown = PrepareActivityBreakdownData(),
                roleDistribution = PrepareRoleDistributionData(),
                recentActivities = recentActivities?.Take(20).Select(a => new
                {
                    userEmail = a.UserEmail,
                    userName = a.UserName,
                    userRole = a.UserRole,
                    activityType = a.ActivityType,
                    description = a.Description,
                    timestamp = a.Timestamp,
                    ipAddress = a.IpAddress
                }).ToList()
            };

            var json = System.Text.Json.JsonSerializer.Serialize(analyticsData, new System.Text.Json.JsonSerializerOptions
            {
                WriteIndented = true,
                PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase
            });

            var filename = $"analytics-export-{DateTime.Now:yyyy-MM-dd-HHmmss}.json";
            await JS.InvokeVoidAsync("downloadFileContent", filename, json, "application/json");

            ToastService.ShowSuccess("Analytics data exported successfully!");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Export failed: {ex.Message}");
        }
    }

    private async Task ExportChartAsPng(string chartId, string filename)
    {
        try
        {
            await JS.InvokeVoidAsync("exportChartAsImage", chartId, filename);
            ToastService.ShowSuccess($"Chart exported successfully!");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Chart export failed: {ex.Message}");
        }
    }

    private async Task ExportAllChartsAsPng()
    {
        try
        {
            ToastService.ShowSuccess("Exporting all charts...");

            // Export all chart canvases
            var charts = new[]
            {
                ("userGrowthChart", "user-growth-chart.png"),
                ("activityBreakdownChart", "activity-breakdown-chart.png"),
                ("roleDistributionChart", "role-distribution-chart.png"),
                ("activityTimelineChart", "activity-timeline-chart.png"),
                ("activityDistributionChart", "activity-distribution-chart.png"),
                ("weeklyComparisonChart", "weekly-comparison-chart.png")
            };

            foreach (var (chartId, filename) in charts)
            {
                await ExportChartAsPng(chartId, filename);
                await Task.Delay(300); // Small delay between exports
            }

            ToastService.ShowSuccess("All charts exported successfully!");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Charts export failed: {ex.Message}");
        }
    }

    private async Task RenderHeatmap()
    {
        try
        {
            var heatmapData = PrepareHeatmapData();
            await JS.InvokeVoidAsync("renderActivityHeatmap", heatmapData);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rendering heatmap: {ex.Message}");
        }
    }

    private object PrepareHeatmapData()
    {
        if (allActivities == null) return new { days = Array.Empty<object>() };

        // Get last 84 days (12 weeks) for full width display
        var endDate = DateTime.UtcNow.Date;
        var startDate = endDate.AddDays(-83);

        // Group activities by date
        var activityByDate = allActivities
            .Where(a => a.Timestamp.Date >= startDate && a.Timestamp.Date <= endDate)
            .GroupBy(a => a.Timestamp.Date)
            .ToDictionary(g => g.Key, g => g.ToList());

        // Create array of days with activity counts
        var days = new List<object>();
        for (var date = startDate; date <= endDate; date = date.AddDays(1))
        {
            var count = activityByDate.ContainsKey(date) ? activityByDate[date].Count : 0;

            // Calculate intensity level (0-4)
            var level = count == 0 ? 0 :
                        count <= 3 ? 1 :
                        count <= 7 ? 2 :
                        count <= 15 ? 3 : 4;

            var topActivities = activityByDate.ContainsKey(date)
                ? activityByDate[date]
                    .GroupBy(a => a.ActivityType)
                    .OrderByDescending(g => g.Count())
                    .Take(3)
                    .Select(g => new { type = g.Key, count = g.Count() })
                    .Cast<object>()
                    .ToList()
                : new List<object>();

            days.Add(new
            {
                date = date.ToString("yyyy-MM-dd"),
                count = count,
                level = level,
                dayOfWeek = (int)date.DayOfWeek,
                topActivities = topActivities
            });
        }

        return new { days = days };
    }

    private double GetActivePercentage()
    {
        if (adminStats == null || adminStats.TotalUsers == 0) return 0;
        return Math.Round((double)adminStats.ActiveUsersToday / adminStats.TotalUsers * 100, 1);
    }

    private string GetActivityRate()
    {
        if (adminStats == null || adminStats.TotalActivities == 0) return "0";
        var days = (toDate - fromDate).Days;
        if (days == 0) days = 1;
        return Math.Round((double)adminStats.TotalActivities / days, 1).ToString();
    }

    private string GetActivityIconBg(string activityType)
    {
        return activityType switch
        {
            "Login" => "bg-green-100 dark:bg-green-900",
            "Register" => "bg-blue-100 dark:bg-blue-900",
            "ProfileUpdate" => "bg-yellow-100 dark:bg-yellow-900",
            "PasswordChange" => "bg-orange-100 dark:bg-orange-900",
            _ => "bg-gray-100 dark:bg-gray-700"
        };
    }

    private string GetActivityIconSvg(string activityType)
    {
        return activityType switch
        {
            "Login" => "<svg class=\"h-5 w-5 text-green-600 dark:text-green-400\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1\"/></svg>",
            "Register" => "<svg class=\"h-5 w-5 text-blue-600 dark:text-blue-400\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z\"/></svg>",
            "ProfileUpdate" => "<svg class=\"h-5 w-5 text-yellow-600 dark:text-yellow-400\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z\"/></svg>",
            _ => "<svg class=\"h-5 w-5 text-gray-600 dark:text-gray-400\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"/></svg>"
        };
    }

    private string GetActivityBadgeColor(string activityType)
    {
        return activityType switch
        {
            "Login" => "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200",
            "Register" => "bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200",
            "ProfileUpdate" => "bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200",
            "PasswordChange" => "bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200",
            _ => "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200"
        };
    }

    private string GetRelativeTime(DateTime timestamp)
    {
        var timeSpan = DateTime.UtcNow - timestamp;

        if (timeSpan.TotalMinutes < 1)
            return "Just now";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes}m ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours}h ago";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays}d ago";

        return timestamp.ToString("MMM dd, yyyy");
    }

    public void Dispose()
    {
        ThemeState.OnChange -= OnThemeChanged;
    }
}

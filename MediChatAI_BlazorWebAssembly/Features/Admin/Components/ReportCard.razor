@inject IJSRuntime JS
@inject IToastService ToastService

<div class="bg-gradient-to-br from-card/90 to-card/70 dark:from-gray-800/90 dark:to-gray-900/70 backdrop-blur-xl border border-gray-200/50 dark:border-gray-700/50 rounded-3xl shadow-2xl overflow-hidden @AdditionalClass">

    <!-- Card Header -->
    <div class="p-6 border-b border-gray-200/50 dark:border-gray-700/50 @HeaderGradientClass">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="p-3 @IconBgClass rounded-xl">
                    @((MarkupString)IconSvg)
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">@Title</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">@Description</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                @if (ShowBookmark)
                {
                    <button @onclick="ToggleBookmark" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" title="@(IsBookmarked ? "Remove bookmark" : "Add bookmark")">
                        <svg class="w-5 h-5 @(IsBookmarked ? "text-yellow-500 fill-current" : "text-gray-400")" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                        </svg>
                    </button>
                }
                @if (ShowShare)
                {
                    <button @onclick="ShareReport" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" title="Share report">
                        <svg class="w-5 h-5 text-gray-400 hover:text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                        </svg>
                    </button>
                }
                @if (ShowRefresh)
                {
                    <button @onclick="RefreshReport" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" title="Refresh data">
                        <svg class="w-5 h-5 text-gray-400 hover:text-primary @(IsRefreshing ? "animate-spin" : "")" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                    </button>
                }
            </div>
        </div>
    </div>

    <!-- Card Content -->
    <div class="p-6">
        @if (IsLoading)
        {
            <div class="flex justify-center items-center py-12">
                <div class="relative">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-primary"></div>
                    <div class="absolute inset-0 animate-ping rounded-full h-12 w-12 border border-primary opacity-20"></div>
                </div>
            </div>
        }
        else
        {
            @ChildContent
        }
    </div>

    <!-- Card Footer - Export Options -->
    @if (ShowExportOptions)
    {
        <div class="px-6 pb-6 pt-0">
            <div class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Export as:</span>
                    <button @onclick="() => ExportReport(ExportFormat.PDF)"
                            class="px-3 py-1.5 text-xs font-medium bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded-lg hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors flex items-center space-x-1">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"/>
                        </svg>
                        <span>PDF</span>
                    </button>
                    <button @onclick="() => ExportReport(ExportFormat.Excel)"
                            class="px-3 py-1.5 text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded-lg hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors flex items-center space-x-1">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 2a2 2 0 00-2 2v8a2 2 0 002 2h6a2 2 0 002-2V6.414A2 2 0 0016.414 5L14 2.586A2 2 0 0012.586 2H9z"/>
                        </svg>
                        <span>Excel</span>
                    </button>
                    <button @onclick="() => ExportReport(ExportFormat.CSV)"
                            class="px-3 py-1.5 text-xs font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors flex items-center space-x-1">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm3 1h6v4H7V5zm6 6H7v2h6v-2z" clip-rule="evenodd"/>
                        </svg>
                        <span>CSV</span>
                    </button>
                    <button @onclick="() => ExportReport(ExportFormat.PNG)"
                            class="px-3 py-1.5 text-xs font-medium bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 rounded-lg hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-colors flex items-center space-x-1">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                        </svg>
                        <span>PNG</span>
                    </button>
                </div>
                @if (!string.IsNullOrEmpty(LastUpdated))
                {
                    <span class="text-xs text-gray-500 dark:text-gray-400">Last updated: @LastUpdated</span>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public string Title { get; set; } = "Report";
    [Parameter] public string Description { get; set; } = "";
    [Parameter] public string IconSvg { get; set; } = "<svg class=\"w-6 h-6 text-primary\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z\"/></svg>";
    [Parameter] public string IconBgClass { get; set; } = "bg-primary/20";
    [Parameter] public string HeaderGradientClass { get; set; } = "bg-gradient-to-r from-blue-500/5 to-cyan-500/5";
    [Parameter] public string AdditionalClass { get; set; } = "";
    [Parameter] public bool ShowBookmark { get; set; } = true;
    [Parameter] public bool ShowShare { get; set; } = true;
    [Parameter] public bool ShowRefresh { get; set; } = true;
    [Parameter] public bool ShowExportOptions { get; set; } = true;
    [Parameter] public bool IsLoading { get; set; } = false;
    [Parameter] public bool IsBookmarked { get; set; } = false;
    [Parameter] public string LastUpdated { get; set; } = "";
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public EventCallback OnRefresh { get; set; }
    [Parameter] public EventCallback<bool> OnBookmarkToggle { get; set; }
    [Parameter] public EventCallback OnShare { get; set; }
    [Parameter] public EventCallback<ExportFormat> OnExport { get; set; }

    private bool IsRefreshing = false;

    public enum ExportFormat
    {
        PDF,
        Excel,
        CSV,
        PNG,
        JSON
    }

    private async Task ToggleBookmark()
    {
        IsBookmarked = !IsBookmarked;
        await OnBookmarkToggle.InvokeAsync(IsBookmarked);
        ToastService.ShowSuccess(IsBookmarked ? "Report bookmarked" : "Bookmark removed");
    }

    private async Task ShareReport()
    {
        await OnShare.InvokeAsync();
        ToastService.ShowInfo("Share options coming soon!");
    }

    private async Task RefreshReport()
    {
        IsRefreshing = true;
        StateHasChanged();
        await OnRefresh.InvokeAsync();
        await Task.Delay(500);
        IsRefreshing = false;
        StateHasChanged();
    }

    private async Task ExportReport(ExportFormat format)
    {
        ToastService.ShowInfo($"Exporting report as {format}...");
        await OnExport.InvokeAsync(format);

        try
        {
            var reportId = $"report-{Guid.NewGuid().ToString().Substring(0, 8)}";
            var filename = $"{Title.Replace(" ", "_")}_{DateTime.Now:yyyyMMdd}";

            switch (format)
            {
                case ExportFormat.PDF:
                    await JS.InvokeVoidAsync("exportReportAsPDF", reportId, $"{filename}.pdf");
                    break;
                case ExportFormat.PNG:
                    await JS.InvokeVoidAsync("exportReportSectionAsImage", reportId, $"{filename}.png");
                    break;
                case ExportFormat.CSV:
                    // Would need actual data here
                    ToastService.ShowInfo("CSV export will be available when connected to data source");
                    break;
                case ExportFormat.Excel:
                    ToastService.ShowInfo("Excel export will be available when connected to data source");
                    break;
                default:
                    ToastService.ShowWarning($"{format} export not yet implemented");
                    break;
            }

            if (format == ExportFormat.PDF || format == ExportFormat.PNG)
            {
                ToastService.ShowSuccess($"Report exported as {format} successfully!");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Export failed: {ex.Message}");
        }
    }
}

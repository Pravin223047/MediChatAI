@page "/doctor/ai-chatbot"
@using MediChatAI_BlazorWebAssembly.Core.Components.Guards
@using MediChatAI_BlazorWebAssembly.Core.Services.Theme
@using MediChatAI_BlazorWebAssembly.Features.Shared.AIChat.Components
@using MediChatAI_BlazorWebAssembly.Features.Shared.AIChat.Models
@using MediChatAI_BlazorWebAssembly.Features.Shared.AIChat.DTOs
@using MediChatAI_BlazorWebAssembly.Features.Shared.AIChat.Services
@using MediChatAI_BlazorWebAssembly.Features.Doctor.Services
@using MediChatAI_BlazorWebAssembly.Core.Components.UI
@using MediChatAI_BlazorWebAssembly.Core.Services.UI
@using Microsoft.AspNetCore.Components
@inject ThemeState ThemeState
@inject MediChatAI_BlazorWebAssembly.Features.Doctor.Services.IAIChatbotService ChatbotService
@inject IConversationStorageService StorageService
@inject ILogger<AIChatbot> Logger
@inject IToastService ToastService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>AI Clinical Assistant - MediChat AI</PageTitle>

<AuthorizeRouteGuard RequiredRole="Doctor">

<div class="min-h-screen @(IsDarkMode ? "bg-gray-900" : "bg-gradient-to-br from-gray-50 to-gray-100")">
    <div class="h-screen flex">
        <!-- Conversation History Sidebar -->
        <div class="@(showSidebar ? "w-80" : "w-0") transition-all duration-300 overflow-hidden">
            <ConversationHistorySidebar Conversations="@savedConversations"
                                        IsLoading="@isLoadingConversations"
                                        OnLoadConversation="@LoadConversation"
                                        OnDeleteConversation="@DeleteConversation"
                                        OnNewChat="@StartNewChat" />
        </div>

        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <header class="@(IsDarkMode ? "bg-gray-800/90 border-gray-700" : "bg-white/80 border-gray-200") backdrop-blur-md border-b px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button @onclick="@(() => showSidebar = !showSidebar)"
                                class="lg:hidden w-10 h-10 rounded-lg @(IsDarkMode ? "hover:bg-gray-700" : "hover:bg-gray-100") flex items-center justify-center transition-colors">
                            <i class="fas fa-bars @(IsDarkMode ? "text-gray-300" : "text-gray-700")"></i>
                        </button>

                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-teal-400 to-cyan-500 flex items-center justify-center shadow-lg">
                                <i class="fas fa-user-md text-white text-xl"></i>
                            </div>
                            <div>
                                <h1 class="text-xl font-bold @(IsDarkMode ? "text-white" : "text-gray-900")">
                                    AI Clinical Assistant
                                </h1>
                                <p class="text-sm @(IsDarkMode ? "text-gray-400" : "text-gray-600")">
                                    Clinical decision support & medical insights
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        @if (currentSession.Messages.Any() && !currentSession.IsSaved)
                        {
                            <button @onclick="@ShowSaveConversationDialog"
                                    class="px-4 py-2 rounded-lg @(IsDarkMode ? "bg-gray-700 hover:bg-gray-600 text-white" : "bg-gray-200 hover:bg-gray-300 text-gray-900") font-semibold text-sm transition-colors flex items-center gap-2">
                                <i class="fas fa-save"></i>
                                <span class="hidden sm:inline">Save</span>
                            </button>
                        }

                        @if (currentSession.Messages.Any())
                        {
                            <button @onclick="@ConfirmClearChat"
                                    class="px-4 py-2 rounded-lg @(IsDarkMode ? "bg-gray-700 hover:bg-gray-600 text-white" : "bg-gray-200 hover:bg-gray-300 text-gray-900") font-semibold text-sm transition-colors flex items-center gap-2">
                                <i class="fas fa-trash-alt"></i>
                                <span class="hidden sm:inline">Clear</span>
                            </button>
                        }
                    </div>
                </div>
            </header>

            <!-- Chat Messages Area -->
            <div class="flex-1 overflow-y-auto px-6 py-8" @ref="chatContainer">
                <div class="max-w-5xl mx-auto">
                    @if (!currentSession.Messages.Any())
                    {
                        <!-- Welcome Screen -->
                        <div class="text-center py-12">
                            <div class="w-24 h-24 rounded-full bg-gradient-to-br from-teal-400 to-cyan-500 flex items-center justify-center mx-auto mb-6 shadow-2xl">
                                <i class="fas fa-user-md text-white text-4xl"></i>
                            </div>
                            <h2 class="text-3xl font-bold @(IsDarkMode ? "text-white" : "text-gray-900") mb-4">
                                Welcome to AI Clinical Assistant
                            </h2>
                            <p class="text-lg @(IsDarkMode ? "text-gray-400" : "text-gray-600") mb-8 max-w-2xl mx-auto">
                                Evidence-based clinical decision support, differential diagnosis assistance, and the latest medical research insights at your fingertips.
                            </p>

                            <QuickActionButtons Actions="@quickActions" OnActionClick="@HandleQuickAction" />
                        </div>
                    }
                    else
                    {
                        @foreach (var message in currentSession.Messages)
                        {
                            <ChatMessageBubble Message="@message" OnSuggestedAction="@HandleSuggestedAction" OnViewImage="@ViewImage" />
                        }
                    }
                </div>
            </div>

            <!-- Image Analysis Panel -->
            @if (showImageAnalysis)
            {
                <div class="absolute bottom-24 right-6 w-full max-w-md z-10 animate-slide-up">
                    <ImageAnalysisPanel OnAnalyze="@HandleImageAnalysis" OnClose="@(() => showImageAnalysis = false)" />
                </div>
            }

            <!-- Input Area -->
            <div class="@(IsDarkMode ? "bg-gray-800/90 border-gray-700" : "bg-white/80 border-gray-200") backdrop-blur-md border-t px-6 py-4">
                <div class="max-w-5xl mx-auto">
                    <div class="flex items-end gap-3">
                        <div class="flex-1 relative">
                            <textarea @bind="userInput"
                                      @bind:event="oninput"
                                      @onkeydown="@HandleKeyPress"
                                      @onkeydown:preventDefault="@preventDefaultEnter"
                                      rows="1"
                                      placeholder="Ask about clinical guidelines, drug interactions, differential diagnosis..."
                                      class="w-full px-4 py-3 pr-12 rounded-xl @(IsDarkMode ? "bg-gray-700 text-white border-gray-600" : "bg-gray-50 text-gray-900 border-gray-300") border focus:ring-2 focus:ring-primary resize-none max-h-32 overflow-y-auto"
                                      style="min-height: 52px;"></textarea>
                        </div>

                        <div class="flex items-center gap-2">
                            <button @onclick="@(() => showImageAnalysis = !showImageAnalysis)"
                                    class="w-12 h-12 rounded-full @(showImageAnalysis ? "bg-gradient-to-br from-purple-500 to-pink-600" : $"{(IsDarkMode ? "bg-gray-700 hover:bg-gray-600" : "bg-gray-200 hover:bg-gray-300")}") flex items-center justify-center transition-all hover:scale-110 shadow-lg">
                                <i class="fas fa-image @(showImageAnalysis ? "text-white" : $"{(IsDarkMode ? "text-gray-200" : "text-gray-700")}")"></i>
                            </button>

                            <button @onclick="@(() => SendMessage(userInput))"
                                    disabled="@(string.IsNullOrWhiteSpace(userInput) || isSending)"
                                    class="w-12 h-12 rounded-full bg-gradient-to-br from-teal-500 to-cyan-600 text-white flex items-center justify-center transition-all hover:scale-110 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                                @if (isSending)
                                {
                                    <i class="fas fa-circle-notch fa-spin"></i>
                                }
                                else
                                {
                                    <i class="fas fa-paper-plane"></i>
                                }
                            </button>
                        </div>
                    </div>

                    <p class="text-xs @(IsDarkMode ? "text-gray-500" : "text-gray-500") mt-3 text-center">
                        <i class="fas fa-shield-alt mr-1"></i>
                        AI provides evidence-based insights. Always use clinical judgment and verify information.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals and Dialogs -->
<SaveConversationModal IsOpen="@showSaveModal"
                       SessionId="@currentSession.Id"
                       OnSave="@HandleSaveConversation"
                       OnCancel="@(() => showSaveModal = false)" />

<ConfirmationDialog IsOpen="@showClearChatDialog"
                    Title="Clear Chat?"
                    Message="This will permanently delete all messages in the current conversation. This action cannot be undone."
                    ConfirmText="Clear Chat"
                    CancelText="Cancel"
                    Type="ConfirmationDialogType.Danger"
                    OnConfirm="@HandleClearChatConfirm"
                    OnCancel="@(() => showClearChatDialog = false)" />

<ConfirmationDialog IsOpen="@showNewChatDialog"
                    Title="Start New Chat?"
                    Message="You have unsaved changes in the current conversation. Starting a new chat will lose these changes."
                    ConfirmText="Start New Chat"
                    CancelText="Cancel"
                    Type="ConfirmationDialogType.Warning"
                    OnConfirm="@HandleNewChatConfirm"
                    OnCancel="@(() => showNewChatDialog = false)" />

<ConfirmationDialog IsOpen="@showDeleteConversationDialog"
                    Title="Delete Conversation?"
                    Message="This will permanently delete this saved conversation. This action cannot be undone."
                    ConfirmText="Delete"
                    CancelText="Cancel"
                    Type="ConfirmationDialogType.Danger"
                    OnConfirm="@HandleDeleteConversationConfirm"
                    OnCancel="@(() => showDeleteConversationDialog = false)" />

<ImageViewerModal IsOpen="@showImageViewer"
                  ImageUrl="@selectedImageUrl"
                  AltText="@selectedImageAlt"
                  OnClose="@(() => showImageViewer = false)" />

</AuthorizeRouteGuard>

@code {
    private ElementReference chatContainer;
    private ChatSession currentSession = new();
    private List<SavedConversationDto> savedConversations = new();
    private List<string> quickActions = new();

    private string userInput = string.Empty;
    private bool showSidebar = true;
    private bool showImageAnalysis = false;
    private bool isSending = false;
    private bool isLoadingConversations = false;
    private bool preventDefaultEnter = false;

    // Modal states
    private bool showSaveModal = false;
    private bool showClearChatDialog = false;
    private bool showNewChatDialog = false;
    private bool showDeleteConversationDialog = false;
    private bool showImageViewer = false;
    private string selectedImageUrl = string.Empty;
    private string selectedImageAlt = string.Empty;
    private string conversationToDelete = string.Empty;

    private bool IsDarkMode => ThemeState.CurrentTheme.Mode == "dark";

    protected override async Task OnInitializedAsync()
    {
        ThemeState.OnChange += OnThemeChanged;
        quickActions = await ChatbotService.GetQuickActionsAsync();

        var savedSession = await StorageService.GetCurrentSessionAsync();
        if (savedSession != null)
        {
            currentSession = savedSession;
        }

        await LoadConversationHistory();
    }

    private void OnThemeChanged() => InvokeAsync(StateHasChanged);

    private async Task LoadConversationHistory()
    {
        isLoadingConversations = true;
        savedConversations = await ChatbotService.GetConversationHistoryAsync();
        isLoadingConversations = false;
    }

    private async Task SendMessage(string message)
    {
        if (string.IsNullOrWhiteSpace(message)) return;

        isSending = true;

        var userMessage = new ChatMessage
        {
            Content = message,
            Role = "user",
            Timestamp = DateTime.UtcNow
        };
        currentSession.Messages.Add(userMessage);
        userInput = string.Empty;

        var loadingMessage = new ChatMessage { Role = "assistant", IsLoading = true };
        currentSession.Messages.Add(loadingMessage);
        StateHasChanged();
        await ScrollToBottom();

        var response = await ChatbotService.SendMessageAsync(message, currentSession.Id);

        currentSession.Messages.Remove(loadingMessage);

        if (response != null)
        {
            currentSession.Messages.Add(response);
            currentSession.LastMessageAt = DateTime.UtcNow;
        }

        await StorageService.SaveCurrentSessionAsync(currentSession);
        isSending = false;
        StateHasChanged();
        await ScrollToBottom();
    }

    private async Task HandleImageAnalysis(ImageAnalysisRequest request)
    {
        showImageAnalysis = false;
        isSending = true;

        var userMessage = new ChatMessage
        {
            Content = $"Analyze this medical image: {request.Context}",
            Role = "user",
            Timestamp = DateTime.UtcNow,
            Type = MessageType.ImageAnalysis,
            Attachments = new List<ChatAttachment>
            {
                new ChatAttachment { Url = request.ImageUrl, FileType = "image/*" }
            }
        };
        currentSession.Messages.Add(userMessage);

        var loadingMessage = new ChatMessage { Role = "assistant", IsLoading = true };
        currentSession.Messages.Add(loadingMessage);
        StateHasChanged();
        await ScrollToBottom();

        var response = await ChatbotService.SendMessageWithImageAsync(request.Context ?? "", request.ImageUrl, currentSession.Id);

        currentSession.Messages.Remove(loadingMessage);

        if (response != null)
        {
            currentSession.Messages.Add(response);
        }

        await StorageService.SaveCurrentSessionAsync(currentSession);
        isSending = false;
        StateHasChanged();
        await ScrollToBottom();
    }

    private async Task HandleQuickAction(string action) => await SendMessage($"Help with: {action}");
    private async Task HandleSuggestedAction(string action) => await SendMessage(action);

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        preventDefaultEnter = (e.Key == "Enter" && !e.ShiftKey);

        if (preventDefaultEnter)
        {
            await SendMessage(userInput);
        }
    }

    private async Task StartNewChat()
    {
        // Check for unsaved changes
        if (currentSession.Messages.Any() && !currentSession.IsSaved)
        {
            showNewChatDialog = true;
            return;
        }

        await HandleNewChatConfirm();
    }

    private async Task HandleNewChatConfirm()
    {
        showNewChatDialog = false;
        currentSession = new ChatSession();
        await StorageService.ClearCurrentSessionAsync();
        showSidebar = false;
        StateHasChanged();
    }

    private async Task LoadConversation(string conversationId)
    {
        try
        {
            var messageDtos = await ChatbotService.LoadConversationAsync(conversationId);

            if (messageDtos != null && messageDtos.Any())
            {
                currentSession = new ChatSession
                {
                    Id = conversationId,
                    IsSaved = true,
                    Messages = messageDtos.Select(MapDtoToChatMessage).ToList(),
                    LastMessageAt = messageDtos.Max(m => m.Timestamp)
                };

                await StorageService.SaveCurrentSessionAsync(currentSession);
                showSidebar = false;
                StateHasChanged();
                await ScrollToBottom();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading conversation {ConversationId}", conversationId);
            ToastService.ShowError("Failed to load conversation");
        }
    }

    private void DeleteConversation(string conversationId)
    {
        conversationToDelete = conversationId;
        showDeleteConversationDialog = true;
    }

    private async Task HandleDeleteConversationConfirm()
    {
        showDeleteConversationDialog = false;

        try
        {
            var success = await ChatbotService.DeleteConversationAsync(conversationToDelete);

            if (success)
            {
                ToastService.ShowSuccess("Conversation deleted successfully");
                await LoadConversationHistory();

                // If the deleted conversation is currently open, clear it
                if (currentSession.Id == conversationToDelete)
                {
                    currentSession = new ChatSession();
                    await StorageService.ClearCurrentSessionAsync();
                    StateHasChanged();
                }
            }
            else
            {
                ToastService.ShowError("Failed to delete conversation");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting conversation {ConversationId}", conversationToDelete);
            ToastService.ShowError("An error occurred while deleting the conversation");
        }
        finally
        {
            conversationToDelete = string.Empty;
        }
    }

    private void ShowSaveConversationDialog()
    {
        showSaveModal = true;
    }

    private async Task HandleSaveConversation((string title, string summary) data)
    {
        showSaveModal = false;

        try
        {
            var success = await ChatbotService.SaveConversationAsync(currentSession.Id, data.title, data.summary);

            if (success)
            {
                currentSession.IsSaved = true;
                ToastService.ShowSuccess("Conversation saved successfully!");
                await LoadConversationHistory();
                StateHasChanged();
            }
            else
            {
                ToastService.ShowError("Failed to save conversation");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving conversation");
            ToastService.ShowError("An error occurred while saving the conversation");
        }
    }

    private void ConfirmClearChat()
    {
        showClearChatDialog = true;
    }

    private async Task HandleClearChatConfirm()
    {
        showClearChatDialog = false;
        currentSession = new ChatSession();
        await StorageService.ClearCurrentSessionAsync();
        ToastService.ShowInfo("Chat cleared");
        StateHasChanged();
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await Task.Delay(100);
            await JS.InvokeVoidAsync("scrollHelper.scrollToBottom", chatContainer);
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Could not scroll to bottom");
        }
    }

    private void ViewImage(string imageUrl, string altText = "")
    {
        selectedImageUrl = imageUrl;
        selectedImageAlt = altText;
        showImageViewer = true;
    }

    // Helper method to map DTOs to domain models
    private ChatMessage MapDtoToChatMessage(MediChatAI_BlazorWebAssembly.Features.Shared.AIChat.DTOs.ChatMessageDto dto)
    {
        return new ChatMessage
        {
            Id = dto.Id,
            Content = dto.Content,
            Role = dto.Role,
            Timestamp = dto.Timestamp,
            Type = ParseMessageType(dto.MessageType),
            Attachments = dto.Attachments?.Select(a => new ChatAttachment
            {
                Url = a.Url,
                FileName = a.FileName,
                FileType = a.FileType,
                FileSize = 0
            }).ToList(),
            Metadata = dto.Metadata != null ? new ChatMessageMetadata
            {
                SymptomAnalysis = dto.Metadata.SymptomAnalysis != null ? MapSymptomAnalysisDtoToModel(dto.Metadata.SymptomAnalysis) : null,
                ImageAnalysis = dto.Metadata.ImageAnalysis != null ? MapImageAnalysisDtoToModel(dto.Metadata.ImageAnalysis) : null,
                SuggestedActions = dto.Metadata.SuggestedActions
            } : null
        };
    }

    private SymptomAnalysisResult MapSymptomAnalysisDtoToModel(SymptomAnalysisDto dto)
    {
        return new SymptomAnalysisResult
        {
            Id = dto.Id,
            Symptoms = dto.Symptoms,
            UrgencyLevel = dto.UrgencyLevel,
            UrgencyMessage = dto.UrgencyMessage,
            RecommendedActions = dto.RecommendedActions,
            PossibleConditions = dto.PossibleConditions.Select(c => new PossibleCondition
            {
                Name = c.Name,
                Description = c.Description,
                Probability = c.Probability,
                Severity = c.Severity
            }).ToList()
        };
    }

    private ImageAnalysisResult MapImageAnalysisDtoToModel(ImageAnalysisDto dto)
    {
        return new ImageAnalysisResult
        {
            Id = dto.Id,
            ImageUrl = dto.ImageUrl,
            Analysis = dto.Analysis,
            Confidence = dto.Confidence,
            Recommendations = dto.Recommendations,
            Findings = dto.Findings.Select(f => new Finding
            {
                Category = f.Category,
                Description = f.Description,
                Severity = f.Severity,
                Confidence = f.Confidence
            }).ToList(),
            Disclaimer = "This is an AI-generated analysis for educational purposes only. Consult a healthcare professional for accurate diagnosis."
        };
    }

    private MessageType ParseMessageType(string? messageType)
    {
        return messageType?.ToLower() switch
        {
            "text" => MessageType.Text,
            "symptomanalysis" => MessageType.SymptomAnalysis,
            "imageanalysis" => MessageType.ImageAnalysis,
            _ => MessageType.Text
        };
    }

    public void Dispose() => ThemeState.OnChange -= OnThemeChanged;
}

<style>
    @@keyframes slide-up {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-slide-up {
        animation: slide-up 0.3s ease-out;
    }
</style>

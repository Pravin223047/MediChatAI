@page "/doctor/appointments"
@using MediChatAI_BlazorWebAssembly.Features.Doctor.Models
@using MediChatAI_BlazorWebAssembly.Features.Doctor.Services
@using MediChatAI_BlazorWebAssembly.Features.Doctor.Components
@inject IAppointmentService AppointmentService
@inject IToastService ToastService
@inject NavigationManager Navigation
@inject AppSettingsState AppSettings

<PageTitle>Appointments - @AppSettings.Settings.SiteName</PageTitle>

<AuthorizeRouteGuard RequiredRole="Doctor">

<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Header -->
    <div class="bg-white dark:bg-gray-800 shadow-md border-b border-gray-200 dark:border-gray-700">
        <div class="px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="flex items-center space-x-4 mb-4 md:mb-0">
                    <div class="p-3 bg-gradient-to-r from-primary to-accent rounded-xl">
                        <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Appointments</h1>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                            @GetDateRangeText()
                        </p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <!-- Tab Selector -->
                    <div class="flex items-center bg-gray-100 dark:bg-gray-700 rounded-lg p-1 mr-3">
                        <button class="px-4 py-2 rounded-md text-sm font-semibold transition-all @(activeTab == "appointments" ? "bg-white dark:bg-gray-600 text-primary shadow-sm" : "text-gray-600 dark:text-gray-400")"
                                @onclick='() => SwitchTab("appointments")'>
                            <svg class="w-4 h-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            Appointments
                        </button>
                        <button class="px-4 py-2 rounded-md text-sm font-semibold transition-all @(activeTab == "requests" ? "bg-white dark:bg-gray-600 text-primary shadow-sm" : "text-gray-600 dark:text-gray-400")"
                                @onclick='() => SwitchTab("requests")'>
                            <svg class="w-4 h-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                            </svg>
                            Pending Requests
                            @if (pendingRequests.Any())
                            {
                                <span class="ml-1 px-2 py-0.5 bg-red-500 text-white rounded-full text-xs">@pendingRequests.Count</span>
                            }
                        </button>
                    </div>

                    @if (activeTab == "appointments")
                    {
                        <!-- View Mode Selector -->
                        <div class="flex items-center bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                            <button class="px-4 py-2 rounded-md text-sm font-semibold transition-all @(viewMode == AppointmentViewMode.Month ? "bg-white dark:bg-gray-600 text-primary shadow-sm" : "text-gray-600 dark:text-gray-400")"
                                    @onclick="() => SetViewMode(AppointmentViewMode.Month)">
                                <svg class="w-4 h-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                Month
                            </button>
                            <button class="px-4 py-2 rounded-md text-sm font-semibold transition-all @(viewMode == AppointmentViewMode.Week ? "bg-white dark:bg-gray-600 text-primary shadow-sm" : "text-gray-600 dark:text-gray-400")"
                                    @onclick="() => SetViewMode(AppointmentViewMode.Week)">
                                <svg class="w-4 h-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                </svg>
                                Week
                            </button>
                            <button class="px-4 py-2 rounded-md text-sm font-semibold transition-all @(viewMode == AppointmentViewMode.Day ? "bg-white dark:bg-gray-600 text-primary shadow-sm" : "text-gray-600 dark:text-gray-400")"
                                    @onclick="() => SetViewMode(AppointmentViewMode.Day)">
                                <svg class="w-4 h-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Day
                            </button>
                        </div>
                        <button class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-primary to-accent text-white rounded-xl hover:shadow-lg transition-all font-semibold"
                                @onclick="ShowNewAppointmentModal">
                            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            New Appointment
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="px-4 sm:px-6 lg:px-8 py-6">
        <!-- Pending Requests View -->
        @if (activeTab == "requests")
        {
            @if (isLoading)
            {
                <div class="flex items-center justify-center py-20">
                    <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-200 border-t-blue-600"></div>
                </div>
            }
            else if (pendingRequests == null || pendingRequests.Count == 0)
            {
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-12 text-center">
                    <svg class="w-24 h-24 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h3 class="text-2xl font-bold text-gray-600 dark:text-gray-400">No Pending Requests</h3>
                    <p class="text-gray-500 dark:text-gray-500 mt-2">All appointment requests have been reviewed</p>
                </div>
            }
            else
            {
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    @foreach (var request in pendingRequests.OrderByDescending(r => r.IsUrgent).ThenBy(r => r.RequestedAt))
                    {
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 hover:shadow-xl transition-all cursor-pointer border-2 @(request.IsUrgent ? "border-red-500" : "border-gray-200 dark:border-gray-700")"
                             @onclick="() => ShowRequestDetails(request)">
                            @if (request.IsUrgent)
                            {
                                <div class="mb-4">
                                    <span class="px-3 py-1 bg-red-500 text-white rounded-full text-xs font-bold">ðŸš¨ URGENT</span>
                                </div>
                            }
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-start space-x-4">
                                    <div class="p-3 bg-gradient-to-r from-primary to-accent rounded-xl">
                                        <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">@request.FullName</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">@request.Age years, @request.Gender</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">@request.PhoneNumber</p>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-2 mb-4">
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 text-gray-500 mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    <div class="flex-1">
                                        <p class="text-sm font-semibold text-gray-700 dark:text-gray-300">Reason:</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">@request.ReasonForVisit</p>
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 text-gray-500 mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <div class="flex-1">
                                        <p class="text-sm text-gray-600 dark:text-gray-400">
                                            Requested: @request.RequestedAt.ToString("MMM dd, yyyy")
                                            @if (request.PreferredDate.HasValue)
                                            {
                                                <span class="ml-2">Preferred: @request.PreferredDate.Value.ToString("MMM dd, yyyy")</span>
                                            }
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="pt-4 border-t border-gray-200 dark:border-gray-700 space-y-2">
                                <button class="w-full px-4 py-2 bg-gradient-to-r from-primary to-accent text-white rounded-lg hover:shadow-lg transition-all font-semibold"
                                        @onclick:stopPropagation="true"
                                        @onclick="() => ShowRequestDetails(request)">
                                    Review Request â†’
                                </button>
                                <button class="w-full px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold flex items-center justify-center gap-2"
                                        @onclick:stopPropagation="true"
                                        @onclick="() => ChatWithPatient(request.PatientId)"
                                        title="Chat with @request.FullName">
                                    <i class="fas fa-comment-medical"></i>
                                    <span>Chat with Patient</span>
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
        }

        <!-- Stats Cards -->
        @if (activeTab == "appointments" && statistics != null)
        {
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm font-medium">Today's Appointments</p>
                            <p class="text-3xl font-bold mt-1">@statistics.TodayAppointments</p>
                        </div>
                        <div class="p-3 bg-white bg-opacity-20 rounded-lg">
                            <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-sm font-medium">This Week</p>
                            <p class="text-3xl font-bold mt-1">@statistics.WeekAppointments</p>
                        </div>
                        <div class="p-3 bg-white bg-opacity-20 rounded-lg">
                            <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-6 text-white shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-100 text-sm font-medium">Completion Rate</p>
                            <p class="text-3xl font-bold mt-1">@statistics.CompletionRate.ToString("F1")%</p>
                        </div>
                        <div class="p-3 bg-white bg-opacity-20 rounded-lg">
                            <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-6 text-white shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-orange-100 text-sm font-medium">This Month</p>
                            <p class="text-3xl font-bold mt-1">@statistics.MonthAppointments</p>
                        </div>
                        <div class="p-3 bg-white bg-opacity-20 rounded-lg">
                            <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Navigation Controls -->
        @if (activeTab == "appointments")
        {
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 mb-6">
                <div class="flex items-center justify-between">
                <button class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-all font-semibold"
                        @onclick="NavigatePrevious">
                    <svg class="w-5 h-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    Previous
                </button>

                <div class="text-center">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">@GetCurrentViewTitle()</h2>
                    <button class="text-sm text-primary hover:text-blue-700 font-medium mt-1" @onclick="GoToToday">
                        Go to Today
                    </button>
                </div>

                <button class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-all font-semibold"
                        @onclick="NavigateNext">
                    Next
                    <svg class="w-5 h-5 inline ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
            </div>

            <!-- Calendar Views -->
            @if (isLoading)
            {
                <div class="flex items-center justify-center py-20">
                <div class="relative mb-6">
                    <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-200 border-t-blue-600 mx-auto"></div>
                    <div class="absolute inset-0 animate-ping rounded-full h-16 w-16 border border-blue-400 opacity-20 mx-auto"></div>
                </div>
            </div>
        }
        else
        {
            @if (viewMode == AppointmentViewMode.Month)
            {
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden">
                    <!-- Month Calendar -->
                    @if (calendarView != null)
                    {
                        <!-- Day Headers -->
                        <div class="grid grid-cols-7 bg-gray-100 dark:bg-gray-700 border-b-2 border-gray-200 dark:border-gray-600">
                            @foreach (var day in new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" })
                            {
                                <div class="py-3 text-center text-sm font-bold text-gray-700 dark:text-gray-300">@day</div>
                            }
                        </div>

                        <!-- Calendar Grid -->
                        <div class="grid grid-cols-7">
                            @foreach (var day in calendarView.Days)
                            {
                                <div class="border border-gray-200 dark:border-gray-700 min-h-[120px] p-2 @(day.IsToday ? "bg-blue-50 dark:bg-blue-900 dark:bg-opacity-20" : "") @(!day.IsCurrentMonth ? "bg-gray-50 dark:bg-gray-900" : "bg-white dark:bg-gray-800") hover:bg-gray-50 dark:hover:bg-gray-700 transition-all cursor-pointer group"
                                     @onclick="() => SelectDate(day.Date)">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-semibold @(day.IsToday ? "text-primary dark:text-primary" : "") @(!day.IsCurrentMonth ? "text-gray-400 dark:text-gray-600" : "text-gray-900 dark:text-white") @(day.IsPast && day.IsCurrentMonth ? "text-gray-500 dark:text-gray-500" : "")">
                                            @day.Date.Day
                                        </span>
                                        @if (day.AppointmentCount > 0)
                                        {
                                            <span class="text-xs px-2 py-0.5 bg-primary text-white rounded-full font-semibold">
                                                @day.AppointmentCount
                                            </span>
                                        }
                                    </div>

                                    @if (calendarView.AppointmentsByDate.ContainsKey(day.Date))
                                    {
                                        <div class="space-y-1">
                                            @foreach (var apt in calendarView.AppointmentsByDate[day.Date].Take(3))
                                            {
                                                <div class="text-xs px-2 py-1 rounded @GetAppointmentTypeClass(apt.Type) truncate group-hover:shadow-sm transition-all"
                                                     @onclick:stopPropagation="true"
                                                     @onclick="() => ViewAppointmentDetails(apt.AppointmentId)">
                                                    <span class="font-semibold">@FormatTime(apt.StartTime)</span>
                                                    <span class="ml-1">@apt.PatientName</span>
                                                </div>
                                            }
                                            @if (calendarView.AppointmentsByDate[day.Date].Count > 3)
                                            {
                                                <div class="text-xs text-primary dark:text-primary font-semibold text-center">
                                                    +@(calendarView.AppointmentsByDate[day.Date].Count - 3) more
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            }
            else if (viewMode == AppointmentViewMode.Week && weekSchedule != null)
            {
                <!-- Week View -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden">
                    <div class="grid grid-cols-8 border-b-2 border-gray-200 dark:border-gray-600">
                        <div class="py-3 px-2 bg-gray-100 dark:bg-gray-700"></div>
                        @foreach (var daySchedule in weekSchedule.Days)
                        {
                            <div class="py-3 px-2 text-center bg-gray-100 dark:bg-gray-700 @(daySchedule.Date.Date == DateTime.Now.Date ? "bg-blue-100 dark:bg-blue-900" : "")">
                                <div class="text-xs font-medium text-gray-600 dark:text-gray-400">@daySchedule.Date.ToString("ddd")</div>
                                <div class="text-lg font-bold text-gray-900 dark:text-white mt-1">@daySchedule.Date.Day</div>
                                @if (daySchedule.TotalAppointments > 0)
                                {
                                    <div class="text-xs text-primary dark:text-primary font-semibold mt-1">@daySchedule.TotalAppointments apt</div>
                                }
                            </div>
                        }
                    </div>

                    <!-- Time Slots -->
                    <div class="max-h-[600px] overflow-y-auto">
                        @for (int hour = 9; hour < 18; hour++)
                        {
                            <div class="grid grid-cols-8 border-b border-gray-200 dark:border-gray-700">
                                <div class="py-4 px-2 text-sm font-semibold text-gray-600 dark:text-gray-400 text-right bg-gray-50 dark:bg-gray-900">
                                    @($"{hour:D2}:00")
                                </div>
                                @foreach (var daySchedule in weekSchedule.Days)
                                {
                                    var timeSlot = new TimeSpan(hour, 0, 0);
                                    var appointmentsAtTime = daySchedule.Appointments.Where(a => a.StartTime.Hours == hour).ToList();

                                    <div class="p-1 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all min-h-[60px] @(daySchedule.Date.Date == DateTime.Now.Date ? "bg-blue-50 dark:bg-blue-900 dark:bg-opacity-10" : "")">
                                        @foreach (var apt in appointmentsAtTime)
                                        {
                                            <div class="mb-1 p-2 rounded-lg cursor-pointer hover:shadow-md transition-all @GetAppointmentStatusColorClass(apt.Status)"
                                                 @onclick="() => ViewAppointmentDetails(apt.AppointmentId)">
                                                <div class="text-xs font-bold">@FormatTime(apt.StartTime) - @FormatTime(apt.EndTime)</div>
                                                <div class="text-xs font-semibold mt-1">@apt.PatientName</div>
                                                <div class="text-xs text-gray-600 dark:text-gray-400">@apt.Type</div>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
            else if (viewMode == AppointmentViewMode.Day && daySchedule != null)
            {
                <!-- Day View -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Main Schedule -->
                    <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-primary to-accent px-6 py-4">
                            <h3 class="text-xl font-bold text-white">Daily Schedule</h3>
                            <p class="text-blue-100 text-sm">@daySchedule.TotalAppointments appointments scheduled</p>
                        </div>

                        <div class="max-h-[700px] overflow-y-auto p-6">
                            @if (daySchedule.Appointments.Any())
                            {
                                <div class="space-y-4">
                                    @foreach (var apt in daySchedule.Appointments.OrderBy(a => a.StartTime))
                                    {
                                        <!-- Modern Appointment Card with Glass-morphism -->
                                        <div class="group relative overflow-hidden rounded-2xl @GetCardBorderClass(apt.Type, apt.Status)
                                                    bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm hover:shadow-2xl hover:scale-[1.01]
                                                    transition-all duration-300 cursor-pointer"
                                             @onclick="() => ViewAppointmentDetails(apt.AppointmentId)">

                                            <!-- Accent Bar on Left -->
                                            <div class="absolute left-0 top-0 bottom-0 w-2 @GetAccentGradient(apt.Type) @GetPulseClass(apt.Status)"></div>

                                            <div class="p-5 flex items-start gap-5">
                                                <!-- Time Display Section (Large & Prominent) -->
                                                <div class="flex flex-col items-center justify-center px-6 py-4 rounded-2xl @GetTimeBackgroundGradient(apt.Status) shadow-lg min-w-[140px]">
                                                    <div class="flex items-baseline gap-1">
                                                        <span class="text-4xl font-bold text-white">@FormatTime12Hour(apt.StartTime)</span>
                                                    </div>
                                                    <div class="h-px w-12 bg-white/40 my-2"></div>
                                                    <span class="text-sm text-white/90 font-medium">@apt.DurationMinutes min</span>

                                                    <!-- Duration Progress Bar -->
                                                    <div class="w-full h-1.5 bg-white/20 rounded-full mt-3">
                                                        <div class="h-full bg-white/80 rounded-full" style="width: @GetTimeProgressWidth(apt)%"></div>
                                                    </div>

                                                    @if (apt.IsVirtual)
                                                    {
                                                        <div class="mt-3 px-2 py-1 bg-white/20 rounded-full flex items-center gap-1">
                                                            <svg class="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                                            </svg>
                                                            <span class="text-xs text-white font-semibold">Virtual</span>
                                                        </div>
                                                    }
                                                </div>

                                                <!-- Patient Info Section -->
                                                <div class="flex-1 min-w-0">
                                                    <div class="flex items-start gap-4">
                                                        <!-- Patient Avatar with Initials -->
                                                        <div class="relative flex-shrink-0">
                                                            <div class="w-16 h-16 rounded-2xl @GetAvatarGradient(apt.Type) flex items-center justify-center shadow-lg">
                                                                <span class="text-white text-2xl font-bold">@GetInitials(apt.PatientName)</span>
                                                            </div>
                                                            <!-- Status Dot -->
                                                            <div class="absolute -bottom-1 -right-1 w-5 h-5 @GetStatusDotColor(apt.Status) rounded-full border-2 border-white dark:border-gray-800 @GetStatusPulse(apt.Status)"></div>
                                                        </div>

                                                        <!-- Patient Details -->
                                                        <div class="flex-1 min-w-0">
                                                            <h4 class="text-2xl font-bold text-gray-900 dark:text-white mb-2 truncate">@apt.PatientName</h4>

                                                            <!-- Badges Row -->
                                                            <div class="flex flex-wrap items-center gap-2 mb-3">
                                                                <span class="inline-flex items-center px-3 py-1 bg-gradient-to-r from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-600 text-gray-700 dark:text-gray-300 rounded-lg text-xs font-mono font-bold shadow-sm">
                                                                    <svg class="w-3 h-3 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/>
                                                                    </svg>
                                                                    @apt.AppointmentId
                                                                </span>
                                                                <span class="inline-flex items-center px-3 py-1.5 @GetTypeBadgeGradient(apt.Type) rounded-lg text-xs font-bold shadow-md">
                                                                    @GetTypeIcon(apt.Type)
                                                                    @apt.Type
                                                                </span>
                                                                <span class="inline-flex items-center px-3 py-1.5 @GetStatusBadgeGradient(apt.Status) rounded-lg text-xs font-bold shadow-md @GetStatusPulse(apt.Status)">
                                                                    @GetStatusIcon(apt.Status)
                                                                    @apt.Status
                                                                </span>
                                                            </div>

                                                            <!-- Contact Info & Details Grid -->
                                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm mb-3">
                                                                <div class="flex items-center gap-2 text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700/50 px-3 py-2 rounded-lg">
                                                                    <svg class="w-4 h-4 text-primary flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                                    </svg>
                                                                    <span class="font-semibold truncate">@FormatTimeWithPeriod(apt.StartTime) - @FormatTimeWithPeriod(apt.EndTime)</span>
                                                                </div>
                                                                <div class="flex items-center gap-2 text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700/50 px-3 py-2 rounded-lg">
                                                                    <svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                                                    </svg>
                                                                    <span class="font-medium truncate">@apt.PatientPhone</span>
                                                                </div>
                                                            </div>

                                                            @if (!string.IsNullOrEmpty(apt.Reason))
                                                            {
                                                                <div class="flex items-start gap-2 p-3 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl border border-blue-100 dark:border-blue-800/30">
                                                                    <svg class="w-4 h-4 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                                    </svg>
                                                                    <div class="flex-1 min-w-0">
                                                                        <span class="text-xs font-bold text-blue-700 dark:text-blue-300 uppercase tracking-wide">Reason</span>
                                                                        <p class="text-sm text-gray-700 dark:text-gray-300 mt-0.5 line-clamp-2">@apt.Reason</p>
                                                                    </div>
                                                                </div>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Action Buttons Section (HORIZONTAL Layout) -->
                                                <div class="flex flex-col justify-center gap-2 ml-4">
                                                    <div class="flex flex-wrap gap-2">
                                                        <!-- Details Button -->
                                                        <button class="inline-flex items-center gap-2 px-4 py-2.5 bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white rounded-xl text-sm font-bold shadow-lg hover:shadow-xl hover:scale-105 transition-all"
                                                                @onclick:stopPropagation="true"
                                                                @onclick="() => ViewAppointmentDetails(apt.AppointmentId)">
                                                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                            </svg>
                                                            <span>Details</span>
                                                        </button>

                                                        @if (apt.Status == "Scheduled" || apt.Status == "Confirmed")
                                                        {
                                                            <!-- Start Consultation Button -->
                                                            <button class="inline-flex items-center gap-2 px-4 py-2.5 bg-gradient-to-r from-primary to-accent hover:from-accent hover:to-primary text-white rounded-xl text-sm font-bold shadow-lg hover:shadow-xl hover:scale-105 transition-all"
                                                                    @onclick:stopPropagation="true"
                                                                    @onclick="() => StartConsultation(apt.AppointmentId)">
                                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                                                </svg>
                                                                <span>Start</span>
                                                            </button>
                                                        }

                                                        <!-- Chat Button -->
                                                        <button class="inline-flex items-center gap-2 px-4 py-2.5 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white rounded-xl text-sm font-bold shadow-lg hover:shadow-xl hover:scale-105 transition-all"
                                                                @onclick:stopPropagation="true"
                                                                @onclick="() => ChatWithPatient(apt.PatientId)"
                                                                title="Chat with @apt.PatientName">
                                                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                                            </svg>
                                                            <span>Chat</span>
                                                        </button>
                                                    </div>

                                                    @if (apt.Status == "Scheduled" || apt.Status == "Confirmed")
                                                    {
                                                        <div class="flex gap-2">
                                                            <!-- Complete Button -->
                                                            <button class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-green-500 hover:bg-green-600 text-white rounded-lg text-xs font-semibold shadow hover:shadow-md transition-all"
                                                                    @onclick:stopPropagation="true"
                                                                    @onclick="() => MarkAsCompleted(apt.AppointmentId)">
                                                                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                                </svg>
                                                                <span>Complete</span>
                                                            </button>

                                                            <!-- Cancel Button -->
                                                            <button class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white rounded-lg text-xs font-semibold shadow hover:shadow-md transition-all"
                                                                    @onclick:stopPropagation="true"
                                                                    @onclick="() => CancelAppointment(apt.AppointmentId)">
                                                                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                                </svg>
                                                                <span>Cancel</span>
                                                            </button>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-12">
                                    <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                    <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-400">No appointments today</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-500 mt-2">Your schedule is clear for this day</p>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Sidebar - Available Slots -->
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-green-500 to-emerald-600 px-6 py-4">
                            <h3 class="text-lg font-bold text-white">Available Slots</h3>
                            <p class="text-green-100 text-sm">@daySchedule.AvailableSlots.Count(s => s.IsAvailable) slots open</p>
                        </div>

                        <div class="max-h-[650px] overflow-y-auto p-4">
                            @foreach (var slot in daySchedule.AvailableSlots)
                            {
                                <div class="mb-2 p-3 rounded-lg border-2 @(slot.IsAvailable ? "border-green-200 dark:border-green-700 bg-green-50 dark:bg-green-900 dark:bg-opacity-20 hover:shadow-md cursor-pointer" : "border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 opacity-60")"
                                     @onclick="() => { if (slot.IsAvailable) BookTimeSlot(slot); }">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm font-semibold text-gray-900 dark:text-white">
                                            @FormatTimeWithPeriod(slot.StartTime)
                                        </span>
                                        @if (slot.IsAvailable)
                                        {
                                            <span class="px-2 py-1 bg-green-500 text-white rounded text-xs font-semibold">Available</span>
                                        }
                                        else
                                        {
                                            <span class="px-2 py-1 bg-gray-400 text-white rounded text-xs font-semibold">Booked</span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        }
    }
    </div>
</div>

<!-- Appointment Request Modal -->
<AppointmentRequestModal IsVisible="@showRequestModal"
                        Request="@selectedRequest"
                        OnClose="CloseRequestModal"
                        OnRequestProcessed="HandleRequestProcessed" />

<!-- Appointment Details Modal -->
<AppointmentDetailsModal IsVisible="@showDetailsModal"
                        AppointmentId="@selectedAppointmentId"
                        OnClose="CloseDetailsModal"
                        OnActionPerformed="HandleAppointmentAction" />

</AuthorizeRouteGuard>

@code {
    private AppointmentViewMode viewMode = AppointmentViewMode.Month;
    private DateTime currentDate = DateTime.Now;
    private bool isLoading = true;
    private string activeTab = "appointments"; // Start with appointments tab

    private CalendarViewModel? calendarView;
    private WeekScheduleModel? weekSchedule;
    private DayScheduleModel? daySchedule;
    private AppointmentStatisticsModel? statistics;

    // New variables for pending requests
    private List<AppointmentRequestDto> pendingRequests = new();
    private bool showRequestModal = false;
    private AppointmentRequestDto? selectedRequest = null;

    // Appointment details modal
    private bool showDetailsModal = false;
    private string? selectedAppointmentId = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        
        // Force load pending requests on initialization
        try
        {
            pendingRequests = await AppointmentService.GetPendingAppointmentRequestsAsync();
            Console.WriteLine($"OnInitializedAsync: Loaded {pendingRequests?.Count ?? 0} pending requests");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"OnInitializedAsync: Error loading pending requests: {ex.Message}");
            pendingRequests = new List<AppointmentRequestDto>();
        }
    }

    private async Task LoadData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // Load pending requests
            pendingRequests = await AppointmentService.GetPendingAppointmentRequestsAsync();
            Console.WriteLine($"LoadData: Loaded {pendingRequests?.Count ?? 0} pending requests");

            statistics = await AppointmentService.GetStatisticsAsync();

            switch (viewMode)
            {
                case AppointmentViewMode.Month:
                    calendarView = await AppointmentService.GetMonthCalendarAsync(currentDate);
                    break;
                case AppointmentViewMode.Week:
                    var weekStart = currentDate.AddDays(-(int)currentDate.DayOfWeek);
                    weekSchedule = await AppointmentService.GetWeekScheduleAsync(weekStart);
                    break;
                case AppointmentViewMode.Day:
                    daySchedule = await AppointmentService.GetDayScheduleAsync(currentDate);
                    break;
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading appointments: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task SetViewMode(AppointmentViewMode mode)
    {
        viewMode = mode;
        await LoadData();
    }

    private async Task NavigatePrevious()
    {
        currentDate = viewMode switch
        {
            AppointmentViewMode.Month => currentDate.AddMonths(-1),
            AppointmentViewMode.Week => currentDate.AddDays(-7),
            AppointmentViewMode.Day => currentDate.AddDays(-1),
            _ => currentDate
        };
        await LoadData();
    }

    private async Task NavigateNext()
    {
        currentDate = viewMode switch
        {
            AppointmentViewMode.Month => currentDate.AddMonths(1),
            AppointmentViewMode.Week => currentDate.AddDays(7),
            AppointmentViewMode.Day => currentDate.AddDays(1),
            _ => currentDate
        };
        await LoadData();
    }

    private async Task GoToToday()
    {
        currentDate = DateTime.Now;
        await LoadData();
    }

    private async Task SelectDate(DateTime date)
    {
        currentDate = date;
        viewMode = AppointmentViewMode.Day;
        await LoadData();
    }

    private string GetCurrentViewTitle()
    {
        return viewMode switch
        {
            AppointmentViewMode.Month => currentDate.ToString("MMMM yyyy"),
            AppointmentViewMode.Week => $"{currentDate.AddDays(-(int)currentDate.DayOfWeek):MMM dd} - {currentDate.AddDays(6 - (int)currentDate.DayOfWeek):MMM dd, yyyy}",
            AppointmentViewMode.Day => currentDate.ToString("dddd, MMMM dd, yyyy"),
            _ => ""
        };
    }

    private string GetDateRangeText()
    {
        return viewMode switch
        {
            AppointmentViewMode.Month => "Monthly view",
            AppointmentViewMode.Week => "Weekly view",
            AppointmentViewMode.Day => "Daily view",
            _ => ""
        };
    }

    private string GetAppointmentTypeClass(string type) => type switch
    {
        "Emergency" => "bg-red-100 dark:bg-red-900 dark:bg-opacity-30 text-red-800 dark:text-red-300",
        "Follow-up" => "bg-purple-100 dark:bg-purple-900 dark:bg-opacity-30 text-purple-800 dark:text-purple-300",
        "Telemedicine" => "bg-green-100 dark:bg-green-900 dark:bg-opacity-30 text-green-800 dark:text-green-300",
        _ => "bg-blue-100 dark:bg-blue-900 dark:bg-opacity-30 text-blue-800 dark:text-blue-300"
    };

    private string GetAppointmentStatusColorClass(string status) => status switch
    {
        "Completed" => "bg-green-100 dark:bg-green-900 dark:bg-opacity-20 text-green-800 dark:text-green-300",
        "Cancelled" => "bg-red-100 dark:bg-red-900 dark:bg-opacity-20 text-red-800 dark:text-red-300",
        "No-Show" => "bg-orange-100 dark:bg-orange-900 dark:bg-opacity-20 text-orange-800 dark:text-orange-300",
        "Confirmed" => "bg-blue-100 dark:bg-blue-900 dark:bg-opacity-20 text-blue-800 dark:text-blue-300",
        _ => "bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300"
    };

    private string GetAppointmentStatusBorderClass(string status) => status switch
    {
        "Completed" => "border-green-300 dark:border-green-700",
        "Cancelled" => "border-red-300 dark:border-red-700",
        "Confirmed" => "border-blue-300 dark:border-blue-700",
        _ => "border-gray-300 dark:border-gray-700"
    };

    private string GetAppointmentStatusBadgeClass(string status) => status switch
    {
        "Completed" => "bg-green-500 text-white",
        "Cancelled" => "bg-red-500 text-white",
        "No-Show" => "bg-orange-500 text-white",
        "Confirmed" => "bg-blue-500 text-white",
        _ => "bg-gray-500 text-white"
    };

    private void ShowNewAppointmentModal()
    {
        ToastService.ShowInfo("New Appointment booking feature coming soon!");
    }

    private void ViewAppointmentDetails(string appointmentId)
    {
        Console.WriteLine($"ViewAppointmentDetails called with ID: {appointmentId}");
        selectedAppointmentId = appointmentId;
        showDetailsModal = true;
        StateHasChanged();
    }

    private void CloseDetailsModal()
    {
        showDetailsModal = false;
        selectedAppointmentId = null;
    }

    private async Task HandleAppointmentAction()
    {
        await LoadData();
    }

    private async Task MarkAsCompleted(string appointmentId)
    {
        var success = await AppointmentService.MarkAsCompletedAsync(appointmentId);
        if (success)
        {
            ToastService.ShowSuccess("Appointment marked as completed");
            await LoadData();
        }
    }

    private void CancelAppointment(string appointmentId)
    {
        ToastService.ShowInfo("Cancel appointment feature coming soon!");
    }

    private void BookTimeSlot(TimeSlotModel slot)
    {
        ToastService.ShowInfo($"Booking appointment for {slot.StartTime:hh\\:mm tt}");
    }

    private void ChatWithPatient(string patientId)
    {
        // Navigate to messages page with the patient conversation pre-selected
        Navigation.NavigateTo($"/doctor/messages?patientId={patientId}");
    }

    private void StartConsultation(string appointmentId)
    {
        Console.WriteLine($"StartConsultation called with ID: {appointmentId}");
        // Navigate to consultation room
        Navigation.NavigateTo($"/doctor/consultation/{appointmentId}");
    }

    // New methods for pending requests
    private async Task SwitchTab(string tab)
    {
        activeTab = tab;
        if (tab == "requests")
        {
            // Reload pending requests when switching to requests tab
            isLoading = true;
            StateHasChanged();
            
            try
            {
                pendingRequests = await AppointmentService.GetPendingAppointmentRequestsAsync();
                Console.WriteLine($"SwitchTab: Loaded {pendingRequests?.Count ?? 0} pending requests");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"SwitchTab: Error loading pending requests: {ex.Message}");
                pendingRequests = new List<AppointmentRequestDto>();
            }
            finally
            {
                isLoading = false;
            }
        }
        else if (tab == "appointments")
        {
            await LoadData();
        }
        StateHasChanged();
    }

    private void ShowRequestDetails(AppointmentRequestDto request)
    {
        selectedRequest = request;
        showRequestModal = true;
        StateHasChanged();
    }

    private Task CloseRequestModal()
    {
        showRequestModal = false;
        selectedRequest = null;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task HandleRequestProcessed(bool approved)
    {
        if (selectedRequest == null) return;

        try
        {
            if (approved)
            {
                var input = new ReviewAppointmentRequestInput
                {
                    RequestId = selectedRequest.Id,
                    Status = "APPROVED",
                    AppointmentDateTime = selectedRequest.PreferredDate ?? DateTime.Now.AddDays(1),
                    DurationMinutes = 30,
                    RoomNumber = "",
                    ReviewNotes = ""
                };

                var result = await AppointmentService.ApproveAppointmentRequestAsync(input);
                if (result != null)
                {
                    ToastService.ShowSuccess($"Appointment scheduled successfully for {result.PatientName}");
                    pendingRequests.Remove(selectedRequest);
                }
                else
                {
                    ToastService.ShowError("Failed to approve appointment request");
                }
            }
            else
            {
                var success = await AppointmentService.RejectAppointmentRequestAsync(selectedRequest.Id, "Not available at preferred time");
                if (success)
                {
                    ToastService.ShowWarning($"Appointment request rejected for {selectedRequest.FullName}");
                    pendingRequests.Remove(selectedRequest);
                }
                else
                {
                    ToastService.ShowError("Failed to reject appointment request");
                }
            }

            await CloseRequestModal();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error processing request: {ex.Message}");
        }
    }

    // Helper methods for time formatting
    private string FormatTime(TimeSpan time)
    {
        var hours = time.Hours;
        var minutes = time.Minutes;
        return $"{hours:D2}:{minutes:D2}";
    }

    private string FormatTimeWithPeriod(TimeSpan time)
    {
        var hours = time.Hours;
        var minutes = time.Minutes;
        var period = hours >= 12 ? "PM" : "AM";
        var displayHours = hours > 12 ? hours - 12 : (hours == 0 ? 12 : hours);
        return $"{displayHours:D2}:{minutes:D2} {period}";
    }

    private string FormatTime12Hour(TimeSpan time)
    {
        var hours = time.Hours;
        var minutes = time.Minutes;
        var period = hours >= 12 ? "PM" : "AM";
        var displayHours = hours > 12 ? hours - 12 : (hours == 0 ? 12 : hours);
        return $"{displayHours}:{minutes:D2} {period}";
    }

    // Helper methods for new card UI
    private string GetCardBorderClass(string type, string status)
    {
        if (type.Contains("Emergency", StringComparison.OrdinalIgnoreCase))
            return "border-2 border-red-300 dark:border-red-700";
        if (status == "Confirmed")
            return "border-2 border-blue-200 dark:border-blue-800";
        return "border border-gray-200 dark:border-gray-700";
    }

    private string GetAccentGradient(string type) => type switch
    {
        "Emergency" => "bg-gradient-to-b from-red-500 to-red-700",
        "FollowUp" or "Follow-up" => "bg-gradient-to-b from-purple-500 to-purple-700",
        "Telemedicine" => "bg-gradient-to-b from-green-500 to-green-700",
        _ => "bg-gradient-to-b from-blue-500 to-blue-700"
    };

    private string GetPulseClass(string status)
    {
        return (status == "Scheduled" || status == "Confirmed") ? "animate-pulse" : "";
    }

    private string GetTimeBackgroundGradient(string status) => status switch
    {
        "Completed" => "bg-gradient-to-br from-green-500 to-emerald-600",
        "Cancelled" => "bg-gradient-to-br from-red-500 to-rose-600",
        "Confirmed" => "bg-gradient-to-br from-blue-500 to-indigo-600",
        "Scheduled" => "bg-gradient-to-br from-primary to-accent",
        "InProgress" => "bg-gradient-to-br from-yellow-500 to-orange-600",
        _ => "bg-gradient-to-br from-gray-500 to-gray-600"
    };

    private int GetTimeProgressWidth(AppointmentModel apt)
    {
        // Show progress based on time until appointment
        var now = DateTime.Now.TimeOfDay;
        var start = apt.StartTime;

        if (now > start)
            return 100; // Past appointment

        var hoursUntil = (start - now).TotalHours;
        if (hoursUntil > 24)
            return 10;
        if (hoursUntil > 12)
            return 25;
        if (hoursUntil > 6)
            return 50;
        if (hoursUntil > 2)
            return 75;

        return 90; // Less than 2 hours
    }

    private string GetAvatarGradient(string type) => type switch
    {
        "Emergency" => "bg-gradient-to-br from-red-400 to-red-600",
        "FollowUp" or "Follow-up" => "bg-gradient-to-br from-purple-400 to-purple-600",
        "Telemedicine" => "bg-gradient-to-br from-green-400 to-green-600",
        "Consultation" => "bg-gradient-to-br from-blue-400 to-blue-600",
        _ => "bg-gradient-to-br from-indigo-400 to-indigo-600"
    };

    private string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "?";

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 1)
            return parts[0].Substring(0, Math.Min(2, parts[0].Length)).ToUpper();

        return $"{parts[0][0]}{parts[^1][0]}".ToUpper();
    }

    private string GetStatusDotColor(string status) => status switch
    {
        "Completed" => "bg-green-500",
        "Cancelled" => "bg-red-500",
        "Confirmed" => "bg-blue-500",
        "Scheduled" => "bg-primary",
        "InProgress" => "bg-yellow-500",
        _ => "bg-gray-500"
    };

    private string GetStatusPulse(string status)
    {
        return (status == "Scheduled" || status == "Confirmed" || status == "InProgress")
            ? "animate-pulse"
            : "";
    }

    private string GetTypeBadgeGradient(string type) => type switch
    {
        "Emergency" => "bg-gradient-to-r from-red-500 to-red-600 text-white",
        "FollowUp" or "Follow-up" => "bg-gradient-to-r from-purple-500 to-purple-600 text-white",
        "Telemedicine" => "bg-gradient-to-r from-green-500 to-green-600 text-white",
        "Consultation" => "bg-gradient-to-r from-blue-500 to-blue-600 text-white",
        _ => "bg-gradient-to-r from-gray-500 to-gray-600 text-white"
    };

    private MarkupString GetTypeIcon(string type)
    {
        var icon = type switch
        {
            "Emergency" => "<svg class='w-3.5 h-3.5 mr-1 inline' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z'/></svg>",
            "Telemedicine" => "<svg class='w-3.5 h-3.5 mr-1 inline' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'/></svg>",
            "FollowUp" or "Follow-up" => "<svg class='w-3.5 h-3.5 mr-1 inline' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2'/></svg>",
            _ => "<svg class='w-3.5 h-3.5 mr-1 inline' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z'/></svg>"
        };
        return new MarkupString(icon);
    }

    private string GetStatusBadgeGradient(string status) => status switch
    {
        "Completed" => "bg-gradient-to-r from-green-500 to-green-600 text-white",
        "Cancelled" => "bg-gradient-to-r from-red-500 to-red-600 text-white",
        "Confirmed" => "bg-gradient-to-r from-blue-500 to-blue-600 text-white",
        "Scheduled" => "bg-gradient-to-r from-primary to-accent text-white",
        "InProgress" => "bg-gradient-to-r from-yellow-500 to-orange-600 text-white",
        "NoShow" or "No-Show" => "bg-gradient-to-r from-orange-500 to-orange-600 text-white",
        _ => "bg-gradient-to-r from-gray-500 to-gray-600 text-white"
    };

    private MarkupString GetStatusIcon(string status)
    {
        var icon = status switch
        {
            "Completed" => "<svg class='w-3.5 h-3.5 mr-1 inline' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M5 13l4 4L19 7'/></svg>",
            "Cancelled" => "<svg class='w-3.5 h-3.5 mr-1 inline' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12'/></svg>",
            "Confirmed" => "<svg class='w-3.5 h-3.5 mr-1 inline' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/></svg>",
            "InProgress" => "<svg class='w-3.5 h-3.5 mr-1 inline' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z'/></svg>",
            _ => "<svg class='w-3.5 h-3.5 mr-1 inline' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z'/></svg>"
        };
        return new MarkupString(icon);
    }
}

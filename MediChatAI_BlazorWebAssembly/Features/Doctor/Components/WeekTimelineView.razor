@using MediChatAI_BlazorWebAssembly.Features.Doctor.Models

<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden transition-colors">
    <div class="overflow-x-auto">
        <div class="min-w-[1200px]">
            <!-- Header with Day Labels -->
            <div class="grid grid-cols-8 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
                <div class="p-4 text-center font-semibold text-gray-700 dark:text-gray-300 border-r border-gray-200 dark:border-gray-600">
                    Time
                </div>
                @if (WeekSchedule != null)
                {
                    @foreach (var day in WeekSchedule.Days)
                    {
                        <div class="@GetDayHeaderClass(day.Date) p-4 text-center border-r border-gray-200 dark:border-gray-600">
                            <div class="font-semibold">@day.Date.ToString("ddd")</div>
                            <div class="text-sm">@day.Date.ToString("MMM dd")</div>
                            <div class="mt-1 flex flex-col gap-1 items-center">
                                @if (day.TotalAppointments > 0)
                                {
                                    <div class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-primary/10 text-primary dark:bg-accent/20 dark:text-accent">
                                        @day.TotalAppointments apt@(day.TotalAppointments != 1 ? "s" : "")
                                    </div>
                                }
                                @if (day.TimeBlocks.Count > 0)
                                {
                                    <div class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-200/60 text-gray-700 dark:bg-gray-700/60 dark:text-gray-300">
                                        @day.TimeBlocks.Count block@(day.TimeBlocks.Count != 1 ? "s" : "")
                                    </div>
                                }
                            </div>
                        </div>
                    }
                }
            </div>

            <!-- Timeline Grid -->
            <div class="relative">
                @for (int hour = 0; hour <= 23; hour++)
                {
                    <div class="grid grid-cols-8 border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50/50 dark:hover:bg-gray-700/50 transition-colors">
                        <!-- Time Label -->
                        <div class="p-2 text-sm font-medium text-gray-600 dark:text-gray-400 text-center border-r border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800">
                            @FormatHour(hour)
                        </div>

                        <!-- Day Columns -->
                        @if (WeekSchedule != null)
                        {
                            @foreach (var day in WeekSchedule.Days)
                            {
                                <div class="relative min-h-[80px] p-1 border-r border-gray-200 dark:border-gray-600 @GetTimeSlotClass(day.Date, hour)"
                                     @onclick="() => OnTimeSlotClick.InvokeAsync((day.Date, new TimeSpan(hour, 0, 0)))"
                                     @ondrop="@(async (e) => await HandleDrop(day.Date, hour))"
                                     @ondragover="HandleDragOver"
                                     @ondragover:preventDefault="true"
                                     @ondragenter="HandleDragEnter"
                                     @ondragenter:preventDefault="true"
                                     @ondragleave="HandleDragLeave">

                                    @* Appointments in this time slot *@
                                    @{
                                        var slotStart = new TimeSpan(hour, 0, 0);
                                        var slotEnd = new TimeSpan(hour + 1, 0, 0);
                                        var appointments = day.Appointments.Where(a =>
                                            (a.StartTime >= slotStart && a.StartTime < slotEnd) ||
                                            (a.EndTime > slotStart && a.EndTime <= slotEnd) ||
                                            (a.StartTime <= slotStart && a.EndTime >= slotEnd)
                                        ).ToList();
                                    }

                                    @foreach (var appointment in appointments)
                                    {
                                        <AppointmentTimelineCard Appointment="@appointment"
                                                                 OnClick="@(() => OnAppointmentClick.InvokeAsync(appointment.AppointmentId))"
                                                                 OnDragStart="@(() => draggedAppointmentId = appointment.AppointmentId)" />
                                    }

                                    @* Time blocks in this time slot *@
                                    @{
                                        var timeBlocks = day.TimeBlocks.Where(tb =>
                                            (tb.StartTime >= slotStart && tb.StartTime < slotEnd) ||
                                            (tb.EndTime > slotStart && tb.EndTime <= slotEnd) ||
                                            (tb.StartTime <= slotStart && tb.EndTime >= slotEnd)
                                        ).ToList();
                                    }

                                    @foreach (var timeBlock in timeBlocks)
                                    {
                                        <div class="mb-1 p-2 rounded-lg @GetTimeBlockClass(timeBlock.BlockType) border @GetTimeBlockBorderClass(timeBlock.BlockType) shadow-sm transition-all"
                                             title="@($"{timeBlock.BlockType}: {timeBlock.StartTime:hh\\:mm} - {timeBlock.EndTime:hh\\:mm}\n{timeBlock.Notes}")">
                                            <div class="flex items-center space-x-2">
                                                @* Icon based on block type *@
                                                <div class="@GetTimeBlockIconClass(timeBlock.BlockType)">
                                                    @if (timeBlock.BlockType == "Lunch")
                                                    {
                                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                                                        </svg>
                                                    }
                                                    else if (timeBlock.BlockType == "Break")
                                                    {
                                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                        </svg>
                                                    }
                                                    else if (timeBlock.BlockType == "Meeting")
                                                    {
                                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                                        </svg>
                                                    }
                                                    else if (timeBlock.BlockType == "Personal")
                                                    {
                                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                                        </svg>
                                                    }
                                                    else
                                                    {
                                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                                                        </svg>
                                                    }
                                                </div>

                                                @* Block info *@
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-xs font-semibold truncate">
                                                        @timeBlock.BlockType
                                                    </p>
                                                    <p class="text-xs opacity-75 truncate">
                                                        @FormatTimeSimple(timeBlock.StartTime) - @FormatTimeSimple(timeBlock.EndTime)
                                                    </p>
                                                </div>

                                                @* Recurring indicator *@
                                                @if (timeBlock.IsRecurring)
                                                {
                                                    <svg class="w-3 h-3 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                                    </svg>
                                                }
                                            </div>
                                        </div>
                                    }

                                    @* Pending requests in this time slot *@
                                    @{
                                        var pendingInSlot = PendingRequests?.Where(r =>
                                            r.PreferredDate.HasValue &&
                                            r.PreferredDate.Value.Date == day.Date &&
                                            GetTimeSlotFromString(r.PreferredTimeSlot) == hour
                                        ).ToList() ?? new List<AppointmentRequestDto>();
                                    }

                                    @foreach (var request in pendingInSlot)
                                    {
                                        <div class="mb-1 p-2 rounded-lg bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 cursor-pointer hover:shadow-md transition-all"
                                             @onclick="() => HandlePendingRequestClick(request.Id)">
                                            <div class="flex items-center justify-between">
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-xs font-semibold text-yellow-900 dark:text-yellow-200 truncate">
                                                        @request.FullName
                                                    </p>
                                                    <p class="text-xs text-yellow-700 dark:text-yellow-400 truncate">
                                                        @request.ReasonForVisit
                                                    </p>
                                                </div>
                                                <span class="ml-2 inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-yellow-100 dark:bg-yellow-900/40 text-yellow-800 dark:text-yellow-300">
                                                    Pending
                                                </span>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        }
                    </div>
                }
            </div>
        </div>
    </div>

    @if (WeekSchedule == null || !WeekSchedule.Days.Any())
    {
        <div class="text-center py-12">
            <svg class="w-16 h-16 mx-auto text-gray-400 dark:text-gray-600 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">No Schedule Data</h3>
            <p class="text-gray-500 dark:text-gray-400">Schedule information is not available.</p>
        </div>
    }
</div>

@code {
    [Parameter] public WeekScheduleModel? WeekSchedule { get; set; }
    [Parameter] public List<AppointmentRequestDto>? PendingRequests { get; set; }
    [Parameter] public EventCallback<string> OnAppointmentClick { get; set; }
    [Parameter] public EventCallback<(string appointmentId, DateTime newDate, TimeSpan newTime)> OnAppointmentReschedule { get; set; }
    [Parameter] public EventCallback<(DateTime date, TimeSpan time)> OnTimeSlotClick { get; set; }

    private string? draggedAppointmentId;

    private string GetDayHeaderClass(DateTime date)
    {
        var baseClass = "transition-colors";
        if (date.Date == DateTime.Now.Date)
        {
            return $"{baseClass} bg-gradient-to-br from-primary/20 to-accent/20 dark:from-primary-dark/20 dark:to-accent-dark/20 text-primary dark:text-accent font-bold";
        }
        else if (date.Date < DateTime.Now.Date)
        {
            return $"{baseClass} text-gray-500 dark:text-gray-500";
        }
        return $"{baseClass} text-gray-700 dark:text-gray-300";
    }

    private string GetTimeSlotClass(DateTime date, int hour)
    {
        var now = DateTime.Now;
        var slotDateTime = date.Date.AddHours(hour);

        if (slotDateTime < now)
        {
            return "bg-gray-50 dark:bg-gray-800/50 cursor-not-allowed";
        }

        return "cursor-pointer hover:bg-primary/5 dark:hover:bg-accent/5";
    }

    private string FormatHour(int hour)
    {
        var time = new TimeSpan(hour, 0, 0);
        var dateTime = DateTime.Today.Add(time);
        return dateTime.ToString("h:mm tt");
    }

    private string FormatTimeSimple(TimeSpan time)
    {
        return $"{time.Hours:D2}:{time.Minutes:D2}";
    }

    private int GetTimeSlotFromString(string? timeSlot)
    {
        if (string.IsNullOrEmpty(timeSlot))
            return -1;

        // Parse time slot like "Morning (8:00 AM - 12:00 PM)" or "09:00 AM"
        if (timeSlot.Contains("Morning"))
            return 9;
        else if (timeSlot.Contains("Afternoon"))
            return 14;
        else if (timeSlot.Contains("Evening"))
            return 18;

        // Try to parse specific time
        try
        {
            var timePart = timeSlot.Split('-')[0].Trim();
            if (DateTime.TryParse(timePart, out var parsedTime))
            {
                return parsedTime.Hour;
            }
        }
        catch { }

        return -1;
    }

    private void HandleDragOver(DragEventArgs e)
    {
        // Allow drop by preventing default
        e.DataTransfer.DropEffect = "move";
    }

    private void HandleDragEnter(DragEventArgs e)
    {
        // Visual feedback can be added here if needed
    }

    private void HandleDragLeave(DragEventArgs e)
    {
        // Remove visual feedback if needed
    }

    private async Task HandleDrop(DateTime date, int hour)
    {
        if (!string.IsNullOrEmpty(draggedAppointmentId))
        {
            var newTime = new TimeSpan(hour, 0, 0);
            await OnAppointmentReschedule.InvokeAsync((draggedAppointmentId, date, newTime));
            draggedAppointmentId = null;
        }
    }

    private void HandlePendingRequestClick(int requestId)
    {
        // Navigate to appointments page to review request
        // This would be handled by the parent component
    }

    private string GetTimeBlockClass(string blockType)
    {
        return blockType switch
        {
            "Lunch" => "bg-orange-50 dark:bg-orange-900/20",
            "Break" => "bg-purple-50 dark:bg-purple-900/20",
            "Meeting" => "bg-blue-50 dark:bg-blue-900/20",
            "Personal" => "bg-pink-50 dark:bg-pink-900/20",
            _ => "bg-gray-50 dark:bg-gray-900/20"
        };
    }

    private string GetTimeBlockBorderClass(string blockType)
    {
        return blockType switch
        {
            "Lunch" => "border-orange-200 dark:border-orange-800",
            "Break" => "border-purple-200 dark:border-purple-800",
            "Meeting" => "border-blue-200 dark:border-blue-800",
            "Personal" => "border-pink-200 dark:border-pink-800",
            _ => "border-gray-200 dark:border-gray-800"
        };
    }

    private string GetTimeBlockIconClass(string blockType)
    {
        return blockType switch
        {
            "Lunch" => "text-orange-600 dark:text-orange-400",
            "Break" => "text-purple-600 dark:text-purple-400",
            "Meeting" => "text-blue-600 dark:text-blue-400",
            "Personal" => "text-pink-600 dark:text-pink-400",
            _ => "text-gray-600 dark:text-gray-400"
        };
    }
}

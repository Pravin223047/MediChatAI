@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime

<div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 border border-gray-200 dark:border-gray-700 @ContainerClass">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h3 class="text-lg font-bold text-gray-900 dark:text-white">@Title</h3>
            @if (!string.IsNullOrEmpty(Subtitle))
            {
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">@Subtitle</p>
            }
        </div>

        <div class="flex items-center gap-2">
            @if (ShowExport)
            {
                <button @onclick="ExportChart"
                        class="p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
                        title="Export Chart">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a 3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                </button>
            }

            @if (ShowDrillDown)
            {
                <button @onclick="OnDrillDown"
                        class="p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
                        title="View Details">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                </button>
            }

            @if (ShowFullscreen)
            {
                <button @onclick="ToggleFullscreen"
                        class="p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
                        title="Fullscreen">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                    </svg>
                </button>
            }
        </div>
    </div>

    @if (IsLoading)
    {
        <div class="flex items-center justify-center h-64">
            <div class="text-center">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                <p class="mt-4 text-gray-600 dark:text-gray-400">Loading chart...</p>
            </div>
        </div>
    }
    else if (HasError)
    {
        <div class="flex items-center justify-center h-64">
            <div class="text-center">
                <svg class="w-16 h-16 mx-auto text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <p class="mt-4 text-gray-600 dark:text-gray-400">Failed to load chart data</p>
            </div>
        </div>
    }
    else
    {
        <div class="relative" style="height: @Height">
            <canvas id="@ChartId"></canvas>
        </div>

        @if (ShowLegend && LegendItems.Any())
        {
            <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex flex-wrap gap-4">
                    @foreach (var item in LegendItems)
                    {
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full" style="background-color: @item.Color"></div>
                            <span class="text-sm text-gray-600 dark:text-gray-400">@item.Label</span>
                            @if (item.Value != null)
                            {
                                <span class="text-sm font-semibold text-gray-900 dark:text-white">@item.Value</span>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter] public string Title { get; set; } = string.Empty;
    [Parameter] public string Subtitle { get; set; } = string.Empty;
    [Parameter] public string ChartId { get; set; } = $"chart-{Guid.NewGuid():N}";
    [Parameter] public string ChartType { get; set; } = "line";
    [Parameter] public object? ChartData { get; set; }
    [Parameter] public object? ChartOptions { get; set; }
    [Parameter] public string Height { get; set; } = "300px";
    [Parameter] public string ContainerClass { get; set; } = string.Empty;
    [Parameter] public bool ShowExport { get; set; } = true;
    [Parameter] public bool ShowDrillDown { get; set; } = false;
    [Parameter] public bool ShowFullscreen { get; set; } = false;
    [Parameter] public bool ShowLegend { get; set; } = false;
    [Parameter] public List<LegendItem> LegendItems { get; set; } = new();
    [Parameter] public bool IsLoading { get; set; } = false;
    [Parameter] public bool HasError { get; set; } = false;
    [Parameter] public EventCallback OnDrillDownClicked { get; set; }

    private bool isFullscreen = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && ChartData != null && !IsLoading && !HasError)
        {
            await RenderChart();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (ChartData != null && !IsLoading && !HasError)
        {
            await RenderChart();
        }
    }

    private async Task RenderChart()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("renderChart", ChartId, ChartType, ChartData, ChartOptions);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rendering chart: {ex.Message}");
        }
    }

    private async Task ExportChart()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("exportChartAsPNG", ChartId, $"{Title.Replace(" ", "_")}.png");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error exporting chart: {ex.Message}");
        }
    }

    private async Task OnDrillDown()
    {
        await OnDrillDownClicked.InvokeAsync();
    }

    private void ToggleFullscreen()
    {
        isFullscreen = !isFullscreen;
        // Implement fullscreen logic if needed
    }

    public class LegendItem
    {
        public string Label { get; set; } = string.Empty;
        public string Color { get; set; } = string.Empty;
        public object? Value { get; set; }
    }
}

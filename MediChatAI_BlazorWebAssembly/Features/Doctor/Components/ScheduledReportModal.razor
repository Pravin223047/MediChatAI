@using MediChatAI_BlazorWebAssembly.Features.Doctor.Models

@if (IsOpen)
{
    <div class="fixed inset-0 z-50 overflow-y-auto">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity" @onclick="Close"></div>

        <!-- Modal -->
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl p-6 transform transition-all">
                <!-- Header -->
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                            @(Report.Id == string.Empty ? "Schedule New Report" : "Edit Scheduled Report")
                        </h2>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Configure automated report generation and delivery</p>
                    </div>
                    <button @onclick="Close" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- Form -->
                <div class="space-y-4">
                    <!-- Report Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Report Name</label>
                        <input type="text" @bind="Report.ReportName" @bind:event="oninput" placeholder="E.g., Weekly Patient Summary"
                               class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400" />
                    </div>

                    <!-- Report Type -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Report Type</label>
                        <select @bind="Report.ReportType"
                                class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-gray-900 dark:text-white">
                            <option value="Patient">Patient Reports</option>
                            <option value="Appointment">Appointment Analytics</option>
                            <option value="Prescription">Prescription Reports</option>
                            <option value="Revenue">Revenue & Financial</option>
                        </select>
                    </div>

                    <!-- Frequency -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Frequency</label>
                        <div class="grid grid-cols-3 gap-3">
                            @foreach (var freq in new[] { "Daily", "Weekly", "Monthly" })
                            {
                                <button @onclick="() => Report.Frequency = freq"
                                        class="@(Report.Frequency == freq ? "bg-primary text-white border-primary" : "bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600") border-2 rounded-lg px-4 py-3 hover:border-primary transition-all font-medium">
                                    @freq
                                </button>
                            }
                        </div>
                    </div>

                    <!-- Export Format -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Export Format</label>
                        <div class="grid grid-cols-3 gap-3">
                            @foreach (var format in new[] { new { Value = "PDF", Icon = "M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" },
                                new { Value = "Excel", Icon = "M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" },
                                new { Value = "CSV", Icon = "M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" }
                            })
                            {
                                <button @onclick="() => Report.ExportFormat = format.Value"
                                        class="@(Report.ExportFormat == format.Value ? "bg-primary text-white border-primary" : "bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600") border-2 rounded-lg px-4 py-3 hover:border-primary transition-all flex flex-col items-center gap-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="@format.Icon"/>
                                    </svg>
                                    <span class="text-sm font-medium">@format.Value</span>
                                </button>
                            }
                        </div>
                    </div>

                    <!-- Email To -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email Address</label>
                        <div class="relative">
                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                            <input type="email" @bind="Report.EmailTo" @bind:event="oninput" placeholder="your.email@example.com"
                                   class="w-full pl-10 pr-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400" />
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Report will be automatically sent to this email</p>
                    </div>

                    <!-- Next Run Date -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Next Run Date</label>
                        <input type="date" @bind="Report.NextRunDate" @bind:event="oninput"
                               class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-gray-900 dark:text-white" />
                    </div>

                    <!-- Active Status -->
                    <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                        <div>
                            <div class="font-medium text-gray-900 dark:text-white">Enable Report</div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Activate automated report generation</p>
                        </div>
                        <button @onclick="() => Report.IsActive = !Report.IsActive"
                                class="@(Report.IsActive ? "bg-primary" : "bg-gray-300 dark:bg-gray-600") relative inline-flex h-6 w-11 items-center rounded-full transition-colors">
                            <span class="@(Report.IsActive ? "translate-x-6" : "translate-x-1") inline-block h-4 w-4 transform rounded-full bg-white transition-transform"></span>
                        </button>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex items-center justify-end gap-3 mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <button @onclick="Close"
                            class="px-6 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors font-medium">
                        Cancel
                    </button>
                    <button @onclick="SaveReport"
                            disabled="@(!IsValid())"
                            class="@(IsValid() ? "" : "opacity-50 cursor-not-allowed") px-6 py-2 bg-gradient-to-r from-primary to-accent text-white rounded-lg hover:shadow-lg transition-all font-medium flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        @(Report.Id == string.Empty ? "Create Schedule" : "Update Schedule")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public ScheduledReport Report { get; set; } = new();
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<ScheduledReport> OnSave { get; set; }

    protected override void OnParametersSet()
    {
        // Set defaults for new reports
        if (Report.Id == string.Empty)
        {
            Report.ReportType = "Patient";
            Report.Frequency = "Weekly";
            Report.ExportFormat = "PDF";
            Report.NextRunDate = DateTime.Now.AddDays(1);
            Report.IsActive = true;
        }
    }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }

    private async Task SaveReport()
    {
        if (IsValid())
        {
            if (Report.Id == string.Empty)
            {
                Report.Id = Guid.NewGuid().ToString();
                Report.CreatedDate = DateTime.Now;
            }

            await OnSave.InvokeAsync(Report);
            await Close();
        }
    }

    private bool IsValid()
    {
        return !string.IsNullOrWhiteSpace(Report.ReportName) &&
               !string.IsNullOrWhiteSpace(Report.EmailTo) &&
               !string.IsNullOrWhiteSpace(Report.ReportType) &&
               !string.IsNullOrWhiteSpace(Report.Frequency) &&
               !string.IsNullOrWhiteSpace(Report.ExportFormat);
    }
}

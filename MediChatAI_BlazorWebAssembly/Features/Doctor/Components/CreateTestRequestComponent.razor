@using MediChatAI_BlazorWebAssembly.Core.Services.GraphQL
@inject IGraphQLService GraphQLService
@inject IToastService ToastService

<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
    <h3 class="text-lg font-semibold text-blue-800 mb-2">Create Test Request</h3>
    
    <button @onclick="CreateTestRequest" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mb-4" disabled="@isCreating">
        @if (isCreating)
        {
            <span>Creating...</span>
        }
        else
        {
            <span>Create Test Appointment Request</span>
        }
    </button>
    
    @if (!string.IsNullOrEmpty(message))
    {
        <div class="text-sm mt-2 @(message.Contains("Error") ? "text-red-600" : "text-green-600")">
            @message
        </div>
    }
</div>

@code {
    private bool isCreating = false;
    private string? message;
    
    private async Task CreateTestRequest()
    {
        try
        {
            isCreating = true;
            message = null;
            
            const string mutation = @"
                mutation {
                    createAppointmentRequestAsync(input: {
                        fullName: ""Test Patient""
                        age: 30
                        gender: ""Male""
                        email: ""test@example.com""
                        phoneNumber: ""1234567890""
                        symptomDescription: ""Test symptoms for debugging""
                        reasonForVisit: ""General consultation""
                        preferredAppointmentType: GENERAL
                        isUrgent: false
                    }) {
                        id
                        fullName
                        symptomDescription
                        status
                    }
                }";
            
            var response = await GraphQLService.SendQueryAsync<Dictionary<string, object>>(mutation);
            
            if (response != null && response.ContainsKey("data"))
            {
                var data = response["data"] as Dictionary<string, object>;
                if (data != null && data.ContainsKey("createAppointmentRequestAsync"))
                {
                    message = "Test appointment request created successfully!";
                    ToastService.ShowSuccess("Test request created");
                }
                else
                {
                    message = "Error: No appointment request data returned";
                }
            }
            else if (response != null && response.ContainsKey("errors"))
            {
                var errors = response["errors"];
                message = $"GraphQL Error: {System.Text.Json.JsonSerializer.Serialize(errors)}";
            }
            else
            {
                message = "Error: Invalid response from server";
            }
        }
        catch (Exception ex)
        {
            message = $"Error: {ex.Message}";
            Console.WriteLine($"Create test request error: {ex.Message}");
        }
        finally
        {
            isCreating = false;
        }
    }
}